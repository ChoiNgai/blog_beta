<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="数据开发修仙手册, null">
    <meta name="description" content="分享些好玩的">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>数据开发修仙手册 | null</title>
    <link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="null" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<!-- 每日一句 -->
<script src="https://v1.hitokoto.cn/?c=d&encode=js&select=%23hitokoto" defer></script>

<!-- 动态诗词 -->
<!-- <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script> -->


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span"></span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>其他</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/about">
          
          <i class="fas fa-user-circle" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>关于</span>
        </a>
      </li>
      
      <li>
        <a href="/friends">
          
          <i class="fas fa-address-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>友链</span>
        </a>
      </li>
      
      <li>
        <a href="/contact">
          
          <i class="fas fa-comments" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>留言</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name"></div>
        <div class="logo-desc">
            
            分享些好玩的
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			其他
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/about " style="margin-left:75px">
				  
				   <i class="fa fas fa-user-circle" style="position: absolute;left:50px" ></i>
			      
		          <span>关于</span>
                  </a>
                </li>
              
                <li>

                  <a href="/friends " style="margin-left:75px">
				  
				   <i class="fa fas fa-address-book" style="position: absolute;left:50px" ></i>
			      
		          <span>友链</span>
                  </a>
                </li>
              
                <li>

                  <a href="/contact " style="margin-left:75px">
				  
				   <i class="fa fas fa-comments" style="position: absolute;left:50px" ></i>
			      
		          <span>留言</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/ChoiNgai" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/ChoiNgai" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20220307061558.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">数据开发修仙手册</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-03-07
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2022-03-07
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    16.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    58 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <a id="more"></a>

<p>[toc]</p>
<h1 id="修仙注意事项（前言）"><a href="#修仙注意事项（前言）" class="headerlink" title="修仙注意事项（前言）"></a>修仙注意事项（前言）</h1><p>旨在学习钻研，切莫真<strong>修仙</strong>，停不下来后果自负！！！</p>
<h1 id="大数据开发基础篇"><a href="#大数据开发基础篇" class="headerlink" title="大数据开发基础篇"></a>大数据开发基础篇</h1><h2 id="Hadoop（必修）"><a href="#Hadoop（必修）" class="headerlink" title="Hadoop（必修）"></a>Hadoop（必修）</h2><h2 id="Hive（必修）"><a href="#Hive（必修）" class="headerlink" title="Hive（必修）"></a>Hive（必修）</h2><h2 id="Spark（必修）"><a href="#Spark（必修）" class="headerlink" title="Spark（必修）"></a>Spark（必修）</h2><h2 id="Sqoop"><a href="#Sqoop" class="headerlink" title="Sqoop"></a>Sqoop</h2><h2 id="Hbase"><a href="#Hbase" class="headerlink" title="Hbase"></a>Hbase</h2><h2 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h2><h2 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h2><h2 id="Flink"><a href="#Flink" class="headerlink" title="Flink"></a>Flink</h2><h1 id="SQL篇"><a href="#SQL篇" class="headerlink" title="SQL篇"></a>SQL篇</h1><h2 id="1-基础语法"><a href="#1-基础语法" class="headerlink" title="1. 基础语法"></a>1. 基础语法</h2><h2 id="2-进阶语法"><a href="#2-进阶语法" class="headerlink" title="2.进阶语法"></a>2.进阶语法</h2><h2 id="3-常见业务场景"><a href="#3-常见业务场景" class="headerlink" title="3.常见业务场景"></a>3.常见业务场景</h2><h2 id="4-数据倾斜调优"><a href="#4-数据倾斜调优" class="headerlink" title="4.数据倾斜调优"></a>4.数据倾斜调优</h2><h3 id="产生原理及现象"><a href="#产生原理及现象" class="headerlink" title="产生原理及现象"></a>产生原理及现象</h3><p><strong>1、数据倾斜发生时的现象</strong></p>
<ul>
<li>绝大多数task执行得都非常快，但个别task执行极慢。比如，总共有1000个task，997个task都在1分钟之 内执行完了，但是剩余两三个task却要一两个小时。这种情况很常见。 </li>
<li>原本能够正常执行的Spark作业，某天突然报出OOM（内存溢出）异常，观察异常栈，是我们写的业务代码 造成的。这种情况比较少见。</li>
</ul>
<p><strong>2、数据倾斜发生的原理</strong></p>
<p>在进行shuffle的时候，必须将各个节点上相同的key拉取到某个节点上的一个task来进行处理，比如按照key进行聚合或join等操作。此时如果某个key对应的数据量特别大的话，就会发生数据倾斜。比如大部分key对应10条数据，但是个别key却对应了100万条数据，那么大部分task可能就只会分配到10条数据，然后1秒钟就运行完了；但是个别task可能分配到了100万数据，要运行一两个小时。因此，整个Spark作业的运行进度是由运行时间最长的那个task决定的。</p>
<p>因此出现数据倾斜的时候，Spark作业看起来会运行得非常缓慢，甚至可能因为某个task处理的 数据量过大导致内存溢出</p>
<p><strong>3、如何定位导致数据倾斜的代码</strong></p>
<p>​    数据倾斜只会发生在shuffle过程中。常用的并且可能会触发shuffle操作的算子：<code>distinct</code>、<code>groupByKey</code>、<code>reduceByKey</code>、<code>aggregateByKey</code>、<code>join</code>、<code>cogroup</code>、<code>repartition</code> 等。出现数据倾斜时，可能就是代码中使用了这些算子中的某一个所导致的。</p>
<p>只要看到Spark代码中出现了一个shuffle类算子或者是Spark SQL的SQL语句中出现了会导致shuffle的语句（比如group by语句），那么就可以判定，以那个地方为界限划分出了 前后两个stage。</p>
<p>知道数据倾斜发生在哪一个stage之后，接着我们就需要根据stage划分原理，推算出来发生倾斜的那个stage对应代码中的哪一部分，这部分代码中肯定会有一个shuffle类算子。</p>
<p><strong>4、某个task莫名其妙内存溢出的情况</strong></p>
<p>这种情况下去定位出问题的代码就比较容易了。我们建议直接看<code>yarn-client</code>模式下本地log的异 常栈，或者是通过YARN查看<code>yarn-cluster</code>模式下的log中的异常栈。一般来说，通过异常栈信息 就可以定位到代码中哪一行发生了内存溢出。然后在那行代码附近找找，一般也会有shuffle 类算子，此时很可能就是这个算子导致了数据倾斜。</p>
<p>但是也要注意，不能单纯靠偶然的内存溢出就判定发生了数据倾斜。因为自己编写的代码 的bug，以及偶然出现的数据异常，也可能会导致内存溢出。因此还是要按照上面所讲的方法，通过Spark Web UI查看报错的那个stage的各个task的运行时间以及分配的数据量，才能确定是否是由于数据倾斜才导致了这次内存溢出。</p>
<p><strong>5、查看导致数据倾斜的key的数据分布情况</strong></p>
<p>知道了数据倾斜发生在哪里之后，通常需要分析一下那个执行了shuffle操作并且导致了数据倾斜的<code>RDD</code>/<code>Hive</code>表，查看一下其中key的分布情况。这主要是为之后选择哪一种技术方案提供依据。 针对不同的key分布与不同的shuffle算子组合起来的各种情况，可能需要选择不同的技术方案来 解决。 此时根据你执行操作的情况不同，可以有很多种查看key分布的方式：</p>
<pre><code>1. 如果是Spark SQL中的group by、join语句导致的数据倾斜，那么就查询一下SQL中使用的表的key分布情 况。 

2. 如果是对Spark RDD执行shuffle算子导致的数据倾斜，那么可以在Spark作业中加入查看key分布的代码，比如RDD.countByKey()。
   然后对统计出来的各个key出现的次数，collect/take到客户端打印一下，就可以 看到key的分布情况。</code></pre><blockquote>
<p>调优分为两部分，一个是SQL调优，另一个属于业务层的调优</p>
</blockquote>
<h3 id="SQL语法层调优"><a href="#SQL语法层调优" class="headerlink" title="SQL语法层调优"></a>SQL语法层调优</h3><ol>
<li>join时无效id产生的倾斜</li>
</ol>
<blockquote>
<p>这种方法不仅减少IO，还减少作业数</p>
</blockquote>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token number">a</span><span class="token punctuation">.</span>detail<span class="token punctuation">,</span> <span class="token number">b</span><span class="token punctuation">.</span>reg_date<span class="token punctuation">,</span> <span class="token number">b</span><span class="token punctuation">.</span>uid 
<span class="token keyword">from</span> dwd<span class="token punctuation">.</span>fact_log_detail <span class="token number">a</span>
<span class="token keyword">left</span> <span class="token keyword">join</span> dwd<span class="token punctuation">.</span>dim_user_info <span class="token number">b</span>
     <span class="token keyword">on</span> <span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token number">a</span><span class="token punctuation">.</span>useid <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">then</span> concat<span class="token punctuation">(</span><span class="token string">'hive'</span><span class="token punctuation">,</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token keyword">else</span> <span class="token number">a</span><span class="token punctuation">.</span>userid
     <span class="token keyword">end</span> <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>uid<span class="token punctuation">;</span></code></pre>
<ol start="2">
<li>不同数据类型关联时产生数据倾斜</li>
</ol>
<blockquote>
<p>对于日志表，如果id既有bigint，又有string类型。关联时做hash值，string先转为int再关联分配reducer。相同字符串的id还是会分到一起。但我个人认为，ETL中就应该把字段类型统一，这种方法也是不得已而为之。</p>
</blockquote>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> log <span class="token keyword">left</span> <span class="token keyword">join</span> dwd<span class="token punctuation">.</span>fact_product_detail p <span class="token keyword">on</span> cast<span class="token punctuation">(</span>log<span class="token punctuation">.</span>id <span class="token keyword">as</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">=</span>p<span class="token punctuation">.</span>pid</code></pre>
<ol start="3">
<li>一个字段关联两列值</li>
</ol>
<blockquote>
<p>多次join转化成union，因为多个union all会优化成一个job<br>这样只有一个mr作业。两个表都只读一次。b表每读取一行就会打上一行标签，这样变成两个&lt;key, value&gt;对。</p>
</blockquote>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> log <span class="token number">a</span>
<span class="token keyword">inner</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span> 
   <span class="token keyword">select</span> price_id <span class="token keyword">as</span> price_id <span class="token keyword">from</span> fact_produce_sale_detail
   <span class="token keyword">union</span> <span class="token keyword">all</span> 
   <span class="token keyword">select</span> money_id <span class="token keyword">as</span> price_id <span class="token keyword">from</span> fact_produce_sale_detail
<span class="token punctuation">)</span> <span class="token number">b</span>
<span class="token keyword">on</span> <span class="token number">a</span><span class="token punctuation">.</span>price_id <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>price_id<span class="token punctuation">;</span></code></pre>
<ol start="4">
<li>消灭子查询的group by<br>原写法:</li>
</ol>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">c1</span><span class="token punctuation">,</span> <span class="token number">c2</span><span class="token punctuation">,</span> <span class="token number">c3</span>
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t2 <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">c1</span><span class="token punctuation">,</span> <span class="token number">c2</span><span class="token punctuation">,</span> <span class="token number">c3</span><span class="token punctuation">)</span> tmp
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">c1</span><span class="token punctuation">,</span> <span class="token number">c2</span><span class="token punctuation">,</span> <span class="token number">c3</span></code></pre>
<p>优化:</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t2<span class="token punctuation">)</span> tmp
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">c1</span><span class="token punctuation">,</span><span class="token number">c2</span><span class="token punctuation">,</span><span class="token number">c3</span></code></pre>
<blockquote>
<p>从业务逻辑来将，子查询的group by功能和外层的group by重复，除非子查询有count(distinct)。<br>数据是一致的。MR的作业数由3减少到1。t1相当于一个目录，t2 相当于一个目录，对map reduce程序来说，t1，t2可以作为map reduce作业的mutli inputs。这可以通过一个map reduce来解决这个问题。 Hadoop计算框架，不怕数据多，怕作业数多。</p>
</blockquote>
<ol start="5">
<li>消灭子查询内的count(distinct), max, min</li>
</ol>
<blockquote>
<p>通过建立临时表，消除子查询内的count(distinct)<br>原写法:</p>
</blockquote>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token number">c1</span><span class="token punctuation">,</span> <span class="token number">c2</span><span class="token punctuation">,</span> <span class="token number">c3</span><span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>pv<span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token number">c1</span><span class="token punctuation">,</span> <span class="token number">c2</span><span class="token punctuation">,</span> <span class="token number">c3</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">c4</span><span class="token punctuation">)</span> <span class="token keyword">from</span> t1 <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">c1</span><span class="token punctuation">,</span> <span class="token number">c2</span><span class="token punctuation">,</span> <span class="token number">c3</span>
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span> <span class="token number">c1</span><span class="token punctuation">,</span> <span class="token number">c2</span><span class="token punctuation">,</span> <span class="token number">c3</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token number">c4</span><span class="token punctuation">)</span> <span class="token keyword">from</span> t2 <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">c1</span><span class="token punctuation">,</span> <span class="token number">c2</span><span class="token punctuation">,</span> <span class="token number">c3</span><span class="token punctuation">)</span>t
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">c1</span><span class="token punctuation">,</span> <span class="token number">c2</span><span class="token punctuation">,</span> <span class="token number">c3</span></code></pre>
<p>优化：</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> t4
<span class="token keyword">select</span> <span class="token number">c1</span><span class="token punctuation">,</span> <span class="token number">c2</span><span class="token punctuation">,</span> <span class="token number">c3</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token number">c4</span><span class="token punctuation">)</span> <span class="token keyword">from</span> t2 <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">c1</span><span class="token punctuation">,</span> <span class="token number">c2</span><span class="token punctuation">,</span> <span class="token number">c3</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token number">c1</span><span class="token punctuation">,</span> <span class="token number">c2</span><span class="token punctuation">,</span> <span class="token number">c3</span><span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>pv<span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token number">c1</span><span class="token punctuation">,</span> <span class="token number">c2</span><span class="token punctuation">,</span> <span class="token number">c3</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">c4</span><span class="token punctuation">)</span> <span class="token keyword">from</span> t1
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t4<span class="token punctuation">)</span>tmp
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">c1</span><span class="token punctuation">,</span> <span class="token number">c2</span><span class="token punctuation">,</span> <span class="token number">c3</span></code></pre>
<ol start="6">
<li>大表join</li>
</ol>
<blockquote>
<p>谓词下推，先把能过滤掉的主键过滤掉，减少表的连接操作。</p>
</blockquote>
<ol start="8">
<li>过多的where条件</li>
</ol>
<blockquote>
<p>有时候超级多的where条件来限制查询，这样子是非常低效的，主要原因是这个and条件在hive生成执行计划时，产生了一个嵌套层次很多的算子。<br>解决方案： </p>
</blockquote>
<pre><code>1. 把筛选条件对应的值写入一张小表，再一次join到主表。 
2. 利用udf处理。</code></pre><h3 id="业务层调优"><a href="#业务层调优" class="headerlink" title="业务层调优"></a>业务层调优</h3><p><strong>一、 使用Hive ETL预处理数据</strong></p>
<p><strong>方案适用场景</strong>：导致数据倾斜的是Hive表。如果该Hive表中的数据本身很不均匀(比如某个key对应了100万数据，其他key才对应了10条数据)，而且业务场景需要频繁使用Spark对Hive表执行某个分析操作，那么比较适合使用这种技术方案。 </p>
<p><strong>方案实现思路</strong>：此时可以评估一下，是否可以通过Hive来进行数据预处理（即通过Hive ETL预先对数据按照key进行聚合，或者是预先和其他表进行join），然后在Spark作业中针对的数据源就不是原来的Hive表了，而是预处理后的Hive表。此时由于数据已经预先进行过聚合或join操作了，那么在Spark作业中也就不需要使用原先的shuffle类算子执行这类操作了。</p>
<p><strong>方案实现原理</strong>：这种方案从根源上解决了数据倾斜，因为彻底避免了在Spark中执行shuffle类算子，那么肯定就不会有数据倾斜的问题了。但是这里也要提醒一下，这种方式属于治标不治本。因为毕竟数据本身就存在分布不均匀的问题，所以Hive ETL中进行group by或者join等shuffle操作时，还是会出现数据倾斜，导致Hive ETL的速度很慢。我们只是把数据倾斜的发生提 前到了Hive ETL中，避免Spark程序发生数据倾斜而已。</p>
<p><strong>方案优点</strong>：实现起来简单便捷，效果还非常好，完全规避掉了数据倾斜，Spark作业的性能会大 幅度提升。</p>
<p><strong>方案缺点</strong>：治标不治本，Hive ETL中还是会发生数据倾斜。</p>
<p><strong>方案实践经验</strong>：在一些Java系统与Spark结合使用的项目中，会出现Java代码频繁调用Spark作业的场景，而且对Spark作业的执行性能要求很高，就比较适合使用这种方案。将数据倾斜提前到 上游的Hive ETL，每天仅执行一次，只有那一次是比较慢的，而之后每次Java调用Spark作业时，执行速度都会很快，能够提供更好的用户体验。</p>
<p><strong>项目实践经验</strong>：在自主研发的报表下载引擎使用了这种方案，该系统主要是允许用户通过Java Web系统提交数据统计任务，后端通过Python提交Spark作业进行数据分析统计。 要求Spark作业速度必须要快，尽量在5分钟以内，否则速度太慢，用户体验会很差。所以我们将有些Spark作业的shuffle操作提前到了Hive ETL中，从而让Spark直接使用预处理的Hive中间表，尽可能地减少Spark的shuffle操作，大幅度提升了性能，将部分作业的性能提升了n倍以上。</p>
<p><strong>二、 过滤少数导致倾斜的key和无效的key</strong></p>
<p><strong>方案适用场景</strong>：如果发现导致倾斜的key就少数几个，而且对计算本身的影响并不大的话，那么很适合使用这种方案。比如99%的key就对应10条数据，但是只有一个key对应了100万数据，从而导致了数据倾斜。</p>
<p><strong>方案实现思路</strong>：如果判断出导致shuffle产生的key对作业的执行和计算结果不是特别重要的话，那么干脆就直接过滤掉那少数几个key。比如，在Spark SQL中可以使用where子句过滤掉这些key或者在Spark Core中对RDD执行filter算子过滤掉这些key。如果需要每次作业执行时，动态判定哪些key的数据量最多然后再进行过滤，那么可以使用sample算子对RDD进行采样，然后计算出每个key的数量，取数据量最多的key过滤掉即可。</p>
<p><strong>方案实现原理</strong>:将导致数据倾斜的key给过滤掉之后，这些key就不会参与计算了，自然不可能产生数据倾斜。</p>
<p><strong>方案优点</strong>：实现简单，而且效果也很好，可以完全规避掉数据倾斜。 </p>
<p><strong>方案缺点</strong>：适用场景不多，大多数情况下，导致倾斜的key还是很多的，并不是只有少数几个。</p>
<p><strong>方案实践经验</strong>：在项目中我们也采用过这种方案解决数据倾斜。有一次发现某一天Spark作业在运行的时候突然OOM了，追查之后发现，是Hive表中的某一个key在那天数据异常，导致数据量暴增。因此就采取每次执行前先进行采样，计算出样本中数据量最大的几个key之后，直接在程序中将那些key给过滤掉</p>
<p><strong>三、 提高shuffle操作的并行度</strong></p>
<p><strong>方案适用场景</strong>：如果我们必须要对数据倾斜迎难而上，那么建议优先使用这种方案，因为这是处 理数据倾斜最简单的一种方案。</p>
<p><strong>方案实现思路</strong>：在对RDD执行shuffle算子时，给shuffle算子传入一个参数，比如 reduceByKey(1000)，该参数就设置了这个shuffle算子执行时shuffle read task的数量。对于 Spark SQL中的shuffle类语句，比如group by、join等，需要设置一个参数，即 <code>spark.sql.shuffle.partitions</code>，该参数代表了shuffle read task的并行度，该值默认是200，对于很多场景来说都有点过小。</p>
<p><strong>方案实现原理</strong>：增加shuffle read task的数量，可以让原本分配给一个task的多个key分配给多个task，从而让每个task处理比原来更少的数据。举例来说，如果原本有5个key，每个key对应10条数据，这5个key都是分配给一个task的，那么这个task就要处理50条数据。而增加了shuffle read task以后，每个task就分配到一个key，即每个task就处理10条数据，那么自然每个task的执行时间都会变短了。</p>
<p><strong>方案优点</strong>：实现起来比较简单，可以有效缓解和减轻数据倾斜的影响。 </p>
<p><strong>方案缺点</strong>：只是缓解了数据倾斜而已，没有彻底根除问题，根据实践经验来看，其效果有限。</p>
<p><strong>方案实践经验</strong>：该方案通常无法彻底解决数据倾斜，因为如果出现一些极端情况，比如某个key对应的数据量有100万，那么无论你的task数量增加到多少，这个对应着100万数据的key肯定还是会分配到一个task中去处理，因此注定还是会发生数据倾斜的。所以这种方案只能说是在发现数据倾斜时尝试去用最简单的方法缓解数据倾斜而已，或者是和其他方案结合起来使用。</p>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211126233118.png" alt="join"></p>
<p><strong>四、 两阶段聚合（局部聚合+全局聚合）</strong></p>
<p><strong>方案适用场景</strong>：对RDD执行reduceByKey等聚合类shuffle算子或者在Spark SQL中使用group by语句进行分组聚合时，比较适用这种方案。</p>
<p><strong>方案实现思路</strong>：这个方案的核心实现思路就是进行两阶段聚合。第一次是局部聚合，先给每个key都打上一个随机数，比如10以内的随机数，此时原先一样的key就变成不一样的了，比如 (hello, 1) (hello, 1) (hello, 1) (hello, 1)，就会变成(1_hello, 1) (1_hello, 1) (2_hello, 1) (2_hello, 1)。接着对打上随机数后的数据，执行reduceByKey等聚合操作，进行局部聚合，那么 局部聚合结果，就会变成了(1_hello, 2) (2_hello, 2)。然后将各个key的前缀给去掉，就会变成 (hello,2)(hello,2)，再次进行全局聚合操作，就可以得到最终结果了，比如(hello, 4)。</p>
<p><strong>方案实现原理</strong>：将原本相同的key通过附加随机前缀的方式，变成多个不同的key，就可以让原本 被一个task处理的数据分散到多个task上去做局部聚合，进而解决单个task处理数据量过多的问 题。接着去除掉随机前缀，再次进行全局聚合，就可以得到最终的结果。具体原理见下图。</p>
<p><strong>方案优点</strong>：对于聚合类的shuffle操作导致的数据倾斜，效果是非常不错的。通常都可以解决掉数 据倾斜，或者至少是大幅度缓解数据倾斜，将Spark作业的性能提升数倍以上。</p>
<p><strong>方案缺点</strong>：仅仅适用于聚合类的shuffle操作，适用范围相对较窄。如果是join类的shuffle操作，还得用其他的解决方案。</p>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211126233023.png" alt="4"></p>
<p><strong>五、 将reduce join转为map join</strong></p>
<p><strong>方案适用场景</strong>：在对RDD使用join类操作，或者是在Spark SQL中使用join语句时，而且join操作 中的一个RDD或表的数据量比较小（比如几百M或者一两G），比较适用此方案。</p>
<p><strong>方案实现思路</strong>：不使用join算子进行连接操作，而使用Broadcast变量与map类算子实现join操作，进而完全规避掉shuffle类的操作，彻底避免数据倾斜的发生和出现。将较小RDD中的数据直 接通过collect算子拉取到Driver端的内存中来，然后对其创建一个Broadcast变量；接着对另外一个RDD执行map类算子，在算子函数内，从Broadcast变量中获取较小RDD的全量数据，与当 前RDD的每一条数据按照连接key进行比对，如果连接key相同的话，那么就将两个RDD的数据 用你需要的方式连接起来。</p>
<p><strong>方案实现原理</strong>：普通的join是会走shuffle过程的，而一旦shuffle，就相当于会将相同key的数据 拉取到一个shuffle read task中再进行join，此时就是reduce join。但是如果一个RDD是比较小 的，则可以采用广播小RDD全量数据+map算子来实现与join同样的效果，也就是map join，此时就不会发生shuffle操作，也就不会发生数据倾斜。具体原理如下图。</p>
<p><strong>方案优点</strong>：对join操作导致的数据倾斜，效果非常好，因为根本就不会发生shuffle，也就根本不 会发生数据倾斜。</p>
<p><strong>方案缺点</strong>：适用场景较少，因为这个方案只适用于一个大表和一个小表的情况。毕竟我们需要将小表进行广播，此时会比较消耗内存资源，driver和每个Executor内存中都会驻留一份小RDD的 全量数据。如果我们广播出去的RDD数据比较大，比如10G以上，那么就可能发生内存溢出了。 因此并不适合两个都是大表的情况。</p>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211126233053.png" alt="5"></p>
<p><strong>六、 采样倾斜key并分拆join操作</strong></p>
<p><strong>方案适用场景</strong>：两个RDD/Hive表进行join的时候，如果数据量都比较大，无法采用“解决方案 五”，那么此时可以看一下两个RDD/Hive表中的key分布情况。如果出现数据倾斜，是因为其中 某一个RDD/Hive表中的少数几个key的数据量过大，而另一个RDD/Hive表中的所有key都分布 比较均匀，那么采用这个解决方案是比较合适的。</p>
<p><strong>方案实现思路</strong>： </p>
<ol>
<li>对包含少数几个数据量过大的key的那个RDD，通过sample算子采样出一份样本来，然后统计一下每个key 的数量，计算出来数据量最大的是哪几个key。</li>
<li>然后将这几个key对应的数据从原来的RDD中拆分出来，形成一个单独的RDD，并给每个key都打上n以内的 随机数作为前缀，而不会导致倾斜的大部分key形成另外一个RDD。</li>
<li>接着将需要join的另一个RDD，也过滤出来那几个倾斜key对应的数据并形成一个单独的RDD，将每条数据 膨胀成n条数据，这n条数据都按顺序附加一个0~n的前缀，不会导致倾斜的大部分key也形成另外一个RDD。</li>
<li>再将附加了随机前缀的独立RDD与另一个膨胀n倍的独立RDD进行join，此时就可以将原先相同的key打散 成n份，分散到多个task中去进行join了。</li>
<li>而另外两个普通的RDD就照常join即可。</li>
<li>最后将两次join的结果使用union算子合并起来即可，就是最终的join结果。</li>
</ol>
<p>eg:</p>
<blockquote>
<p>num表是一张一列30行的表，对应1-30的正整数。这样做可以把users表膨胀成N份，然后根据 log表的id和login_time分配到不同的reduce里，保证数据均匀。</p>
</blockquote>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> log <span class="token number">a</span> 
<span class="token keyword">left</span> <span class="token keyword">join</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> uid<span class="token punctuation">,</span> number <span class="token keyword">from</span> users <span class="token number">d</span> 
    <span class="token keyword">join</span> num <span class="token number">e</span>
<span class="token punctuation">)</span> <span class="token number">b</span> 
<span class="token keyword">on</span> <span class="token number">a</span><span class="token punctuation">.</span>uid <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>uid 
<span class="token operator">and</span> mod<span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>login_time<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>number</code></pre>
<p><strong>方案实现原理</strong>：对于join导致的数据倾斜，如果只是某几个key导致了倾斜，可以将少数几个key分拆成独立RDD，并附加随机前缀打散成n份去进行join，此时这几个key对应的数据就不会集中 在少数几个task上，而是分散到多个task进行join了。具体原理见下图。</p>
<p><strong>方案优点</strong>：对于join导致的数据倾斜，如果只是某几个key导致了倾斜，采用该方式可以用最有效的方式打散key进行join。而且只需要针对少数倾斜key对应的数据进行扩容n倍，不需要对全量数据进行扩容。避免了占用过多内存。</p>
<p><strong>方案缺点</strong>：如果导致倾斜的key特别多的话，比如成千上万个key都导致数据倾斜，那么这种方式也不适合。</p>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211126233035.png" alt="6"></p>
<p><strong>七、 使用随机前缀和扩容RDD进行join</strong></p>
<p><strong>方案适用场景</strong>：如果在进行join操作时，RDD中有大量的key导致数据倾斜，那么进行分拆key也 没什么意义，此时就只能使用最后一种方案来解决问题了。</p>
<p><strong>方案实现思路</strong>：</p>
<ol>
<li>该方案的实现思路基本和“解决方案六”类似，首先查看RDD/Hive表中的数据分布情况，找到那个造成数 据倾斜的RDD/Hive表，比如有多个key都对应了超过1万条数据。</li>
<li>然后将该RDD的每条数据都打上一个n以内的随机前缀。</li>
<li>同时对另外一个正常的RDD进行扩容，将每条数据都扩容成n条数据，扩容出来的每条数据都依次打上一个 0~n的前缀。</li>
<li>最后将两个处理后的RDD进行join即可。</li>
</ol>
<p><strong>方案实现原理</strong>：将原先一样的key通过附加随机前缀变成不一样的key，然后就可以将这些处理后的“不同key”分散到多个task中去处理，而不是让一个task处理大量的相同key。该方案与方案六的不同之处在于，上一种方案是尽量只对少数倾斜key对应的数据进行特殊处理，由于处理过程需要扩容RDD，因此上一种方案扩容RDD后对内存的占用并不大；而这一种方案是 针对有大量倾斜key的情况，没法将部分key拆分出来进行单独处理，因此只能对整个RDD进行数据扩容，对内存资源要求很高。</p>
<p><strong>方案优点</strong>：对join类型的数据倾斜基本都可以处理，而且效果也相对比较显著，性能提升效果非常不错。</p>
<p><strong>方案缺点</strong>：该方案更多的是缓解数据倾斜，而不是彻底避免数据倾斜。而且需要对整个RDD进行扩容，对内存资源要求很高。</p>
<p><strong>方案实践经验</strong>：曾经开发一个数据需求的时候，发现一个join导致了数据倾斜。优化之前，作业的执行时间大约是60分钟左右；使用该方案优化之后，执行时间缩短到10分钟左右，性能提升了6倍。</p>
<p><strong>八、 多种方案组合使用</strong></p>
<p>在实践中发现，很多情况下，如果只是处理较为简单的数据倾斜场景，那么使用上述方案中的某一种基本就可以解决。但是如果要处理一个较为复杂的数据倾斜场景，那么可能需要将多种方案 组合起来使用。</p>
<p>比如说，针对出现了多个数据倾斜环节的Spark作业：</p>
<ul>
<li>可以先运用解决方案一和二，预处理一部分数据，并过滤一部分数据来缓解；</li>
<li>其次可以对某些shuffle操作提升并行度，优化其性能；</li>
<li>最后还可以针对不同的聚合或join操作，选择一种方案来优化其性能。</li>
</ul>
<p>说到底还是需要对这些方案的思路和原理都透彻理解之后，在实践中根据各种不同的情况，灵活运用多种方案，来解决自己的数据倾斜问题。</p>
<h1 id="数据仓库篇"><a href="#数据仓库篇" class="headerlink" title="数据仓库篇"></a>数据仓库篇</h1><h2 id="0-前言"><a href="#0-前言" class="headerlink" title="0.前言"></a>0.前言</h2><p>大数据有很重要的一部分都在数据仓库上，数仓开发工程师是对数据最了解的人，也是对业务最应该有全局观的人。</p>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20220307062733.png" alt=""></p>
<p>数仓工作涉及的代码很大一部分都是SQL（Hive SQL、Spark SQL、Flink SQL），所以又戏称是SQL boy/girl、表哥 茶树姑…但工作室最重要的是支撑业务的发展，如果只写SQL就能够支撑业务，何必花大量时间精力写Java呢？（这里不代表不需要掌握Java，只是说对写SQL没必要以抗拒的心态，数仓工程师是业务导向的岗位，技术是达到目的的手段而不是目的）</p>
<h2 id="1-数据仓库的定义"><a href="#1-数据仓库的定义" class="headerlink" title="1. 数据仓库的定义"></a>1. 数据仓库的定义</h2><p><strong>问：什么是数据仓库?</strong></p>
<p>数据仓库面向主题（整个处理流程）、具有集成（数据整合）、随时间相对稳定、反映历史变化。</p>
<h2 id="2-数仓常见概念"><a href="#2-数仓常见概念" class="headerlink" title="2. 数仓常见概念"></a>2. 数仓常见概念</h2><h3 id="2-1-事实表"><a href="#2-1-事实表" class="headerlink" title="2.1 事实表"></a>2.1 事实表</h3><p>事实表产生于业务过程，存储了业务活动或事件提炼出来的性能度量。从最低的粒度级别来看，事实表行对应一个度量事件。</p>
<p>事实表根据粒度的角色划分不同，可分为事务事实表、周期快照事实表、累积快照事实表。</p>
<p>（1）<strong>事务事实表</strong>，用于承载事务数据，通常粒度比较低，它是面向事务的，其粒度是每一行对应一个事务，它是最细粒度的事实表，例如产品交易事务事实、ATM交易事务事实。</p>
<p>（2）<strong>周期快照事实表</strong>，按照一定的时间周期间隔(每天，每月)来捕捉业务活动的执行情况，一旦装入事实表就不会再去更新，它是事务事实表的补充。用来记录有规律的、固定时间间隔的业务累计数据，通常粒度比较高，例如账户月平均余额事实表。</p>
<p>（3）<strong>累积快照事实表</strong>，用来记录具有时间跨度的业务处理过程的整个过程的信息，每个生命周期一行，通常这类事实表比较少见。</p>
<p>注意：这里需要值得注意的是，在事实表的设计时，一定要注意一个事实表只能有一个粒度，不能将不同粒度的事实建立在同一张事实表中。</p>
<h3 id="2-2-维度表"><a href="#2-2-维度表" class="headerlink" title="2.2 维度表"></a>2.2 维度表</h3><p>维度表，一致性维度，业务过程的发生或分析角度，我们主要关注下退化维度和缓慢变化维。</p>
<p>（1）<strong>退化维度</strong>（DegenerateDimension）</p>
<p>在维度类型中，有一种重要的维度称作为退化维度，亦维度退化一说。这种维度指的是<strong>直接把一些简单的维度放在事实表中</strong>。退化维度是维度建模领域中的一个非常重要的概念，它对理解维度建模有着非常重要的作用，退化维度一般在分析中可以用来做分组使用。</p>
<p>（2）<strong>缓慢变化维</strong>（Slowly Changing Dimensions）</p>
<p>维度的属性并不是始终不变的，它会随着时间的流逝发生缓慢的变化，这种随时间发生变化的维度我们一般称之为缓慢变化维（SCD）。</p>
<p>SCD常用的三种处理方式：</p>
<p>① <strong>TYPE1</strong> 直接覆盖原值</p>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210912040809.png" alt=""></p>
<p>② <strong>TYPE2</strong> 增加维度行</p>
<p>   <em>在为维度成员增加新行时，需为其分配新的主代理键。<strong>并且，至少需要在维度行再增加三列：</strong>有效日期、截止日期、行标识。**这个地方可联想拉链表设计。</em></p>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210912040838.png" alt="image-20210912040838080"></p>
<p>③ <strong>TYPE3</strong> 增加属性列 </p>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210912040855.png" alt=""></p>
<p>④ 混合方式</p>
<p>可根据实际业务场景，混合或选择使用以上三种方式，以快速方便而又准确的分析历史变化情况。</p>
<h3 id="2-3-粒度"><a href="#2-3-粒度" class="headerlink" title="2.3 粒度"></a>2.3 粒度</h3><p>用于确定某一事实表中的行表示什么，是业务最小活动单元或不同维度组合，即业务细节程度。</p>
<h3 id="2-4-数仓其他专业术语"><a href="#2-4-数仓其他专业术语" class="headerlink" title="2.4 数仓其他专业术语"></a>2.4 数仓其他专业术语</h3><ul>
<li><p>ETL</p>
<p>ETL（Extract-Transform-Load）是指将业务系统中的数据进行<strong>抽取、转换、加载</strong>到数据仓库的过程，目的是将企业中分散、零乱、标准不统一的数据整合到一起，为企业的决策提供分析的依据。</p>
</li>
</ul>
<ul>
<li><p>OLAP</p>
<p>联机分析处理（Online analytical processing，OLAP），从数据仓库中抽取详细数据的一个子集并经过必要的聚集，存储到OLAP存储器中供前端分析工具读取。</p>
</li>
</ul>
<ul>
<li><p>OLTP</p>
<p>联机(在线)事务处理(On-Line Transaction Processing，OLTP)，主要是执行日常的事务处理，比如数据库记录的增删改查。OLTP的特点一般有：实时性要求高，数据量不大，高并发，并且要求满足ACID原则。</p>
</li>
</ul>
<h3 id="2-4-数据库？数据仓库？数据湖？"><a href="#2-4-数据库？数据仓库？数据湖？" class="headerlink" title="2.4 数据库？数据仓库？数据湖？"></a>2.4 数据库？数据仓库？数据湖？</h3><h4 id="2-4-1-数据仓库和数据库的区别？"><a href="#2-4-1-数据仓库和数据库的区别？" class="headerlink" title="2.4.1 数据仓库和数据库的区别？"></a>2.4.1 数据仓库和数据库的区别？</h4><table>
<thead>
<tr>
<th>数据库</th>
<th>数据仓库</th>
</tr>
</thead>
<tbody><tr>
<td>数据库是面向<strong>事务</strong>的，数据由日常业务产生，常更新</td>
<td>数据仓库是面向<strong>主题</strong>的，数据来源于数据库或文件，经过一定的规则转换得到，用于分析决策</td>
</tr>
<tr>
<td>数据库一般是存储<strong>当前</strong>数据的</td>
<td>数据仓库一般存储的是<strong>历史</strong>数据</td>
</tr>
<tr>
<td>数据库的设计一般要符合<strong>三范式（3NF）</strong>，有最大精确度和最小冗余度，有利于数据的插入</td>
<td>数据仓库的设计一般是按照<strong>数仓建模</strong>规范，有一定的冗余，有利于查询</td>
</tr>
</tbody></table>
<h4 id="2-4-2-数据仓库与数据湖的区别？"><a href="#2-4-2-数据仓库与数据湖的区别？" class="headerlink" title="2.4.2 数据仓库与数据湖的区别？"></a>2.4.2 数据仓库与数据湖的区别？</h4><table>
<thead>
<tr>
<th>数据仓库</th>
<th>数据湖</th>
</tr>
</thead>
<tbody><tr>
<td>不开放HDFS</td>
<td>开放HDFS</td>
</tr>
<tr>
<td>存储结构化、半结构化数据</td>
<td>存储结构化、半结构化、非结构化数据</td>
</tr>
<tr>
<td>依托大数据技术</td>
<td>依托大数据技术与人工智能</td>
</tr>
</tbody></table>
<h2 id="3-维度建模"><a href="#3-维度建模" class="headerlink" title="3. 维度建模"></a>3. 维度建模</h2><h3 id="3-1-三种模型"><a href="#3-1-三种模型" class="headerlink" title="3.1 三种模型"></a>3.1 三种模型</h3><p>数据仓库建模方法论可分为：<strong>维度建模</strong>、范式建模、Data Vault模型、Anchor模型</p>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210801225303.png" width="50%"></p>
<p>其中数仓最为常用的是<strong>维度建模</strong>，而维度建模建立的模型主要有三种：（1）<strong>星型模型</strong>、（2）<strong>雪花模型</strong>、（3）<strong>星座模型</strong></p>
<h4 id="3-1-1-星型模型"><a href="#3-1-1-星型模型" class="headerlink" title="3.1.1 星型模型"></a>3.1.1 星型模型</h4><p>星型模型主要由维表和事实表构成，<strong>以事实表为中心</strong>，所有维度直接关联在事实表上，呈星型分布。</p>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210912040748.png" alt=""></p>
<p>图来源于Kimball《The Data Warehouse Toolkits -3rd Edition》</p>
<h4 id="3-2-雪花模型"><a href="#3-2-雪花模型" class="headerlink" title="3.2 雪花模型"></a>3.2 雪花模型</h4><p>雪花模型，在星型模型的基础上，维度表上又关联了其他维度表。</p>
<p>雪花模型的维护成本较高，性能方面也较差，尤其是基于hadoop体系构建数仓，减少join就是减少shuffle，性能差距会很大。</p>
<ul>
<li><p><strong>区分星型模型与雪花模型</strong></p>
<p>与星型模型的区别：主要在维度，标准的星型模型维度只有一层，而雪花模型的维度会涉及多级，如图：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210801230325.png" alt="星型模型与雪花模型"></p>
<ul>
<li><strong>星型模型和雪花模型的优劣对比</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="left">属性</th>
<th align="left">星型模型</th>
<th align="left">雪花模型</th>
</tr>
</thead>
<tbody><tr>
<td align="left">数据总量</td>
<td align="left">多</td>
<td align="left">少</td>
</tr>
<tr>
<td align="left">可读性</td>
<td align="left">容易</td>
<td align="left">差</td>
</tr>
<tr>
<td align="left">表个数</td>
<td align="left">少</td>
<td align="left">多</td>
</tr>
<tr>
<td align="left">查询速度</td>
<td align="left">快</td>
<td align="left">慢</td>
</tr>
<tr>
<td align="left">冗余度</td>
<td align="left">高</td>
<td align="left">低</td>
</tr>
<tr>
<td align="left">对实时表的情况</td>
<td align="left">增加宽度</td>
<td align="left">字段比较少，冗余底</td>
</tr>
<tr>
<td align="left">扩展性</td>
<td align="left">差</td>
<td align="left">好</td>
</tr>
</tbody></table>
<ul>
<li><p>应用场景</p>
<p><strong>星型模型</strong>的设计方式主要带来的好处是能够提升查询效率，因为生成的事实表已经经过预处理，主要的数据都在事实表里面，所以只要扫描实时表就能够进行大量的查询，而不必进行大量的join，其次维表数据一般比较少，在join可直接放入内存进行join以提升效率，除此之外，星型模型的事实表可读性比较好，不用关联多个表就能获取大部分核心信息，设计维护相对比较简答。</p>
<p><strong>雪花模型</strong>的设计方式是比较符合数据库范式（比较靠近3NF，但无法完全遵守，因为完全遵循3NF的性能成本太高）的理念，设计方式比较正规，数据冗余少，但在查询的时候可能需要join多张表从而导致查询效率下降，此外规范化操作在后期维护比较复杂。</p>
</li>
</ul>
<h4 id="3-3-星座模型"><a href="#3-3-星座模型" class="headerlink" title="3.3 星座模型"></a>3.3 星座模型</h4><p>星座模型，是对星型模型的扩展延伸，多张事实表共享维度表。数仓模型建设后期，大部分维度建模都是星座模型。</p>
<p>星座模型与前两种的区别是<strong>事实表的数量</strong>，星座模型有多个事实表。</p>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210801234858.png" alt=""></p>
<h3 id="3-2-模型选择"><a href="#3-2-模型选择" class="headerlink" title="3.2 模型选择"></a>3.2 模型选择</h3><ul>
<li><p>星座不星座？</p>
<p>这个只跟数据和需求有关系，跟设计没关系，不用选择。</p>
<p>（需要星座模型的时候就得是星座模型，不需要的时候就不会是星座模型，所以不用选）</p>
</li>
<li><p>星型还是雪花？</p>
<p>取决于<strong>性能优先</strong>还是<strong>灵活优先</strong></p>
<p>如果性能优先，则选择星型模型；如果灵活优先则选择雪花模型。</p>
<p>在实际开发中，不会只选择一种，会根据情况组合甚至并存（一层维度和多层维度都保留）。但整体来看会更倾向于<strong>星型模型</strong>，尤其是Hadoop体系中，减少Join操作可减少Shuffle，性能差距很大（关系型库数据可以依靠强大的主键索引）。</p>
</li>
</ul>
<p>总结：</p>
<p>数据仓库大多数时候是比较适合使用<strong>星型模型构建底层数据Hive表</strong>，通过大量的冗余来提升查询效率，星型模型对OLAP的分析引擎支持比较友好，这一点在Kylin中比较能体现。而雪花模型在关系型数据库中如MySQL，Oracle中非常常见，尤其像电商的数据库表。在数据仓库中雪花模型的应用场景比较少，但也不是没有，所以在具体设计的时候，可以考虑是不是能结合两者的优点参与设计，以此达到设计的最优化目的。</p>
<h3 id="3-3-注意点"><a href="#3-3-注意点" class="headerlink" title="3.3 注意点"></a>3.3 注意点</h3><h3 id="3-3-1-维度建模常见错误"><a href="#3-3-1-维度建模常见错误" class="headerlink" title="3.3.1 维度建模常见错误"></a>3.3.1 维度建模常见错误</h3><ul>
<li>舍弃一致性维度和一致性事实表</li>
<li>事实表的粒度不采用原子型</li>
<li>基于报表来设计维度表</li>
<li>不使用代理关键字</li>
<li>忽视维度的变化的需求</li>
<li>将体系与体系层次分解成多个维度</li>
<li>在维度表中为节省空间而限制使用详细的描述属性</li>
<li>在事实表中放置用于约束与分组操作的文本属性</li>
</ul>
<h3 id="3-3-2-维度建模技巧"><a href="#3-3-2-维度建模技巧" class="headerlink" title="3.3.2 维度建模技巧"></a>3.3.2 维度建模技巧</h3><p>关键点：退化维度、代理关键字、一致性维度、渐变维度、角色模仿、杂项维度、微型维度、深度可变的层次建模方法、审计维度、多值维度解决办法、异构产品解决办法。</p>
<p>1、维度表倾向于将行数做得相当少，而将列数做的特别大。数据仓库的能力直接与维度表的属性的质量和深度成正比。</p>
<p>2、维度的属性采用文字而不是编码。</p>
<p>3、维度表通常是不规范的，几乎总是用空间换取简明性和可访问性。（第一章）</p>
<p>4、日期维度，应包含星期、周末指示符、月末指示符、节假日指示符、重大事件、财政时间等。</p>
<p>5、如果需要处理一天中不同时间，则增加一个时间维度。</p>
<p>6、一个维度包含多个体系（层次），每个层次包含若干级别。</p>
<p>7、退化维度。一方面可以通过退化维度对数据进行分组，另一方面可以使用退化维度关联到源数据上，有利于ETL更新及排错。</p>
<p>8、一般情况维度个数应该控制在15个以内，唯独过多影响查询性能和磁盘空间。一些小维度可以进行组合，这取决于具体的业务。</p>
<p>9、代理关键字。使用代理关键字的优点：能实现渐变维度；获得性能上的优势，节省事实表空间；可以记录没有操作源码的数据（ETL过程生成）；处理关键字段的修改、删除等。（第二章）</p>
<p>10、一致性维度。具有一致性的维度关键字，一致的属性名称，一致的属性定义，一致的属性值。一致性维度对于设计可以进行集成的数据中心来说，具有绝对的决定性作用。（第三章）</p>
<p>11、渐变维度。渐变维度的处理办法。</p>
<ul>
<li>类型1：改写属性值；</li>
<li>类型2：添加维度行（常用，例如拉链表）；</li>
<li>类型3：添加维度列。</li>
</ul>
<p>12、快变维度的处理办法：将这些迅速变化的属性分裂成一个或者多个单独的维度。</p>
<p>13、维度的角色模仿。在同一个维度表上通过视图的形式建立多个维度。在实际运用中，很多OLAP工具都支持在同一个维度表上建多个维度，而并不需要建立视图。</p>
<p>14、实体之间存在固定的，不随时间变化的，强烈相关的关系时，显然应该将它们当作单一维度进行建模。</p>
<p>15、杂项维度。将标志与指标符从设计中剥离出来，将其封装成一个或者多个杂项维度。</p>
<p>16、将聚集事实放入维度表的优缺点。优点：查询时可以对聚集属性进行约束。缺点：ETL过程变麻烦了。</p>
<p>17、雪花模型的使用场合：粒度悬殊，节省空间（属性众多）。</p>
<p>18、宽度变化的属性集的处理办法：拆分成两个维度。Oracle数据库不存在这个问题。</p>
<p>19、采用类型2的方式处理维度慢性变化时，应该注意避免计数过度。</p>
<p>20、深化不变的体系结构（层次、级别）。一个层次建立单独的字段。如果某一个级别没有值，就应该用较低级别的属性覆盖该值。</p>
<p>21、深度可变的体系结构。使用桥接标来解决。父到子的每一条路径都包含一行记录，到其自身长度为0的路径包含一行。实际上是把循环递归的过程通过表数据的形式实现。大量olap工具以提供了对小于64000个成员的中小尺寸维度中这些体系进行导航操作得更加强劲的内置功能支持。</p>
<p>22、依照十五描述内容在每行加入生效和截止日期标记，可以将类型2渐变维度设计方案修改为允许自然的对维度在时间上进行非常精细的切割。</p>
<p>23、审计维度。源系统的情况；抽取软件的版本；抽取记录数；开始时间；完成时间等。</p>
<p>24、维度的属性数量不确定时，使用关键词支架维度。相当于将横表设计成纵表。使用union和intersect命令解决SQL跨行约束问题。</p>
<p>25、维度类型：因果维度、多日期或时间标记维度、退化维度、角色模仿维度、状态维度、审计维度、杂项维度。</p>
<p>26、多值维度。概念：一个账户拥有多个客户，一个客户也可能拥有多个账户。解决办法：桥接表。</p>
<p>27、异构产品方案。概念：每种产品类型都有大量的专用属性与度量事实不能为其他产品所用。解决方案：核心维度，定制维度，使用相同的代理关键字。采用支架结构。</p>
<p>28、日期维度。国别历法的处理办法，做成日期维度的支架。</p>
<p>29、多个时区日期的处理办法，增加维度。</p>
<p>30、多值维度解决方案。所谓多值维度是指一个事实表对应多个值的维度，比如，住院结算事实表拥有多个疾病。通过组桥表来实现。组桥表可以增加起止时间来满足住院渐变维度。可以增加加权因子来实现财务报表关于疾病的分类统计。</p>
<p>31、稀疏事实表的解决方案。事实维度表。实际上是纵表和横表的设计思想。优点：灵活、结构简单、节省空间。缺点：生成查询、报表复杂、行间计算困难。</p>
<p>32、迟到维度行的处理办法。所谓迟到维度是指某项属性到当前时间才知道其以前的值。通过渐变维度（类型2）的方法处理，在维度表中增加记录并修改其他型的起止时间，在事实表中修改该维度的代理关键字。</p>
<h2 id="4-维度建模流程"><a href="#4-维度建模流程" class="headerlink" title="4. 维度建模流程"></a>4. 维度建模流程</h2><h3 id="4-1-维度建模四步法"><a href="#4-1-维度建模四步法" class="headerlink" title="4.1 维度建模四步法"></a>4.1 维度建模四步法</h3><p>维度建模步骤：选择业务过程-&gt;声明粒度-&gt;确定维度-&gt;确定事实。旨在重点解决数据粒度、维度设计和事实表设计问题。</p>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210912040728.png" alt=""></p>
<p>声明粒度，为业务最小活动单元或不同维度组合。以共同粒度从多个组织业务过程合并度量的事实表称为合并事实表，需要注意的是，来自多个业务过程的事实合并到合并事实表时，它们必须具有同样等级的粒度。</p>
<blockquote>
<p>举个例子：</p>
<ol>
<li><p>选择业务过程——确定主题和数据指标（目标是什么）</p>
<ul>
<li><p><strong>确定主题</strong></p>
<p>即确定数据分析或前端展示的主题（例如：某年某月某地区的啤酒销售情况）。</p>
<p>主要体现出某一方面的分析角度（维度）和统计数值型数据（指标）之间的关系。</p>
<p>确定主题时要综合考虑。</p>
</li>
<li><p>选择<strong>数据指标</strong>（即确定度量单位）</p>
<p>确定主题后，要考虑分析的数据指标（例如年销售额等）。数据指标是要统计的指标，必须事先选择恰当。（如果条件允许，则依托一套元数据管理会做得更好）</p>
</li>
</ul>
</li>
<li><p><strong>声明粒度</strong>——确定事实数据粒度（声明粒度，即确定最小研究单位）</p>
<p>确定数据指标之后，需要考虑该指标的汇总情况和不同维度下指标的聚合情况。例如在业务系统中数据最小记录到秒，而在数仓建设需求中，时间可能只需要精确到天就可以了。</p>
</li>
<li><p>确定<strong>维度</strong>（即分析的角度）</p>
<p>维度是分析的各个角度，例如：我们希望按照时间、地区、产品进行分析，那么这里的时间、地区、产品就是维度。基于不同的维度，可以看到各种数据指标的汇总情况，也可以基于所有维度进行交叉分析（这里的所有维度是指模型中列入的维度）。</p>
</li>
<li><p>创建<strong>事实表</strong>（结果表）</p>
<p>在确定好实时数据和维度后，将考虑加载事实表。业务系统中的一条条订单、交易数据就是将要简历的事实表的原始数据（原始表）。通常是将原始表与维度表进行关联，生成事实表。</p>
</li>
</ol>
</blockquote>
<p>以上四个步骤是维度建模的所有步骤，仅仅确定模型中的事实表和维度表。</p>
<p>而数据整个流向具体步骤如下：</p>
<ul>
<li>将详细的原子数据加载到维度结构中</li>
<li>围绕业务流程构建维度模型</li>
<li>确保每个事实表都有一个关联的日期维度表</li>
<li>确保单个事实表中的所有事实具有相同的粒度或详细程度</li>
<li>解析事实表中的多对多关系</li>
<li>解析维度表中的多对一关系</li>
<li>在维度表中存储报表标签和筛选值</li>
<li>确保维度表使用代理键</li>
<li>创建一致的维度以在整个企业中集成数据</li>
<li>提供DW/BI解决方案</li>
<li>支持业务用户的决策</li>
</ul>
<h3 id="4-2-三种事实表的维度建模"><a href="#4-2-三种事实表的维度建模" class="headerlink" title="4.2 三种事实表的维度建模"></a>4.2 三种事实表的维度建模</h3><p>维度建模的中心是事实表（星型模型、雪花模型、星座模型都是以<strong>事实表</strong>为中心）,因而事实表是维度建模的核心表和基本表。它存储了业务过程中的各种度量和事实，而这些度量和事实正是下游数据使用人员所要关心和分析的对象。</p>
<p>接下来将探讨以下三种事实表：</p>
<ul>
<li>事务事实表</li>
<li>快照事实表</li>
<li>累计快照事实表</li>
</ul>
<h4 id="4-2-1-事务事实表"><a href="#4-2-1-事务事实表" class="headerlink" title="4.2.1 事务事实表"></a>4.2.1 事务事实表</h4><p>事务事实表是维度建模事实表中最为常见、使用最为广泛的事实表。</p>
<p>事务事实表通常用于记录业务过程的事件，而且是原子粒度的事件。事务事实表中的数据在事务事件发生之后，数据的粒度通常是每个事务一条记录。一旦事务被提交，事实表数据被插入，数据就不再进行更改。</p>
<p>我们通过事务事实表存储单次业务事件 / 行为的细节，以及存储与事件相关的维度细节，用户即可以单独或者聚合分析业务事件和行为。</p>
<p>事务事实表的粒度确定是事务事实表设计过程中的关键步骤，一般都会包含可加的度量和事实。理解概念的最佳途径无疑是实际的例子，因此下面将结合超市零售业务以及维度建模的四个环节来说明事务事实表。</p>
<p><strong>（1）选择业务过程</strong></p>
<p>在超市的零售示例中，业务用户做的事情是更好的理解POS系统记录顾客购买的情况，那么很容易确定业务过程就是POS系统记录的顾客购买情况，即在什么时候、什么商品、哪个收银台、销售了哪些产品等。</p>
<p><strong>（2）定义粒度</strong></p>
<p>顾客单次购买行为的体现是一张购物小票，但是事务事实表应该选择最原子粒度的事件，所以小票的子项（在业务上的动作即为收银员每次扫描的商品条码）应该是超市零售事务事实表的粒度。</p>
<p><strong>（3）确定维度</strong></p>
<p>小票子项的粒度确定后，销售日期、销售商品、销售收银台、销售门店等维度很容易被确定了。另一个不太容易考虑到的是维度是促销行为，但是通过和业务人员交流或者查看报表表头等也能够发现此维度。</p>
<p><strong>（4）确定事实</strong></p>
<p>维度设计的最后一步，是确定哪些事实和度量应该在事实表中出现。对于本例，商品销售数量、销售价格和销售金额很容易确定下来。但是实际上，商品的成本价是确定的，因此可以很容易地确定商品的销售毛利：（商品实际销售价格－商品成本价） 销售数量，基于下游使用便利这一因素，也应该将此放人事务事实表中。</p>
<p>基于毛利润也可以计算出毛利率，那么毛利率这种比例应该放入事务事实表吗？在事实表的设计中，一个常见的原则是只存放比例的分子和分母，因此比例的计算是和业务强，业务逻辑可能非常的复杂，所以一般不加入事实表中。</p>
<p>至此，我们也完成了超市零售事务的事实表和维度表的设计，超市零售事务事实表以及相关的维度表如图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210912040711.png" alt=""></p>
<h4 id="4-2-2-快照事实表"><a href="#4-2-2-快照事实表" class="headerlink" title="4.2.2 快照事实表"></a>4.2.2 快照事实表</h4><p>在实际的业务活动中，除了关心单次的业务事件和行为外，很多时候还关心业务的状态（当前状态、历史状态）。以超市零售业务为例，管理人员和分析人员除了关心销售情况，还会关心商品的库存情况，例如哪些商品的库存情况，例如哪些商品库存告罄需要补货、哪些积压需要促销，而这正是 <strong>快照事实表（也叫周期快照事实表）</strong>所要解决发范畴。</p>
<p>所谓周期快照事实表，是指间隔一定的周期对业务的状态进行一次拍照并记录下来的事实表。最常见的例子是销售库存、银行账户余额等。</p>
<p>与事务事实表的稀疏性不同（这里的稀疏性是相对的），周期快照事实表通常被认为是稠密的。因此事务事实表只有事务发生才会记录，但是周期快照则必须捕获当前每个实体的状态。</p>
<p>比如，某个商品如果某天没有销售，那么这个商品不会存在于当天的事务事实表中的，但是为了记录其库存情况，即使没有销售行为，也必须再周期快照事实表中对其进行拍照。</p>
<p>周期快照事实表的周期通常需要和业务方共同确定，最常见的周期是天、周和月等。</p>
<p>周期快照事实表中的事实一般是半可加的，如某个商品的库存可以跨商品、仓库等相加，但是明显在时间上相加是没有意义的。</p>
<p>下面就以超市的库存业务为例来介绍周期快照事实表的设计过程。</p>
<p><strong>（1）选择业务过程</strong></p>
<p>本例是为了更好地理解超市的库存情况，因此业务过程就是商品的库存情况，即在什么时候、什么商品、哪个仓库的库存量如何。</p>
<p><strong>（2）定义粒度</strong></p>
<p>这里的粒度主要指库存的周期，商品的粒度很容易确定（注意这里是 SKU 级别）。选择库存的周期需要考虑到数据量膨胀情况。</p>
<p>考虑如下例子，某个超市有 万个商品（即SKU）， 其有 100 家连锁店，那么每天对其库存拍照将有 100<em>10000=100 万行记录，那么一年将有 365</em>1000000=3.65亿条记录。当然随着目前存储的日益廉价，这些都不是问题，但是设计人员需要考虑到这些因素。</p>
<p><strong>（3）确认维度</strong></p>
<p>对于超市零售库存，相应的维度为周期（天 周、月等） 商品、仓库（总仓、分仓或者门店等）。</p>
<p><strong>（4）确定事实</strong></p>
<p>这里的事实很容易确定，即库存量。但是仅仅记录现存库存是不够充分的，因为业务上通常会和其他事实协同来度量库存的变化趋势、快慢等，所以还可对周期快照事实表的事实进行增强 。</p>
<p>基于上述设计的周期快照事实表及相关维度如图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210912040651.png" alt=""></p>
<h4 id="4-2-3-累计快照事实表"><a href="#4-2-3-累计快照事实表" class="headerlink" title="4.2.3 累计快照事实表"></a>4.2.3 累计快照事实表</h4><p>事实表的第三种类型是累计快照事实表，相比前两者，累计快照事实表没那么常见，但是对于某些业务场景来说非常有价值。</p>
<p><strong>累计快照事实表非常适用于具有工作流或者流水线形式业务的分**</strong>析**，这些业务通常涉及多个时间节点或者有主要的里程碑事件，而累计快照事实表正是从全流程角度对其业务状态的拍照。</p>
<p>考虑车险理赔业务，一次车险的理赔通常包括客户报案、保险公司立案、客户提交理赔材料、理赔审批通过和付款等关键步骤，而累积快照事实表正是从全流程角度对每个车险理赔单的拍照，拍照内容即是其关键步骤的各个状态，便于业务人员一目了然地分析各个理赔单的状态、步骤间的耗时等。</p>
<p>下面以车险理赔业务为例来介绍累计周期快照事实表。</p>
<p><strong>（1）选择业务过程</strong></p>
<p>本例是为了更好地理解保险公司的车险理赔业务，因此业务过程就是车险理赔，即在什么时候、 哪个理赔申请所处的状态如何。</p>
<p><strong>（2）定义粒度</strong></p>
<p>累计周期快照事实表的粒度一般很容易确定，就是业务的某个实体，这里即为保险理赔申请。</p>
<p><strong>（3）确定维度</strong></p>
<p>对于累计周期快照事实表，相关的维度包含快照周期（天、周、月 和年等）、理赔申请人、受理 、审核人、网点 电话或者实体）等。</p>
<p><strong>（4）确定事实</strong></p>
<p>这里的事实包括索赔金额、审批金额、打款金额、处理时长等。</p>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210912040629.png" alt=""></p>
<h2 id="5-数仓分层设计-amp-命名规范"><a href="#5-数仓分层设计-amp-命名规范" class="headerlink" title="5. 数仓分层设计&amp;命名规范"></a>5. 数仓分层设计&amp;命名规范</h2><h3 id="5-1-数仓分层目的"><a href="#5-1-数仓分层目的" class="headerlink" title="5.1 数仓分层目的"></a>5.1 数仓分层目的</h3><ul>
<li><p><strong>清晰数据结构</strong></p>
<p>每一个数据分层都有它的作用域和职责，在使用表的时候能更方便地定位和理解</p>
</li>
<li><p><strong>减少重复开发</strong></p>
<p>规范数据分层，开发一些通用的中间层数据，能够减少极大的重复计算</p>
</li>
<li><p><strong>统一数据口径</strong></p>
<p>通过数据分层，提供统一的数据出口，统一对外输出的数据口径</p>
</li>
<li><p><strong>复杂问题简单化</strong></p>
<p>将一个复杂的任务分解成多个步骤来完成，每一层解决特定的问题</p>
</li>
</ul>
<h3 id="5-2-数仓命名规范"><a href="#5-2-数仓命名规范" class="headerlink" title="5.2 数仓命名规范"></a>5.2 数仓命名规范</h3><p>这里分为<strong>表命名规范</strong>、<strong>字段命名规范</strong>、<strong>指标命名规范</strong>、<strong>作业命名规范</strong></p>
<h4 id="5-2-1-表命名规范"><a href="#5-2-1-表命名规范" class="headerlink" title="5.2.1 表命名规范"></a>5.2.1 表命名规范</h4><p>不同分层的表命名规范不一样（以下命名规范包括了库名），abc为补充的三个参数，具体见后面</p>
<ul>
<li><p>ODS层</p>
<p>即贴源层，由业务方直接导入，不会经过数据清洗转化。操作数据层定位于业务明细数据保留区，负责保留数据接入时点后历史变更数据，数据原则上全量保留。</p>
<pre><code>项目名_ods.ods_系统名称(默认为空)_源表名_abc</code></pre></li>
<li><p>DW层</p>
<p>由ODS层数据经过清洗转化而成。这一层整合后的业务过程明细数据，负责各业务场景整合、数据结构化、规范化，常用公共维度冗余加工，以及明细业务标签信息加工。另外，在该层也会做一部分的数据聚合，将相同主题的数据汇集到一张表中，提高数据的可用性。</p>
<ul>
<li><p>dim层（维表）</p>
<pre><code>项目名_dw.dim_项目名_业务描述_abc</code></pre></li>
<li><p>dwv（业务明细）</p>
<pre><code>项目名_dw.dwv_项目名_一级主题域_二级主题域_业务描述_abc</code></pre></li>
<li><p>dwm（周期汇总）</p>
<pre><code>项目名_dw.dws_项目名_数据粒度_业务描述_统计范围cycle[N]_abc</code></pre><p>例如：</p>
<p><code>pm_dw.dwm_pm_store_activity_byr_currcy_order_cycle7_sdt</code>说明：pm是项目名，其数据粒度为店铺（store）+活动（activity）+买家（byr）+币种（currcy）;业务描述为下单（order）；统计的时间范围为近7天。</p>
</li>
<li><p>dws层（数据汇总服务）</p>
<pre><code>项目名_dw.dws_项目名_数据粒度_业务描述_abc</code></pre></li>
</ul>
</li>
<li><p>DM层</p>
<p>主要用于各产品或各业务向个性化的数据加工，一般报表/产品数据存放在这层</p>
<p>dm_产品|应用_数据粒度_业务描述_abc； </p>
<p><code>pm_dm.dm_sl_store_event_sdt</code>其产品名称为sl、数据粒度为店铺、业务描述为店铺的顾客行为相关指标数据。</p>
</li>
</ul>
<blockquote>
<p><strong>abc 说明</strong></p>
<p>a：表示数据粒度类别: <strong>f</strong> 表示明细数据，<strong>s</strong>表示汇总数据。</p>
<p>b：表示数据更新周期: <strong>d</strong>表示天(t+1)产出; <strong>h</strong>表示小时产出; <strong>mi</strong>表示分钟产出; <strong>c</strong>表示全量产出; <strong>w</strong>表示周产出; <strong>m</strong>表示月产出，<strong>y</strong>表示月产出。</p>
<p>c：表示数据存储形态: <strong>t</strong>表示表; <strong>v</strong>表示视图。</p>
<p>abc会有多种不同的组合，比如 fct 表示dw层的全量表，fdt 表示dw层的增量表(天表)</p>
</blockquote>
<h4 id="5-2-2-作业命名规范"><a href="#5-2-2-作业命名规范" class="headerlink" title="5.2.2 作业命名规范"></a>5.2.2 作业命名规范</h4><ul>
<li><p>数据采集作业（后缀import）</p>
<p>一般是采集变成ods层数据</p>
<pre><code>项目名_ods.ods_系统名称_源表名_abc_import </code></pre><p>如：pm_ods.ods_pm_orders_fct_import</p>
</li>
<li><p>数据导出作业（后缀export）</p>
<p>同采集作业，但后缀改成export</p>
<p>pm_store_method_h_export </p>
</li>
<li><p>数据查询作业</p>
<p>与产出目标表同名</p>
</li>
</ul>
<h4 id="5-2-3-字段命名规范"><a href="#5-2-3-字段命名规范" class="headerlink" title="5.2.3 字段命名规范"></a>5.2.3 字段命名规范</h4><ul>
<li><p>度量词汇</p>
<blockquote>
<p>次数：cnt</p>
<p>金额：amt</p>
<p>时长：dr</p>
<p>比例：rate</p>
<p>百分比：pct</p>
<p>环比：p2p</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>统计词汇</p>
<blockquote>
<p>订单金额：order_amt</p>
<p>商品数：prod_cnt</p>
<p>用户数：uid_cnt</p>
<p>订单数：order_cnt</p>
<p>曝光次数：pv</p>
<p>点击次数：click_cnt</p>
<p>买家数：byr_cnt</p>
<p>卖家数：sel_cnt</p>
<p>店铺数：store_cnt</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>约定名词词汇</p>
<blockquote>
<p>gmv：成交金额</p>
<p>cmv：取消金额</p>
<p>pmv：营业额</p>
<p>cancel：取消</p>
<p>consumer：顾客（有消费记录）</p>
<p>user：用户</p>
<p>member：会员</p>
<p>coins：购物金</p>
<p>sent：发送</p>
<p>used：使用</p>
<p>unuse：待使用/未使用（不含已过期）</p>
<p>source：来源</p>
<p>promotion：优惠</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>日期修饰词汇</p>
<blockquote>
<p>日：d</p>
<p>小时：h</p>
<p>分钟：mi</p>
<p>周：w</p>
<p>月：m</p>
<p>季度：q</p>
<p>年：y</p>
<p>七日：7d</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>聚合词汇</p>
<blockquote>
<p>total：历史累计</p>
<p>avg：平均</p>
<p>std：截止到当前统计日期</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>业务场景词汇</p>
<blockquote>
<p>order：下单</p>
<p>pay：支付</p>
<p>refund：退款</p>
<p>return_goods：退货  </p>
<p>subs：订阅</p>
<p>reg：注册</p>
<p>login：登录  </p>
<p>visit：访问</p>
<p>add_chart：购物车</p>
<p>site：站点</p>
</blockquote>
</li>
</ul>
<h4 id="5-2-4-指标命名规范"><a href="#5-2-4-指标命名规范" class="headerlink" title="5.2.4 指标命名规范"></a>5.2.4 指标命名规范</h4><p>1、指标统一：数据指标的内容及对应的命名、属性需要保持唯一性，无歧义。</p>
<p>2、指标统一目前只针对单一业务，暂不考虑跨业务间场景</p>
<p>3、指标统一命名：修饰语（业务场景限定条件）+对象+方法+时间范围 如cancel_order_cnt_1d</p>
<p>修饰语（业务场景限定条件）：cancel 取消；</p>
<p>统计对象：order 订单；</p>
<p>统计方法：cnt 记数，对订单进行去重统计；</p>
<p>统计周期：1d近一天的。</p>
<p>4、原子、派生指标之间的定义和关系</p>
<p>​    原子指标：基于某一业务事件行为下的度量，是业务定义中不可再拆分的指标，具有明确业务含义的名词 ，如支付金额。</p>
<p>​    派生指标: 由原子指标＋多个修饰词（可选）＋时间周期。可以理解为对原子指标业务统计范围的圈定。如原子指标：支付金额，最近一天海外买家支付金额则为派生指标（最近一天为时间周期，海外为修饰词 买家作为维度，而不作为修饰词）</p>
<h3 id="5-3-指标分级"><a href="#5-3-指标分级" class="headerlink" title="5.3 指标分级"></a>5.3 指标分级</h3><p>指标一共分为三级：A B C</p>
<blockquote>
<p>1、产品中展示给用户的指标：</p>
<p>业务过程指标，如订单数、GMV等          A级</p>
<p>行为数据指标，如PV UV 加入购物车等       B级</p>
</blockquote>
<blockquote>
<p>2、财务指标(BI)</p>
<p>如营收、净利润等                       A级</p>
</blockquote>
<blockquote>
<p>3、决策指标(BI)</p>
<p>影响公司管理者做决策相关的指标           A级</p>
</blockquote>
<blockquote>
<p>4、其它指标</p>
<p>C级</p>
</blockquote>
<h3 id="5-4-表的生命周期"><a href="#5-4-表的生命周期" class="headerlink" title="5.4 表的生命周期"></a>5.4 表的生命周期</h3><blockquote>
<p>ods层表</p>
<p>增量(fdt)：数据永久保存</p>
<p>全量(fct)：数据保存30天</p>
<p>小时(fht)：数据保存90天</p>
<p>dw层表</p>
<p>增量(fdt)：数据保存3年</p>
<p>全量(fct)：数据保存30天</p>
<p>小时(fht)：数据保存90天</p>
<p>dm层表</p>
<p>数据永久保存</p>
</blockquote>
<h2 id="6-主题域划分"><a href="#6-主题域划分" class="headerlink" title="6. 主题域划分"></a>6. 主题域划分</h2><p>因为数据仓库是面向主题的，所以主题域的划分显得很重要，因为主题域的确定也意味着数据的目的是干什么的。有关于主题划分的文章较少，阿里大数据之路这本书也没有单独的章节来讲主题域的划分，因为这个是需要对业务场景来说的，而且就算确定的业务场景也没有说百分百该如何划分，我还见过一群在互联网大数据领域有着多年工作经验的数仓专家们讨论某个表该划分到哪个主题域。所以，以下内容仅代表我在数仓主题域的一些拙见。</p>
<p><strong>什么是数据仓库主题域？</strong></p>
<p>主题域通常是联系较为紧密的数据主题的集合。可以根据业务的关注点，将这些数据主题划分到不同的主题域。主题域的确定必须由最终用户和数据仓库的设计人员共同完成。</p>
<h3 id="6-1-划分主题域方法"><a href="#6-1-划分主题域方法" class="headerlink" title="6.1 划分主题域方法"></a>6.1 划分主题域方法</h3><h4 id="6-1-1-传统方法"><a href="#6-1-1-传统方法" class="headerlink" title="6.1.1 传统方法"></a>6.1.1 传统方法</h4><p>在业务调研之后，可以进行主题域的划分。划分主题域，需要分析各个业务模块中有哪些业务活动。通常我们按照以下方法划分主题域，可以按照用户企业的部门划分，也可以按照业务过程或者业务板块中的功能模块划分。</p>
<ul>
<li>按照系统划分：业务系统有几种，就划分为几类</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210801204402.png" alt=""></p>
<ul>
<li>按业务划分：比如业务系统中有商品、交易、物流等过程，那这里的每一个过程就划分到一个主体域里。相对来说按业务划分主题域较常用。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210801215033.png" alt=""></p>
<ul>
<li>按部门规划：比如公司内的生产、供应链、研发、销售等</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210801204847.png" alt=""></p>
<h4 id="6-1-2-目前常用方法"><a href="#6-1-2-目前常用方法" class="headerlink" title="6.1.2 目前常用方法"></a>6.1.2 目前常用方法</h4><p>目前较多大型互联网公司都有建设数据中台，这种模式下较多按业务划分。这种除了具有一级主题域以外，每个一级主题域还有二级主题域。具体架构图如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210801214947.png" alt=""></p>
<p>具体表现例子：</p>
<p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210801215726.png" alt=""></p>
<p>当然，在实际的业务中每个一级域下的二级域也不会就这么两三个。</p>
<h3 id="6-2-主题域的核心"><a href="#6-2-主题域的核心" class="headerlink" title="6.2 主题域的核心"></a>6.2 主题域的核心</h3><p>为保障整个体系的生命力，主题域需要抽象提炼，并长期维护更新，但不轻易变动。划分数据域时，需满足以下两点：</p>
<ul>
<li>能涵盖当前所有的业务需求。</li>
<li>能在新业务进入时，无影响地被包含进已有的主题域中和扩展新的主题域。</li>
</ul>
<h3 id="6-3-注意点"><a href="#6-3-注意点" class="headerlink" title="6.3 注意点"></a>6.3 注意点</h3><ul>
<li><p>一次能划分好主题域吗</p>
<p>首先，主题域是无法一次划分完整的，一般是一次先建立几个明确的主题，在大多数数据仓库的设计过程中都有一个主题域的选择过程。业务是一直发展的，因此设计之初不要想着一次把所有主题全部划分完整。我们可以遵循上面说的划分主题域的两个要点，后续采用迭代的方式补充。</p>
</li>
</ul>
<ul>
<li><p>划分为几个主题域合适</p>
<p>主题域的个数由业务复杂度决定，但建议一级主题域在10个以内。</p>
</li>
</ul>
<ul>
<li><p>感觉可以划分到多个主题域？</p>
<p>表只能属于一个一级主题域，在一些比较模糊中的报表中，例如如果有一级数据域：商品域、订阅域，那商品中的订阅该划分到商品域还是订阅域？</p>
<p>这种比较容易让人接受的是以<strong>数据内容</strong>来划分域。不同的人有不同的看法，但是数据团队一定要制定统一的规范。</p>
</li>
</ul>
<h2 id="7-数据开发规范及流程"><a href="#7-数据开发规范及流程" class="headerlink" title="7. 数据开发规范及流程"></a>7. 数据开发规范及流程</h2><ol>
<li>业务理解与数据调研</li>
<li>数据域划分，构建总线矩阵，明确统计指标</li>
<li>分层架构 ，规范定义（命名规范、开发规范、流程规范）</li>
<li>模型设计（<strong>维度建模</strong>）宽表 粒度 指标体系</li>
<li>代码开发（任务调度 数据质量 元数据管理 血缘关系 数据治理）</li>
<li>应用（BI可视化 OLAP多维分析 用户画像 推荐系统 ）</li>
</ol>
<h2 id="8-数据治理"><a href="#8-数据治理" class="headerlink" title="8. 数据治理"></a>8. 数据治理</h2><p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210911041853.png" alt="数据治理轮盘"></p>
<h3 id="8-1元数据管理"><a href="#8-1元数据管理" class="headerlink" title="8.1元数据管理"></a>8.1元数据管理</h3><h4 id="8-1-1-元数据管理平台"><a href="#8-1-1-元数据管理平台" class="headerlink" title="8.1.1 元数据管理平台"></a>8.1.1 元数据管理平台</h4><p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210911040333.png" alt="元数据管理平台"></p>
<h4 id="8-1-2-指标确定"><a href="#8-1-2-指标确定" class="headerlink" title="8.1.2 指标确定"></a>8.1.2 指标确定</h4><ul>
<li><p>原子指标</p>
</li>
<li><p>基础指标</p>
</li>
<li><p>衍生指标</p>
</li>
</ul>
<h2 id="8-2-血缘关系"><a href="#8-2-血缘关系" class="headerlink" title="8.2 血缘关系"></a>8.2 血缘关系</h2><p>自建血缘管理工具，记录血缘关系。</p>
<p>数据血缘的获取主要有程序解析与人工采集两种方式。</p>
<p><strong>1.程序解析</strong></p>
<p>程序解析主要是面向存储过程，sql，视图以及已有的ETL过程。</p>
<p>以一个数据加工的完整流程为例，每个数据加工的流程都通过一个唯一的标识进行标记，流程中的每一个环节都记录其前后依赖关系，程序将灭一个环节的逻辑解析以后根据依赖关系和流程便可以生成全流程的数据血缘。</p>
<p><strong>2.人工采集</strong></p>
<p>人工采集可以是程序解析的一种辅助，也可以单独以这种方式发挥作用。</p>
<p>与程序解析不同的是，人工采集的结果可以更准确与详实，即使是在程序解析可以实现极高的准确率的情况下也需要以人工的方式进行一次审核是比较合理的做法。</p>
<h3 id="8-3-数仓难题"><a href="#8-3-数仓难题" class="headerlink" title="8.3 数仓难题"></a>8.3 数仓难题</h3><h4 id="8-3-1-数据跨层-amp-跨域问题"><a href="#8-3-1-数据跨层-amp-跨域问题" class="headerlink" title="8.3.1 数据跨层&amp;跨域问题"></a>8.3.1 数据跨层&amp;跨域问题</h4><ul>
<li><p>跨层性能优先还是近距离？</p>
<p>如果非要跨层，dws从dwm（近）还是ods（性能好）取数？</p>
<p>（从dwm取，因为性能怎样由多种情况决定，此外跨层少血缘清晰）</p>
</li>
<li><p>跨域</p>
<p>若只是少量跨域，则把表放在dwd（dwv）层</p>
<p>大量的情况则需要起一个新的主题域</p>
</li>
</ul>
<h1 id="后端开发篇"><a href="#后端开发篇" class="headerlink" title="后端开发篇"></a>后端开发篇</h1><h2 id="1-Java"><a href="#1-Java" class="headerlink" title="1.Java"></a>1.Java</h2><h2 id="2-数据库理论"><a href="#2-数据库理论" class="headerlink" title="2. 数据库理论"></a>2. 数据库理论</h2><h3 id="2-1-ACID与事务隔离级别"><a href="#2-1-ACID与事务隔离级别" class="headerlink" title="2.1 ACID与事务隔离级别"></a>2.1 ACID与事务隔离级别</h3><h3 id="2-2-CAP分布式理论"><a href="#2-2-CAP分布式理论" class="headerlink" title="2.2 CAP分布式理论"></a>2.2 CAP分布式理论</h3><h2 id="3-实时计算"><a href="#3-实时计算" class="headerlink" title="3.实时计算"></a>3.实时计算</h2><h1 id="数据挖掘篇"><a href="#数据挖掘篇" class="headerlink" title="数据挖掘篇"></a>数据挖掘篇</h1><h2 id="1-统计学基础"><a href="#1-统计学基础" class="headerlink" title="1.统计学基础"></a>1.统计学基础</h2><h2 id="2-python"><a href="#2-python" class="headerlink" title="2.python"></a>2.python</h2><h2 id="3-时间序列预测模型"><a href="#3-时间序列预测模型" class="headerlink" title="3.时间序列预测模型"></a>3.时间序列预测模型</h2><h3 id="2-1确定数据范围"><a href="#2-1确定数据范围" class="headerlink" title="2.1确定数据范围"></a>2.1确定数据范围</h3><h3 id="2-2-特征选择方法"><a href="#2-2-特征选择方法" class="headerlink" title="2.2 特征选择方法"></a>2.2 特征选择方法</h3><h3 id="2-3-参数与工业界的区别"><a href="#2-3-参数与工业界的区别" class="headerlink" title="2.3 参数与工业界的区别"></a>2.3 参数与工业界的区别</h3><h1 id="数据治理篇"><a href="#数据治理篇" class="headerlink" title="数据治理篇"></a>数据治理篇</h1><h2 id="0-前言-1"><a href="#0-前言-1" class="headerlink" title="0.前言"></a>0.前言</h2><p>从数据仓库篇单独拆分出来详细讲解</p>
<h2 id="1-数据质量"><a href="#1-数据质量" class="headerlink" title="1.数据质量"></a>1.数据质量</h2><h2 id="2-数据成本"><a href="#2-数据成本" class="headerlink" title="2.数据成本"></a>2.数据成本</h2><h2 id="3-数据价值"><a href="#3-数据价值" class="headerlink" title="3.数据价值"></a>3.数据价值</h2><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">CAIWEI</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.memorydrive.online/2022/03/07/shu-ju-kai-fa-xiu-xian-shou-ce/">https://www.memorydrive.online/2022/03/07/shu-ju-kai-fa-xiu-xian-shou-ce/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">CAIWEI</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="wechat,qq,twitter,facebook,google,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'SBRP8BrjzgaaVUSSLVkFMB7W-gzGzoHsz',
        appKey: 'qhVxMo6VBwDcXKq9PzE8lnyR',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/03/26/ec-cun-chu-yuan-li-ji-jian-dan-gong-cheng-hua-shi-xian/">
                    <div class="card-image">
                        
                        
                        <img src="https://auto2dev.coding.net/p/ImageHostingService/d/ImageHostingService/git/raw/master/higan/catoon_thumbnail/catoon_2200.jpg" class="responsive-img" alt="EC存储原理及简单工程化实现">
                        
                        <span class="card-title">EC存储原理及简单工程化实现</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            主要是为了省钱
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-03-26
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF/" class="post-category">
                                    大数据技术
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%AD%98%E5%82%A8/">
                        <span class="chip bg-color">存储</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/11/27/ji-qi-xue-xi-ji-chu-suan-fa/">
                    <div class="card-image">
                        
                        
                        <img src="https://auto2dev.coding.net/p/ImageHostingService/d/ImageHostingService/git/raw/master/higan/catoon_thumbnail/catoon_188.jpg" class="responsive-img" alt="机器学习基础算法">
                        
                        <span class="card-title">机器学习基础算法</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            简单汇总一下四种基础的机器学习算法
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-11-27
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6/" class="post-category">
                                    数据科学
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">
                        <span class="chip bg-color">机器学习</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2019</span>
			
            <!-- <a href="/about" target="_blank">CAIWEI</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br> -->
			
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">182.3k</span>&nbsp;字
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/ChoiNgai" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1354280129@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1354280129" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1354280129" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 百度统计 -->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?868ac38553679cc31b5f7b7a71851500";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<!-- 流程图 -->

  <script src='https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'dark'});
    }
  </script>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    

    

    

    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon-refresh.min.js" async="async"></script>
    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
