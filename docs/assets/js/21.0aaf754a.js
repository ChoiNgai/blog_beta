(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{411:function(s,t,a){"use strict";a.r(t);var n=a(30),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"hive优化-大表join大表优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#hive优化-大表join大表优化"}},[s._v("#")]),s._v(" Hive优化-大表join大表优化")]),s._v(" "),a("h2",{attrs:{id:"_0、大表join大表优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_0、大表join大表优化"}},[s._v("#")]),s._v(" 0、大表join大表优化")]),s._v(" "),a("p",[s._v("今天介绍大表join大表的问题。首先引入一个具体的问题场景，然后基于此介绍多种优化方案。")]),s._v(" "),a("h2",{attrs:{id:"_1、问题场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1、问题场景"}},[s._v("#")]),s._v(" 1、问题场景")]),s._v(" "),a("p",[s._v("问题场景如下：")]),s._v(" "),a("p",[s._v("A表为一个汇总表，汇总的是卖家买家最近N天交易汇总信息，即对于每个卖家最近N天，其每个买家共成交了多少单，总金额是多少，假设N取90天，汇总值仅取成交单数。")]),s._v(" "),a("p",[s._v("A表的字段有：buyer_id、seller_id、pay_cnt_90day。")]),s._v(" "),a("p",[s._v("B表为卖家基本信息表，其字段有seller_id、sale_level，其中sale_levels是卖家的一个分层评级信息，比如吧卖家分为6个级别：S0、S1、S2、S3、S4和S5。")]),s._v(" "),a("p",[s._v("要获得的结果是每个买家在各个级别的卖家的成交比例信息，比如：")]),s._v(" "),a("p",[s._v("某买家：S0:10%；S1:20%；S2:20%；S3:10%；S4:20%；S5:10%。")]),s._v(" "),a("p",[s._v("正如mapjoin中的例子一样，第一反应是直接join两表并统计：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("\n　　　　　　　　 m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buyer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pay_cnt_90day"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s5\n　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("  a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pay_cnt_90day\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" buyer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  pay_cnt_90day   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" table_A"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  a\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v("\n　　　　　　　　       "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  sale_level  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" table_B"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  b\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v("  a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  m\n　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("group")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buyer_id\n")])])]),a("p",[s._v("但是此SQL会引起数据倾斜，原因在于卖家的二八准则，某些卖家90天内会有几百万甚至上千万的买家，但是大部分的卖家90天内买家的数目并不多，join table_A和table_B的时候，")]),s._v(" "),a("p",[s._v("Hive会按照seller_id进行分发，table_A的大卖家引起了数据倾斜。")]),s._v(" "),a("p",[s._v("但是数据本身无法用mapjoin table_B解决，因为卖家超过千万条，文件大小有几个GB，超过了1GB的限制。")]),s._v(" "),a("h2",{attrs:{id:"_2、优化方案1-转为mapjoin"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2、优化方案1-转为mapjoin"}},[s._v("#")]),s._v(" 2、优化方案1：转为mapjoin")]),s._v(" "),a("p",[s._v("一个很正常的想法是，尽管B表无法直接mapjoin, 但是是否可以间接mapjoin它呢？")]),s._v(" "),a("p",[s._v("实际上此思路有两种途径：限制行和限制列。")]),s._v(" "),a("p",[s._v("限制行的思路是不需要join B全表，而只需要join其在A表中存在的，对于本问题场景，就是过滤掉90天内没有成交的卖家。")]),s._v(" "),a("p",[s._v("限制列的思路是只取需要的字段。")]),s._v(" "),a("p",[s._v("加上如上的限制后，检查过滤后的B表是否满足了Hive  mapjoin的条件，如果能满足，那么添加过滤条件生成一个临时B表，然后mapjoin该表即可。采用此思路的语句如下：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("\n　　　　　　　　 m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buyer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pay_cnt_90day"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s5\n　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" \n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*+mapjoin(b)*/")]),s._v("\n　　　　　　　　　　a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pay_cnt_90day\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" buyer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  pay_cnt_90day   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" table_A"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  a\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v("\n　　　　　　　　       "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n　　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  sale_level  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" table_B b0\n　　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v(" \n　　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" seller_id "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" table_A "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("group")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" a0\n　　　　　　　　　　   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" b0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" a0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("selller_id\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  b\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v("  a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  m\n　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("group")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buyer_id\n")])])]),a("p",[s._v("此方案在一些情况可以起作用，但是很多时候还是无法解决上述问题，因为大部分卖家尽管90天内买家不多，但还是有一些的，过滤后的B表仍然很多。")]),s._v(" "),a("h2",{attrs:{id:"_3、优化方案2-join时用case-when语句"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3、优化方案2-join时用case-when语句"}},[s._v("#")]),s._v(" 3、优化方案2：join时用case when语句")]),s._v(" "),a("p",[s._v("此种解决方案应用场景是：倾斜的值是明确的而且数量很少，比如null值引起的倾斜。其核心是将这些引起倾斜的值随机分发到Reduce,其主要核心逻辑在于join时对这些特殊值concat随机数，")]),s._v(" "),a("p",[s._v("从而达到随机分发的目的。此方案的核心逻辑如下：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("order_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user_id\n　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" table_a a "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v(" table_b b\n　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user_is "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("is")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" concat"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hive'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" rand"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user_id "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user_id\n")])])]),a("p",[s._v("Hive 已对此进行了优化，只需要设置参数skewinfo和skewjoin参数，不修改SQL代码，例如，由于table_B的值“0” 和“1”引起了倾斜，值需要做如下设置：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" hive"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("optimize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("skewinfo"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("table_B:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("selleer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" hive"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("optimize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("skewjoin "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("p",[s._v("但是方案2因为无法解决本问题场景的倾斜问题，因为倾斜的卖家大量存在而且动态变化。")]),s._v(" "),a("h2",{attrs:{id:"_4-、优化方案3-倍数b表-再取模join"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-、优化方案3-倍数b表-再取模join"}},[s._v("#")]),s._v(" 4 、优化方案3：倍数B表，再取模join")]),s._v(" "),a("h3",{attrs:{id:"_1-、通用方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-、通用方案"}},[s._v("#")]),s._v(" 1）、通用方案")]),s._v(" "),a("p",[s._v("此方案的思路是建立一个numbers表，其值只有一列int 行，比如从1到10（具体值可根据倾斜程度确定），然后放大B表10倍，再取模join。代码如下：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("\n　　　　　　　　 m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buyer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pay_cnt_90day"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s5\n　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("  a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pay_cnt_90day\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" buyer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  pay_cnt_90day   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" table_A"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  a\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v("\n　　　　　　　　       "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*+mapjoin(members)*/")]),s._v("\n　　　　　　　　　　　　seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  sale_level "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("member\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" table_B\n   　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v(" members\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  b\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v("  a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mod")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pay_cnt_90day"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("number \n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  m\n　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("group")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buyer_id\n")])])]),a("p",[s._v("此思路的核心在于，既然按照seller_id分发会倾斜，那么再人工增加一列进行分发，这样之前倾斜的值的倾斜程度会减少到原来的1/10，可以通过配置numbers表改放大倍数来降低倾斜程度，")]),s._v(" "),a("p",[s._v("但这样做的一个弊端是B表也会膨胀N倍。")]),s._v(" "),a("h3",{attrs:{id:"_2-、专用方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-、专用方案"}},[s._v("#")]),s._v(" 2）、专用方案")]),s._v(" "),a("p",[s._v("通用方案的思路把B表的每条数据都放大了相同的倍数，实际上这是不需要的，只需要把大卖家放大倍数即可：需要首先知道大卖家的名单，即先建立一个临时表动态存放每天最新的大卖家（比如dim_big_seller）,同时此表的大卖家要膨胀预先设定的倍数（1000倍）。")]),s._v(" "),a("p",[s._v("在A表和B表分别新建一个join列，其逻辑为：如果是大卖家，那么concat一个随机分配正整数（0到预定义的倍数之间，本例为0~1000）；如果不是，保持不变。具体代码如下：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("\n　　　　　　　　 m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buyer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pay_cnt_90day"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s5\n　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("  a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pay_cnt_90day\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("  \n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*+mapjoin(big)*/")]),s._v("\n　　　　　　　　　　　　　buyer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  pay_cnt_90day"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("big"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("is")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("not")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" concat"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("  table_A"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rnd'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  cast"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("  rand"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("bigint")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" table_A"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" seller_id_joinkey\n　　　　　　　　　　　　  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" table_A\n　　　　　　　　　　　　   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("left")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("outer")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v("\n　　　　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--big表seller_id有重复，请注意一定要group by 后再join,保证table_A的行数保持不变")]),s._v("\n　　　　　　　　　　　　　（"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" seller_id  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" dim_big_seller  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("group")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" seller_id）big\n　　　　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" table_A"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" big"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  a\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v("\n　　　　　　　　       "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*+mapjoin(big)*/")]),s._v("\n　　　　　　　　　　　　seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  sale_level "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--big表的seller_id_joinkey生成逻辑和上面的生成逻辑一样")]),s._v("\n　　　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("coalesce")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("seller_id_joinkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("table_B"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" seller_id_joinkey\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" table_B\n   　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("left")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("out")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v("\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--table_B表join大卖家表后大卖家行数扩大1000倍，其它卖家行数保持不变")]),s._v("\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" seller_id_joinkey "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" dim_big_seller"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" big\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" table_B"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" big"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  b\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v("  a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id_joinkey"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id_joinkey\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mod")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pay_cnt_90day"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("number \n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  m\n　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("group")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buyer_id\n")])])]),a("p",[s._v("相比通用方案，专用方案的运行效率明细好了许多，因为只是将B表中大卖家的行数放大了1000倍，其它卖家的行数保持不变，但同时代码复杂了很多，而且必须首先建立大数据表。")]),s._v(" "),a("h2",{attrs:{id:"_5-、方案4-动态一分为二"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-、方案4-动态一分为二"}},[s._v("#")]),s._v(" 5 、方案4：动态一分为二")]),s._v(" "),a("p",[s._v("实际上方案2和3都用了一分为二的思想，但是都不彻底，对于mapjoin不能解决的问题，终极解决方案是"),a("strong",[s._v("动态一分为二，即对倾斜的键值和不倾斜的键值分开处理，不倾斜的正常join即可，倾斜的把他们找出来做mapjoin，最后union all其结果即可。")])]),s._v(" "),a("p",[s._v("但是此种解决方案比较麻烦，代码复杂而且需要一个临时表存放倾斜的键值。代码如下：")]),s._v(" "),a("p",[s._v("由于数据倾斜，先找出90天买家超过10000的卖家")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" overwrite "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v("  temp_table_B\n　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" \n　　　　　　　　m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level\n　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("   seller_id\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("count")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("buyer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" byr_cnt\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" table_A\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("group")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" seller_id\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" a\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("byr_cnt "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" m\n　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("left")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v(" \n　　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sale_level  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" table_B\n　　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" n\n　　　　　   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n　　　　　　\n　　　　　　"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--对于90天买家超过10000的卖家直接mapjoin,对其它卖家直接正常join即可。")]),s._v("\n　　　　　　\n　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("\n　　　　　　　　 m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buyer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pay_cnt_90day"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" pay_cnt_90day  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pay_cnt_90day_s5\n　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("  a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pay_cnt_90day\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" buyer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  pay_cnt_90day   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" table_A"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  a\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v("\n　　　　　　　　       "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level \n　　　　　　　　　　 "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" table_A  a\n　　　　　　　　　　 "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("left")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v(" temp_table_B b\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("is")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("not")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),s._v("\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  b\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v("  a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id\n　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("union")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("all")]),s._v("\n　　　　　　　\n　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*+mapjoin(b)*/")]),s._v("\n　　　　　　　　　　a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sale_level"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pay_cnt_90day\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" \n　　　　　　　　　　 "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" buyer_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  pay_cnt_90day   \n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" table_A\n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  a\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v("\n　　　　　　　　       "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n　　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" seller_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  sale_level  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" table_B \n　　　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  b\n　　　　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v("  a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seller_id\n　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  m  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("group")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buyer_id\n　　　　　"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" m\n　　　　　"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("group")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buyer_id\n")])])]),a("p",[a("strong",[s._v("总结：")])]),s._v(" "),a("p",[s._v("方案1、2以及方案3中的同用方案不能保证解决大表join大表问题，因为它们都存在种种不同的限制和特定使用场景。")]),s._v(" "),a("p",[s._v("而方案3的专用方案和方案4是推荐的优化方案，但是它们都需要新建一个临时表来存储每日动态变化的大卖家。相对方案4来说，方案3的专用方案不需要对代码框架进行修改，但是B表会被放大，所以一定要是是维度表，不然统计结果会是错误的。方案4最通用，自由度最高，但是对代码的更改也最大，甚至修改更难代码框架，可以作为终极方案使用。")])])}),[],!1,null,null,null);t.default=e.exports}}]);