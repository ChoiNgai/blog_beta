(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{410:function(s,t,r){"use strict";r.r(t);var e=r(30),a=Object(e.a)({},(function(){var s=this,t=s.$createElement,r=s._self._c||t;return r("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[r("h2",{attrs:{id:"hive-中的四种排序详解"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#hive-中的四种排序详解"}},[s._v("#")]),s._v(" Hive 中的四种排序详解")]),s._v(" "),r("h2",{attrs:{id:"hive-中的四种排序"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#hive-中的四种排序"}},[s._v("#")]),s._v(" Hive 中的四种排序")]),s._v(" "),r("p",[s._v("排序操作是一个比较常见的操作，尤其是在数据分析的时候，我们往往需要对数据进行排序，hive 中和排序相关的有四个关键字，今天我们就看一下，它们都是什么作用。")]),s._v(" "),r("p",[r("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cAoClgx53VsgXdoMWIu1kmRibT9b6yMTkkrxNHV3ficRm6ghqFiaCNmxbAzzEjqubB3JOQGhH4BudzI7W4o335JMw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),s._v(" "),r("h3",{attrs:{id:"数据准备"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#数据准备"}},[s._v("#")]),s._v(" 数据准备")]),s._v(" "),r("p",[s._v("下面我们有一份温度数据,tab 分割")]),s._v(" "),r("div",{staticClass:"language-sql extra-class"},[r("pre",{pre:!0,attrs:{class:"language-sql"}},[r("code",[r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2008")]),s._v("    "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("32.0")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2008")]),s._v("    "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("21.0")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2008")]),s._v("    "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("31.5")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2008")]),s._v("    "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("17.0")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2013")]),s._v("    "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("34.0")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2015")]),s._v("    "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("32.0")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2015")]),s._v("    "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("33.0")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2015")]),s._v("    "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("15.9")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2015")]),s._v("    "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("31.0")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2015")]),s._v("    "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("19.9")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2015")]),s._v("    "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("27.0")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2016")]),s._v("    "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("23.0")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2016")]),s._v("    "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.9")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2016")]),s._v("    "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("32.0")]),s._v("\n")])])]),r("p",[s._v("建表加载数据")]),s._v(" "),r("div",{staticClass:"language-sql extra-class"},[r("pre",{pre:!0,attrs:{class:"language-sql"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" ods_temperature"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("year")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    temper "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("float")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" format delimited "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("load")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" inpath "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/Users/liuwenqiang/workspace/hive/temperature.data'")]),s._v(" overwrite "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" ods_temperature"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),r("h3",{attrs:{id:"_1-order-by-全局排序"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_1-order-by-全局排序"}},[s._v("#")]),s._v(" 1. order by(全局排序)")]),s._v(" "),r("p",[s._v("order by会对输入做"),r("strong",[s._v("全局排序")]),s._v("，因此只有一个Reducer(多个Reducer无法保证全局有序)，然而只有一个reducer，会导致当输入规模较大时，消耗较长的计算时间。")]),s._v(" "),r("ul",[r("li",[s._v("降序：desc")]),s._v(" "),r("li",[s._v("升序：asc 不需要指定，默认是升序")])]),s._v(" "),r("p",[s._v("需要注意的是它受"),r("code",[s._v("hive.mapred.mode")]),s._v("的影响，在严格模式下，必须使用limit 对排序的数据量进行限制，因为数据量很大只有一个reducer的话，会出现OOM 或者运行时间超长的情况，所以严格模式下，不适用limit 则会报错，更多请参考Hive的严格模式和本地模式。")]),s._v(" "),r("div",{staticClass:"language-sql extra-class"},[r("pre",{pre:!0,attrs:{class:"language-sql"}},[r("code",[s._v("Error: Error "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" compiling statement: FAILED: SemanticException "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(":"),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("39")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Order")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s without "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("limit")]),s._v(" are disabled "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" safety reasons"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("If")]),s._v(" you know what you are doing"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" please "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" hive"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("strict"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("checks"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("orderby"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("no")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("limit")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" make sure that hive"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mapred"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("mode")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("is")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("not")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'strict'")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" proceed"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" Note that you may get "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("errors")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("or")]),s._v(" incorrect results "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" you make a mistake "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("using")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("some")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("of")]),s._v(" the unsafe features"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" Error encountered near token "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'year'")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("state"),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("42000")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("code"),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("40000")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),r("p",[s._v("接下来我们看一下order by的排序结果"),r("code",[s._v("select * from ods_temperature order by year;")])]),s._v(" "),r("p",[r("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cAoClgx53VsgXdoMWIu1kmRibT9b6yMTkVjNuvI712h7oj6N17ibCm379WicT0pokiaDwwRUDjWYmdpgyEKagqjdlA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),s._v(" "),r("h3",{attrs:{id:"_2-sort-by-分区内排序"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_2-sort-by-分区内排序"}},[s._v("#")]),s._v(" 2. sort by(分区内排序)")]),s._v(" "),r("p",[s._v("不是全局排序，其在数据进入reducer前完成排序，也就是说它会在数据进入reduce之前为每个reducer都产生一个排序后的文件。因此，如果用sort by进行排序，并且设置mapreduce.job.reduces>1，则sort by只保证每个reducer的输出有序，不保证全局有序。")]),s._v(" "),r("p",[s._v("它不受Hive.mapred.mode属性的影响，sort by的数据只能保证在同一个reduce中的数据可以按指定字段排序。使用sort by你可以指定执行的reduce个数(通过set mapred.reduce.tasks=n来指定)，对输出的数据再执行归并排序，即可得到全部结果。")]),s._v(" "),r("div",{staticClass:"language-sql extra-class"},[r("pre",{pre:!0,attrs:{class:"language-sql"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" mapred"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("reduce"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tasks"),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" ods_temperature sort "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("year")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),r("p",[r("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cAoClgx53VsgXdoMWIu1kmRibT9b6yMTk4QGaZhrHdXcBIWNq43Uu1mFX1Y2EdpBjO1RBrTGKNpBZKbJ0A78Niag/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),s._v(" "),r("p",[s._v("发现上面的输出好像看不出来啥，只能看到不是有序的，哈哈，那我们换一种方法，将数据输出到文件，因为我们设置了reduce数是3，那应该会有三个文件输出。")]),s._v(" "),r("div",{staticClass:"language-sql extra-class"},[r("pre",{pre:!0,attrs:{class:"language-sql"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" mapred"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("reduce"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tasks"),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" overwrite "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" directory "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/Users/liuwenqiang/workspace/hive/sort'")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" format delimited "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" ods_temperature sort "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("year")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),r("p",[r("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cAoClgx53VsgXdoMWIu1kmRibT9b6yMTkGpzHjpqRicqp0VvnDn8o5bPTYG71lkYEV5RXGOyaHiaOhkeibdcs1ABCQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),s._v(" "),r("p",[s._v("可以看出这下就清楚多了，我们看到一个分区内的年份并不同意，那个年份的数据都有。")]),s._v(" "),r("h4",{attrs:{id:"sort-by-和order-by-的执行效率"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#sort-by-和order-by-的执行效率"}},[s._v("#")]),s._v(" sort by 和order by 的执行效率")]),s._v(" "),r("p",[s._v("首先我们看一个现象，一般情况下我们认为sort by 应该是比 order by 快的，因为 order by 只能使用一个reducer,进行全部排序，但是当数据量比较小的时候就不一定了，因为reducer 的启动耗时可能远远数据处理的时间长，就像下面的例子order by 是比sort by快的。")]),s._v(" "),r("p",[r("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cAoClgx53VsgXdoMWIu1kmRibT9b6yMTkiaUamC6CKfkMBTRw53qUqzlchhltM6luOUBdiaUzibR0uicibviaibBxMtwQQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),s._v(" "),r("h4",{attrs:{id:"sort-by-中的limt"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#sort-by-中的limt"}},[s._v("#")]),s._v(" sort by 中的limt")]),s._v(" "),r("p",[s._v("可以在sort by 用limit子句减少数据量，使用limit n 后，传输到reduce端的数据记录数就减少到 n *（map个数）,也就是说我们在sort by 中使用limit 限制的实际上是每个reducer 中的数量，然后再根据sort by的排序字段进行order by，最后返回n 条数据给客户端，也就是说你在sort by 用limit子句，最后还是会使用order by 进行最后的排序。")]),s._v(" "),r("p",[s._v("order by 中使用limit 是对排序好的结果文件去limit 然后交给reducer,可以看到sort by 中limit 子句会减少参与排序的数据量，而order by 中的不行，只会限制返回客户端数据量的多少。")]),s._v(" "),r("p",[s._v("从上面的执行效率，我们看到sort by limit 几乎是 order by limit 的两倍了 ，大概猜出来应该是多了某个环节。")]),s._v(" "),r("p",[r("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cAoClgx53VsgXdoMWIu1kmRibT9b6yMTkiaRP3sxicSuBmtwz1uZWDo0pDDzpAQ5Q6Fha17iatcEMF5ZkjfrsuicU0g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),s._v(" "),r("p",[s._v("接下来我们分别看一下order by limit 和 sort by limit 的执行计划")]),s._v(" "),r("div",{staticClass:"language-sql extra-class"},[r("pre",{pre:!0,attrs:{class:"language-sql"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("explain")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" ods_temperature "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("order")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("year")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("limit")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),r("p",[r("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cAoClgx53VsgXdoMWIu1kmRibT9b6yMTkrryPNGBtVuWBS3yNoWxJ1lTX9tEj0FahVb8S4WZuPyRmXhFlnFB62Q/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),s._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[s._v("explain select * from ods_temperature sort by year limit 2;\n")])])]),r("p",[r("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cAoClgx53VsgXdoMWIu1kmRibT9b6yMTkHaoIEWuVa3icKVxYYEmRGZOy4WQYURibsghCsFvaQRqOvu9fnicQwBdIw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),s._v(" "),r("p",[s._v("从上面截图我圈出来的地方可以看到")]),s._v(" "),r("ol",[r("li",[s._v("sort by limit 比 order by limit 多出了一个stage(order limit)")]),s._v(" "),r("li",[s._v("sort by limit  实际上执行了两次limit ,减少了参与排序的数据量")])]),s._v(" "),r("h3",{attrs:{id:"_3-distribute-by-数据分发"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_3-distribute-by-数据分发"}},[s._v("#")]),s._v(" 3. distribute by(数据分发)")]),s._v(" "),r("p",[s._v("distribute by是控制在map端如何拆分数据给reduce端的。类似于MapReduce中分区partationer对数据进行分区")]),s._v(" "),r("p",[s._v("hive会根据distribute by后面列，将数据分发给对应的reducer，默认是采用hash算法+取余数的方式。")]),s._v(" "),r("p",[s._v("sort by为每个reduce产生一个排序文件，在有些情况下，你需要控制某写特定的行应该到哪个reducer，这通常是为了进行后续的聚集操作。distribute by刚好可以做这件事。因此，distribute by经常和sort by配合使用。")]),s._v(" "),r("p",[s._v("例如上面的sort by 的例子中，我们发现不同年份的数据并不在一个文件中，也就说不在同一个reducer 中，接下来我们看一下如何将相同的年份输出在一起，然后按照温度升序排序")]),s._v(" "),r("p",[s._v("首先我们尝试一下没有distribute by 的SQL的实现")]),s._v(" "),r("div",{staticClass:"language-sql extra-class"},[r("pre",{pre:!0,attrs:{class:"language-sql"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" overwrite "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" directory "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/Users/liuwenqiang/workspace/hive/sort'")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" format delimited "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),s._v("  "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" ods_temperature sort "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" temper "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),r("p",[r("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cAoClgx53VsgXdoMWIu1kmRibT9b6yMTkm3JibzYBnGRoQSumkm9IE5tk8RdzxgwRkJZNwEESAbBM5ODEoHIoTGg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),s._v(" "),r("p",[s._v("发现结果并没有把相同年份的数据分配在一起,接下来我们使用一下distribute by")]),s._v(" "),r("div",{staticClass:"language-sql extra-class"},[r("pre",{pre:!0,attrs:{class:"language-sql"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" overwrite "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" directory "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/Users/liuwenqiang/workspace/hive/sort'")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" format delimited "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),s._v(" \n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" ods_temperature distribute "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("year")]),s._v(" sort "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" temper "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),r("p",[r("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cAoClgx53VsgXdoMWIu1kmRibT9b6yMTkNzc26TFfian0EVmWic4bUlRbEFn5ic98gMxpoGyReInv9vU99J255uHXg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),s._v(" "),r("p",[s._v("这下我们看到相同年份的都放在了一下，可以看出2013 和 2016 放在了一起，但是没有一定顺序，这个时候我们可以对 distribute by 字段再进行一下排序")]),s._v(" "),r("div",{staticClass:"language-sql extra-class"},[r("pre",{pre:!0,attrs:{class:"language-sql"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" overwrite "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" directory "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/Users/liuwenqiang/workspace/hive/sort'")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" format delimited "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),s._v(" \n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" ods_temperature distribute "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("year")]),s._v(" sort "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("year")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("temper "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),r("p",[r("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cAoClgx53VsgXdoMWIu1kmRibT9b6yMTkUjrezNckWWCria7ucsXjMTeXs85icw84ibjlT259BSZe6R9Qia6Q6TkOibQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),s._v(" "),r("h3",{attrs:{id:"_4-cluster-by"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-cluster-by"}},[s._v("#")]),s._v(" 4. cluster by")]),s._v(" "),r("p",[s._v("cluster by除了具有distribute by的功能外还兼具sort by的功能。但是排序只能是升序排序，不能指定排序规则为ASC或者DESC。")]),s._v(" "),r("p",[s._v("当分区字段和排序字段相同cluster by可以简化distribute by+sort by 的SQL 写法，也就是说当distribute by和sort by 字段相同时，可以使用cluster by 代替distribute by和sort by")]),s._v(" "),r("div",{staticClass:"language-sql extra-class"},[r("pre",{pre:!0,attrs:{class:"language-sql"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" overwrite "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" directory "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/Users/liuwenqiang/workspace/hive/sort'")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" format delimited "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),s._v(" \n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" ods_temperature  distribute "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("year")]),s._v(" sort "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("year")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),r("p",[r("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cAoClgx53VsgXdoMWIu1kmRibT9b6yMTkG5CH9ibo7iaxhQZPGwHE4W0DJV81RKfMShMb1QYzgmLRtuT9iaL2RFt7A/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),s._v(" "),r("div",{staticClass:"language-sql extra-class"},[r("pre",{pre:!0,attrs:{class:"language-sql"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" overwrite "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" directory "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/Users/liuwenqiang/workspace/hive/sort'")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" format delimited "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),s._v(" \n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" ods_temperature cluster "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("year")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),r("p",[r("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cAoClgx53VsgXdoMWIu1kmRibT9b6yMTk9SaLm96D7fLnicibkclYV90PF1KpKice5ibAfDBRnKlWX2icPrib0Xp46EGg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),s._v(" "),r("p",[s._v("我们看到上面两种SQL写法的输出结果是一样的，这也就证明了我们的说法，当distribute by和sort by 字段相同时，可以使用cluster by 代替distribute by和sort by")]),s._v(" "),r("p",[s._v("当你尝试给cluster by  指定排序方向的时候，你就会得到如下错误。")]),s._v(" "),r("div",{staticClass:"language-sql extra-class"},[r("pre",{pre:!0,attrs:{class:"language-sql"}},[r("code",[s._v("Error: Error "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" compiling statement: FAILED: ParseException line "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(":"),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("46")]),s._v(" extraneous input "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'desc'")]),s._v(" expecting EOF near "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'<EOF>'")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("state"),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("42000")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("code"),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("40000")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),r("h2",{attrs:{id:"总结"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),r("ol",[r("li",[s._v("order by 是全局排序，可能性能会比较差；")]),s._v(" "),r("li",[s._v("sort by分区内有序，往往配合distribute by来确定该分区都有那些数据；")]),s._v(" "),r("li",[s._v("distribute by 确定了数据分发的规则，满足相同条件的数据被分发到一个reducer；")]),s._v(" "),r("li",[s._v("cluster by 当distribute by和sort by 字段相同时，可以使用cluster by 代替distribute by和sort by,但是cluster by默认是升序，不能指定排序方向；")]),s._v(" "),r("li",[s._v("sort by limit 相当于每个reduce 的数据limit 之后，进行order by 然后再limit ；")])])])}),[],!1,null,null,null);t.default=a.exports}}]);