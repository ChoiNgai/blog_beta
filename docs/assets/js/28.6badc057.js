(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{422:function(s,t,a){"use strict";a.r(t);var e=a(30),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"hive小知识之分桶抽样"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#hive小知识之分桶抽样"}},[s._v("#")]),s._v(" Hive小知识之分桶抽样")]),s._v(" "),a("p",[s._v("先把大家都知道的分桶抽样查询 的语法以及用法po出")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" 分桶表 tablesample"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bucket x "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("out")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("of")]),s._v(" y "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" 分桶字段"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("p",[s._v("假设当前分桶表，一共分了z桶！")]),s._v(" "),a("p",[s._v("x: 代表从当前的第几桶开始抽样")]),s._v(" "),a("p",[s._v("0<x<=y")]),s._v(" "),a("p",[s._v("y: z/y 代表一共抽多少桶！")]),s._v(" "),a("p",[s._v("y必须是z的因子或倍数！")]),s._v(" "),a("p",[a("strong",[s._v("怎么抽")]),s._v("：从第x桶开始抽，当y<=z每间隔y桶抽一桶，直到抽满 z/y桶")]),s._v(" "),a("p",[s._v("举例1：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" stu_buck2 tablesample"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bucket "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("out")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("of")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("p",[s._v("从第1桶开始抽，每间隔2桶抽一桶，一共抽2桶！")]),s._v(" "),a("p",[s._v("桶号：x+y*(n-1) 抽0号桶和2号桶")]),s._v(" "),a("p",[s._v("举例2：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" stu_buck2 tablesample"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bucket "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("out")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("of")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("p",[s._v("从第1桶开始抽，每间隔1桶抽一桶，一共抽4桶！")]),s._v(" "),a("p",[s._v("抽0,1,2,3号桶")]),s._v(" "),a("p",[s._v("举例3：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" stu_buck2 tablesample"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bucket "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("out")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("of")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("p",[s._v("从第2桶开始抽，一共抽0.5桶！")]),s._v(" "),a("p",[s._v("抽1号桶的一半")]),s._v(" "),a("p",[s._v("然而，当我自己实验时，发现实际情况跟预期有偏差")]),s._v(" "),a("p",[s._v("建表语句：")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--创建分桶表")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" people "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("name string"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("clustered")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nsorted "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("desc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" buckets\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" format  delimited "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--创建临时表")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" tmp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("name string"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" format delimited "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fields")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("terminated")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\t'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--加载数据")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("load")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" inpath "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/home/guigu/data.txt'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" tmp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--加载数据到分桶表")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" overwrite "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" people \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tmp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("p",[s._v("数据：分好的桶如下")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2OVH9w5E0u3oKpWicfr1TOVMS586LbQhIwG3c3lvO9ZLiaZ0iapObs3gWBs948EOggVBFDJSEOFzFwrQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),s._v(" "),a("p",[s._v("然而查询时却发现 本来打算取第2个桶里的4/8 数据，但返回的数据跟预期差得很多")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2OVH9w5E0u3oKpWicfr1TOVMtwibQBxjXhiaypD1kNOXkYQtiaPCWOiawWxdTgbDtjjib7Usv7zc5TWjElw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),s._v(" "),a("p",[a("strong",[s._v("其实")])]),s._v(" "),a("p",[s._v("select * from 分桶表 tablesample(bucket x out of y on 分桶字段);\n"),a("strong",[s._v("这个抽样查询的底层是把所有数据按照 字段的hash值 % y  分成y 个 区（相当于Hadoop里的分区），然后取第 x 区")]),s._v(" "),a("strong",[s._v("中的数据。\n之所以没有达到预期的效果，是因为用来测试的数据太少！")])])])}),[],!1,null,null,null);t.default=n.exports}}]);