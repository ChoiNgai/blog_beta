(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{406:function(t,s,a){"use strict";a.r(s);var e=a(30),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"hive-分析函数进阶指南"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#hive-分析函数进阶指南"}},[t._v("#")]),t._v(" Hive 分析函数进阶指南")]),t._v(" "),a("p",[t._v("[数据仓库与Python大数据](javascript:void(0)😉 "),a("em",[t._v("2020-05-27")])]),t._v(" "),a("p",[t._v("以下文章来源于大数据与人工智能 ，作者斌迪")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=Mzg3NjIyNjQwMg==&mid=2247487212&idx=1&sn=f0480567f8b91f8d94d0953e6c27baf8&chksm=cf343ce1f843b5f7940d4e9db7619f085b4e48e7be6d3ba28b8f3f1030d6548337696df02dc5&mpshare=1&scene=1&srcid=0726mhr6LTVvfc19f95uueAS&sharer_sharetime=1627236514990&sharer_shareid=fe705087c00f630c1298600646872540&key=7459898629dc7ce463a856ad1a0306f7fc870392cc205dd9bb00383f97df7e200ba44f6bd4c4a064446bbf90c618eea6dd8ac6c5c974074138f1b2e0f59f433add93ce630f87bea15a9ae38a307932458bd634001f1094968d789e213570428e39e4394b96c66d45f88128f2b6e7dcce9a9414e4f0d9ba194e7a71d158ef4ba5&ascene=1&uin=OTA2MDU2Nzc3&devicetype=Windows+10+x64&version=63030073&lang=zh_CN&exportkey=A1iwbm2PseHPVSOB74PuDGc%3D&pass_ticket=AJSYPF%2FDRZ5Dbgdei0x8CrxCiEvRpI%2BkjCKzB%2B%2F84htSssI1Paw1OxXHAexDSAzx&wx_header=0&fontgear=2#",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"http://wx.qlogo.cn/mmhead/Q3auHgzwzM5M7lLKEAiaomE2bdU1AnqO5cps0UN6CZ9wQbmjgnSYM0g/0",alt:"大数据与人工智能"}}),a("strong",[t._v("大数据与人工智能")]),t._v("本公众号作者来自电视猫MoreTV大数据与人工智能团队，持续关注业内大数据与人工智能技术、行业动态，每周输出2篇以上大数据、推荐系统、算法、机器学习、AI相关原创文章！"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"http://mp.weixin.qq.com/s?__biz=Mzg3NjIyNjQwMg==&mid=2247487154&idx=1&sn=8513992a5f7aabe7f63e9e83fad050ef&chksm=cf343cbff843b5a9e502263b3017182681c8f249122e40ececb57e32364f262f3e4a29f84996&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cge06IdYQydF9cXeWKNTs10PeDAk1ibcItFKic3u5LTdvOzOIofLIYfZaCa7qgbgibrYJcicLWriaAsLfJptk4DaAXQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),a("OutboundLink")],1)]),t._v(" "),a("p",[a("strong",[t._v("作者丨斌迪")])]),t._v(" "),a("p",[t._v("作为一名SQL BOY/GIRL：在写SQL的漫漫路上，窗口函数犹如一把披荆斩棘的利剑，帮助作者解决了很多繁琐复杂的需求，在此对窗口函数表示感谢。")]),t._v(" "),a("p",[t._v("本文在介绍了窗口函数的同时，着重介绍Hive窗口函数的使用，希望读者在看完本篇文章之后，对窗口函数的使用能够有所掌握。")]),t._v(" "),a("p",[t._v("值得注意的是本文中的例子使用的是HQL（Hive SQL），本文需要一定的SQL基础，如果想了解基础SQL，请移步："),a("a",{attrs:{href:"http://mp.weixin.qq.com/s?__biz=Mzg3NjIyNjQwMg==&mid=2247485812&idx=2&sn=721cb0b0051d745db0eaef599192c272&chksm=cf343b79f843b26fa7fe0c983646d48f362eab90458288c8508fa7670ef22a971aade2d312b0&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[t._v("SQL 开发规范与优化技巧"),a("OutboundLink")],1),a("a",{attrs:{href:"http://mp.weixin.qq.com/s?__biz=MzI1NjM1ODEyMg==&mid=2247483959&idx=1&sn=23f9ee016dca61c2e78a5b6e8f8b1eae&chksm=ea26a1b2dd5128a4bcd8a3d425876e8ec8ed2698899fb12c60a128dbad2d5eb7d68ab3998b76&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[a("OutboundLink")],1),t._v("。")]),t._v(" "),a("p",[a("strong",[t._v("两个问题")])]),t._v(" "),a("p",[t._v("对于数据工作者来说，窗口函数或多或少都使用过，但是可能没有系统的去总结它的用法。")]),t._v(" "),a("p",[t._v("如果读者对于窗口函数有一点了解的话，不妨先看看针对下表的两个问题，如何使用SQL去解决；"),a("strong",[t._v("如果读者对于窗口函数一点都不了解，那请您直接跳过这一部分，直接从"),a("strong",[a("strong",[t._v("什么是窗口函数")])]),t._v("开始阅读。")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cge06IdYQydF9cXeWKNTs10PeDAk1ibcIicbiae5r1XUcq2vLdzja1Tia0ZgibaLtkBU1w0ON8bsJghibdmXdiaIFHokw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),t._v(" "),a("p",[t._v("针对上面一张学生成绩表(class)，有year-学年，class-课程，student-学生，score-分数这四个字段，请看问题：")]),t._v(" "),a("p",[a("em",[t._v("问题1：每年每门学科排名第一的学生是？")])]),t._v(" "),a("p",[a("em",[t._v("问题2：每年总成绩都有所提升的学生是？")])]),t._v(" "),a("p",[t._v("对于问题1来说比较简单，既可以使用聚合函数来统计，也可以使用窗口函数来统计，其中窗口函数给了两种解法：")]),t._v(" "),a("ul",[a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("--使用聚合函数select a.year,a.class,b.studentfrom(select year,class,max(score) as max_scorefrom classgroup by year,class) a join class b on a.year = b.year and a.class = b.class and a.max_score = b.scoreorder by a.year\n")])])]),a("p",[t._v("执行结果如下，如果有相同成绩的话都会保留。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cge06IdYQydF9cXeWKNTs10PeDAk1ibcIpiaCCkMVzPiaGC01YhpwXfCPesWV60aTKwd5lgw9WYibv5ibiaJyuE65Vcg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),t._v(" "),a("ul",[a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("--使用窗口函数maxselect a.year,a.class,a.studentfrom(select year,class,score,student,max(score) over (partition by year,class) as max_score --增加一列为聚合后的最高分    from `class`) a where a.score = max_score  --保留与最高分相同的记录数 \n")])])]),a("p",[t._v("执行结果如下，同样的如果有相同记录也会保留下来。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cge06IdYQydF9cXeWKNTs10PeDAk1ibcI6N9fZLHvq3H5X4pKj8XeV1wYah5O0NuOHpqYOy3TJScdQ55oBicHrbw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),t._v(" "),a("ul",[a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("--使用窗口函数first_valueselect distinct year,class,first_value(student) over (partition by year,class order by score desc) as studentfrom class\n")])])]),a("p",[t._v("执行结果，需要注意的是如果有相同成绩，只会取一条记录。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cge06IdYQydF9cXeWKNTs10PeDAk1ibcIKs7oB5S08fiaMMMD6viaJacgbicvPiavr4aV5ic2rBOtvHkrxVibBf2RlS1g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),t._v(" "),a("p",[t._v("对比两种写法可以发现：")]),t._v(" "),a("p",[a("strong",[t._v("• 使用窗口函数的SQL代码量少")])]),t._v(" "),a("p",[a("strong",[t._v("• 避免了与原表的join")])]),t._v(" "),a("p",[t._v("对于问题2，是一个相对复杂但是比较常见的需求，"),a("strong",[t._v("无法只使用聚合函数来统计，只能配合窗口函数来统计。")])]),t._v(" "),a("ul",[a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li"),t._v(" "),a("li")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("select studentfrom(  select year,student  ,if((sum_score - lag(sum_score,1,0)   over   (    partition by student     order by year  )) > 0,1,0) as flag  ,(sum_score - lag(sum_score,1,0)   over   (partition by student   order by year  )) as flag1  --按照student进行分区并进行year正序排序  --，找到每个学生的上一条学年总成绩  --，并与当年成绩相减，如果小于  --，则将flag值置为1，否则置为0  from  (    select year,student    ,sum(score) as sum_score     --按照学年和学生进行成绩汇总    from class    group by year,student  ) a ) b group by studenthaving avg(flag) = 1 --平均值为1则代表是每年都有增长\n")])])]),a("p",[t._v("执行结果：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_jpg/cge06IdYQydF9cXeWKNTs10PeDAk1ibcIGfCK1Z45p6jGJ4FPNDWsefK3QJLg3kOiaF8E2rDC9UGObdxEic0LAZqA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),t._v(" "),a("p",[t._v("通过上面两个问题，可以对窗口函数的特征做一个简单的小结：")]),t._v(" "),a("p",[a("strong",[t._v("• 聚合函数可以作为窗口函数使用")])]),t._v(" "),a("p",[a("strong",[t._v("• 具有计算和取值的功能")])]),t._v(" "),a("p",[a("strong",[t._v("• 不改变记录数")])]),t._v(" "),a("p",[a("strong",[t._v("什么是窗口函数")])]),t._v(" "),a("p",[t._v("相信看了上面的两个问题后，对窗口函数的使用有一个大概的了解。下面从理论方面来详细了解下窗口函数。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cge06IdYQye9IR2ddRibJCAe9fbFSiaon5cTg6333Q1Yib27hmP1Knw11O45grZkF0icvpVwqZGNTbQF6DqEDZ1vuQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),t._v(" "),a("p",[t._v("理论")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cge06IdYQye9IR2ddRibJCAe9fbFSiaon5cTg6333Q1Yib27hmP1Knw11O45grZkF0icvpVwqZGNTbQF6DqEDZ1vuQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),t._v(" "),a("p",[t._v("窗口函数也称为OLAP（Online Analytical Processing）函数，是对一组值进行操作，"),a("strong",[t._v("不需要使用Group by子句对数据进行分组，还能在同一行返回原来行的列和使用聚合函数得到的聚合列")]),t._v("。")]),t._v(" "),a("p",[t._v("那为什么叫窗口函数呢？"),a("strong",[t._v("因为窗口函数将表以窗口为单位进行分割，并在其中进行各种分析操作，为了让大家快速形成直观印象，才起了这样一个容易理解的名称")]),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"sql语法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sql语法"}},[t._v("#")]),t._v(" SQL语法")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("窗口函数"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("OVER")]),t._v(" \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PARTITION")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("列清单"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("排序用清单列"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ASC")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DESC")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ROWS")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" RANGE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("范围条件"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("如上代码所示，窗口函数的语法分为"),a("strong",[t._v("四个部分")]),t._v("：")]),t._v(" "),a("p",[a("strong",[t._v("函数子句")]),t._v("：指明具体操作，如sum-求和，first_value-取第一个值；")]),t._v(" "),a("p",[a("strong",[t._v("partition by子句")]),t._v("：指明分区字段，如果没有，则将所有数据作为一个分区；")]),t._v(" "),a("p",[a("strong",[t._v("order by子句")]),t._v("：指明了每个分区排序的字段和方式,也是可选的，没有就是按照表中的顺序；")]),t._v(" "),a("p",[a("strong",[t._v("窗口子句")]),t._v("：指明相对当前记录的计算范围，可以向上（preceding），可以向下（following）,也可以使用between指明，上下边界的值，没有的话默认为当前分区。有些场景比较特殊，后文会讲到这种场景。")]),t._v(" "),a("p",[a("strong",[t._v("窗口函数分类")])]),t._v(" "),a("p",[t._v("下面的思维导图基本包含了Hive所有的窗口函数，按照窗口函数的功能分为："),a("strong",[t._v("计算、取值、排序、序列")]),t._v("四种，前三种的使用场景比较常见，容易理解，最后一种(序列)的使用场景比较少。")]),t._v(" "),a("p",[a("a",{attrs:{href:"http://mp.weixin.qq.com/s?__biz=Mzg3NjIyNjQwMg==&mid=2247483677&idx=1&sn=32ddbe9c8747d9cf9a821162bb9de27f&chksm=cf343310f843ba0626f8623283dd4a23dc480788d818f53713ab038f2fd8f2152f08c985507a&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[t._v("点击跳转：SQL分析函数，看这一篇就够了"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"http://mp.weixin.qq.com/s?__biz=Mzg3NjIyNjQwMg==&mid=2247483677&idx=1&sn=32ddbe9c8747d9cf9a821162bb9de27f&chksm=cf343310f843ba0626f8623283dd4a23dc480788d818f53713ab038f2fd8f2152f08c985507a&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cge06IdYQydF9cXeWKNTs10PeDAk1ibcICp9QiaiaQiciam7kfT56wFbvwYnvnRIKT2dYIb1icgr6JCAnAPMbaVRLYsw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),a("OutboundLink")],1)]),t._v(" "),a("p",[a("strong",[t._v("窗口函数使用场景")])]),t._v(" "),a("p",[t._v("介绍了这么多，那窗口函数到底可以帮我们做什么呢？")]),t._v(" "),a("p",[t._v("结合实际场景看看怎么用窗口函数来解决问题。下面针对不同的使用场景，将窗口函数的使用呈现给大家。所有例子的数据均来自下图这张表。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cge06IdYQydF9cXeWKNTs10PeDAk1ibcICHo52KzPaicTUdOibCVITANWCMGfITDUMiaOYQ6Q8VgM8LUQXeEHjibzDQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),t._v(" "),a("h2",{attrs:{id:"用于辅助计算"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#用于辅助计算"}},[t._v("#")]),t._v(" 用于辅助计算")]),t._v(" "),a("p",[t._v("主要的用法是在原有表的基础上，增加一列聚合后的值，辅以后续的计算。")]),t._v(" "),a("p",[t._v("例如：统计出不同产品类型售价最高的产品。")]),t._v(" "),a("p",[t._v("具体代码如下：")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("--使用窗口函数max")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("product_type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("product_name\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" product_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("product_type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("sale_price\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("max")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sale_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("over")]),t._v(" \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("partition")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("by")]),t._v(" product_type\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" max_sale_price \n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("--增加一列为聚合后的最高售价")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" product\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" a \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("where")]),t._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sale_price "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("max_sale_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("--保留与最高售价相同的记录数")]),t._v("\n")])])]),a("p",[t._v("执行结果：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cge06IdYQydF9cXeWKNTs10PeDAk1ibcI3adFGbmpiaIIbvNYky0AGtonazRjGuSa2C00tsr0zzqia76oZBWS6bTA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),t._v(" "),a("p",[a("strong",[t._v("几乎所有的窗口函数都可以用于辅助计算")]),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"累积计算"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#累积计算"}},[t._v("#")]),t._v(" 累积计算")]),t._v(" "),a("p",[t._v("标准聚合函数作为窗口函数配合order by使用，可以实现累积计算。")]),t._v(" "),a("p",[t._v("例如：sum窗口函数配合order by，可以实现累积和。")]),t._v(" "),a("p",[t._v("具体代码如下：")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" product_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("product_name\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("product_type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("sale_price\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("SUM")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sale_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("OVER")]),t._v(" \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" product_id\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" current_sum\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" product"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("执行结果：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cge06IdYQydF9cXeWKNTs10PeDAk1ibcI06f8ibfW9GhjWhVeiaevDKKicgvqgoQkHZYHibFKHX4QqZAEKg0vqhSGjA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),t._v(" "),a("p",[t._v("相应的AVG窗口函数配合order by，可以实现累积平均，max可以实现累积最大值，min可以实现累积最小值，count则可以实现累积计数。注意，"),a("strong",[t._v("只有计算类的窗口函数可以实现累积计算")]),t._v("。")]),t._v(" "),a("p",[a("em",[t._v("这里提出一个问题，为什么增加了order by就可以实现累积计算呢？读者可以停顿思考一下！")])]),t._v(" "),a("p",[a("strong",[t._v("答案马上揭晓")]),t._v("：标准聚合函数作为窗口函数使用的时候，在指明order by的情况下，如果没有Window子句，则Window子句默认为：RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW(上边界不限制，下边界到当前行)。")]),t._v(" "),a("h2",{attrs:{id:"移动计算"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#移动计算"}},[t._v("#")]),t._v(" 移动计算")]),t._v(" "),a("p",[t._v("移动计算是在分区和排序的基础上，对计算范围进一步做出限定。")]),t._v(" "),a("p",[t._v("例如：按照产品ID排序，将最近3条的销售价格进行汇总平均。")]),t._v(" "),a("p",[t._v("具体代码如下：")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" product_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("product_name\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("sale_price\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("AVG")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sale_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" \n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("over")]),t._v(" \n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" \n     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" product_id \n     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rows")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("preceding")]),t._v(" \n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" moving_avg\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" product"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("rows 2 preceding的意思就是“截止到之前2行”。也就是将作为汇总对象的记录限定为如下的"),a("strong",[t._v("最靠近的3行")]),t._v("。")]),t._v(" "),a("p",[t._v("执行结果如下：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cge06IdYQydF9cXeWKNTs10PeDAk1ibcIxpUYLAyickJTxAnOBbKklaZv0Tar9Kv7olibGgPt5Pxl7L8JIp0ltZvA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),t._v(" "),a("p",[t._v("使用关键字FOLLOWING(“之后”）替换PRECEDING，就可以指定"),a("strong",[t._v("截止到之后~行")]),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"取任一字段值"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#取任一字段值"}},[t._v("#")]),t._v(" 取任一字段值")]),t._v(" "),a("p",[t._v("取值的窗口函数有："),a("strong",[t._v("first_value/last_value、lag/lead")]),t._v("，其中first_value和lag在开篇的例子中已经使用到了，这里就不举例说明了。只细化说明下他们的语法。")]),t._v(" "),a("p",[t._v("first_value(字段名)-取出分区中的第一条记录的任意一个字段的值，可以排序也可以不排序，此处也可以进一步指明Window子句。")]),t._v(" "),a("p",[t._v("lag(字段名,N,默认值)-取出当前行之上的第N条记录的任意一个字段的值，这里的N和默认值都是可选的，默认N为1，默认值为null。")]),t._v(" "),a("h2",{attrs:{id:"排序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#排序"}},[t._v("#")]),t._v(" 排序")]),t._v(" "),a("p",[t._v("排序对应的四个窗口函数为："),a("strong",[t._v("rank、dense_rank、row_number、ntitle")])]),t._v(" "),a("p",[t._v("rank：计算排序时，如果存在相同位次的记录，则会跳过之后的位次。")]),t._v(" "),a("p",[t._v("e.g. 有三条记录排在第1位时：1位、1位、1位、4位......")]),t._v(" "),a("p",[t._v("dense_rank：计算排序时，即使存在相同位次的记录，也不会跳过之后的位次。")]),t._v(" "),a("p",[t._v("e.g. 有三条记录排在第1位时：1位、1位、1位、2位......")]),t._v(" "),a("p",[t._v("row_number：赋予唯一的连续位次。")]),t._v(" "),a("p",[t._v("e.g. 有三条记录排在第1位时：1位、2位、3位、4位...")]),t._v(" "),a("p",[t._v("ntitle：用于将分组数据按照顺序切分成n片，返回当前切片值")]),t._v(" "),a("p",[t._v("e.g. 对于一组数字（1，2，3，4，5，6），ntile(2)切片后为（1，1，1，2，2，2）")]),t._v(" "),a("p",[a("strong",[t._v("1）统计所有产品的售价排名")])]),t._v(" "),a("p",[t._v("具体代码如下：")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" product_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("product_type\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("sale_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   RANK "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("OVER")]),t._v(" \n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" sale_price \n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" ranking\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" product"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("执行结果如下：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cge06IdYQydF9cXeWKNTs10PeDAk1ibcIbvWotv5dPNPl3nl6pS4ebpQuS1JlicFZoqqfhR6X8apPIMorsNiauB3g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),t._v(" "),a("p",[a("strong",[t._v("2）统计各产品类型下各产品的售价排名")])]),t._v(" "),a("p",[t._v("具体代码如下：")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" product_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("product_type\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("sale_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   RANK "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("OVER")]),t._v(" \n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PARTITION")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" product_type \n     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" sale_price \n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" ranking\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" product"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("执行结果如下：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cge06IdYQydF9cXeWKNTs10PeDAk1ibcIGZAscbb93FP0xeicSymgjlbFXqgrjaWLSAibDpyQMK012eu8cGVicO7iag/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),t._v(" "),a("p",[t._v("对比一下"),a("strong",[t._v("dense_rank、row_number、ntile")])]),t._v(" "),a("p",[t._v("具体代码如下：")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" product_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("product_type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("sale_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    RANK "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("OVER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" sale_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" ranking"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    DENSE_RANK "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("OVER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" sale_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" dense_ranking"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    ROW_NUMBER "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("OVER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" sale_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" row_num"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    ntile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("OVER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" sale_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" nt1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    ntile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("OVER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" sale_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" nt2 \n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("--切片大于总记录数")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" product"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("执行结果如下：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cge06IdYQydF9cXeWKNTs10PeDAk1ibcInJSB4rR08GmViaL1E4gaqowE6cGhgBYK9GqSp2uWDO35DfFCAYq6N2g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),t._v(" "),a("p",[t._v("从结果可以发现，"),a("strong",[t._v("当ntile(30)中的切片大于了总记录数时，切片的值为记录的序号")]),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"序列"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#序列"}},[t._v("#")]),t._v(" 序列")]),t._v(" "),a("p",[t._v("序列中的两个窗口函数cume_dist和percent_rank，通过实例来看看它们是怎么使用的。")]),t._v(" "),a("p",[a("strong",[t._v("1）统计小于等于当前售价的产品数，所占总产品数的比例")])]),t._v(" "),a("p",[t._v("具体代码如下：")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" product_type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("product_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("sale_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\nCUME_DIST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("OVER")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" sale_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" rn1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\nCUME_DIST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("OVER")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PARTITION")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" product_type \n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" sale_price\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" rn2 \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" product"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("执行结果如下：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cge06IdYQydF9cXeWKNTs10PeDAk1ibcIuEjibiaicGfsicbSwIjHTDZ5clDlLz3RBJ37x5hgJxxwMZ7z1aI88mUPiaw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),t._v(" "),a("p",[t._v("rn1: 没有partition,所有数据均为1组，总行数为8，")]),t._v(" "),a("p",[t._v("第一行：小于等于100的行数为1，因此，1/8=0.125")]),t._v(" "),a("p",[t._v("第二行：小于等于500的行数为3，因此，3/8=0.375")]),t._v(" "),a("p",[t._v("rn2: 按照产品类型分组，product_type=厨房用品的行数为4,")]),t._v(" "),a("p",[t._v("第三行：小于等于500的行数为1，因此，1/4=0.25")]),t._v(" "),a("p",[a("strong",[t._v("2）统计每个产品的百分比排序")])]),t._v(" "),a("p",[t._v("当前行的RANK值-1/分组内总行数-1")]),t._v(" "),a("p",[t._v("具体代码如下：")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" product_type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("product_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("sale_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\npercent_rank"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("OVER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" sale_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" rn1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\npercent_rank"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("OVER")]),t._v(" \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PARTITION")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" product_type \n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" sale_price\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" rn2 \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" product"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("执行结果如下：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/cge06IdYQydF9cXeWKNTs10PeDAk1ibcIB34GSHuib80LdoHVN0hEMAcAsVV2jZbibtkCEpRbB3qyCr7y2cQF7o2g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),t._v(" "),a("p",[t._v("rn1: 没有partition,所有数据均为1组，总行数为8，")]),t._v(" "),a("p",[t._v("第一行：排序为1，因此，（1-1）/（8-1）= 0")]),t._v(" "),a("p",[t._v("第二行：排序为2，因此，（2-1）/（8-1）= 0.14")]),t._v(" "),a("p",[t._v("rn2: 按照产品类型分组，product_type=厨房用品的行数为4,")]),t._v(" "),a("p",[t._v("第三行：排序为1，因此，（1-1）/（4-1）= 0")]),t._v(" "),a("p",[t._v("第四行：排序为1，因此，（2-1）/（4-1）= 0.33")]),t._v(" "),a("p",[a("strong",[t._v("总结")])]),t._v(" "),a("p",[t._v("以上介绍了Hive中窗口函数的几乎所有的使用场景，每种函数的用法也配合代码进行讲解。相信大家看了本文后，在实际数据工作中对于窗口函数的使用肯定会得心应手。")])])}),[],!1,null,null,null);s.default=n.exports}}]);