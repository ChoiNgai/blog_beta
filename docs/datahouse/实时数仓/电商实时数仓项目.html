<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>电商数仓项目 | 大数据技术文档</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="./favicon.ico">
    <meta name="description" content="从入门到入土">
    
    <link rel="preload" href="./assets/css/0.styles.8b017a1a.css" as="style"><link rel="preload" href="./assets/js/app.dbe5dc78.js" as="script"><link rel="preload" href="./assets/js/2.fa5f1a4a.js" as="script"><link rel="preload" href="./assets/js/94.2701ba5d.js" as="script"><link rel="prefetch" href="./assets/js/10.af7e6d14.js"><link rel="prefetch" href="./assets/js/100.f98d6b7c.js"><link rel="prefetch" href="./assets/js/101.3ebb2df2.js"><link rel="prefetch" href="./assets/js/102.bddf26fd.js"><link rel="prefetch" href="./assets/js/103.3c13d131.js"><link rel="prefetch" href="./assets/js/104.76e7b64f.js"><link rel="prefetch" href="./assets/js/105.b8907b13.js"><link rel="prefetch" href="./assets/js/106.26f679d0.js"><link rel="prefetch" href="./assets/js/107.7670ff83.js"><link rel="prefetch" href="./assets/js/108.c620cb38.js"><link rel="prefetch" href="./assets/js/109.394140cc.js"><link rel="prefetch" href="./assets/js/11.99d58157.js"><link rel="prefetch" href="./assets/js/110.8a03d1ab.js"><link rel="prefetch" href="./assets/js/111.709e74df.js"><link rel="prefetch" href="./assets/js/112.e7c7c661.js"><link rel="prefetch" href="./assets/js/113.b9c7ba9e.js"><link rel="prefetch" href="./assets/js/114.45aede8c.js"><link rel="prefetch" href="./assets/js/115.1ad69003.js"><link rel="prefetch" href="./assets/js/116.0f4944de.js"><link rel="prefetch" href="./assets/js/117.338b1f46.js"><link rel="prefetch" href="./assets/js/118.56fa4871.js"><link rel="prefetch" href="./assets/js/119.1374f6e2.js"><link rel="prefetch" href="./assets/js/12.2e190b00.js"><link rel="prefetch" href="./assets/js/120.7e3bde42.js"><link rel="prefetch" href="./assets/js/121.bf4c105b.js"><link rel="prefetch" href="./assets/js/122.9678e246.js"><link rel="prefetch" href="./assets/js/123.4f9c51b8.js"><link rel="prefetch" href="./assets/js/124.6ed32d31.js"><link rel="prefetch" href="./assets/js/125.c1c1f240.js"><link rel="prefetch" href="./assets/js/126.f7dae67d.js"><link rel="prefetch" href="./assets/js/127.aa5de251.js"><link rel="prefetch" href="./assets/js/128.7a097fcd.js"><link rel="prefetch" href="./assets/js/129.62b823c3.js"><link rel="prefetch" href="./assets/js/13.5d4714fa.js"><link rel="prefetch" href="./assets/js/130.04125268.js"><link rel="prefetch" href="./assets/js/131.f93632b5.js"><link rel="prefetch" href="./assets/js/132.8efcb3ab.js"><link rel="prefetch" href="./assets/js/133.045ade7e.js"><link rel="prefetch" href="./assets/js/134.82af04a6.js"><link rel="prefetch" href="./assets/js/135.06de65c0.js"><link rel="prefetch" href="./assets/js/136.3fc5ce45.js"><link rel="prefetch" href="./assets/js/137.ca4e288e.js"><link rel="prefetch" href="./assets/js/138.f8e9409a.js"><link rel="prefetch" href="./assets/js/139.51cc74b3.js"><link rel="prefetch" href="./assets/js/14.cd95effa.js"><link rel="prefetch" href="./assets/js/15.d7a053dc.js"><link rel="prefetch" href="./assets/js/16.241383de.js"><link rel="prefetch" href="./assets/js/17.cdf37f90.js"><link rel="prefetch" href="./assets/js/18.54a8e3ff.js"><link rel="prefetch" href="./assets/js/19.b1f41278.js"><link rel="prefetch" href="./assets/js/20.00809aa4.js"><link rel="prefetch" href="./assets/js/21.ed4af20e.js"><link rel="prefetch" href="./assets/js/22.d70e789f.js"><link rel="prefetch" href="./assets/js/23.4bd4acfc.js"><link rel="prefetch" href="./assets/js/24.b68c0ece.js"><link rel="prefetch" href="./assets/js/25.56ed8a43.js"><link rel="prefetch" href="./assets/js/26.6bcb257f.js"><link rel="prefetch" href="./assets/js/27.c00845f2.js"><link rel="prefetch" href="./assets/js/28.6badc057.js"><link rel="prefetch" href="./assets/js/29.9230aae3.js"><link rel="prefetch" href="./assets/js/3.b52d03f5.js"><link rel="prefetch" href="./assets/js/30.24beb61e.js"><link rel="prefetch" href="./assets/js/31.f2a94727.js"><link rel="prefetch" href="./assets/js/32.a3ba2747.js"><link rel="prefetch" href="./assets/js/33.c524bae4.js"><link rel="prefetch" href="./assets/js/34.163f85b3.js"><link rel="prefetch" href="./assets/js/35.c42df8de.js"><link rel="prefetch" href="./assets/js/36.03d4748a.js"><link rel="prefetch" href="./assets/js/37.07cd39b4.js"><link rel="prefetch" href="./assets/js/38.18db04a1.js"><link rel="prefetch" href="./assets/js/39.c1633a4e.js"><link rel="prefetch" href="./assets/js/4.1d0a3544.js"><link rel="prefetch" href="./assets/js/40.a49e9f5c.js"><link rel="prefetch" href="./assets/js/41.0490672b.js"><link rel="prefetch" href="./assets/js/42.03ff0a41.js"><link rel="prefetch" href="./assets/js/43.7567d202.js"><link rel="prefetch" href="./assets/js/44.e36ca589.js"><link rel="prefetch" href="./assets/js/45.5b0f064d.js"><link rel="prefetch" href="./assets/js/46.11d921c5.js"><link rel="prefetch" href="./assets/js/47.f961d914.js"><link rel="prefetch" href="./assets/js/48.ba14e041.js"><link rel="prefetch" href="./assets/js/49.566ddc43.js"><link rel="prefetch" href="./assets/js/5.cc194294.js"><link rel="prefetch" href="./assets/js/50.b70961ac.js"><link rel="prefetch" href="./assets/js/51.3c084f92.js"><link rel="prefetch" href="./assets/js/52.14662c12.js"><link rel="prefetch" href="./assets/js/53.c40aa86f.js"><link rel="prefetch" href="./assets/js/54.300e2058.js"><link rel="prefetch" href="./assets/js/55.3b06c210.js"><link rel="prefetch" href="./assets/js/56.227ea682.js"><link rel="prefetch" href="./assets/js/57.19a5d767.js"><link rel="prefetch" href="./assets/js/58.7fc8ce3f.js"><link rel="prefetch" href="./assets/js/59.9abc1a7f.js"><link rel="prefetch" href="./assets/js/6.a67b19a4.js"><link rel="prefetch" href="./assets/js/60.21e470b2.js"><link rel="prefetch" href="./assets/js/61.342c1882.js"><link rel="prefetch" href="./assets/js/62.b8d083e4.js"><link rel="prefetch" href="./assets/js/63.d98056bc.js"><link rel="prefetch" href="./assets/js/64.abb48239.js"><link rel="prefetch" href="./assets/js/65.06d2edcf.js"><link rel="prefetch" href="./assets/js/66.11f32f94.js"><link rel="prefetch" href="./assets/js/67.55fb49ed.js"><link rel="prefetch" href="./assets/js/68.6a9fb92c.js"><link rel="prefetch" href="./assets/js/69.ea206161.js"><link rel="prefetch" href="./assets/js/7.4db7fac4.js"><link rel="prefetch" href="./assets/js/70.19b21c67.js"><link rel="prefetch" href="./assets/js/71.6d30915f.js"><link rel="prefetch" href="./assets/js/72.c663480f.js"><link rel="prefetch" href="./assets/js/73.c64a8bc9.js"><link rel="prefetch" href="./assets/js/74.b4853538.js"><link rel="prefetch" href="./assets/js/75.ed723be5.js"><link rel="prefetch" href="./assets/js/76.bd2efea1.js"><link rel="prefetch" href="./assets/js/77.8e8632d7.js"><link rel="prefetch" href="./assets/js/78.69ef8849.js"><link rel="prefetch" href="./assets/js/79.9785ef8d.js"><link rel="prefetch" href="./assets/js/8.eace717d.js"><link rel="prefetch" href="./assets/js/80.5365bfc6.js"><link rel="prefetch" href="./assets/js/81.69b36a86.js"><link rel="prefetch" href="./assets/js/82.aad515c0.js"><link rel="prefetch" href="./assets/js/83.050ac97d.js"><link rel="prefetch" href="./assets/js/84.78bb8c43.js"><link rel="prefetch" href="./assets/js/85.feeffda7.js"><link rel="prefetch" href="./assets/js/86.f38af2cb.js"><link rel="prefetch" href="./assets/js/87.3c875b53.js"><link rel="prefetch" href="./assets/js/88.ccc36d1b.js"><link rel="prefetch" href="./assets/js/89.44e2573e.js"><link rel="prefetch" href="./assets/js/9.3a163afb.js"><link rel="prefetch" href="./assets/js/90.816482fc.js"><link rel="prefetch" href="./assets/js/91.9072f45b.js"><link rel="prefetch" href="./assets/js/92.858235e2.js"><link rel="prefetch" href="./assets/js/93.ef35de87.js"><link rel="prefetch" href="./assets/js/95.666433f2.js"><link rel="prefetch" href="./assets/js/96.f2b93c96.js"><link rel="prefetch" href="./assets/js/97.cb6eb699.js"><link rel="prefetch" href="./assets/js/98.8f172db0.js"><link rel="prefetch" href="./assets/js/99.26797ef8.js">
    <link rel="stylesheet" href="./assets/css/0.styles.8b017a1a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><!----> <span class="site-name">大数据技术文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程基础" class="dropdown-title"><span class="title">编程基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程基础" class="mobile-dropdown-title"><span class="title">编程基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Java基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/java基础语法/" class="nav-link">
  Java基础语法
</a></li><li class="dropdown-subitem"><a href="/./coding-base/" class="nav-link">
  Java基础实战
</a></li></ul></li><li class="dropdown-item"><h4>
          Java进阶(选学)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/java并发编程/java并发编程.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-subitem"><a href="/./coding-base/" class="nav-link">
  Java网络编程
</a></li><li class="dropdown-subitem"><a href="/./coding-base/java集合/Java集合（永盛）.html" class="nav-link">
  Java集合
</a></li><li class="dropdown-subitem"><a href="/./coding-base/java虚拟机/" class="nav-link">
  Java虚拟机
</a></li></ul></li><li class="dropdown-item"><h4>
          计算机基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-subitem"><a href="/./coding-base/数据结构与算法/" class="nav-link">
  数据结构（重要）
</a></li><li class="dropdown-subitem"><a href="/./coding-base/计算机网络/计算机网络（双祥）.html" class="nav-link">
  计算机网络
</a></li><li class="dropdown-subitem"><a href="/./coding-base/操作系统/" class="nav-link">
  操作系统
</a></li></ul></li><li class="dropdown-item"><h4>
          Python（选学）
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/Python/python基础/" class="nav-link">
  Python基础语法
</a></li><li class="dropdown-subitem"><a href="/./coding-base/Python/python库/" class="nav-link">
  Python数据科学库
</a></li></ul></li><li class="dropdown-item"><h4>
          框架（选学）
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/框架/sprin系列/" class="nav-link">
  Spring系列
</a></li><li class="dropdown-subitem"><a href="/./coding-base/框架/flask/falsk.html" class="nav-link">
  Flask
</a></li><li class="dropdown-subitem"><a href="/./coding-base/框架/vue/flask.html" class="nav-link">
  Vue
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./database/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/./database/hbase/" class="nav-link">
  HBase
</a></li><li class="dropdown-item"><!----> <a href="/./database/tidb/" class="nav-link">
  TiDB
</a></li><li class="dropdown-item"><!----> <a href="/./database/clickhouse/" class="nav-link">
  ClickHouse
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据仓库" class="dropdown-title"><span class="title">数据仓库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据仓库" class="mobile-dropdown-title"><span class="title">数据仓库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./datahouse/sql/" class="nav-link">
  SQL
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/大数据基础/bigdata-base.html" class="nav-link">
  大数据基础
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/离线数仓/" class="nav-link">
  离线数仓
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/实时数仓/" class="nav-link">
  实时数仓
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/商业化技术/" class="nav-link">
  商业化技术
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/电商业务/" class="nav-link">
  电商业务
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据框架及组件" class="dropdown-title"><span class="title">大数据框架及组件</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据框架及组件" class="mobile-dropdown-title"><span class="title">大数据框架及组件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./bigdata/hadoop/" class="nav-link">
  Hadoop
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/hive/" class="nav-link">
  Hive
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/zookeeper/" class="nav-link">
  Zookeeper
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/kafka/" class="nav-link">
  kafka
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/spark/" class="nav-link">
  Spark
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/flink/" class="nav-link">
  Flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./other/面经/" class="nav-link">
  面经
</a></li><li class="dropdown-item"><!----> <a href="/./other/机器学习/" class="nav-link">
  机器学习
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/./" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程基础" class="dropdown-title"><span class="title">编程基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程基础" class="mobile-dropdown-title"><span class="title">编程基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Java基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/java基础语法/" class="nav-link">
  Java基础语法
</a></li><li class="dropdown-subitem"><a href="/./coding-base/" class="nav-link">
  Java基础实战
</a></li></ul></li><li class="dropdown-item"><h4>
          Java进阶(选学)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/java并发编程/java并发编程.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-subitem"><a href="/./coding-base/" class="nav-link">
  Java网络编程
</a></li><li class="dropdown-subitem"><a href="/./coding-base/java集合/Java集合（永盛）.html" class="nav-link">
  Java集合
</a></li><li class="dropdown-subitem"><a href="/./coding-base/java虚拟机/" class="nav-link">
  Java虚拟机
</a></li></ul></li><li class="dropdown-item"><h4>
          计算机基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-subitem"><a href="/./coding-base/数据结构与算法/" class="nav-link">
  数据结构（重要）
</a></li><li class="dropdown-subitem"><a href="/./coding-base/计算机网络/计算机网络（双祥）.html" class="nav-link">
  计算机网络
</a></li><li class="dropdown-subitem"><a href="/./coding-base/操作系统/" class="nav-link">
  操作系统
</a></li></ul></li><li class="dropdown-item"><h4>
          Python（选学）
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/Python/python基础/" class="nav-link">
  Python基础语法
</a></li><li class="dropdown-subitem"><a href="/./coding-base/Python/python库/" class="nav-link">
  Python数据科学库
</a></li></ul></li><li class="dropdown-item"><h4>
          框架（选学）
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/框架/sprin系列/" class="nav-link">
  Spring系列
</a></li><li class="dropdown-subitem"><a href="/./coding-base/框架/flask/falsk.html" class="nav-link">
  Flask
</a></li><li class="dropdown-subitem"><a href="/./coding-base/框架/vue/flask.html" class="nav-link">
  Vue
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./database/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/./database/hbase/" class="nav-link">
  HBase
</a></li><li class="dropdown-item"><!----> <a href="/./database/tidb/" class="nav-link">
  TiDB
</a></li><li class="dropdown-item"><!----> <a href="/./database/clickhouse/" class="nav-link">
  ClickHouse
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据仓库" class="dropdown-title"><span class="title">数据仓库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据仓库" class="mobile-dropdown-title"><span class="title">数据仓库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./datahouse/sql/" class="nav-link">
  SQL
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/大数据基础/bigdata-base.html" class="nav-link">
  大数据基础
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/离线数仓/" class="nav-link">
  离线数仓
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/实时数仓/" class="nav-link">
  实时数仓
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/商业化技术/" class="nav-link">
  商业化技术
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/电商业务/" class="nav-link">
  电商业务
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据框架及组件" class="dropdown-title"><span class="title">大数据框架及组件</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据框架及组件" class="mobile-dropdown-title"><span class="title">大数据框架及组件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./bigdata/hadoop/" class="nav-link">
  Hadoop
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/hive/" class="nav-link">
  Hive
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/zookeeper/" class="nav-link">
  Zookeeper
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/kafka/" class="nav-link">
  kafka
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/spark/" class="nav-link">
  Spark
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/flink/" class="nav-link">
  Flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./other/面经/" class="nav-link">
  面经
</a></li><li class="dropdown-item"><!----> <a href="/./other/机器学习/" class="nav-link">
  机器学习
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>实时数仓</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./datahouse/%E5%AE%9E%E6%97%B6%E6%95%B0%E4%BB%93/" aria-current="page" class="sidebar-link">目录</a></li><li><a href="/./datahouse/实时数仓/实时数仓概述.html" class="sidebar-link">实时数仓概述</a></li><li><a href="/./datahouse/实时数仓/kudu.html" class="sidebar-link">Kudu</a></li><li><a href="/./datahouse/实时数仓/电商实时数仓项目.html" class="active sidebar-link">电商数仓项目</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_1-1-数据概览" class="sidebar-link">1.1 数据概览</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#整体概览" class="sidebar-link">整体概览</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#商品概览" class="sidebar-link">商品概览</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#运营看板" class="sidebar-link">运营看板</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#功能看板" class="sidebar-link">功能看板</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#实时统计" class="sidebar-link">实时统计</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_1-2-数据分析" class="sidebar-link">1.2 数据分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#漏斗分析" class="sidebar-link">漏斗分析</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#留存分析" class="sidebar-link">留存分析</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#用户路径" class="sidebar-link">用户路径</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#归因分析" class="sidebar-link">归因分析</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_1-3-用户画像" class="sidebar-link">1.3 用户画像</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_2-1-分层设计思路" class="sidebar-link">2.1 分层设计思路</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_2-2-数仓构建流程" class="sidebar-link">2.2 数仓构建流程</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_2-3-基本概念" class="sidebar-link">2.3 基本概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_2-3-1-业务过程" class="sidebar-link">2.3.1 业务过程</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_2-3-2-划分数据域" class="sidebar-link">2.3.2 划分数据域</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_2-3-3-定义维度与构建总线矩阵" class="sidebar-link">2.3.3 定义维度与构建总线矩阵</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_2-3-4-明确统计指标" class="sidebar-link">2.3.4 明确统计指标</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_2-4-维度模型" class="sidebar-link">2.4 维度模型</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_2-1-mysql的binlog原理" class="sidebar-link">2.1 Mysql的Binlog原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#二进制日志-binlog" class="sidebar-link">二进制日志(binlog)</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#binlog的开启" class="sidebar-link">binlog的开启</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#binlog配置的说明" class="sidebar-link">binlog配置的说明</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_2-2-canal" class="sidebar-link">2.2 Canal</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#canal简介" class="sidebar-link">canal简介</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#canal安装" class="sidebar-link">canal安装</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_3-3-数据采集" class="sidebar-link">3.3 数据采集</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#mysql数据准备" class="sidebar-link">mysql数据准备</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#canal配置" class="sidebar-link">canal配置</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#模拟数据生成" class="sidebar-link">模拟数据生成</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#总结-2" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#功能" class="sidebar-link">功能</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#todo" class="sidebar-link">TODO</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_4-1-什么是用户行为数据" class="sidebar-link">4.1 什么是用户行为数据</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_4-2-用户行为数据的价值" class="sidebar-link">4.2 用户行为数据的价值</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#评估功能的效果" class="sidebar-link">评估功能的效果</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#协助分析问题" class="sidebar-link">协助分析问题</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#了解用户行为路径" class="sidebar-link">了解用户行为路径</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#用户分群" class="sidebar-link">用户分群</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_4-3-用户行为数据采集" class="sidebar-link">4.3 用户行为数据采集</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_5-1-需求分析及实现思路" class="sidebar-link">5.1 需求分析及实现思路</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_5-2-业务数据dwd层设计" class="sidebar-link">5.2 业务数据DWD层设计</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#总结-3" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_6-1-模型设计" class="sidebar-link">6.1 模型设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_6-1-1-选择业务过程" class="sidebar-link">6.1.1 选择业务过程</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_6-1-2-粒度" class="sidebar-link">6.1.2 粒度</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_6-1-3-维度" class="sidebar-link">6.1.3 维度</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_6-1-4-事实" class="sidebar-link">6.1.4 事实</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_6-2-dwd层数据开发" class="sidebar-link">6.2 DWD层数据开发</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_7-1-数据指标体系" class="sidebar-link">7.1 数据指标体系</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#什么是数据指标体系" class="sidebar-link">什么是数据指标体系</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#指标体系生命周期" class="sidebar-link">指标体系生命周期</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#为什么需要数据指标体系" class="sidebar-link">为什么需要数据指标体系</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_7-2-如何设计指标体系" class="sidebar-link">7.2 如何设计指标体系</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_7-2-1-定目标" class="sidebar-link">7.2.1 定目标</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_7-2-2-用分析模型搭建指标体系" class="sidebar-link">7.2.2 用分析模型搭建指标体系</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_7-2-3-场景化搭建指标体系" class="sidebar-link">7.2.3 场景化搭建指标体系</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_7-3-如何管理指标体系" class="sidebar-link">7.3 如何管理指标体系</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_7-3-1-痛点分析" class="sidebar-link">7.3.1 痛点分析</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_7-3-2-管理目标" class="sidebar-link">7.3.2 管理目标</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_7-3-3-模型架构" class="sidebar-link">7.3.3 模型架构</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_7-3-4-指标体系元数据管理" class="sidebar-link">7.3.4 指标体系元数据管理</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_7-4-实时指标定义与模型设计" class="sidebar-link">7.4 实时指标定义与模型设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_7-4-1-实时指标定义" class="sidebar-link">7.4.1 实时指标定义</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_7-4-2-实时数仓dws" class="sidebar-link">7.4.2 实时数仓DWS</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_7-5-实时指标开发" class="sidebar-link">7.5 实时指标开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_7-5-1-flink-sql简单介绍" class="sidebar-link">7.5.1 Flink Sql简单介绍</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_7-5-2-需求" class="sidebar-link">7.5.2 需求</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_7-5-3-数据开发" class="sidebar-link">7.5.3 数据开发</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#实时指标总结" class="sidebar-link">实时指标总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#写在后面" class="sidebar-link">写在后面</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#todo-2" class="sidebar-link">TODO</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_8-1-olap简介" class="sidebar-link">8.1 OLAP简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_8-1-1-什么是olap" class="sidebar-link">8.1.1 什么是OLAP</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_8-1-2-olap的基本操作" class="sidebar-link">8.1.2 OLAP的基本操作</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_8-1-3-olap分类" class="sidebar-link">8.1.3 OLAP分类</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_8-1-4-olap的核心设计" class="sidebar-link">8.1.4 OLAP的核心设计</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_8-1-5-开源rolap产品" class="sidebar-link">8.1.5 开源ROLAP产品</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_8-2-为什么需要olap" class="sidebar-link">8.2 为什么需要OLAP</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#olap实施阶段" class="sidebar-link">OLAP实施阶段</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_8-3-数据分析" class="sidebar-link">8.3 数据分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#事件分析" class="sidebar-link">事件分析</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#漏斗分析-2" class="sidebar-link">漏斗分析</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#留存分析-2" class="sidebar-link">留存分析</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#用户分布分析" class="sidebar-link">用户分布分析</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#用户路径-2" class="sidebar-link">用户路径</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#网页热力分析" class="sidebar-link">网页热力分析</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#app点击分析" class="sidebar-link">APP点击分析</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#间隔分析" class="sidebar-link">间隔分析</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#归因分析-2" class="sidebar-link">归因分析</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#用户属性分析" class="sidebar-link">用户属性分析</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#用户分群-2" class="sidebar-link">用户分群</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#总结-4" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#todo-3" class="sidebar-link">TODO</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#一、数据指标体系" class="sidebar-link">一、数据指标体系</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_1-什么是数据指标体系" class="sidebar-link">1. 什么是数据指标体系？</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_2-为什么需要指标体系" class="sidebar-link">2. 为什么需要指标体系？</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#二、如何设计指标体系" class="sidebar-link">二、如何设计指标体系？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_1-定目标" class="sidebar-link">1. 定目标</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_2-建模型" class="sidebar-link">2. 建模型</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#三、埋点" class="sidebar-link">三、埋点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_1-什么是埋点" class="sidebar-link">1. 什么是埋点</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_2-埋点流程" class="sidebar-link">2. 埋点流程</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_3-如何埋点" class="sidebar-link">3. 如何埋点</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_4-案例-浏览app首页行为埋点" class="sidebar-link">4. 案例：浏览APP首页行为埋点</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_5-案例-支付订单行为埋点" class="sidebar-link">5. 案例：支付订单行为埋点</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#四、数据分析" class="sidebar-link">四、数据分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_1-什么是数据分析" class="sidebar-link">1. 什么是数据分析？</a></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#_2-数据分析方法" class="sidebar-link">2. 数据分析方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#数据模型简介" class="sidebar-link">数据模型简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#event实体" class="sidebar-link">Event实体</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#埋点数据" class="sidebar-link">埋点数据</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/实时数仓/电商实时数仓项目.html#数据整体格式" class="sidebar-link">数据整体格式</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="电商数仓项目"><a href="#电商数仓项目" class="header-anchor">#</a> 电商数仓项目</h1> <blockquote><p>原文链接：https://github.com/fengchi66/realtime-dw</p></blockquote> <h1 id="_0-项目简介"><a href="#_0-项目简介" class="header-anchor">#</a> 0. 项目简介</h1> <p><strong><code>写在前面</code></strong></p> <p>随着数据科学的进步以及处理技术的成熟，业务/开发人员早已不在满足于传统的离线数仓报表或者提前设置好维度与指标的OLAP查询。近些年来，实时场景需求的不断增加，比如实时报表、实时指标、实时OLAP、实时监控等，一方面对实时数据提出了更多的要求，另一方面也促进了实时处理框架的发展，从storm、spark streaming、flink，flink作为目前最热门的实时处理框架，我们将从它开始慢慢揭露实时数仓的秘密。</p> <p>该项目以尚硅谷大数据实时数仓项目为基础，结合电商互联网公司实时数据场景，对项目作了一定的扩展，从实时数仓理论基础开始，试着让读者理解实时数仓，并熟悉互联网领域常见的数据需求，学到有用的技术。时间回到2018年，作为转行入门大数据，当时的学习资源还没这么丰富，最开始在网上找视频看(在这里再次鸣谢尚硅谷)，然后和大部分群友一样，来到一线城市，海投简历...我也将把自己的经历分享给大家</p> <p><strong><code>项目技术栈</code></strong></p> <ul><li>开发语言：Java、Scala、Sql</li> <li>数据库：Mysql</li> <li>数据采集：Canal</li> <li>消息队列：Kafka</li> <li>实时计算：Flink</li> <li>实时OLAP：ClickHouse</li> <li>数据存储：Phoenix、HBase、Redis</li> <li>监控：Prometheus、Grafana</li> <li>实时计算平台：基于Flink Sql、SpringBoot</li> <li>实时数据服务：Spring、SpringBoot</li></ul> <p>如果你对以上某些技术栈并不熟悉，没有关系，我们将会一个一个深入学习。</p> <p><strong><code>一个通用的实时数仓架构</code></strong></p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128000547.png" alt=""></p> <hr> <h1 id="_1-产品需求"><a href="#_1-产品需求" class="header-anchor">#</a> 1. 产品需求</h1> <p>首先需要了解一个互联网公司有哪些常见的数据需求，在公司发展前期，往往是基于需求来驱动数据平台的发展的。这里我们以一个电商互联网为例，借鉴神策数据平台体验demo，了解数据需求。</p> <h2 id="_1-1-数据概览"><a href="#_1-1-数据概览" class="header-anchor">#</a> 1.1 数据概览</h2> <p>也就是通常说的数据大屏，一般来说，大屏包含了一些基础的指标数据。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128002731.png" alt=""></p> <h3 id="整体概览"><a href="#整体概览" class="header-anchor">#</a> 整体概览</h3> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128003209.png" alt=""></p> <p>这里列举了几个基础的指标，包括实时指标与离线指标。</p> <h3 id="商品概览"><a href="#商品概览" class="header-anchor">#</a> 商品概览</h3> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128003223.png" alt=""></p> <h3 id="运营看板"><a href="#运营看板" class="header-anchor">#</a> 运营看板</h3> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128003250.png" alt=""></p> <h3 id="功能看板"><a href="#功能看板" class="header-anchor">#</a> 功能看板</h3> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128003302.png" alt=""></p> <h3 id="实时统计"><a href="#实时统计" class="header-anchor">#</a> 实时统计</h3> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128003312.png" alt=""></p> <h2 id="_1-2-数据分析"><a href="#_1-2-数据分析" class="header-anchor">#</a> 1.2 数据分析</h2> <p>一般是一些OLAP的分析，能够支持用户自定义的维度以及度量值做灵活查询。</p> <h3 id="漏斗分析"><a href="#漏斗分析" class="header-anchor">#</a> 漏斗分析</h3> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128003332.png" alt=""></p> <p>这里就有一个典型的漏斗分析的OLAP需求，是需要实时数仓的支持的。</p> <h3 id="留存分析"><a href="#留存分析" class="header-anchor">#</a> 留存分析</h3> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128003416.png" alt=""></p> <h3 id="用户路径"><a href="#用户路径" class="header-anchor">#</a> 用户路径</h3> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128003451.png" alt=""></p> <h3 id="归因分析"><a href="#归因分析" class="header-anchor">#</a> 归因分析</h3> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128003511.png" alt=""></p> <p>这里就有一个很典型的订单归因分析，比如我们想实时的知道一个用户从打开APP开始到提交订单的转化贡献数据。</p> <h2 id="_1-3-用户画像"><a href="#_1-3-用户画像" class="header-anchor">#</a> 1.3 用户画像</h2> <p><strong>TODO</strong></p> <hr> <h1 id="_2-实时数仓架构"><a href="#_2-实时数仓架构" class="header-anchor">#</a> 2. 实时数仓架构</h1> <p>这里参考滴滴的实时数仓分层设计，其实分层设计思路是通用的，可以按照自己公司的业务基于实现</p> <p><a href="https://mp.weixin.qq.com/s/PdxjNQd7SNx1POv6fVKVmA" target="_blank" rel="noopener noreferrer">实时数仓在滴滴的实践和落地<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="_2-1-分层设计思路"><a href="#_2-1-分层设计思路" class="header-anchor">#</a> 2.1 分层设计思路</h2> <ul><li>ODS: <strong>操作型数据</strong>(Operational Data Store)，指结构与源系统基本保持一致的增量或者全量数据。作为DW数据的一个数据准备区，同时又承担基础数据记录历史变化，之所以保留原始数据和线上原始数据保持一致，方便后期数据核对需要。</li> <li>DWD：数据仓库<strong>明细层数据</strong>(Data Warehouse Detail)。对ODS层数据进行清洗转化，以<strong>业务过程作为建模驱动</strong>，基于每个具体的业务过程特点，构建<strong>最细粒度的明细事实表</strong>。可以结合企业的数据使用特点，基于<strong>维度建模</strong>思想，将明细事实表的某些重要属性字段做适当冗余，也即<strong>宽表化处理</strong>，构建明细宽表。</li> <li>DWS：数据仓库<strong>汇总层数据</strong>(Data Warehouse Summary)，基于指标需求，构建初步<strong>汇总事实表</strong>，一般是宽表。基于上层的应用和产品的指标需求，构建<strong>公共粒度的汇总指标表</strong>。以宽表化手段物理化模型，构建命名规范、口径一致的统计指标，<strong>为上层提供公共指标</strong>。</li> <li>DIM：建立<strong>一致数据分析维表</strong>，可以降低数据计算口径不统一的风险，同时可以方便进行交叉探查。以维度作为建模驱动，基于每个维度的业务含义，通过添加维度属性、关联维度等定义计算逻辑，完成属性定义的过程并建立一致的数据分析维表。</li> <li>ADS：面向应用的<strong>数据服务层</strong>(Application Data Service)。整合汇总成分析某一个主题域的服务数据，面向应用逻辑的数据加工。该层主要<strong>存放数据产品个性化的统计指标数据</strong>，这一层的数据直接对接数据的消费者，是产品、运营等角色可以直接感知理解的一层，大多数这一层的表都可以直接在BI上通过图表的形式直接透出。</li></ul> <h2 id="_2-2-数仓构建流程"><a href="#_2-2-数仓构建流程" class="header-anchor">#</a> 2.2 数仓构建流程</h2> <p>Kimball老爷爷维度建模四部曲：</p> <p><strong>选择业务处理过程 &gt; 定义粒度 &gt; 选择维度 &gt; 确定事实</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128003612.png" alt=""></p> <h2 id="_2-3-基本概念"><a href="#_2-3-基本概念" class="header-anchor">#</a> 2.3 基本概念</h2> <ul><li>业务板块：比数据域更高维度的业务划分方法，适用于庞大的业务系统。</li> <li>数据域：也称为主题域（数据仓库是面向主题的），一般一个业务板块会划分为多个主题域，例如商品域、交易域、物流域等</li> <li>维度：维度建模由Ralph Kimball提出。维度模型主张从分析决策的需求出发构建模型，为分析需求服务。维度是度量的环境，是我们观察业务的角度，用来反映业务的一类属性。属性的集合构成维度，维度也可以称为实体对象。例如，在分析交易过程时，可以通过买家、卖家、商品和时间等维度描述交易发生的环境。</li> <li>属性（维度属性）：维度所包含的表示维度的列称为维度属性。维度属性是查询约束条件、分组和报表标签生成的基本来源，是数据易用性的关键。</li> <li>度量：在维度建模中，将度量称为事实，将环境描述为维度，维度是用于分析事实所需要的多样环境。度量通常为数值型数据，作为事实逻辑表的事实。</li> <li>指标：指标分为原子指标和派生指标。原子指标是基于某一业务事件行为下的度量，是业务定义中不可再拆分的指标，是具有明确业务含义的名词，体现明确的业务统计口径和计算逻辑，例如支付金额。业务限定：统计的业务范围，筛选出符合业务规则的记录（类似于SQL中where后的条件，不包括时间区间）。
<ul><li>原子指标=业务过程+度量。</li> <li>派生指标=时间周期+修饰词+原子指标，派生指标可以理解为对原子指标业务统计范围的圈定。</li></ul></li> <li>统计周期：统计的时间范围，例如最近一天，最近30天等（类似于SQL中where后的时间条件）。</li> <li>统计粒度：统计分析的对象或视角，定义数据需要汇总的程度，可理解为聚合运算时的分组条件（类似于SQL中的group by的对象）。粒度是维度的一个组合，指明您的统计范围。例如，某个指标是某个卖家在某个省份的成交额，则粒度就是卖家、地区这两个维度的组合。如果您需要统计全表的数据，则粒度为全表。在指定粒度时，您需要充分考虑到业务和维度的关系。统计粒度常作为派生指标的修饰词而存在。</li></ul> <p>基本概念之间的关系和举例如下图所示。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128003640.png" alt=""></p> <h3 id="_2-3-1-业务过程"><a href="#_2-3-1-业务过程" class="header-anchor">#</a> 2.3.1 业务过程</h3> <p>业务过程可以概括为一个个<strong>不可拆分的行为事件</strong>。用户的业务系统中，通过埋点或日常积累，通常已经获取了充足的业务数据。为理清数据之间的逻辑关系和流向，首先需要理解用户的业务过程，了解过程中涉及到的数据系统。</p> <p>您可以采用过程分析法，将整个业务过程涉及的每个环节一一列清楚，包括技术、数据、系统环境等。在分析企业的工作职责范围（部门）后，您也可以借助工具通过逆向工程抽取业务系统的真实模型。您可以参考业务规划设计文档以及业务运行（开发、设计、变更等）相关文档，全面分析数据仓库涉及的源系统及业务管理系统：</p> <ul><li>每个业务会生成哪些数据，存在于什么数据库中。</li> <li>对业务过程进行分解，了解过程中的每一个环节会产生哪些数据，数据的内容是什么。</li> <li>数据在什么情况下会更新，更新的逻辑是什么。</li></ul> <p>业务过程可以是单个业务事件，例如交易的支付、退款等；也可以是某个事件的状态，例如当前的账户余额等；还可以是一系列相关业务事件组成的业务流程。具体取决于您分析的是某些事件过去发生情况、当前状态还是事件流转效率。</p> <p>选择粒度：在业务过程事件分析中，您需要预判所有分析需要细分的程度和范围，从而决定选择的粒度。 识别维表、选择好粒度之后，您需要基于此粒度设计维表，包括维度属性等，用于分析时进行分组和筛选。最后，您需要确定衡量的指标。</p> <p>本教程中，经过业务过程调研，我们了解到用户电商营销业务的交易订单功能模块的业务流程如下：</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128004009.png" alt=""></p> <p>这是一个非常典型的电商交易业务流程图。在该业务流程图中，有创建订单、买家付款、卖家发货、确认收货四个核心业务步骤。由于确认收货代表交易成功，我们重点分析确认收货（交易成功）步骤即可。</p> <p>在明确用户的业务过程之后，您可以根据需要对进行分析决策的业务划分数据域。</p> <h3 id="_2-3-2-划分数据域"><a href="#_2-3-2-划分数据域" class="header-anchor">#</a> 2.3.2 划分数据域</h3> <p>数据仓库是面向主题（数据综合、归类并进行分析利用）的应用。数据仓库模型设计除横向的分层外，通常也需要根据业务情况纵向划分数据域。数据域是联系较为紧密的数据主题的集合，是业务对象高度概括的概念，目的是便于管理和应用数据。</p> <p>通常，您需要阅读各源系统的设计文档、数据字典和数据模型，研究逆向导出的物理数据模型。进而，可以进行跨源的主题域合并，跨源梳理出整个企业的数据域。</p> <p>数据域是指面向业务分析，将业务过程或者维度进行抽象的集合。为保障整个体系的生命力，数据域需要抽象提炼，并长期维护更新。在划分数据域时，既能涵盖当前所有的业务需求，又能让新业务在进入时可以被包含进已有的数据域或扩展新的数据域。数据域的划分工作可以在业务调研之后进行，需要分析各个业务模块中有哪些业务活动。</p> <p>数据域可以按照用户企业的部门划分，也可以按照业务过程或者业务板块中的功能模块进行划分。例如A公司电商营销业务板块可以划分为如下数据域，数据域中每一部分都是实际业务过程经过归纳抽象之后得出的。</p> <table><thead><tr><th style="text-align:left;">数据域</th> <th style="text-align:left;">业务过程</th></tr></thead> <tbody><tr><td style="text-align:left;">会员店铺域</td> <td style="text-align:left;">注册、登录、装修、开店、关店</td></tr> <tr><td style="text-align:left;">商品域</td> <td style="text-align:left;">发布、上架、下架、重发</td></tr> <tr><td style="text-align:left;">日志域</td> <td style="text-align:left;">曝光、浏览、单击</td></tr> <tr><td style="text-align:left;">交易域</td> <td style="text-align:left;">下单、支付、发货、确认收货</td></tr> <tr><td style="text-align:left;">服务域</td> <td style="text-align:left;">商品收藏、拜访、培训、优惠券领用</td></tr> <tr><td style="text-align:left;">采购域</td> <td style="text-align:left;">商品采购、供应链管理</td></tr></tbody></table> <h3 id="_2-3-3-定义维度与构建总线矩阵"><a href="#_2-3-3-定义维度与构建总线矩阵" class="header-anchor">#</a> 2.3.3 定义维度与构建总线矩阵</h3> <h4 id="定义维度"><a href="#定义维度" class="header-anchor">#</a> 定义维度</h4> <p>在划分数据域、构建总线矩阵时，需要结合对业务过程的分析定义维度。以本教程中A电商公司的营销业务板块为例，在交易数据域中，我们重点考察确认收货（交易成功）的业务过程。</p> <p>在确认收货的业务过程中，主要有商品和收货地点（本教程中，假设收货和购买是同一个地点）两个维度所依赖的业务角度。从商品维度我们可以定义出以下维度的属性：</p> <ul><li>商品ID（主键）</li> <li>商品名称</li> <li>商品交易价格</li> <li>商品新旧程度： 1 全新 2 闲置 3 二手</li> <li>商品类目ID</li> <li>商品类目名称</li> <li>品类ID</li> <li>品类名称</li> <li>买家ID</li> <li>商品状态： 0 正常 1 删除 2 下架 3 从未上架</li> <li>商品所在城市</li> <li>商品所在省份</li></ul> <p>从地域维度，我们可以定义出以下维度的属性：</p> <ul><li>城市code</li> <li>城市名称</li> <li>省份code</li> <li>省份名称</li></ul> <p>作为维度建模的核心，在企业级数据仓库中必须保证维度的唯一性。以A公司的商品维度为例，有且只允许有一种维度定义。例如，省份code这个维度，对于任何业务过程所传达的信息都是一致的。</p> <h4 id="构建总线矩阵"><a href="#构建总线矩阵" class="header-anchor">#</a> 构建总线矩阵</h4> <p>明确每个数据域下有哪些业务过程后，即可构建总线矩阵。您需要明确业务过程与哪些维度相关，并定义每个数据域下的业务过程和维度。如下所示是A公司电商板块交易功能的总线矩阵，我们定义了购买省份、购买城市、类目名称、类目ID、品牌名称、品牌ID、商品名称、商品ID、成交金额等维度。</p> <table><thead><tr><th>数据域/过程</th> <th>一致性维度</th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th></tr></thead> <tbody><tr><td>购买省份</td> <td>购买城市</td> <td>类目ID</td> <td>类目名称</td> <td>品牌ID</td> <td>品牌名称</td> <td>商品ID</td> <td>商品名称</td> <td>成交金额</td> <td></td> <td></td></tr> <tr><td>交易</td> <td>下单</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>N</td></tr> <tr><td>支付</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>N</td> <td></td></tr> <tr><td>发货</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>N</td> <td></td></tr> <tr><td>确认收货</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td>Y</td> <td></td></tr></tbody></table> <h3 id="_2-3-4-明确统计指标"><a href="#_2-3-4-明确统计指标" class="header-anchor">#</a> 2.3.4 明确统计指标</h3> <h4 id="指标定义注意事项"><a href="#指标定义注意事项" class="header-anchor">#</a> 指标定义注意事项</h4> <p>原子指标是明确的统计口径、计算逻辑： <code>原子指标=业务过程+度量</code>。派生指标即常见的统计指标：<code>派生指标=时间周期+修饰词+原子指标</code>。原子指标的创建需要在业务过程定义后方才可创建。派生指标的创建一般需要在了解具体报表需求之后展开，在新建派生指标前必须新建好原子指标。 注意事项如下：</p> <ul><li>原子指标、修饰类型及修饰词，直接归属在业务过程下，其中修饰词继承修饰类型的数据域。</li> <li>派生指标可以选择多个修饰词，由具体的派生指标语义决定。例如，支付金额为原子指标，则客单价（支付金额除以买家数）为派生指标。</li> <li>派生指标唯一归属一个原子指标，继承原子指标的数据域，与修饰词的数据域无关。</li></ul> <h4 id="根据业务需求确定指标"><a href="#根据业务需求确定指标" class="header-anchor">#</a> 根据业务需求确定指标</h4> <p>本教程中，用户是电商营销部门的营销数据分析师。数据需求为最近一天厨具类目的商品在各省的销售总额、该类目Top10销售额商品名称、各省用户购买力分布（人均消费额）等，用于营销分析。</p> <p>根据之前的分析，我们确认业务过程为：确认收货（交易成功），而度量为商品的销售金额。因此根据业务需求，我们可以定义出原子指标：商品成功交易金额。</p> <p>派生指标为：</p> <ul><li>最近一天全省厨具类目各商品销售总额</li> <li>最近一天全省厨具类目人均消费额（消费总额除以人数）</li></ul> <p>最近一天全省厨具类目各商品销售总额进行降序排序后取前10名的名称，即可得到该类目Top10销售额商品名称。</p> <h2 id="_2-4-维度模型"><a href="#_2-4-维度模型" class="header-anchor">#</a> 2.4 维度模型</h2> <p>维度模型是数据仓库领域 Ralph Kimball 大师倡导的，是数据仓库工程领域最流行的数仓建模经典。</p> <p>维度建模以分析决策的需求出发构建模型，构建的数据模型为分析需求服务，因此它重点解决用户如何更快速完成分析需求，同时还有较好的大规模复杂查询的响应性能。</p> <p>其中典型的代表就是使用星型模型，以及在一些特殊场景下使用的雪花模型。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128010951.png" alt=""></p> <p>其设计主要分为以下几个步骤：</p> <ol><li><strong>选择需要进行分析决策的业务过程</strong>。业务过程可以是单个业务事件，比如交易的支付、退款等；也可以是某个事件的状态，比如当前账户的余额；还有就是一系列相关业务事件组成的业务流程，具体需要我们分析的是某些事件发生的情况，还是当前状态，或是事件流转效率。</li> <li><strong>选择粒度</strong>。在事件分析中，我们要预判所有分析需要细分的程度，从而决定选择的粒度。粒度是维度的一个组合。</li> <li><strong>识别维表</strong>。选择好粒度之后，就需要基于这个粒度来设计维表，包括维度属性，用于分析时进行分组和筛选。</li> <li><strong>选择事实</strong>。确定分析需要衡量的指标。</li></ol> <p>在 Ralph Kimball 提出对数据仓库维度建模，我们将数据仓库中的表划分为事实表、维度表两种类型。</p> <p>针对维度建模中事实表和维度表的设计，之前有详细介绍过，感兴趣的同学可以看：<a href="http://mp.weixin.qq.com/s?__biz=MzU4NjQzNjUxMQ==&amp;mid=2247485764&amp;idx=1&amp;sn=384af210b1e0feaedec465c78ab4fb22&amp;chksm=fdfa13b4ca8d9aa281061450c76d1beef4f0f9ce6e500f56775558bafdd39e172cb122a4dd2e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer"><strong>维度建模技术实践——深入事实表</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <strong>、</strong><a href="http://mp.weixin.qq.com/s?__biz=MzU4NjQzNjUxMQ==&amp;mid=2247485637&amp;idx=1&amp;sn=706a6ed248c62724884e3693302cb37a&amp;chksm=fdfa1235ca8d9b23c586697ae0bf28492c681caa3ab17fb18b92cdf7d17599e01709e30f562f&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer"><strong>维度建模的灵魂所在——维度表设计</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><strong>。</strong></p> <p>在这里，我就以常见的电商场景为例：在一次购买的事件中，涉及主体包括客户、商品、商家，产生的可度量值会包括商品数量、金额、件数等。</p> <p>事实表根据粒度的角色划分不同，可分为事务事实表、周期快照事实表、累积快照事实表等。</p> <ol><li><strong>事务事实表</strong>：用于承载事务数据，任何类型的事件都可以被理解为一种事务，比如商家在交易过程中的常见订单、买家付款，物流过程中的揽货、发货、签收，退款中的申请退款。</li> <li><strong>周期快照事实表</strong>：快照事实表以预定的间隔采样状态度量，比如自然年至今或者历史至今的下单金额、支付金额、支付买家数、支付商品件数等等状态度量。</li> <li><strong>累计快照事实表</strong>：数据不断更新，选取多业务过程日期。用来记录具有时间跨度的业务处理过程的整个过程的信息，每个生命周期一行，通常这类事实表比较少见。</li></ol> <p>我们继续就上述的电商场景，聊聊在维表设计时需要关注的一些东西：</p> <ol><li><strong>缓慢变化维度</strong>：例如会员表的手机号、地址、生日等属性。</li> <li><strong>退化维度</strong> ：订货单表的订单编号、物流表的物流编号等。</li> <li><strong>雪花维度</strong>：满足第三范式的维度关系结构。</li> <li><strong>非规范化扁平维度</strong>：商品维表中产品、品牌、类目、品类等。</li> <li><strong>多层次维度</strong>：地区维度的省、市、区县，商品的类目层级。</li> <li><strong>角色维度</strong>：日期维度在物流中扮演发货日期、送货日期、收获日期等不同角色。</li></ol> <p>接下来就是针对维度建模按照数据的组织类型，可以划分为星型模型、雪花模型、星座模型。</p> <ol><li><strong>星型模型</strong>：星型模型主要是维表和事实表，以事实表为中心，所有维度直接关联在事实表上，呈星型分布。</li></ol> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011004.png" alt=""></p> <ol><li><strong>雪花模型</strong>：在星型模型的基础上，维度表上又关联了其他维度表。这种模型维护成本高，性能方面会差一些。</li></ol> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011013.png" alt=""></p> <ol><li><strong>星座模型</strong>：是对星型模型的扩展延伸，多张事实表共享维度表。实际上数仓模型建设后期，大部分维度建模都是星座模型。</li></ol> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011024.png" alt=""></p> <p>简单总结下就是：</p> <ol><li>星型模型和雪花模型主要区别就是对维度表的拆分。</li> <li>对于雪花模型，维度表的设计更加规范，一般符合3NF，有效降低数据冗余，维度表之间不会相互关联。</li> <li>星型模型，一般采用降维的操作，反规范化，不符合3NF，通过利用冗余来避免模型过于复杂，提高易用性和分析效率，效率相对较高。</li></ol> <hr> <h1 id="_3-业务数据采集"><a href="#_3-业务数据采集" class="header-anchor">#</a> 3. 业务数据采集</h1> <h2 id="_2-1-mysql的binlog原理"><a href="#_2-1-mysql的binlog原理" class="header-anchor">#</a> 2.1 Mysql的Binlog原理</h2> <p>在实时数仓业务数据采集、分析中，往往是通过采集Mysql数据库的Binlog到消息队列中进行实时分析。首先，我们介绍一下什么是Mysql的Binlog</p> <h3 id="二进制日志-binlog"><a href="#二进制日志-binlog" class="header-anchor">#</a> 二进制日志(binlog)</h3> <p>MySQL的二进制日志可以说MySQL最重要的日志了，它记录了所有的 DDL 和DML(除了数据查询语句)语句，以事件形式记录，还包含语句所执行的消耗的时间，MySQL的二进制日志是事务安全型的。</p> <p>的二进制日志是事务安全型的。</p> <ul><li><p>binlog是记录所有<strong>数据库表结构变更</strong>（例如CREATE、ALTER TABLE…）以及<strong>表数据修改</strong>（INSERT、UPDATE、DELETE…）的二进制日志。</p></li> <li><p><strong>binlog不会记录SELECT和SHOW</strong>这类操作，因为这类操作对数据本身并没有修改，但你可以通过查询通用日志来查看MySQL执行过的所有语句。</p></li> <li><p>二进制日志包括两类文件：</p> <ul><li><code>二进制日志索引文件</code>（文件名后缀为.index）用于记录所有的二进制文件</li> <li><code>二进制日志文件</code>（文件名后缀为.00000*）记录数据库所有的DDL和DML(除了数据查询语句)语句事件。</li></ul></li></ul> <p>一般来说，开启二进制日志会有1%的性能损耗，二进制有两个最重要的使用场景:</p> <ul><li><p>其一：MySQL Replication 在 Master 端开启 binlog，Master 把它的二进制日志</p> <p>传递给 slaves 来达到 master-slave 数据一致的目的。</p></li> <li><p>其二：自然就是数据恢复了，通过使用 mysqlbinlog 工具来使恢复数据。</p></li></ul> <h3 id="binlog的开启"><a href="#binlog的开启" class="header-anchor">#</a> binlog的开启</h3> <ul><li><p>登录Mysql后使用下面的命令查看是否开启binlog</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'log_%'</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>如果看到以下日志说明没有开启binlog</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011032.png" alt=""></p></li> <li><p>编辑配置文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vim</span> /etc/my.cnf
</code></pre></div></li> <li><p>配置文件中增加以下内容</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
log-bin<span class="token operator">=</span>mysql-bin <span class="token comment"># 开启 binlog</span>
binlog-format<span class="token operator">=</span>ROW <span class="token comment"># 选择 ROW 模式</span>
<span class="token assign-left variable">server_id</span><span class="token operator">=</span><span class="token number">1</span> <span class="token comment"># 配置 MySQL replaction 需要定义，不要和 canal 的 slaveId 重复</span>
</code></pre></div></li> <li><p>重启mysql后查看<code>show variables like 'log_%';</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code>mysql<span class="token operator">&gt;</span> show variables like <span class="token string">'log_%'</span><span class="token punctuation">;</span>
+----------------------------------------+----------------------------------------+
<span class="token operator">|</span> Variable_name                          <span class="token operator">|</span> Value                                  <span class="token operator">|</span>
+----------------------------------------+----------------------------------------+
<span class="token operator">|</span> log_bin                                <span class="token operator">|</span> ON                                     <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_basename                       <span class="token operator">|</span> /usr/local/mysql/data/mysql-bin        <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_index                          <span class="token operator">|</span> /usr/local/mysql/data/mysql-bin.index  <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_trust_function_creators        <span class="token operator">|</span> OFF                                    <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_use_v1_row_events              <span class="token operator">|</span> OFF                                    <span class="token operator">|</span>
<span class="token operator">|</span> log_error                              <span class="token operator">|</span> /usr/local/mysql/data/mysqld.local.err <span class="token operator">|</span>
</code></pre></div></li> <li><p>授权 canal 链接 MySQL 账号具有作为 MySQL slave 的权限,</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> canal IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'canal'</span><span class="token punctuation">;</span>  
<span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span><span class="token punctuation">,</span> <span class="token keyword">REPLICATION</span> SLAVE<span class="token punctuation">,</span> <span class="token keyword">REPLICATION</span> CLIENT <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'canal'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>
<span class="token comment">-- GRANT ALL PRIVILEGES ON *.* TO 'canal'@'%' ;</span>
FLUSH <span class="token keyword">PRIVILEGES</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>查看配置是否成功</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">show</span> master <span class="token keyword">status</span><span class="token punctuation">;</span>
</code></pre></div><p>如果打印以下内容，则说明配置成功</p> <div class="language-shell extra-class"><pre class="language-shell"><code>mysql<span class="token operator">&gt;</span> show master status<span class="token punctuation">;</span>
+------------------+----------+--------------+------------------+-------------------+
<span class="token operator">|</span> File             <span class="token operator">|</span> Position <span class="token operator">|</span> Binlog_Do_DB <span class="token operator">|</span> Binlog_Ignore_DB <span class="token operator">|</span> Executed_Gtid_Set <span class="token operator">|</span>
+------------------+----------+--------------+------------------+-------------------+
<span class="token operator">|</span> mysql-bin.000002 <span class="token operator">|</span>      <span class="token number">885</span> <span class="token operator">|</span>              <span class="token operator">|</span>                  <span class="token operator">|</span>                   <span class="token operator">|</span>
+------------------+----------+--------------+------------------+-------------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre></div></li></ul> <h3 id="binlog配置的说明"><a href="#binlog配置的说明" class="header-anchor">#</a> binlog配置的说明</h3> <p>mysql binlog 的格式有三种，分别是 <code>STATEMENT,MIXED,ROW</code>。</p> <p>在配置文件中可以选择配置</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token assign-left variable">binlog_format</span><span class="token operator">=</span> statement<span class="token operator">|</span>mixed<span class="token operator">|</span>row
</code></pre></div><ul><li><strong>statement</strong>：语句级，binlog 会记录每次一执行写操作的语句,相对 row 模式节省空间，但是可能产生不一致性，比<code>·update tt set create_date=now()</code>如果用 binlog 日志进行恢复，由于执行时间不同可能产生的数据就不同。优点是节省空间缺点则是，有可能造成数据不一致。</li> <li><strong>row</strong>：行级， binlog 会记录每次操作后每行记录的变化。优点是保持数据的绝对一致性，因为不管 sql 是什么，引用了什么函数，他只记录执行后的效果。缺点则是会占用较大空间。</li> <li><strong>mixed</strong>：statement 的升级版，一定程度上解决了，因为一些情况而造成的 statement 模式不一致问题，默认还是statement，在某些情况下譬如：当函数中包含 UUID() 时；包含 AUTO_INCREMENT 字段的表被更新时；执行 INSERT DELAYED 语句时；用 UDF 时；都会按照 ROW 的方式进行处理</li> <li>生产环境开启binlog提供实时分析能力，一般采用<strong>row</strong>模式</li></ul> <h2 id="_2-2-canal"><a href="#_2-2-canal" class="header-anchor">#</a> 2.2 Canal</h2> <blockquote><p><strong>canal安装、配置可以先阅读canal官方文档</strong></p> <ul><li><a href="https://github.com/alibaba/canal/wiki/QuickStart" target="_blank" rel="noopener noreferrer">QuickStart<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/alibaba/canal/wiki/ClientExample" target="_blank" rel="noopener noreferrer">ClientExample<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/alibaba/canal/wiki/Canal-Kafka-RocketMQ-QuickStart" target="_blank" rel="noopener noreferrer">Canal-Kafka-RocketMQ-QuickStart<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></blockquote> <h3 id="canal简介"><a href="#canal简介" class="header-anchor">#</a> canal简介</h3> <p>实时数据分析中常常有实时分析处理MySQL中的增量数据的需求，面对这种需求当然我们可以通过JDBC的方式定时查询Mysql，然后再对查询到的数据进行处理也能得到预期的结果，但是Mysql往往还有其他业务也在使用，这些业务往往比较重要，通过JDBC方式频繁查询会对Mysql造成大量无形的压力，甚至可能会影响正常业务的使用，在基本不影响其他Mysql正常使用的情况下完成对增量数据的处理，那就需要 Canal 了。</p> <p>当前目前社区有很多采集数据库中增量数据的工具，比如Debezium、Canal、Maxwell，Flink社区也专门开发了专门的connector format，的鉴于目前社区的活跃度，我们暂重点调研canal。</p> <p>Canal [kə'næl] 是阿里巴巴开源的纯java开发的基于数据库binlog的增量订阅&amp;消费组件。Canal的原理是模拟为一个Mysql slave的交互协议，伪装自己为MySQL slave，向Mysql Master发送dump协议，然后Mysql master接收到这个请求后将binary log推送给slave(也就是Canal)，Canal解析binary log对象(原始为 byte 流)。</p> <p><strong>当前的 canal 支持源端 MySQL 版本包括 5.1.x , 5.5.x , 5.6.x , 5.7.x , 8.0.x</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011045.png" alt=""></p> <h3 id="canal安装"><a href="#canal安装" class="header-anchor">#</a> canal安装</h3> <p>关于canal等组件的安装，为了方便快速测试，我们暂时在mac/linux文件系统下直接安装，后期再用docker-compose打包安装。</p> <p>Canal的server mode在1.1.x版本支持的有TPC、Kafka、RocketMQ。本次安装的canal版本为1.1.4，Canal版本最后在1.1.4之后，并且canal在1.1.4版本引入了canal-admin工程，支持面向WebUI的canal管理能力。server端采用MQ模式，MQ选用Kafka。服务器系统为Centos7，其他环境为：jdk8、Scala 2.11、Mysql、Zookeeper、Kafka。</p> <h4 id="mysql环境准备"><a href="#mysql环境准备" class="header-anchor">#</a> mysql环境准备</h4> <p>在此之前我们已经安装好了mysql并开启了binlog，并且授予了canal具有MySQL slave的权限。</p> <h4 id="下载canal"><a href="#下载canal" class="header-anchor">#</a> 下载canal</h4> <ul><li><p>访问Canal的Release页 canal v1.1.2</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">wget</span> https://github.com/alibaba/canal/releases/download/canal-1.1.4/canal.deployer-1.1.4.tar.gz
</code></pre></div></li> <li><p>解压缩</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mkdir</span> /opt/module/canal
<span class="token function">tar</span> zxvf canal.deployer-1.1.4.tar.gz -C /opt/module/canal
</code></pre></div><ul><li><p>解压完成后，进入 /opt/module/canal 目录，可以看到如下结构</p> <div class="language-shell extra-class"><pre class="language-shell"><code>drwxr-xr-x   <span class="token number">6</span> root  wheel   <span class="token number">192</span> Apr  <span class="token number">1</span> <span class="token number">22</span>:52 bin/
drwxr-xr-x   <span class="token number">8</span> root  wheel   <span class="token number">256</span> Apr  <span class="token number">1</span> <span class="token number">22</span>:52 conf/
drwxr-xr-x  <span class="token number">83</span> root  wheel  <span class="token number">2656</span> Apr  <span class="token number">1</span> <span class="token number">22</span>:52 lib/
drwxrwxrwx   <span class="token number">2</span> root  wheel    <span class="token number">64</span> Sep  <span class="token number">2</span>  <span class="token number">2019</span> logs/
</code></pre></div></li></ul></li> <li><p>修改instance 配置文件，修改如下项，其他默认即可</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> conf/example/instance.properties
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## mysql serverId , v1.0.26+ will autoGen ， 不要和server_id重复</span>
canal.instance.mysql.slaveId<span class="token operator">=</span><span class="token number">3</span>

<span class="token comment"># position info。Mysql的url</span>
canal.instance.master.address<span class="token operator">=</span>node1:3306

<span class="token comment"># table meta tsdb info</span>
canal.instance.tsdb.enable<span class="token operator">=</span>false

<span class="token comment"># 这里配置前面在Mysql分配的用户名和密码</span>
canal.instance.dbUsername<span class="token operator">=</span>canal
canal.instance.dbPassword<span class="token operator">=</span>canal
canal.instance.connectionCharset<span class="token operator">=</span>UTF-8
<span class="token comment"># enable druid Decrypt database password</span>
canal.instance.enableDruid<span class="token operator">=</span>false

<span class="token comment"># 配置过滤的正则表达式，监测canal_test库下的所有表</span>
canal.instance.filter.regex<span class="token operator">=</span>canal_test<span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token punctuation">..</span>*

<span class="token comment"># 配置MQ</span>
<span class="token comment">## 配置上在Kafka创建的那个Topic名字</span>
canal.mq.topic<span class="token operator">=</span>canal_test
<span class="token comment">## 配置分区编号为1</span>
canal.mq.partition<span class="token operator">=</span><span class="token number">1</span>
</code></pre></div></li> <li><p>修改canal.properties配置文件，修改如下项，其他默认即可</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vim</span> <span class="token variable">$CANAL_HOME</span>/conf/canal.properties
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 这个是如果开启的是tcp模式，会占用这个11111端口，canal客户端通过这个端口获取数据</span>
canal.port <span class="token operator">=</span> <span class="token number">11111</span>

<span class="token comment"># 可以配置为：tcp, kafka, RocketMQ，这里配置为kafka</span>
canal.serverMode <span class="token operator">=</span> kafka

<span class="token comment"># 这里将这个注释掉，否则启动会有一个警告</span>
<span class="token comment">#canal.instance.tsdb.spring.xml = classpath:spring/tsdb/h2-tsdb.xml</span>

<span class="token comment">##################################################</span>
<span class="token comment">#########              MQ              #############</span>
<span class="token comment">##################################################</span>
canal.mq.servers <span class="token operator">=</span> node1:9092,node2:9092,node3:9092
canal.mq.retries <span class="token operator">=</span> <span class="token number">0</span>
canal.mq.batchSize <span class="token operator">=</span> <span class="token number">16384</span>
canal.mq.maxRequestSize <span class="token operator">=</span> <span class="token number">1048576</span>
canal.mq.lingerMs <span class="token operator">=</span> <span class="token number">1</span>
canal.mq.bufferMemory <span class="token operator">=</span> <span class="token number">33554432</span>

Canal的batch size, 默认50K, 由于kafka最大消息体限制请勿超过1M<span class="token punctuation">(</span>900K以下<span class="token punctuation">)</span>
canal.mq.canalBatchSize <span class="token operator">=</span> <span class="token number">50</span>
<span class="token comment"># Canal get数据的超时时间, 单位: 毫秒, 空为不限超时</span>
canal.mq.canalGetTimeout <span class="token operator">=</span> <span class="token number">100</span>
<span class="token comment"># 是否为flat json格式对象</span>
canal.mq.flatMessage <span class="token operator">=</span> <span class="token boolean">true</span>
canal.mq.compressionType <span class="token operator">=</span> none
canal.mq.acks <span class="token operator">=</span> all
<span class="token comment"># kafka消息投递是否使用事务</span>
<span class="token comment">#canal.mq.transaction = false</span>
</code></pre></div></li> <li><p>启动canal instance</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token variable">$CANAL_HOME</span>/bin/startup.sh
</code></pre></div></li> <li><p>验证 查看日志：启动后会在logs下生成两个日志文件：<code>logs/canal/canal.log</code>、<code>logs/example/example.log</code>，查看这两个日志，保证没有报错日志。如果是在虚拟机安装，最好给2个核数以上。确保登陆的系统的hostname可以ping通。</p></li> <li><p>在Mysql数据库中进行增删改查的操作，然后查看Kafka的topic为 canal_test 的数据</p> <div class="language-shell extra-class"><pre class="language-shell"><code>bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --from-beginning --topic canal_test
</code></pre></div></li> <li><p>如果在kafka中能看到正确格式的数据，则说明canal已经配置、部署成功了</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">{</span><span class="token string">&quot;data&quot;</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;flink&quot;</span>,<span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>,<span class="token string">&quot;database&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;canal_test&quot;</span>,<span class="token string">&quot;es&quot;</span>:1617352427000,<span class="token string">&quot;id&quot;</span>:1,<span class="token string">&quot;isDdl&quot;</span>:false,<span class="token string">&quot;mysqlType&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;varchar(20)&quot;</span>,<span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;int&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;old&quot;</span>:null,<span class="token string">&quot;pkNames&quot;</span>:null,<span class="token string">&quot;sql&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;&quot;</span>,<span class="token string">&quot;sqlType&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span>:12,<span class="token string">&quot;age&quot;</span>:4<span class="token punctuation">}</span>,<span class="token string">&quot;table&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;student&quot;</span>,<span class="token string">&quot;ts&quot;</span>:1617352427677,<span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;INSERT&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;data&quot;</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;flink&quot;</span>,<span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>,<span class="token string">&quot;database&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;canal_test&quot;</span>,<span class="token string">&quot;es&quot;</span>:1617352569000,<span class="token string">&quot;id&quot;</span>:2,<span class="token string">&quot;isDdl&quot;</span>:false,<span class="token string">&quot;mysqlType&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;varchar(20)&quot;</span>,<span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;int&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;old&quot;</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>,<span class="token string">&quot;pkNames&quot;</span>:null,<span class="token string">&quot;sql&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;&quot;</span>,<span class="token string">&quot;sqlType&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span>:12,<span class="token string">&quot;age&quot;</span>:4<span class="token punctuation">}</span>,<span class="token string">&quot;table&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;student&quot;</span>,<span class="token string">&quot;ts&quot;</span>:1617352569291,<span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;UPDATE&quot;</span><span class="token punctuation">}</span>
</code></pre></div></li></ul> <blockquote><h4 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h4> <p>以上我们简单的安装部署了canal-server服务，并将mysql-binlog的数据通过canal采集成功发送到了kafka，以后的开发可以基于这个demo。但一般生产环境，一般不会在服务器上去编写我们业务的配置的，后续会基于docker来安装部署canal-admin、canal-server。</p> <blockquote><p>关于canal-admin、canal-server，请先阅读官方文档。</p> <ul><li><a href="https://github.com/alibaba/canal/wiki/Canal-Admin-QuickStart" target="_blank" rel="noopener noreferrer">canal-admin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></blockquote></blockquote> <h2 id="_3-3-数据采集"><a href="#_3-3-数据采集" class="header-anchor">#</a> 3.3 数据采集</h2> <h3 id="mysql数据准备"><a href="#mysql数据准备" class="header-anchor">#</a> mysql数据准备</h3> <ul><li><p><strong>创建数据库</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> gmall2021<span class="token punctuation">;</span>
</code></pre></div></li> <li><p><strong>导入建表数据</strong></p> <ul><li><p><a href="collections/src/main/resources/sales/gmall2020_12_08.sql">建表脚本</a></p></li> <li><p>执行建表脚本后，可以在mysql中看到以下47张业务表:</p> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------------------+</span>
<span class="token operator">|</span> Tables_in_gmall2021    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------+</span>
<span class="token operator">|</span> activity_info          <span class="token operator">|</span>
<span class="token operator">|</span> activity_rule          <span class="token operator">|</span>
<span class="token operator">|</span> activity_sku           <span class="token operator">|</span>
<span class="token operator">|</span> base_attr_info         <span class="token operator">|</span>
<span class="token operator">|</span> base_attr_value        <span class="token operator">|</span>
<span class="token operator">|</span> base_category1         <span class="token operator">|</span>
<span class="token operator">|</span> base_category2         <span class="token operator">|</span>
<span class="token operator">|</span> base_category3         <span class="token operator">|</span>
<span class="token operator">|</span> base_category_view     <span class="token operator">|</span>
<span class="token operator">|</span> base_dic               <span class="token operator">|</span>
<span class="token operator">|</span> base_frontend_param    <span class="token operator">|</span>
<span class="token operator">|</span> base_province          <span class="token operator">|</span>
<span class="token operator">|</span> base_region            <span class="token operator">|</span>
<span class="token operator">|</span> base_sale_attr         <span class="token operator">|</span>
<span class="token operator">|</span> base_trademark         <span class="token operator">|</span>
<span class="token operator">|</span> cart_info              <span class="token operator">|</span>
<span class="token operator">|</span> cms_banner             <span class="token operator">|</span>
<span class="token operator">|</span> comment_info           <span class="token operator">|</span>
<span class="token operator">|</span> coupon_info            <span class="token operator">|</span>
<span class="token operator">|</span> coupon_range           <span class="token operator">|</span>
<span class="token operator">|</span> coupon_use             <span class="token operator">|</span>
<span class="token operator">|</span> favor_info             <span class="token operator">|</span>
<span class="token operator">|</span> financial_sku_cost     <span class="token operator">|</span>
<span class="token operator">|</span> order_detail           <span class="token operator">|</span>
<span class="token operator">|</span> order_detail_activity  <span class="token operator">|</span>
<span class="token operator">|</span> order_detail_coupon    <span class="token operator">|</span>
<span class="token operator">|</span> order_info             <span class="token operator">|</span>
<span class="token operator">|</span> order_refund_info      <span class="token operator">|</span>
<span class="token operator">|</span> order_status_log       <span class="token operator">|</span>
<span class="token operator">|</span> payment_info           <span class="token operator">|</span>
<span class="token operator">|</span> refund_payment         <span class="token operator">|</span>
<span class="token operator">|</span> seckill_goods          <span class="token operator">|</span>
<span class="token operator">|</span> sku_attr_value         <span class="token operator">|</span>
<span class="token operator">|</span> sku_image              <span class="token operator">|</span>
<span class="token operator">|</span> sku_info               <span class="token operator">|</span>
<span class="token operator">|</span> sku_sale_attr_value    <span class="token operator">|</span>
<span class="token operator">|</span> spu_image              <span class="token operator">|</span>
<span class="token operator">|</span> spu_info               <span class="token operator">|</span>
<span class="token operator">|</span> spu_poster             <span class="token operator">|</span>
<span class="token operator">|</span> spu_sale_attr          <span class="token operator">|</span>
<span class="token operator">|</span> spu_sale_attr_value    <span class="token operator">|</span>
<span class="token operator">|</span> user_address           <span class="token operator">|</span>
<span class="token operator">|</span> user_info              <span class="token operator">|</span>
<span class="token operator">|</span> ware_info              <span class="token operator">|</span>
<span class="token operator">|</span> ware_order_task        <span class="token operator">|</span>
<span class="token operator">|</span> ware_order_task_detail <span class="token operator">|</span>
<span class="token operator">|</span> ware_sku               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------+</span>
<span class="token number">47</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre></div></li></ul></li></ul> <h3 id="canal配置"><a href="#canal配置" class="header-anchor">#</a> canal配置</h3> <p><a href="collections/src/main/resources/canal/conf"><strong>配置文件路径</strong></a></p> <p>基于我们前面的canal配置，已经实现了采集myql的binlog数据到kafka的demo。现在实现将上述表的binlog采集到kafka。</p> <ul><li><p>修改instance 配置文件，修改如下项，其他默认即可</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## mysql serverId , v1.0.26+ will autoGen，不要和server_id重复</span>
canal.instance.mysql.slaveId<span class="token operator">=</span><span class="token number">3</span>

<span class="token comment">#配置Mysql的url</span>
canal.instance.master.address<span class="token operator">=</span>localhost:3306

<span class="token comment"># table meta tsdb info</span>
canal.instance.tsdb.enable<span class="token operator">=</span>false

<span class="token comment"># 这里配置前面在Mysql分配的用户名和密码</span>
canal.instance.dbUsername<span class="token operator">=</span>canal
canal.instance.dbPassword<span class="token operator">=</span>canal
canal.instance.connectionCharset<span class="token operator">=</span>UTF-8
<span class="token comment"># enable druid Decrypt database password</span>
canal.instance.enableDruid<span class="token operator">=</span>false

<span class="token comment"># 配置过滤的正则表达式，监测canal_test库下的所有表</span>
canal.instance.filter.regex<span class="token operator">=</span>gmall2021.*<span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token punctuation">..</span>*

<span class="token comment"># 配置MQ</span>
<span class="token comment">## 配置上在Kafka创建的那个Topic名字</span>
canal.mq.topic<span class="token operator">=</span>canal_test
<span class="token comment">## 根据表名，动态生成Topic</span>
canal.mq.dynamicTopic<span class="token operator">=</span>.*<span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token punctuation">..</span>*
<span class="token comment">## 配置分区编号为0</span>
canal.mq.partition<span class="token operator">=</span><span class="token number">0</span>
<span class="token comment"># hash partition config</span>
canal.mq.partitionsNum<span class="token operator">=</span><span class="token number">1</span>
<span class="token comment">## 基于数据库主键做hash分区</span>
canal.mq.partitionHash<span class="token operator">=</span>.*<span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token punctuation">..</span>*:<span class="token variable">$pk</span>$
</code></pre></div></li> <li><p>修改canal.properties配置文件，修改如下项，其他默认即可</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 这个是如果开启的是tcp模式，会占用这个11111端口，canal客户端通过这个端口获取数据</span>
canal.port <span class="token operator">=</span> <span class="token number">11111</span>

<span class="token comment"># 可以配置为：tcp, kafka, RocketMQ，这里配置为kafka</span>
canal.serverMode <span class="token operator">=</span> kafka

canal.mq.servers <span class="token operator">=</span> localhost:9092
canal.mq.retries <span class="token operator">=</span> <span class="token number">0</span>
canal.mq.batchSize <span class="token operator">=</span> <span class="token number">16384</span>
canal.mq.maxRequestSize <span class="token operator">=</span> <span class="token number">1048576</span>
canal.mq.lingerMs <span class="token operator">=</span> <span class="token number">1</span>
canal.mq.bufferMemory <span class="token operator">=</span> <span class="token number">33554432</span>

Canal的batch size, 默认50K, 由于kafka最大消息体限制请勿超过1M<span class="token punctuation">(</span>900K以下<span class="token punctuation">)</span>
canal.mq.canalBatchSize <span class="token operator">=</span> <span class="token number">50</span>
<span class="token comment"># Canal get数据的超时时间, 单位: 毫秒, 空为不限超时</span>
canal.mq.canalGetTimeout <span class="token operator">=</span> <span class="token number">100</span>
<span class="token comment"># 是否为flat json格式对象</span>
canal.mq.flatMessage <span class="token operator">=</span> <span class="token boolean">true</span>
canal.mq.compressionType <span class="token operator">=</span> none
canal.mq.acks <span class="token operator">=</span> all
</code></pre></div></li> <li><p>启动canal-instance后，查看kafka topic</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011104.png" alt=""></p></li></ul> <p>已经成功将<code>gmall2021</code>库下的所有表的binlog采集到kafka</p> <h3 id="模拟数据生成"><a href="#模拟数据生成" class="header-anchor">#</a> 模拟数据生成</h3> <ul><li>数据生成的jar包以及配置文件</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011113.png" alt=""></p> <ul><li>修改 application.properties 中数据库连接信息</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011122.png" alt=""></p> <ul><li><p>java命令的方式运行jar包，查看运行日志</p> <div class="language-shell extra-class"><pre class="language-shell"><code>--------开始生成数据--------
--------开始生成用户数据--------
共有786名用户发生变更
共生成1000名用户
--------开始生成收藏数据--------
共生成收藏100条
--------开始生成购物车数据--------
共生成购物车12681条
--------开始生成订单数据--------
共优惠券3000张
共生成订单2680条
共有403订单参与活动条
共有169订单参与活动条
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre></div></li> <li><p>查看canal日志、kafka topic等，正常的情况下在kafka对应的topic中有对应的数据产生</p></li></ul> <blockquote><h2 id="总结-2"><a href="#总结-2" class="header-anchor">#</a> 总结</h2> <h3 id="功能"><a href="#功能" class="header-anchor">#</a> 功能</h3> <ul><li>mysql binlog的了解以及如何开启binlog</li> <li>canal-server的下载安装，以及采集binlog数据到kafka的配置</li> <li>模拟数据生成，canal-instance采集</li></ul> <h3 id="todo"><a href="#todo" class="header-anchor">#</a> TODO</h3> <ul><li>基于容器环境安装部署canal-admin以及canal-server</li></ul></blockquote> <hr> <h1 id="_4-用户行为数据dwd层"><a href="#_4-用户行为数据dwd层" class="header-anchor">#</a> 4. 用户行为数据DWD层</h1> <p>​	主要是用户在使用web端网页、App、小程序的过程中,与客户端产品交互过程中产生的数据,比如页面浏览、点击、停留、评论、点赞、收藏等。用户行为数据测采集往往涉及到前端埋点技术，关于如何埋点，这里不做过多介绍，主要介绍从产品/数据开发/数据分析的角度介绍什么是用户行为数据以及用户行为数据的价值。</p> <h2 id="_4-1-什么是用户行为数据"><a href="#_4-1-什么是用户行为数据" class="header-anchor">#</a> 4.1 什么是用户行为数据</h2> <p>用户使用产品，是通过一系列与产品的交互行为来完成的，且每一次的交互都有特定的操作对象，比如浏览某个商品详情、点击提交订单按钮、输入搜索词、滑动视频等。通过这些交互行为，用户完成对产品的使用并进一步转化。</p> <p>将用户在产品中的交互行为及交互对象转化为可以存储的数据形式，我们便得到了用户行为数据。</p> <h2 id="_4-2-用户行为数据的价值"><a href="#_4-2-用户行为数据的价值" class="header-anchor">#</a> 4.2 用户行为数据的价值</h2> <p>用户行为数据记录了用户在产品中进行的操作，以及具体的操作对象，反映了用户如何使用产品。在日常工作中，通过对行为数据进行分析，可应用于以下几个方面：</p> <ul><li><strong>评估功能的效果</strong></li> <li><strong>协助分析问题</strong></li> <li><strong>了解用户行为路径</strong></li> <li><strong>用户分群</strong></li></ul> <h3 id="评估功能的效果"><a href="#评估功能的效果" class="header-anchor">#</a> 评估功能的效果</h3> <p>功能上线后，需要对功能的效果进行评估。比如，功能触达了多少用户、有多少用户使用等。用户行为数据，作为记录并量化用户如何使用产品的一种形式，可以用来评估功能效果。</p> <p>注：这里的功能，泛指对产品进行的任何尝试，而不仅是需要开发的代码功能。比如，为了提升商品详情页下单率，尝试新的介绍文案，也看作为一个“功能”。</p> <p>用户在产品中，可以进行多种操作，不同的操作，代表了用户不同的想法。最常见的操作行为有：浏览、点击。</p> <p>**浏览：**指用户在产品中对某个具体内容进行了“阅读”。发生了浏览行为，表示用户已经看到了某个内容。比如，我们收集到某个用户浏览了某个商品详情页，那我们就可以认为，该商品，已经被这个用户看见了。可以用来评估内容的曝光量是否达到预期。</p> <p>比如，为增加产品曝光，选定了3个渠道推广产品落地页，预期通过10天的推广，为产品带来10000次的曝光。推广结束后，需要了解是否达到了预期。通过对各个渠道的落地页浏览量进行统计：渠道A的浏览量为5000，B的浏览量为3000，C的浏览量为4000，则可以得出，曝光量达到了预期。</p> <p>**点击：**指使用鼠标/手指触控了某个位置，是用户对产品的主动触发，多发生在浏览行为之后。产品中很多关键行为都需要用户通过点击完成，比如从列表进入详情页、提交订单、播放视频、打开/关闭广告等；点击行为因为是用户主动触发的操作，可以用来评估用户对所浏览的内容是否感兴趣。</p> <p>比如：在内容列表中，展示给用户两种不同的新闻：娱乐新闻和汽车类新闻，用户浏览了列表100次，假设在列表中两种新闻的标题等都一样好，但用户浏览列表时，点击了80次娱乐新闻，20次汽车新闻，则可以一定程度的认为，相比汽车新闻，该用户更喜欢娱乐新闻。</p> <h3 id="协助分析问题"><a href="#协助分析问题" class="header-anchor">#</a> 协助分析问题</h3> <p>工作中，经常面临分析产品中存在的某个问题的场景。通常，给出的是一个具体的问题，需要我们找到原因。</p> <p>如果只有一个问题，是很难定位原因的，因为我们所知道的信息量太少。用户行为数据，在用户以及用户所产生的行为的纬度上，丰富了我们的信息量，使得我们掌握了更多的信息，可以使用这些数据，对一个很“大”的问题进行拆分，将问题的范围不断缩小。</p> <blockquote><p>比如：小明新做了一个老带新的活动，希望通过邀请得好礼，刺激老用户将活动链接分享给他人，为产品带来新注册用户。</p> <p>活动流程为：老用户购课后弹出活动弹窗&gt;&gt;点击弹窗进入活动页面&gt;&gt;生成专属海报&gt;&gt;保存并分享给好友&gt;&gt;好友注册。</p> <p>老带新作为一个越来越重要的获客手段，领导对此十分重视，但功能上线了一周，效果却平平，只带来了100个新用户。领导要求小明尽快查出原因。</p> <p>如果只有100位新用户这个数据，很难定位问题原因，我们需要更加丰富的用户行为数据，对问题进行拆解。</p> <p>根据活动流程，用户参与活动，需要进行几个关键的行为：浏览弹窗&gt;&gt;点击弹窗&gt;&gt;生成专属海报&gt;&gt;保存海报&gt;&gt;分享邀请好友</p> <p>假设流程中，有2000名用户浏览弹窗，500人点击弹窗，300人生成了专属海报，260人点击保存图片。</p> <p>通过这些数据，可以很容易发现，用户浏览弹窗到点击弹窗这一步，流失最为严重。可以针对这一步进行一些假设，并设计解决方案。</p></blockquote> <h3 id="了解用户行为路径"><a href="#了解用户行为路径" class="header-anchor">#</a> 了解用户行为路径</h3> <p>用户从某一点开始，到某一点结束，其操作对象，所构成的路线，称为用户行为路径。比如，用户从搜索开始，到完成购买，操作对象有：点击搜索框&gt;&gt;浏览搜索列表&gt;&gt;浏览详情&gt;&gt;提交订单&gt;&gt;完成支付，则这条路线是该用户从搜索开始，到完成购买的行为路径。</p> <p>用户行为路径通常使用桑基图进行展示，便于更直观的观察。如图：</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128001201.png" alt=""></p> <p>注：图片为在网络上查找，非真实路径与数据。</p> <p>设计产品时，按照产品期待的方向，会自然的形成一条路径，但用户实际使用中，并不会完全按照期待的路径操作。了解用户行为路径，能够知道用户实际使用与产品设想的差异点，针对性优化产品。</p> <blockquote><p>如：期待的用户购买路径是，浏览列表页&gt;&gt;浏览详情页&gt;&gt;生成订单&gt;&gt;完成支付，但实际发现，浏览详情页到生成订单这一步转化率很低，用户在该环节流失严重，可以借助用户行为路径，查看用户浏览详情后，又进行了什么操作，流向了哪里，定位具体的流失原因。</p> <p>我们以浏览详情页为路径起点发现，浏览详情后，用户主要有两条路径：一部分用户返回了列表页；另一部分用户点击评价后，返回列表页。针对这两种主要的流失路径，可以对用户操作时的心理活动进行探索，如详情文案不够吸引人、评价不够好等，在接下来针对性的优化。</p></blockquote> <h3 id="用户分群"><a href="#用户分群" class="header-anchor">#</a> 用户分群</h3> <p>用户分群，是指将满足相同特征条件的用户组成一个群组。比如，产品有三个获客渠道A、B、C，可以将用户按照渠道来源的纬度，分为三个群组。通过用户分群，可以对不同的群体针对性的运营与分析，促进用户转化。</p> <p>通过用户行为对用户分群是一种常见的分群方法。用户行为数据信息量丰富，能够从多纬度对用户进行细致的分群，提高用户分群运营的效果。常使用的行为分群维度有：</p> <p><strong>1.是否发生过某个/些行为及次数</strong></p> <p>这种用户分群以用户是否发生过某个/些行为为条件，对用户进行分群，常使用产品所关注的具体行为对用户进行分群，并进行后续分析等。</p> <p>比如，假设一款在线教育产品，通过尝试发现，新用户如果听完了赠送的体验课，则购买正价课的意愿相比其他新用户会高很多，因此，需要提高新用户体验课的完课率。可以通过新用户是否听完体验课这个行为，筛选出没听完体验课的群体，针对性的进行运营，提高这部分用户的完课率，常见的如推送push、发送短信等。</p> <p><strong>2.发生某个/些行为的频率是否有变化</strong></p> <p>这种用户分群以用户发生某个/些行为上的频率是否有变化，对用户接下来的行为进行预测，进而划分出群体，针对性运营。</p> <p>比如，一款健身产品，使用用户以往月均锻炼次数及本月锻炼次数的比值，来预测用户流失的可能性，假设将用户本月锻炼次数与月均锻炼次数的比值小于40%，定义为可能流失用户，则可以使用这个条件，划分出可能流失的用户，针对性的挽留。</p> <h2 id="_4-3-用户行为数据采集"><a href="#_4-3-用户行为数据采集" class="header-anchor">#</a> 4.3 用户行为数据采集</h2> <p>这里不去关注埋点体系，只是造一定的用户埋点数据，用于demo分析，借助于神策提供的电商行业demo，在分析：自定义查询中下单一定的数据量，然后生产到kafka中，作为实时数仓ODS层。</p> <blockquote><p>代码详见: collections模块com.gmall.data.collection.flow.Csv2JsonDemo03</p></blockquote> <p>神策提供的demo中，提供了一些常见的埋点事件，下面只列举几个：</p> <table><thead><tr><th style="text-align:left;">事件名</th> <th style="text-align:left;">事件显示名</th></tr></thead> <tbody><tr><td style="text-align:left;">ProductExposure</td> <td style="text-align:left;">商品曝光</td></tr> <tr><td style="text-align:left;">SubmitOrder</td> <td style="text-align:left;">提交订单</td></tr> <tr><td style="text-align:left;">PayOrder</td> <td style="text-align:left;">支付订单</td></tr> <tr><td style="text-align:left;">AddToShoppingCart</td> <td style="text-align:left;">加入购物车</td></tr> <tr><td style="text-align:left;">$MPShare</td> <td style="text-align:left;">小程序分享</td></tr> <tr><td style="text-align:left;">$AppViewScreen</td> <td style="text-align:left;">App 浏览页面</td></tr> <tr><td style="text-align:left;">$AppClick</td> <td style="text-align:left;">App 元素点击</td></tr> <tr><td style="text-align:left;">Collect</td> <td style="text-align:left;">收藏商品</td></tr></tbody></table> <p><strong>神策埋点数据结构</strong></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;distinct_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;time&quot;</span><span class="token operator">:</span> <span class="token number">1434556935000</span><span class="token punctuation">,</span>
	<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;track&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;event&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ViewProduct&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;project&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ebiz_test&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;time_free&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//建议在导入历史数据时使用，SDK 采集的实时数据不建议使用</span>
	<span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;$is_login_id&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//此参数请慎重使用，详细介绍请参考文档底部 8.1 $is_login_id 参数说明</span>
		<span class="token property">&quot;$app_version&quot;</span><span class="token operator">:</span><span class="token string">&quot;1.3&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;$wifi&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
		<span class="token property">&quot;$ip&quot;</span><span class="token operator">:</span><span class="token string">&quot;180.79.35.65&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;$province&quot;</span><span class="token operator">:</span><span class="token string">&quot;湖南&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;$city&quot;</span><span class="token operator">:</span><span class="token string">&quot;长沙&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;$user_agent&quot;</span><span class="token operator">:</span><span class="token string">&quot;Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_2 like Mac OS X) AppleWebKit/602.1.50 (KHTML, like Gecko) CriOS/58.0.3029.113 Mobile/14F89 Safari/602.1&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;$screen_width&quot;</span><span class="token operator">:</span><span class="token number">320</span><span class="token punctuation">,</span>
		<span class="token property">&quot;$screen_height&quot;</span><span class="token operator">:</span><span class="token number">568</span><span class="token punctuation">,</span>
		<span class="token property">&quot;product_id&quot;</span><span class="token operator">:</span><span class="token number">12345</span><span class="token punctuation">,</span>
		<span class="token property">&quot;product_name&quot;</span><span class="token operator">:</span><span class="token string">&quot;苹果&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;product_classify&quot;</span><span class="token operator">:</span><span class="token string">&quot;水果&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;product_price&quot;</span><span class="token operator">:</span><span class="token number">14.0</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>采集数据到kafka</strong></p> <p>使用以上程序将数据写入到kafka中<code>ods_user_action_log</code></p> <hr> <h1 id="_5-业务数据dwd层"><a href="#_5-业务数据dwd层" class="header-anchor">#</a> 5. 业务数据DWD层</h1> <h2 id="_5-1-需求分析及实现思路"><a href="#_5-1-需求分析及实现思路" class="header-anchor">#</a> 5.1 需求分析及实现思路</h2> <h4 id="分层需求分析"><a href="#分层需求分析" class="header-anchor">#</a> 分层需求分析</h4> <p>首先简单了解一下数仓的分层思路，实际上不管是离线数仓还是实时数仓，我们的分层与建模的思路是一致的。</p> <p><strong>ODS层</strong></p> <p>对于实时数仓来说，ods层一般是存储在kafka中的原始数据。所谓原始数据，主要有两个来源:</p> <ul><li>基于canal采集到kafka中的mysql表的binlog日志</li> <li>基于flume/fluentd采集到kafka中的客户端访问日志
<ul><li>PC网页访问日志</li> <li>H5端访问日志</li> <li>小程序访问日志</li> <li>APP访问日志</li></ul></li> <li>后端网关服务日志</li></ul> <p>那么，对于ODS层的数据，我们需要做哪些处理呢？通常来说，什么都不做，ods层一般会保留数据原样，方便定位与回溯数据。</p> <p><strong>DWD</strong></p> <p>数据仓库<strong>明细层数据</strong>(Data Warehouse Detail)。对ODS层数据进行清洗转化，以<strong>业务过程作为建模驱动</strong>，基于每个具体的业务过程特点，构建<strong>最细粒度的明细事实表</strong>。可以结合企业的数据使用特点，基于<strong>维度建模</strong>思想，将明细事实表的某些重要属性字段做适当冗余，也即<strong>宽表化处理</strong>，构建明细宽表。主要是对ODS层的数据做一定的清洗和主题汇总。</p> <p>以用户访问日志表为例，在dwd层一般会做的事情:</p> <ul><li>保留和ODS层数据一样的数据维度</li> <li>包含PC、H5、小程序、APP各个来源的数据</li> <li>对部分枚举类型的值进行翻译</li> <li>剔除异常数据，保证数据质量</li></ul> <p>一般在该层，还会做表之间的join、以及维表join冗余维度信息等。</p> <h2 id="_5-2-业务数据dwd层设计"><a href="#_5-2-业务数据dwd层设计" class="header-anchor">#</a> 5.2 业务数据DWD层设计</h2> <h4 id="_5-2-1-需求分析与思路"><a href="#_5-2-1-需求分析与思路" class="header-anchor">#</a> 5.2.1 需求分析与思路</h4> <p>一般DWD层的数据建模步骤可以分为以下几步：</p> <ul><li>选择业务过程</li> <li>定义粒度</li> <li>选择维度</li> <li>确定事实</li></ul> <p>以交易数据为例，如果我们需要构建交易域的订单明细表，可以以以下几个步骤来实现：</p> <ul><li><p>选择业务过程，对于业务系统来说，订单一般有下单、支付、发货、收货等业务过程，这里可以选择订单支付过程；</p></li> <li><p>定义粒度：粒度表示这一行数据代码什么，维度可以是订单明细；</p></li> <li><p>选择维度：基于数仓中构建的一致性DIM维度表，选择一些重要维度，表示会从哪些维度来统计数据，比如在订单明细中往往会从用户、地区、商</p> <p>品、品类、品牌等维度来看数据；</p></li> <li><p>确定事实：也就是需要统计的指标，如订单金额、下单人数、新客人数等。</p></li></ul> <p>为了之后统计计算更加方便，减少大表之间的关联，所以在实时计算过程中将围绕订单的相关数据整合成为一张订单的宽表。</p> <p>那究竟哪些数据需要和订单整合在一起？</p> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011319.png" style="zoom:50%;"> <p>如上图，在之前的工作中我们已经基于canal把mysql中的业务表都采集到了kafka中，每一个topic都对应一张mysql表。</p> <p>下面应该做以下几方面:</p> <ul><li>维度表的存储</li> <li>事实数据和事实数据关联，其实就是流与流之间的关联</li> <li>事实数据与维度数据关联，其实就是流计算中查询外部数据源</li></ul> <h4 id="_5-2-2-dim层设计"><a href="#_5-2-2-dim层设计" class="header-anchor">#</a> 5.2.2 DIM层设计</h4> <p>首先应该将kafka中的维度表的信息同步到数据库中存储，维度表的设计应该考虑到维度的更新、查询数据的并发以及与业务库解耦等因素，一般会用HBase或Redis来作为实时数仓DIM层的存储。</p> <ul><li>对于维度变化缓慢且维度数据比较大的维度表，可以考虑用<strong>HBase</strong>存储，查询HBase时可以结合本地缓存 + 异步IO来实现。</li> <li>对于维度变化较快且维表数据量相对较小的维度表，一般可以用<strong>Redis</strong>存储。</li></ul> <p>对于HBase维表以及Redis维表，我们考虑都实现一次。</p> <h6 id="读取kafka中canal采集的binlog数据"><a href="#读取kafka中canal采集的binlog数据" class="header-anchor">#</a> 读取Kafka中Canal采集的binlog数据</h6> <p>项目中设计了一个**<code>tools</code>**模块，该模块可以读取mysql中的表字段信息，将其映射成ODS层中Scala的类结构。执行主函数后会自动生成所有的类结构。</p> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011401.png" style="zoom:50%;"> <p><strong>canal-json</strong></p> <p>Canal 为变更日志提供了统一的格式，基于canal采集的数据为一个json格式，数据格式如下。以activity_info表为例:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;data&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;activity_name&quot;</span><span class="token operator">:</span><span class="token string">&quot;联想专场&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;activity_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;3101&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;activity_desc&quot;</span><span class="token operator">:</span><span class="token string">&quot;联想满减&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start_time&quot;</span><span class="token operator">:</span><span class="token string">&quot;2020-10-21 18:49:12&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end_time&quot;</span><span class="token operator">:</span><span class="token string">&quot;2020-10-31 18:49:15&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;create_time&quot;</span><span class="token operator">:</span><span class="token null keyword">null</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;database&quot;</span><span class="token operator">:</span><span class="token string">&quot;gmall2021&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;es&quot;</span><span class="token operator">:</span><span class="token number">1617544188000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">,</span>
    <span class="token property">&quot;isDdl&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">&quot;mysqlType&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;bigint&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;activity_name&quot;</span><span class="token operator">:</span><span class="token string">&quot;varchar(200)&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;activity_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;varchar(10)&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;activity_desc&quot;</span><span class="token operator">:</span><span class="token string">&quot;varchar(2000)&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;start_time&quot;</span><span class="token operator">:</span><span class="token string">&quot;datetime&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;end_time&quot;</span><span class="token operator">:</span><span class="token string">&quot;datetime&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;create_time&quot;</span><span class="token operator">:</span><span class="token string">&quot;datetime&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;old&quot;</span><span class="token operator">:</span><span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;pkNames&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token string">&quot;id&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sql&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sqlType&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">-5</span><span class="token punctuation">,</span>
        <span class="token property">&quot;activity_name&quot;</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span>
        <span class="token property">&quot;activity_type&quot;</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span>
        <span class="token property">&quot;activity_desc&quot;</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span>
        <span class="token property">&quot;start_time&quot;</span><span class="token operator">:</span><span class="token number">93</span><span class="token punctuation">,</span>
        <span class="token property">&quot;end_time&quot;</span><span class="token operator">:</span><span class="token number">93</span><span class="token punctuation">,</span>
        <span class="token property">&quot;create_time&quot;</span><span class="token operator">:</span><span class="token number">93</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;table&quot;</span><span class="token operator">:</span><span class="token string">&quot;activity_info&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ts&quot;</span><span class="token operator">:</span><span class="token number">1617545028537</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;INSERT&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>对</strong>canal-json<strong>格式数据的简单说明:</strong></p> <ul><li><code>isDdl</code> ，是否是ddl变更操作，比如create table/drop table]</li> <li><code>sql</code> ，具体的ddl sql]</li> <li><code>old</code>，表示数据行发生更改时，对那些字段做了更改以及上一级字段的值。若   &quot;type&quot;:&quot;INSERT&quot;，则old为null，在某些情况下需要关心old的值来确定当前事实。</li> <li><code>ts</code>，数据采集时间，可作为数据的事件时间。</li> <li><code>type</code>， INSERT/UPDATE/DELETE</li></ul> <p>对于kafka中的canal-json的数据，这里做了一个通用的模板，用于解析flatmessage数据映射为scala类。</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">class</span> <span class="token punctuation">{</span>ods_model_class_name<span class="token punctuation">}</span> <span class="token keyword">extends</span> OdsModel <span class="token punctuation">{</span>
  <span class="token keyword">override</span> <span class="token keyword">var</span> database<span class="token operator">:</span> <span class="token builtin">String</span>            <span class="token operator">=</span> _
  <span class="token keyword">override</span> <span class="token keyword">var</span> table   <span class="token operator">:</span> <span class="token builtin">String</span>            <span class="token operator">=</span> _
  <span class="token keyword">override</span> <span class="token keyword">var</span> ts      <span class="token operator">:</span> <span class="token builtin">Long</span>              <span class="token operator">=</span> _
  <span class="token keyword">override</span> <span class="token keyword">var</span> sqlType <span class="token operator">:</span> ods<span class="token punctuation">.</span>SqlType<span class="token punctuation">.</span>Value <span class="token operator">=</span> _
  <span class="token keyword">override</span> <span class="token keyword">var</span> old     <span class="token operator">:</span> mutable<span class="token punctuation">.</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> _
  <span class="token punctuation">{</span>ods_model_fields<span class="token punctuation">}</span>

  <span class="token keyword">def</span> <span class="token keyword">this</span><span class="token punctuation">(</span>database<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> table<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> sqlType<span class="token operator">:</span> SqlType<span class="token punctuation">,</span> ts<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> old<span class="token operator">:</span> mutable<span class="token punctuation">.</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>database <span class="token operator">=</span> database
    <span class="token keyword">this</span><span class="token punctuation">.</span>table <span class="token operator">=</span> table
    <span class="token keyword">this</span><span class="token punctuation">.</span>sqlType <span class="token operator">=</span> sqlType
    <span class="token keyword">this</span><span class="token punctuation">.</span>ts <span class="token operator">=</span> ts
    <span class="token keyword">this</span><span class="token punctuation">.</span>old <span class="token operator">=</span> old
  <span class="token punctuation">}</span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> toString <span class="token operator">=</span> s<span class="token string">&quot;{ods_model_to_string}&quot;</span>

<span class="token punctuation">}</span>
</code></pre></div><h6 id="维度数据写入hbase"><a href="#维度数据写入hbase" class="header-anchor">#</a> 维度数据写入HBase</h6> <p>需求:  将<strong>用户</strong>、<strong>地区</strong>、<strong>品牌</strong>、<strong>商品</strong>、<strong>分类</strong>、<strong>SPU</strong>维度表写入HBase。</p> <p>######## 用户信息维度表</p> <ul><li><p><strong>查询mysql中用户信息表结构</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">desc</span> user_info<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+--------------+------+-----+---------+----------------+</span>
<span class="token operator">|</span> Field        <span class="token operator">|</span> <span class="token keyword">Type</span>         <span class="token operator">|</span> <span class="token boolean">Null</span> <span class="token operator">|</span> <span class="token keyword">Key</span> <span class="token operator">|</span> <span class="token keyword">Default</span> <span class="token operator">|</span> Extra          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+--------------+------+-----+---------+----------------+</span>
<span class="token operator">|</span> id           <span class="token operator">|</span> <span class="token keyword">bigint</span>       <span class="token operator">|</span> <span class="token keyword">NO</span>   <span class="token operator">|</span> PRI <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token keyword">auto_increment</span> <span class="token operator">|</span>
<span class="token operator">|</span> login_name   <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> nick_name    <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> passwd       <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> name         <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> phone_num    <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> email        <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> head_img     <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> user_level   <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> birthday     <span class="token operator">|</span> <span class="token keyword">date</span>         <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> gender       <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>   <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> create_time  <span class="token operator">|</span> <span class="token keyword">datetime</span>     <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> operate_time <span class="token operator">|</span> <span class="token keyword">datetime</span>     <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token keyword">status</span>       <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+--------------+------+-----+---------+----------------+</span>
<span class="token number">14</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre></div><ul><li>该用户信息表中包含了用户的一些基本信息，如用户名、密码、性别等信息，在制作用户维度表的时候，可以将这些字段全部存到HBase。事实上，某一张维度表的信息的来源往往可能是多张ODS表，这个时候，选用HBase作为实时数仓的DIM层存储介质的优势就体现出来了，它的列可以动态扩容，甚至可以基于rowkey设置多个列簇，将具有相同规律的列存放在同一个列簇下。开源Flink Sql也支持以时态表的方式读取HBase，选用HBase也是为Flink实时计算平台化做准备。</li></ul></li> <li><p><strong>HBase创建表</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>create table <span class="token string">'dim:dim_user_info'</span>,NAME<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">'f1'</span>
</code></pre></div><ul><li>用户维度表以user_id作为rowkey，其余13列用户信息存在列簇f1下。</li> <li>对于用户信息的更新操作，一般只需要保留最新的用户信息就行了，所以HBase表的版本数设置为1(默认)，利用HBase的幂等性来实现用户维度表的更新。</li> <li>在使用HBase的时候，一定要注意表的rowkey以及预分区的设计，否则可能带来严重的数据热点问题，影响线上数据服务。本次测试中部署的HBase单节点，功能测试为主，不做预分区的设计。</li></ul></li> <li><p><strong>写入数据到Hbase</strong></p> <ul><li><p>对于<strong>DataStream</strong>所有的sink操作，可以设置一个Sink的基类，子类实现具体的流的sink实现。</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">/**
 * sink接口，流sink函数需要继承该抽象类
 *
 * @tparam T
 */</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> Sink<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token punctuation">{</span>

  <span class="token comment">// 请子类取一个有意义的方法名的方法来调用sink方法</span>
  <span class="token keyword">def</span> sink<span class="token punctuation">(</span>input<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    doSink<span class="token punctuation">(</span>input<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 基于业务,封装在doSink方法中</span>
  <span class="token keyword">protected</span> <span class="token keyword">def</span> doSink<span class="token punctuation">(</span>input<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span>

<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><strong>RichSinkFunction代码实现</strong></p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">class</span> UserInfoSinkFunc <span class="token keyword">extends</span> RichSinkFunction<span class="token punctuation">[</span>UserInfo<span class="token punctuation">]</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">var</span> conn<span class="token operator">:</span> Connection <span class="token operator">=</span> _
    <span class="token keyword">private</span> <span class="token keyword">var</span> table<span class="token operator">:</span> Table <span class="token operator">=</span> _

    <span class="token keyword">override</span> <span class="token keyword">def</span> open<span class="token punctuation">(</span>parameters<span class="token operator">:</span> Configuration<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      conn <span class="token operator">=</span> HBaseUtil<span class="token punctuation">.</span>getConn<span class="token punctuation">(</span><span class="token punctuation">)</span>
      table <span class="token operator">=</span> conn<span class="token punctuation">.</span>getTable<span class="token punctuation">(</span>TableName<span class="token punctuation">.</span>valueOf<span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>DIM_USER_INFO<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">def</span> invoke<span class="token punctuation">(</span>input<span class="token operator">:</span> UserInfo<span class="token punctuation">,</span> context<span class="token operator">:</span> SinkFunction<span class="token punctuation">.</span>Context<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> put <span class="token operator">=</span> <span class="token keyword">new</span> Put<span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span>toBytes<span class="token punctuation">(</span>input<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">// 添加要上传的列</span>
        put<span class="token punctuation">.</span>addColumn<span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span>toBytes<span class="token punctuation">(</span><span class="token string">&quot;f1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span>toBytes<span class="token punctuation">(</span><span class="token string">&quot;login_name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span>toBytes<span class="token punctuation">(</span>input<span class="token punctuation">.</span>login_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        put<span class="token punctuation">.</span>addColumn<span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span>toBytes<span class="token punctuation">(</span><span class="token string">&quot;f1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span>toBytes<span class="token punctuation">(</span><span class="token string">&quot;nick_name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span>toBytes<span class="token punctuation">(</span>input<span class="token punctuation">.</span>nick_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// 。。。</span>

        table<span class="token punctuation">.</span>put<span class="token punctuation">(</span>put<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> e<span class="token operator">:</span> Exception <span class="token keyword">=&gt;</span> LoggerUtil<span class="token punctuation">.</span>error<span class="token punctuation">(</span>logger<span class="token punctuation">,</span> e<span class="token punctuation">,</span>
          s<span class="token string">&quot;failed to UserInfoSinkFunc.invoke,input=${input}&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">def</span> close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>table <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> table<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><p><strong>查看HBase中表数据</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:012:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> scan <span class="token string">'dim:dim_user_info'</span>,LIMIT<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token number">1</span>
ROW                            COLUMN+CELL                                                                            
 <span class="token number">1</span>                             <span class="token assign-left variable">column</span><span class="token operator">=</span>f1:birthday, <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token number">1618118849366</span>, <span class="token assign-left variable">value</span><span class="token operator">=</span><span class="token number">1985</span>-11-23                          
 <span class="token number">1</span>                             <span class="token assign-left variable">column</span><span class="token operator">=</span>f1:create_time, <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token number">1618118849366</span>, <span class="token assign-left variable">value</span><span class="token operator">=</span><span class="token number">2020</span>-11-23 <span class="token number">20</span>:03:49              
 <span class="token number">1</span>                             <span class="token assign-left variable">column</span><span class="token operator">=</span>f1:email, <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token number">1618118849366</span>, <span class="token assign-left variable">value</span><span class="token operator">=</span>cjn0s1flj@googlemail.com               
 <span class="token number">1</span>                             <span class="token assign-left variable">column</span><span class="token operator">=</span>f1:gender, <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token number">1618118849366</span>, <span class="token assign-left variable">value</span><span class="token operator">=</span>F                                     
 <span class="token number">1</span>                             <span class="token assign-left variable">column</span><span class="token operator">=</span>f1:login_name, <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token number">1618118849366</span>, <span class="token assign-left variable">value</span><span class="token operator">=</span>pbgkadgis99                       
 <span class="token number">1</span>                             <span class="token assign-left variable">column</span><span class="token operator">=</span>f1:name, <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token number">1618118849366</span>, <span class="token assign-left variable">value</span><span class="token operator">=</span><span class="token punctuation">\</span>xE9<span class="token punctuation">\</span>xA1<span class="token punctuation">\</span>xBE<span class="token punctuation">\</span>xE7<span class="token punctuation">\</span>x91<span class="token punctuation">\</span>x9E<span class="token punctuation">\</span>xE5<span class="token punctuation">\</span>x87<span class="token punctuation">\</span>xA1    
 <span class="token number">1</span>                             <span class="token assign-left variable">column</span><span class="token operator">=</span>f1:nick_name, <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token number">1618118849366</span>, <span class="token assign-left variable">value</span><span class="token operator">=</span><span class="token punctuation">\</span>xE5<span class="token punctuation">\</span>x98<span class="token punctuation">\</span>x89<span class="token punctuation">\</span>xE5<span class="token punctuation">\</span>x98<span class="token punctuation">\</span>x89           
 <span class="token number">1</span>                             <span class="token assign-left variable">column</span><span class="token operator">=</span>f1:phone_num, <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token number">1618118849366</span>, <span class="token assign-left variable">value</span><span class="token operator">=</span><span class="token number">13622353916</span>                        
 <span class="token number">1</span>                             <span class="token assign-left variable">column</span><span class="token operator">=</span>f1:user_level, <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token number">1618118849366</span>, <span class="token assign-left variable">value</span><span class="token operator">=</span><span class="token number">2</span>                                 
<span class="token number">1</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
Took <span class="token number">0.0103</span> seconds 
</code></pre></div><p>此时已经成功将用户信息维度表写入到HBase了，作为实时数仓的DIM层。</p></li></ul> <p>######## 商品：SPU维度表</p> <p>######## 商品：SKU维度表</p> <p>######## 地区维度表</p> <p>######## 品牌维度表</p> <p>######## 类目维度表</p> <p>以上维度表写入HBase与dim_user_info类似，具体可以详见代码**<code>ods2dim</code>**模块：com.gmall.data.dim.App。维度数据都写入Hbase后，参考Hbase中的表:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:012:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> list
TABLE                                                                                                                   
dim:dim_category3_info                                                                                                  
dim:dim_province_info                                                                                                   
dim:dim_sku_info                                                                                                        
dim:dim_spu_info                                                                                                        
dim:dim_trademark_info                                                                                                  
dim:dim_user_info       
</code></pre></div><h4 id="_5-2-3-事实表与事实表关联"><a href="#_5-2-3-事实表与事实表关联" class="header-anchor">#</a> 5.2.3 事实表与事实表关联</h4> <p><strong>对于电商业务场景来说</strong>，订单表一般会记录该订单的下单、支付等状态以及订单金额等信息，订单明细表则会记录该订单更加详细的信息，比如商品ID、品牌、类目等信息，一般来说，这两张表是具有业务上的事务性的，两张表数据的INSERT、UPDATE往往是相关联的。</p> <p>对于离线数仓来说，往往会把业务表T+1同步到Hive中，在数仓中T+1的Join任务让两张表关联。而对于实时数仓来说，ODS层的数据在Kafka中，一般是使用Flink/Flink Sql消费Kafka中的数据实现双流Join的语义使得两张表关联，形成一张DWD层的事实宽表。</p> <p>在flink中的双流join大体分为两种，一种是基于时间窗口的 join（Time Windowed Join），比如 join、coGroup 等。另一种是基于状态缓存的 join（Temporal Table Join），比如 intervalJoin。</p> <p>关于如何基于DataStream Api实现双流Join，已经在其他文章中有详细说明了：<a href="https://gitee.com/joeyooa/bigdata-project/blob/main/docs/flink/FlinkStreamingJoins.md" target="_blank" rel="noopener noreferrer">Streaming Joins<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h6 id="订单表关联订单明细表"><a href="#订单表关联订单明细表" class="header-anchor">#</a> 订单表关联订单明细表</h6> <p>订单系统中，订单表和订单明细表是具有业务的事务性的，当下单时，订单表中会INSERT一条订单数据，对应的会异步插入订单明细数据到明细表中。订单表与订单明细表关联实现的是<strong>Inner Join</strong>语义，适合使用Interval Join来实现，Interval Join目前只支持事件时间语义。</p> <p>######## Interval Join</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>co<span class="token punctuation">.</span></span>ProcessJoinFunction<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">val</span> orangeStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Integer<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">val</span> greenStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Integer<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

orangeStream
    <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span>elem <span class="token keyword">=&gt;</span> <span class="token comment">/* select key */</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>intervalJoin<span class="token punctuation">(</span>greenStream<span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span>elem <span class="token keyword">=&gt;</span> <span class="token comment">/* select key */</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>between<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>milliseconds<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Time<span class="token punctuation">.</span>milliseconds<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> ProcessJoinFunction<span class="token punctuation">[</span>Integer<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token keyword">override</span> <span class="token keyword">def</span> processElement<span class="token punctuation">(</span>left<span class="token operator">:</span> Integer<span class="token punctuation">,</span> right<span class="token operator">:</span> Integer<span class="token punctuation">,</span> ctx<span class="token operator">:</span> ProcessJoinFunction<span class="token punctuation">[</span>Integer<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span>##Context<span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
         out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span>left <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>Innerval Join的原理是连接两个keyedStream, 按照相同的key在一个相对数据时间的时间段内进行连接。</li> <li>between方法传递的两个参数lowerBound和upperBound，用来控制右边的流可以与哪个时间范围内的左边的流进行关联，即：leftElement.timestamp + lowerBound &lt;= rightElement.timestamp &lt;= leftElement.timestamp + upperBound 相当于左边的流可以晚到lowerBound（lowerBound为负的话）时间，也可以早到upperBound（upperBound为正的话）时间。</li> <li>在使用中, between方法传递的两个参数lowerBound和upperBound并不是拍脑袋决定的。如果时间间隔设置过短，可能出现两条流Join不上的情况；如果时间间隔设置过长，则可能造成流任务存在比较大的状态而不能及时清理。参数的设置一般会参考业务含义、以及可以通过历史离线数据得到一个相对合理的时间间隔保证双流数据都可以Join到。</li></ul> <p>######## 创建合并后的宽表实体类</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">/**
 * 订单和订单明细关联宽表对应实体类
 * &quot;id&quot;相关的字段，在数仓中用string类型表示
 */</span>
<span class="token keyword">class</span> DwdOrderDetail <span class="token keyword">extends</span> Model<span class="token punctuation">{</span>

  <span class="token keyword">override</span> <span class="token keyword">var</span> ts<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> _
  <span class="token comment">// 订单明细表</span>
  <span class="token keyword">var</span> detail_id<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> order_id<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> sku_id<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> sku_name<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> sku_num<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> order_price<span class="token operator">:</span> <span class="token builtin">Double</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> source_type<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  <span class="token comment">// 订单表</span>
  <span class="token keyword">var</span> province_id<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> user_id<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> order_status<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> total_amount<span class="token operator">:</span> <span class="token builtin">Double</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> activity_reduce_amount<span class="token operator">:</span> <span class="token builtin">Double</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> coupon_reduce_amount<span class="token operator">:</span> <span class="token builtin">Double</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> original_total_amount<span class="token operator">:</span> <span class="token builtin">Double</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> feight_fee<span class="token operator">:</span> <span class="token builtin">Double</span> <span class="token operator">=</span> _
  <span class="token comment">// 明细表</span>
  <span class="token keyword">var</span> split_total_amount<span class="token operator">:</span> <span class="token builtin">Double</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> split_activity_amount<span class="token operator">:</span> <span class="token builtin">Double</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> split_coupon_amount<span class="token operator">:</span> <span class="token builtin">Double</span> <span class="token operator">=</span> _
  <span class="token comment">// 订单表</span>
  <span class="token keyword">var</span> create_time<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> operate_time<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> expire_time<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> create_date<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _ <span class="token comment">// 把其他字段处理得到</span>
  <span class="token keyword">var</span> create_hour<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _

  <span class="token comment">// 查询维表得来: 地区</span>
  <span class="token keyword">var</span> province_name<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> province_area_code<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> province_iso_code<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> province_3166_2_code<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _

  <span class="token comment">// 用户</span>
  <span class="token keyword">var</span> user_age<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> user_gender<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _

  <span class="token comment">// 商品: 查询sku维表</span>
  <span class="token keyword">var</span> spu_id<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> tm_id<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _ <span class="token comment">// 品牌id</span>
  <span class="token keyword">var</span> category3_id<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _

  <span class="token comment">// spu</span>
  <span class="token keyword">var</span> spu_name<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  <span class="token comment">// tm</span>
  <span class="token keyword">var</span> tm_name<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  <span class="token comment">// category</span>
  <span class="token keyword">var</span> category3_name<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
  
<span class="token punctuation">}</span>
</code></pre></div><p>######## 代码实现</p> <p><strong>双流Join的基类</strong></p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">/**
 * DataStream[T1] and DataStream[T2] to DataStream[T]
 * 双流join
 * @param source
 * @tparam T1
 * @tparam T2
 * @tparam T
 */</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> Merger<span class="token punctuation">[</span>T1<span class="token punctuation">,</span> T2<span class="token punctuation">,</span> T<span class="token punctuation">]</span><span class="token punctuation">(</span>source<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>T1<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Serializable <span class="token punctuation">{</span>

  <span class="token keyword">def</span> joinStream<span class="token punctuation">(</span>input<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>T2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> DataStream<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    merge<span class="token punctuation">(</span>source<span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">(</span>s<span class="token string">&quot;merge_${getName}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>uid<span class="token punctuation">(</span>s<span class="token string">&quot;merger_${getUid}&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">def</span> getName<span class="token operator">:</span> <span class="token builtin">String</span>
  
  <span class="token keyword">def</span> getUid<span class="token operator">:</span> <span class="token builtin">String</span>

  <span class="token keyword">protected</span> <span class="token keyword">def</span> merge<span class="token punctuation">(</span>input1<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>T1<span class="token punctuation">]</span><span class="token punctuation">,</span> input2<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>T2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> DataStream<span class="token punctuation">[</span>T<span class="token punctuation">]</span>

<span class="token punctuation">}</span>
</code></pre></div><p><strong>子类实现</strong></p> <div class="language-SCALA extra-class"><pre class="language-scala"><code> input1<span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>intervalJoin<span class="token punctuation">(</span>input2<span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>order_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>between<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> ProcessJoinFunction<span class="token punctuation">[</span>OrderInfo<span class="token punctuation">,</span> OrderDetail<span class="token punctuation">,</span> DwdOrderDetail<span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token keyword">override</span> <span class="token keyword">def</span> processElement<span class="token punctuation">(</span>left<span class="token operator">:</span> OrderInfo<span class="token punctuation">,</span>
                                    right<span class="token operator">:</span> OrderDetail<span class="token punctuation">,</span>
                                    context<span class="token operator">:</span> ProcessJoinFunction<span class="token punctuation">[</span>OrderInfo<span class="token punctuation">,</span> OrderDetail<span class="token punctuation">,</span> DwdOrderDetail<span class="token punctuation">]</span>##Context<span class="token punctuation">,</span>
                                    out<span class="token operator">:</span> Collector<span class="token punctuation">[</span>DwdOrderDetail<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> orderDetail <span class="token operator">=</span> DwdOrderDetail<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>from<span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">.</span>from<span class="token punctuation">(</span>right<span class="token punctuation">)</span>
            out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span>orderDetail<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> e<span class="token operator">:</span> Exception <span class="token keyword">=&gt;</span> LoggerUtil<span class="token punctuation">.</span>error<span class="token punctuation">(</span>OrderInfoAndDetailMerger<span class="token punctuation">.</span>logger<span class="token punctuation">,</span> e<span class="token punctuation">,</span>
              s<span class="token string">&quot;failed to OrderInfoAndDetailMerger.merger,left=${left},right=${right}&quot;</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h6 id="订单明细表关联优惠券表"><a href="#订单明细表关联优惠券表" class="header-anchor">#</a> 订单明细表关联优惠券表</h6> <p>用户下单支付的时候，往往还会领取相应的优惠券，订单系统会维护一张订单明细的Coupon表，也就是案例中的order_detail_coupon表，所以在订单明细事实宽表中，也需要冗余该订单的活动、优惠券的信息，方便事实数仓下游的统计分析等。</p> <p>但不是每个订单都会领取优惠券参与活动，所以需要实现left join。那么，实现left join，需要选择什么方案呢？</p> <p>在Flink中，实现双流join，前面已经介绍了基于时间间隔的interval join，并且interval join实现的是<strong>inner join</strong>的语义。除了interval join，Flink还提供了基于时间窗口的双流join。</p> <div class="language-java extra-class"><pre class="language-java"><code>stream<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>otherStream<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WindowAssigner</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JoinFunction</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
</code></pre></div><p>基于窗口的Join是将具有相同key并位于同一个窗口中的事件进行联结。值的一提的是，<strong>join</strong>算子也是实现的<strong>inner join</strong>，如果我们需要用到<strong>coGroup</strong>算子。</p> <p>######## coGroup</p> <p>该操作是将两个数据流/集合按照key进行group，然后将相同key的数据进行处理，但是它和join操作稍有区别，它在一个流/数据集中没有找到与另一个匹配的数据还是会输出。</p> <p>coGroup的用法类似于Join，不同的是在apply中传入的是一个CoGroupFunction，而不是JoinFunction。</p> <div class="language- extra-class"><pre class="language-text"><code>stream.coGroup(otherStream)
    .where(&lt;KeySelector&gt;)
    .equalTo(&lt;KeySelector&gt;)
    .window(&lt;WindowAssigner&gt;)
    .apply(&lt;CoGroupFunction&gt;)
</code></pre></div><p>######## SessionWindow</p> <p>我们清楚需要使用<strong>coGroup</strong>算子来实现<strong>left join</strong>，那么应该选择哪种window保证具有相同key的在同一个窗口中进行联结呢？先简单介绍一下，基于滚动窗口的join，官方的描述:</p> <p><strong>基于滚动窗口的join</strong></p> <p>当执行滚动窗口联接时，所有具有公共键和公共滚动窗口的元素都按成对组合联接，并传递给a<code>JoinFunction</code>或<code>FlatJoinFunction</code>。因为它的行为就像一个内部联接，所以在其滚动窗口中不发出一个流中没有其他流元素的元素！</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011456.svg" alt=""></p> <p>如图所示，我们定义了一个大小为2毫秒的翻滚窗口，该窗口的形式为<code>[0,1], [2,3], ...</code>。该图显示了每个窗口中所有元素的成对组合，这些元素将传递给<code>JoinFunction</code>。注意，在翻转窗口中<code>[6,7]</code>什么也不发射，因为在绿色流中不存在要与橙色元素⑥和joined连接的元素。</p> <p>道理我们都懂，但不管是滚动窗口还是滑动窗口，都很难保证我们想要join的两条数据能够在一个窗口中。实时上，在订单系统中，需要join的两张事实表都是具有业务上的绑定的。比如，<strong>订单优惠明细表会在支付订单的一段时间内写入到订单系统中</strong>。</p> <p><strong>基于SessionWindow的Join</strong></p> <p>看一个实际场景：当我们需要分析用户的一段交互的行为事件时，通常的想法是将用户的事件流按照“session”来分组。session 是指一段持续活跃的期间，由活跃间隙分隔开。通俗一点说，消息之间的间隔小于超时阈值（<code>sessionGap</code>）的，则被分配到同一个窗口，间隔大于阈值的，则被分配到不同的窗口。</p> <p>Flink的底层API中是实现了session window的，因此上面的场景，只要设置合理的<code>sessionGap</code>，是可以保证双流相同key的数据在一个窗口内的。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011504.svg" alt=""></p> <p>######## 代码实现</p> <div class="language-scala extra-class"><pre class="language-scala"><code> input1<span class="token punctuation">.</span>coGroup<span class="token punctuation">(</span>input2<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>where<span class="token punctuation">(</span>_<span class="token punctuation">.</span>detail_id<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>equalTo<span class="token punctuation">(</span>_<span class="token punctuation">.</span>order_detail_id<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>window<span class="token punctuation">(</span>EventTimeSessionWindows<span class="token punctuation">.</span>withGap<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>apply<span class="token punctuation">(</span><span class="token keyword">new</span> CoGroupFunction<span class="token punctuation">[</span>DwdOrderDetail<span class="token punctuation">,</span> OrderDetailCoupon<span class="token punctuation">,</span> DwdOrderDetail<span class="token punctuation">{</span>
        <span class="token keyword">override</span> <span class="token keyword">def</span> coGroup<span class="token punctuation">(</span>iterable<span class="token operator">:</span> lang<span class="token punctuation">.</span>Iterable<span class="token punctuation">[</span>DwdOrderDetail<span class="token punctuation">]</span><span class="token punctuation">,</span>
                             iterable1<span class="token operator">:</span> lang<span class="token punctuation">.</span>Iterable<span class="token punctuation">[</span>OrderDetailCoupon<span class="token punctuation">]</span><span class="token punctuation">,</span>
                             out<span class="token operator">:</span> Collector<span class="token punctuation">[</span>DwdOrderDetail<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> left <span class="token operator">=</span> iterable<span class="token punctuation">.</span>asScala<span class="token punctuation">.</span>toSeq
            <span class="token keyword">val</span> right <span class="token operator">=</span> iterable1<span class="token punctuation">.</span>asScala<span class="token punctuation">.</span>toSeq

            <span class="token keyword">if</span> <span class="token punctuation">(</span>left<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span>
              OrderDetailAndCouponMerger<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token string">&quot;DwdOrderDetail is empty&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>right<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token comment">// 直接发出结果</span>
                out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span>left<span class="token punctuation">.</span>head<span class="token punctuation">)</span>
              <span class="token keyword">else</span> <span class="token comment">// 关联coupon信息</span>
                out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span>left<span class="token punctuation">.</span>head<span class="token punctuation">.</span>from<span class="token punctuation">(</span>right<span class="token punctuation">.</span>head<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> e<span class="token operator">:</span> Exception <span class="token keyword">=&gt;</span> LoggerUtil<span class="token punctuation">.</span>error<span class="token punctuation">(</span>OrderDetailAndCouponMerger<span class="token punctuation">.</span>logger<span class="token punctuation">,</span> e<span class="token punctuation">,</span>
              s<span class="token string">&quot;failed to OrderDetailAndCouponMerger.merger,left=${iterable},right=${iterable1}&quot;</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="_5-2-4-事实表与维度表关联"><a href="#_5-2-4-事实表与维度表关联" class="header-anchor">#</a> 5.2.4 事实表与维度表关联</h4> <p>在实时数仓中，维度表一般是使用HBase或者Redis这两种数据库来作为存储介质的。这两种数据库，各有优缺点，一般是基于业务场景来决定。这里基于Flink流计算中的几种维表关联的方案:</p> <h6 id="维表join的方案"><a href="#维表join的方案" class="header-anchor">#</a> 维表Join的方案</h6> <p>######## <strong>方案一：将维表预加载到内存关联</strong></p> <ul><li><p>实现方式</p> <ul><li>定义一个类实现RichFlatMapFunction在open()方法中读取全部数据加载到内存中。在流上使用该算子，运行时与内存维度数据关联。</li></ul></li> <li><p>优点：实现简单</p></li> <li><p>缺点:：因为存在内存中，所以仅支持小数据量维表；因为open方法中读取，所以维表变化需要重启作业。</p></li> <li><p>代码示例:</p> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011524.png" style="zoom:50%;"></li></ul> <p>######## <strong>方案二：预加载维表</strong></p> <ul><li>实现方式：
<ul><li>通过Distributed Cache分发本地维度文件到task manager后加载到内存关联</li> <li>通过env.registerCachedFile注册文件</li> <li>实现RichFunction在open()方法中通过RuntimeContext获取cache文件</li> <li>解析使用文件数据</li></ul></li> <li>优缺点:
<ul><li>不需要外部数据库</li> <li>支持的数据量小，更新维表配置文件需要重启作业</li></ul></li></ul> <p>######## <strong>方案三：热存储关联</strong></p> <ul><li><p>实现方式：</p> <ul><li>实时流与热存储上维度数据关联，使用cache减轻存储访问压力</li> <li>将维度数据导入到热存储redis hbase es等，通过异步IO的方式查询，利用<strong>cache机制</strong>将维度数据缓存在内存。</li></ul></li> <li><p>优缺点:</p> <ul><li>维度数据不受限与内存，支持较多维度数据</li> <li>维度更新结果可能有延迟，而且对外部存储的压力较大</li></ul></li> <li><p>试用场景：</p> <ul><li>维度数据量较大，可接受维度更新有一定的延迟</li></ul> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011630.png" style="zoom:50%;"></li></ul> <p>######## <strong>方案四：广播维表</strong></p> <ul><li><p>实现方式</p> <ul><li>利用broadcast State将维度数据流广播到下游做join</li> <li>将维度数据发送到kakfa作为广播原始流S1</li> <li>定义状态描述符MapStateDescriptor 调用S1.broadcast()获得broadCastStream S2</li> <li>调用非广播流S3.connect(S2),得到BroadcastConnectedStream S4</li> <li>应用混合流的S4.process()，并在KeyedBroadcastProcessFunction/BroadcastProcessFunction实现关联处理逻辑</li></ul></li> <li><p>优缺点:</p> <ul><li>维度数据实时更新</li> <li>数据保存在内存中，支持维表数据量比较小。</li></ul> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011656.png" style="zoom:50%;"></li></ul> <p>一般来说，维度表数据都会维度在数据库中，方便维护和管理，当然在维度数据量很小的情况下也可以使用内存缓存或者广播维表的方式来实现，这里主要介绍方案三的实现。</p> <h6 id="异步io"><a href="#异步io" class="header-anchor">#</a> 异步IO</h6> <p>Async I/O 是阿里巴巴贡献给社区的一个呼声非常高的特性，于1.2版本引入。主要目的是为了解决与外部系统交互时网络延迟成为了系统瓶颈的问题。</p> <p>相关flink异步IO的知识，请查看官网:<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/operators/asyncio.html" target="_blank" rel="noopener noreferrer">Flink异步IO<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>######## 异步IO API</p> <p>Flink 的异步 I/O API 允许用户在流处理中使用异步请求客户端。API 处理与数据流的集成，同时还能处理好顺序、事件时间和容错等。</p> <p>在具备异步数据库客户端的基础上，实现数据流转换操作与数据库的异步 I/O 交互需要以下三部分：</p> <ul><li>实现分发请求的 <code>AsyncFunction</code></li> <li>获取数据库交互的结果并发送给 <code>ResultFuture</code> 的 <em>回调</em> 函数</li> <li>将异步 I/O 操作应用于 <code>DataStream</code> 作为 <code>DataStream</code> 的一次转换操作。</li></ul> <p>######## 异步IO的重要参数</p> <div class="language-scala extra-class"><pre class="language-scala"><code>  <span class="token keyword">def</span> unorderedWait<span class="token punctuation">[</span>IN<span class="token punctuation">,</span> OUT<span class="token operator">:</span> TypeInformation<span class="token punctuation">]</span><span class="token punctuation">(</span>
      input<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>IN<span class="token punctuation">]</span><span class="token punctuation">,</span>
      asyncFunction<span class="token operator">:</span> AsyncFunction<span class="token punctuation">[</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">]</span><span class="token punctuation">,</span>
      timeout<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span>
      timeUnit<span class="token operator">:</span> TimeUnit<span class="token punctuation">,</span>
      capacity<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> DataStream<span class="token punctuation">[</span>OUT<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
</code></pre></div><ul><li><strong>结果顺序</strong>：unorderedWait/orderedWait：结果的有序和无序</li> <li><strong>Timeout</strong>： 超时参数定义了异步请求发出多久后未得到响应即被认定为失败。 它可以防止一直等待得不到响应的请求。</li> <li><strong>Capacity</strong>： 容量参数定义了可以同时进行的异步请求数。 即使异步 I/O 通常带来更高的吞吐量，执行异步 I/O 操作的算子仍然可能成为流处理的瓶颈。 限制并发请求的数量可以确保算子不会持续累积待处理的请求进而造成积压，而是在容量耗尽时触发反压。</li></ul> <h6 id="维表关联"><a href="#维表关联" class="header-anchor">#</a> 维表关联</h6> <p>这里以关联用户维表为例，使用异步IO结合缓存的方式实现订单明细事实表关联用户维度表扩展宽表中的字段。一般来说，公司都会有一个统一的实时数仓维度表的存储框架，HBase和Redis比较常见。选用HBase或者Redis，是否使用异步IO关联并没有一个明确的标准。</p> <ul><li>当存储在Hbase中的维度表变化缓慢，且数据量较大时，我们对维度表的时效性不是特别高的时候，可以使用异步IO查询同时在本地内存中做<strong>缓存</strong>以提高查询性能。</li> <li>当维度表数据比较小，且变化频繁，把维表数据存在Redis中，查询redis也是一种不错的方案。</li></ul> <p><strong>订单事实表与用户维度表关联</strong></p> <p>######## 代码实现</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">/**
 * 订单明细表与用户维度表Join
 * @param input
 */</span>
<span class="token keyword">case</span> <span class="token keyword">class</span> OrderDetailAndDimUserJoin<span class="token punctuation">(</span>input<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>DwdOrderDetail<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">extends</span> Format<span class="token punctuation">[</span>DwdOrderDetail<span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> getUid<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">&quot;joinDimUser&quot;</span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> getName<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">&quot;joinDimUser&quot;</span>

  <span class="token keyword">def</span> joinDimUser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> DataStream<span class="token punctuation">[</span>DwdOrderDetail<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>input<span class="token punctuation">)</span>

  <span class="token keyword">override</span> <span class="token keyword">protected</span> <span class="token keyword">def</span> doFormat<span class="token punctuation">(</span>input<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>DwdOrderDetail<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> DataStream<span class="token punctuation">[</span>DwdOrderDetail<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 几个重要的参数说明:
     * 1.unorderedWait/orderedWait：结果的有序和无序
     * 2.Timeout： 超时参数定义了异步请求发出多久后未得到响应即被认定为失败。 它可以防止一直等待得不到响应的请求。
     * Capacity： 容量参数定义了可以同时进行的异步请求数。
     */</span>
    AsyncDataStream<span class="token punctuation">.</span>unorderedWait<span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token keyword">new</span> OrderDetailAndDimUserJoinFunc<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">object</span> OrderDetailAndDimUserJoin <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">val</span> logger<span class="token operator">:</span> Logger <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">)</span>

  <span class="token comment">/**
   * guava cache用于将数据缓存到JVM内存中,简单、强大、及轻量级。
   * 它不需要配置文件，使用起来和ConcurrentHashMap一样简单，而且能覆盖绝大多数使用cache的场景需求！
   */</span>
  <span class="token keyword">var</span> cache<span class="token operator">:</span> Cache<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> DimUserInfo<span class="token punctuation">]</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> asyncConn<span class="token operator">:</span> AsyncConnection <span class="token operator">=</span> _
  <span class="token keyword">var</span> table<span class="token operator">:</span> AsyncTable<span class="token punctuation">[</span>AdvancedScanResultConsumer<span class="token punctuation">]</span> <span class="token operator">=</span> _

  <span class="token keyword">class</span> OrderDetailAndDimUserJoinFunc<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> RichAsyncFunction<span class="token punctuation">[</span>DwdOrderDetail<span class="token punctuation">,</span> DwdOrderDetail<span class="token punctuation">]</span> <span class="token punctuation">{</span>

    <span class="token comment">// 当前线程下，用于future回调的上下文环境</span>
    <span class="token keyword">implicit</span> <span class="token keyword">lazy</span> <span class="token keyword">val</span> executor <span class="token operator">=</span> ExecutionContext<span class="token punctuation">.</span>fromExecutor<span class="token punctuation">(</span>Executors<span class="token punctuation">.</span>directExecutor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * 1. 初始化HBaseConnection、Table等，这里使用的是HBase2.0之后的异步客户端,实现与java库的CompletableFuture
     * 2. 缓存的初始化
     * @param parameters
     */</span>
    <span class="token keyword">override</span> <span class="token keyword">def</span> open<span class="token punctuation">(</span>parameters<span class="token operator">:</span> Configuration<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      cache <span class="token operator">=</span> CacheBuilder<span class="token punctuation">.</span>newBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>expireAfterWrite<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>HOURS<span class="token punctuation">)</span> <span class="token comment">// 设置cache中的数据在写入之后的存活时间为2小时</span>
        <span class="token punctuation">.</span>maximumSize<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span> <span class="token comment">// 设置缓存大小为10000</span>
        <span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span>

      asyncConn <span class="token operator">=</span> HBaseUtil<span class="token punctuation">.</span>getAsyncConn<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
      table <span class="token operator">=</span> asyncConn<span class="token punctuation">.</span>getTable<span class="token punctuation">(</span>TableName<span class="token punctuation">.</span>valueOf<span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>DIM_USER_INFO<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">def</span> asyncInvoke<span class="token punctuation">(</span>input<span class="token operator">:</span> DwdOrderDetail<span class="token punctuation">,</span> resultFuture<span class="token operator">:</span> ResultFuture<span class="token punctuation">[</span>DwdOrderDetail<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 发送异步请求，接收 future 结果</span>
        <span class="token keyword">val</span> resultFutureRequested<span class="token operator">:</span> Future<span class="token punctuation">[</span>DwdOrderDetail<span class="token punctuation">]</span> <span class="token operator">=</span> Future <span class="token punctuation">{</span>
          <span class="token keyword">var</span> dimUser <span class="token operator">=</span> <span class="token keyword">new</span> DimUserInfo
          <span class="token comment">// 先查询缓存中数据，若缓存不存在则查询HBase</span>
          <span class="token keyword">val</span> dimUserInfo <span class="token operator">=</span> cache<span class="token punctuation">.</span>getIfPresent<span class="token punctuation">(</span>input<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>Objects<span class="token punctuation">.</span>isNull<span class="token punctuation">(</span>dimUserInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 查询HBase</span>
            <span class="token keyword">val</span> get <span class="token operator">=</span> <span class="token keyword">new</span> Get<span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span>toBytes<span class="token punctuation">(</span>input<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>addFamily<span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span>toBytes<span class="token punctuation">(</span><span class="token string">&quot;f1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token keyword">val</span> result <span class="token operator">=</span> table<span class="token punctuation">.</span>get<span class="token punctuation">(</span>get<span class="token punctuation">)</span>
            result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rawCells<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>cell <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">val</span> colName <span class="token operator">=</span> Bytes<span class="token punctuation">.</span>toString<span class="token punctuation">(</span>CellUtil<span class="token punctuation">.</span>cloneQualifier<span class="token punctuation">(</span>cell<span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token keyword">val</span> value <span class="token operator">=</span> Bytes<span class="token punctuation">.</span>toString<span class="token punctuation">(</span>CellUtil<span class="token punctuation">.</span>cloneValue<span class="token punctuation">(</span>cell<span class="token punctuation">)</span><span class="token punctuation">)</span>

              colName <span class="token keyword">match</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token string">&quot;birthday&quot;</span> <span class="token keyword">=&gt;</span> dimUser<span class="token punctuation">.</span>userBirthday <span class="token operator">=</span> value
                <span class="token keyword">case</span> <span class="token string">&quot;gender&quot;</span> <span class="token keyword">=&gt;</span> dimUser<span class="token punctuation">.</span>userGender <span class="token operator">=</span> value
                <span class="token keyword">case</span> <span class="token string">&quot;login_name&quot;</span> <span class="token keyword">=&gt;</span> dimUser<span class="token punctuation">.</span>userLoginName <span class="token operator">=</span> value
                <span class="token keyword">case</span> _ <span class="token keyword">=&gt;</span> <span class="token comment">// do nothing</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token comment">// 将查询结果写入到缓存中</span>
            cache<span class="token punctuation">.</span>put<span class="token punctuation">(</span>input<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> dimUser<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span>
            dimUser <span class="token operator">=</span> dimUserInfo

          <span class="token comment">// 结果输出</span>
          input<span class="token punctuation">.</span>from<span class="token punctuation">(</span>dimUser<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * 客户端完成请求后要执行的回调函数,将结果发给future
         */</span>
        resultFutureRequested<span class="token punctuation">.</span>onSuccess <span class="token punctuation">{</span>
          <span class="token keyword">case</span> result<span class="token operator">:</span> DwdOrderDetail <span class="token keyword">=&gt;</span> resultFuture<span class="token punctuation">.</span>complete<span class="token punctuation">(</span>Iterable<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> e<span class="token operator">:</span> Exception <span class="token keyword">=&gt;</span> LoggerUtil<span class="token punctuation">.</span>error<span class="token punctuation">(</span>logger<span class="token punctuation">,</span> e<span class="token punctuation">,</span>
          s<span class="token string">&quot;failed to joinDimUser,input=$input&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 当异步 I/O 请求超时的时候，默认会抛出异常并重启作业。如果你想处理超时，可以重写 AsyncFunction##timeout 方法。
     * @param input
     * @param resultFuture
     */</span>
    <span class="token keyword">override</span> <span class="token keyword">def</span> timeout<span class="token punctuation">(</span>input<span class="token operator">:</span> DwdOrderDetail<span class="token punctuation">,</span> resultFuture<span class="token operator">:</span> ResultFuture<span class="token punctuation">[</span>DwdOrderDetail<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span>
      <span class="token keyword">super</span><span class="token punctuation">.</span>timeout<span class="token punctuation">(</span>input<span class="token punctuation">,</span> resultFuture<span class="token punctuation">)</span>

    <span class="token comment">/**
     * 关闭连接
     */</span>
    <span class="token keyword">override</span> <span class="token keyword">def</span> close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>asyncConn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> asyncConn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>另外几张维度表的实现方式和以上类似，就不一一实现了，实际上我们考虑到了真实的线上数据情况，选择了一种比较复杂的实现方式。</p> <p><strong>以上，一张订单交易域的DWD事实宽表事实宽表就已经做好了，它包含了订单相关的明细数据，以及冗余了用户、商品、地区、品牌等维度的维度信息，然后将数据以</strong>json<strong>格式写入到Kafka中，作为实时数仓的DWD层。</strong></p> <blockquote><h2 id="总结-3"><a href="#总结-3" class="header-anchor">#</a> 总结</h2> <ul><li><p>读取Kafka的Change log数据</p></li> <li><p>DIM维度层</p> <ul><li>HBase</li> <li>Redis</li></ul></li> <li><p>DWD层</p> <ul><li>事实表关联：双流Join</li> <li>维度表关联：Cache + 异步IO</li></ul></li> <li><p>以上都可以使用Flink sql（在搭建好实时计算平台之后）</p></li></ul></blockquote> <h1 id="_6-流量数据"><a href="#_6-流量数据" class="header-anchor">#</a> 6. 流量数据</h1> <h2 id="_6-1-模型设计"><a href="#_6-1-模型设计" class="header-anchor">#</a> 6.1 模型设计</h2> <p>在前面的流量数据采集中，已经将埋点上报的用户行为日志采集到ODS层，保存在Kafka中作为贴源层。在设计流量域DWD数据明细层的时候，数据建模思路是和传统离线数仓是一致的。在实时数仓分层设计中提到，与业务数据的处理略有不同，对于流量数据而言，在DWD层一般会做数据数据通过的ETL处理，如统一数据格式等以及会做维度表的关联，行为各张明细事实宽表。</p> <h3 id="_6-1-1-选择业务过程"><a href="#_6-1-1-选择业务过程" class="header-anchor">#</a> 6.1.1 选择业务过程</h3> <p>在选择业务过程之前，先简单介绍一下数据埋点，按照获取数据的类型以及用户触发行为的不同，埋点一般可以分为以下几种：</p> <h4 id="点击事件"><a href="#点击事件" class="header-anchor">#</a> 点击事件</h4> <p>用户在应用内的每一次点击行为，都可以记为一次点击事件。比如按钮的点击，区域的点击，商品的点击，每一条新闻的点击等，都可以成为一个点击事件。</p> <p>一般通过点击事件，我们可以拿到点击PV，点击UV。</p> <h4 id="曝光事件"><a href="#曝光事件" class="header-anchor">#</a> 曝光事件</h4> <p>曝光事件是为了统计应用内的某些局部区域是否被用户<strong>有效</strong>浏览。比如推荐区域，某个按钮，首焦等等。</p> <p>比如一般来说我们在衡量页面某个区域用户的点击率的时候，首先需要搞清楚的就是这个区域到底被多少用户看到了，每被用户看到一次就是一个简单的曝光事件，然后才能计算点击率。</p> <p>做曝光埋点的时候需要注意两个事情：</p> <ul><li><p>第一，有效曝光的定义要科学，合理</p></li> <li><p>第二，为了不影响页面性能以及用户体验，不能在应用内的所有区域都加曝光埋点。</p></li></ul> <h4 id="页面事件"><a href="#页面事件" class="header-anchor">#</a> 页面事件</h4> <p>页面事件通常是指页面的各种维度信息的统计，通常通过页面参数来传递。常见的比如页面浏览PV，页面浏览UV。</p> <p>页面事件通常统计的信息包括以下几个部分：</p> <ul><li>浏览器信息：浏览器版本，浏览器语言，浏览器编码，屏幕分辨率等等；</li> <li>访问信息：用户账号，当前页面url，上次访问时间，访问时长，页面停留时间等等；</li> <li>来源信息：广告来源，上一页面url等等；</li> <li>物品信息：不同的业务，这部分信息区别很大。</li></ul> <p>在了解了一些常见的数据埋点类型之后，对于流量域DWD层的建设可以分为以下3个业务事实：</p> <ul><li>点击</li> <li>曝光</li> <li>页面浏览</li></ul> <h3 id="_6-1-2-粒度"><a href="#_6-1-2-粒度" class="header-anchor">#</a> 6.1.2 粒度</h3> <p>这里使用的是神策数据埋点模型，数据的粒度是event</p> <h3 id="_6-1-3-维度"><a href="#_6-1-3-维度" class="header-anchor">#</a> 6.1.3 维度</h3> <p>可以结合公司具体业务，用户行为数据一般关注的维度信息有：</p> <ul><li>页面</li> <li>地理位置</li> <li>时间</li> <li>广告媒介</li> <li>操作系统</li> <li>浏览器</li> <li>平台，如APP、小程序、H5</li></ul> <p>值的一提的是，维度数据的选择应该完全遵循DIM层一致性维度表，且维度的定义应该尽量与离线数仓保持一致。</p> <h3 id="_6-1-4-事实"><a href="#_6-1-4-事实" class="header-anchor">#</a> 6.1.4 事实</h3> <p>最常见的事实有点击、曝光、页面浏览次数等；</p> <h2 id="_6-2-dwd层数据开发"><a href="#_6-2-dwd层数据开发" class="header-anchor">#</a> 6.2 DWD层数据开发</h2> <p>流量数据ODS -&gt; DWD层需要做的事情：</p> <ul><li><p>通用的ETL处理</p> <ul><li><p>空值、异常格式数据过滤等</p></li> <li><p>做一定的数据格式转换，通常采集到ODS的数据都是像一些类似嵌套Json的格式，可以统一格式</p></li></ul></li> <li><p>维度表的关联，基于模型设计里的维度</p></li> <li><p>将点击、曝光、页面点击事件分流到下游不同的Kafka Topic中</p></li></ul> <blockquote><p>代码详见：ods2dwd模块下 com.gmall.data.dwd.FlowTopologyV2</p></blockquote> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">object</span> FlowTopologyV2 <span class="token punctuation">{</span>

  <span class="token keyword">implicit</span> <span class="token keyword">private</span> <span class="token keyword">val</span> redisConfig <span class="token operator">=</span> RedisConfig<span class="token punctuation">(</span>Config<span class="token punctuation">.</span>redisHost<span class="token punctuation">,</span> Config<span class="token punctuation">.</span>redisPort<span class="token punctuation">,</span> Config<span class="token punctuation">.</span>redisPassword<span class="token punctuation">,</span> Config<span class="token punctuation">.</span>redisDb<span class="token punctuation">)</span>

  <span class="token comment">// 定义侧输出的标签</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> exposeOutPut         <span class="token operator">=</span> OutputTag<span class="token punctuation">[</span>DwdUserBaseLog<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;exposeOutPut&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> pageOutPut           <span class="token operator">=</span> OutputTag<span class="token punctuation">[</span>DwdUserBaseLog<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;pageOutPut&quot;</span><span class="token punctuation">)</span>

  <span class="token comment">// kafka输出</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> actionLogProducer <span class="token operator">=</span> SinkFactory<span class="token punctuation">.</span>createKafkaProducer<span class="token punctuation">[</span>DwdUserBaseLog<span class="token punctuation">]</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>DWD_USER_ACTION_LOG<span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> exposeLogProducer <span class="token operator">=</span> SinkFactory<span class="token punctuation">.</span>createKafkaProducer<span class="token punctuation">[</span>DwdUserBaseLog<span class="token punctuation">]</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>DWD_USER_EXPOSE_LOG<span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> pageLogProducer <span class="token operator">=</span> SinkFactory<span class="token punctuation">.</span>createKafkaProducer<span class="token punctuation">[</span>DwdUserBaseLog<span class="token punctuation">]</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>DWD_PAGE_VIEW_LOG<span class="token punctuation">)</span>

  <span class="token keyword">def</span> build<span class="token punctuation">(</span>kafkaConfig<span class="token operator">:</span> KafkaConfig<span class="token punctuation">)</span><span class="token punctuation">(</span>
    <span class="token keyword">implicit</span> env<span class="token operator">:</span> StreamExecutionEnvironment<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 1. 读取Kafka中ODS层用户行为日志
     * 2. 数据ETL处理，统一格式
     * 3. 关联eventName维度表信息
     * 4. 对点击、曝光、页面浏览事件分流
     */</span>
    <span class="token keyword">val</span> eventStream <span class="token operator">=</span> SourceFactory<span class="token punctuation">.</span>createKafkaStream<span class="token punctuation">[</span>OdsUserActionLog<span class="token punctuation">]</span><span class="token punctuation">(</span>kafkaConfig<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>ODS_USER_ACTION_LOG<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>convertToDwdLog<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>joinDimEvent<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>process<span class="token punctuation">(</span>EventTypeSplitFunc<span class="token punctuation">(</span>exposeOutPut<span class="token punctuation">,</span> pageOutPut<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * 从侧输出的标签取出对应的曝光、页面点击测流
     */</span>
    <span class="token keyword">val</span> exposeStream <span class="token operator">=</span> eventStream<span class="token punctuation">.</span>getSideOutput<span class="token punctuation">(</span>exposeOutPut<span class="token punctuation">)</span>
    <span class="token keyword">val</span> pageStream <span class="token operator">=</span> eventStream<span class="token punctuation">.</span>getSideOutput<span class="token punctuation">(</span>pageOutPut<span class="token punctuation">)</span>


    <span class="token comment">/**
     * 点击、曝光、页面浏览事件流输出到Kafka，作为实时数仓DWD层
     */</span>
    eventStream<span class="token punctuation">.</span>addSink<span class="token punctuation">(</span>actionLogProducer<span class="token punctuation">)</span>
    exposeStream<span class="token punctuation">.</span>addSink<span class="token punctuation">(</span>exposeLogProducer<span class="token punctuation">)</span>
    pageStream<span class="token punctuation">.</span>addSink<span class="token punctuation">(</span>pageLogProducer<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="_7-实时指标"><a href="#_7-实时指标" class="header-anchor">#</a> 7. 实时指标</h1> <p><code>写在前面</code></p> <blockquote><p>不知不觉已经来到了2021年的夏天了，今年的夏天来的格外的早，风也很大，似乎学习的思路也应该转变一下。刚开始做这一行的时候，拿到一个需求的时候，可能会直接想到怎么代码实现，而没有真正去理解需求所涉及的架构是否合理、如何从产品的角度理解需求，甚至需求本身它就是不合理的。拿数据指标体系而言，作为一个研发人员，应该从数据产品、数仓架构、业务特点等角度来理解数据指标体系。本文主要参考&lt;人人都是产品经理&gt;、&lt;指标体系在滴滴的实现&gt;。</p> <p>文章：</p> <p><a href="https://mp.weixin.qq.com/s/4JNPf4qhGyJ_JK5W3ZTkag" target="_blank" rel="noopener noreferrer">数据仓库&amp;数据指标&amp;数据治理体系搭建方法论<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="_7-1-数据指标体系"><a href="#_7-1-数据指标体系" class="header-anchor">#</a> 7.1 数据指标体系</h2> <h3 id="什么是数据指标体系"><a href="#什么是数据指标体系" class="header-anchor">#</a> 什么是数据指标体系</h3> <ul><li><p>通常我们讲述的指标是对当前业务有参考价值的统计数据，换句话说，不是所有的数据都叫指标；指标的核心意义是它使得业务目标可描述、可度量、可拆解；常用的指标有PV、UV等。</p></li> <li><p>指标可分为原子指标和派生指标，按照笔者的理解，原子指标就是不加任何修饰词的指标，又叫度量，例如订单量、用户量、支付金额等；衍生/派生指标就是在原子指标上进行加减乘除或者修饰词的限定等等。</p></li></ul> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011726.png" alt=""></p> <ul><li>指标体系是从不同维度梳理业务，并将零散单点的具有相互联系的指标，系统化地组织起来；其中，维度分为定性维度和定量维度，定性维度主要是文字描述类，例如姓名、地名等；定量维度主要是数值描述类，如工资、年龄等。</li> <li>指标体系是由不同的维度组成，而维度是指用户观察、思考与表述某事物的“思维角度”，维度是指标体系的核心，没有维度，单纯说指标是没有任何意义的。维度主要分为定性维度和定量维度，定性维度，主要是偏文字描述类如城市、性别、职业等;定量维度，主要是数值类描述如收入、年龄等，对定量维度需要做数值分组处理。</li> <li>总的来说，指标体系是对业务指标体系化的汇总，主要用来明确指标的维度、口径、指标取数逻辑等信息，并能够迅速获得指标的相关信息。多个不同的指标和维度可以组合起来进行业务的综合分析，用户可通过指标的变化看到整体业务的变化，并能够快速发现问题、定位问题</li></ul> <h3 id="指标体系生命周期"><a href="#指标体系生命周期" class="header-anchor">#</a> 指标体系生命周期</h3> <p>生命周期主要包含定义、生产、消费、下线四个阶段。针对整个生命周期要持续做指标运维、质量保障，同时为了提高指标数据复用度，降低用户使用成本需要做对应的数据运营工作。</p> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011742" style="zoom:50%;"> <h3 id="为什么需要数据指标体系"><a href="#为什么需要数据指标体系" class="header-anchor">#</a> 为什么需要数据指标体系</h3> <ul><li>对于数据产品经理来说，搭建指标体系可以更好地梳理业务，提高问题分析效率。</li> <li>对于研发来说，大数据平台统一关键指标业务口径及计算口径，统一企业业务目标，实现自上而下目标驱动。</li></ul> <h2 id="_7-2-如何设计指标体系"><a href="#_7-2-如何设计指标体系" class="header-anchor">#</a> 7.2 如何设计指标体系</h2> <p>指标体系建设的常用方法是通过场景化进行指标体系的搭建，以用户的视角场景化思考，自上而下业务驱动指标体系建设，所以要在特定场景下做好指标体系建设，需要先选好指标，然后用科学的方法搭建指标体系。</p> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011939.png" alt="【7000字】从 0-1 构建指标体系" style="zoom:50%;"> <h3 id="_7-2-1-定目标"><a href="#_7-2-1-定目标" class="header-anchor">#</a> 7.2.1 定目标</h3> <p>这是第一步，也是最重要的一步，同时也是很多产品上线运营后进行评估的标准，并以此形成闭环。</p> <p>好的目标具有以下三个特征：</p> <ul><li>与高层目标一致；</li> <li>目标应当符合 SMART 原则；</li> <li>具有挑战性。</li></ul> <h3 id="_7-2-2-用分析模型搭建指标体系"><a href="#_7-2-2-用分析模型搭建指标体系" class="header-anchor">#</a> 7.2.2 用分析模型搭建指标体系</h3> <p>在《精益数据分析》一书中给出了两套比较常用的指标体系建设方法论，其中一个就是比较有名的海盗指标法，也就是我们经常听到的AARRR海盗模型。海盗模型是用户分析的经典模型，它反映了增长是系统性地贯穿于用户生命周期各个阶段的：用户拉新(Acquisition)、用户激活(Activation)、用户留存(Retention)、商业变现(Revenue)、用户推荐(Referral)。</p> <h4 id="aarrr模型"><a href="#aarrr模型" class="header-anchor">#</a> AARRR模型</h4> <ul><li>A拉新
通过各种推广渠道，以各种方式获取目标用户，并对各种营销渠道的效果评估，不断优化投入策略，降低获客成本。涉及关键指标：曝光量、点击、下载、安装、激活、安装率、激活率、注册转化率、留存率、付费率等。</li> <li>A活跃
活跃用户指真正开始使用了产品提供的价值，我们需要掌握用户的行为数据，监控产品健康程度。这个模块主要反映用户进入产品的行为表现，是产品体验的核心所在。涉及关键指标：新老用户占比、DAU/WAU/MAU、日均登录次数、日均使用时长等。</li> <li>R留存
衡量用户粘性和质量的指标。涉及关键指标：新用户留存率、老用户留存率、活跃用户留存率、日周月留存率、流失率等。</li> <li>R变现
主要用来衡量产品商业价值。涉及关键指标：ARPU、ARPPU、付费率（区分新老用户）、客单价、LTV、GMV 等。</li> <li>R推荐
主要是基于产品、营销、明星等事件的吸引力，从而使用户自发地传播。涉及关键指标例如邀请率、裂变系数等</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128011958.png" alt=""></p> <h4 id="osm模型"><a href="#osm模型" class="header-anchor">#</a> OSM模型</h4> <p>OSM模型（Obejective，Strategy，Measurement）是指标体系建设过程中辅助确定核心的重要方法，包含业务目标、业务策略、业务度量，是指标内容横向的思考。</p> <ul><li>O 用户使用产品的目标是什么？产品满足了用户的什么需求？主要从用户视角和业务视角确定目标，原则是切实可行、易理解、可干预、正向有益</li> <li>S 为了达成上述目标我采取的策略是什么？</li> <li>M 这些策略随之带来的数据指标变化有哪些？</li></ul> <p>可以根据实际业务场景，结合使用OSM和AARRR模型，来系统性的选择不同阶段所需要的核心数据指标。</p> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012024.png" alt="图片" style="zoom:50%;"> <h4 id="指标分级"><a href="#指标分级" class="header-anchor">#</a> 指标分级</h4> <p>指标分级主要是将指标化解为不同层级并逐级分析。根据企业战略、企业组织及业务进行自上而下的分级，对指标进行层层剖析，其中可结合 OSM 模型来确定指标。</p> <ul><li>**一级指标：公司战略层 **</li></ul> <p>用于衡量公司整体目标完成情况，与公司当前业务紧密结合，并对所有员工均有核心的指导意义。一级指标通常指引着公司的战略。</p> <p>一级指标通常根据市场、产品生命周期、产品品类和商业模式确定，一个时间点只有一个最关键的指标（OMTM，One Metric That Matters）。</p> <p>例如：小红书的OMTM（又称：北极星指标）如何演变？</p> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012051.png" alt="【7000字】从 0-1 构建指标体系" style="zoom:50%;"> <ul><li><strong>二级指标：业务策略层</strong></li></ul> <p>为达成战略目标，公司会对其进一步拆解为业务线或事业群的核心指标；通常为了实现一级指标，企业会做出相应的策略，二级指标也会与这些策略有所关联。</p> <p>例如：小红书当前的一级指标是销售额，那么二级指标可以设定为不同品类商品的销售额，分地区的销售额等；这样当一级指标出现问题的时候，我们可以快速定位问题所在。</p> <ul><li><strong>三级指标：业务执行层</strong></li></ul> <p>三级指标是将二级指标纵向展开，进行路径拆解、漏斗拆解、公式拆解；三级指标通常用于定位二级指标的问题，通常指导一线运营或分析人员开展工作，三级指标是业务中最多的指标。</p> <p>路径拆解需要对业务流程进行分析，例如：打开应用、浏览首页、浏览商品详情页、加入购物车、提交订单、订单支付、支付成功。</p> <p>运用公式拆解月活跃用户，如下图。</p> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012116.png" alt="【7000字】从 0-1 构建指标体系" style="zoom:50%;"> <h3 id="_7-2-3-场景化搭建指标体系"><a href="#_7-2-3-场景化搭建指标体系" class="header-anchor">#</a> 7.2.3 场景化搭建指标体系</h3> <p>目前阶段互联网业务比较流行的一种通用抽象场景“人、货、场”，实际就是我们日常所说的用户、产品、场景，在通俗点讲就是谁在什么场景下使用了什么产品，不同的商业模式会有不同的组合模式。</p> <p>以滴滴实际场景为例：哪些场景（此处场景定义为终端，如Native，微信，支付宝）的什么人（乘客）在平台上使用了哪些货（平台业务线，如快车/专车等），进而为评估用户增长的价值和效果。</p> <h4 id="人的视角"><a href="#人的视角" class="header-anchor">#</a> 人的视角</h4> <p>从&quot;人&quot;的视角，我们比较关心的是什么乘客在什么时间打的车，排了多长时间，等了多长时间上车，周期内第几次打车，打车花了多少钱，是否有投诉和取消行为，具体到数据指标主要看发单用户数、完单用户数、客单价、周期内完单订单数、取消订单数、评价订单数等。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012140.png" alt=""></p> <h4 id="货的视角"><a href="#货的视角" class="header-anchor">#</a> 货的视角</h4> <p>从&quot;货&quot;的视角，我们比较关心的就是成交了多少，交易额多少，花了多少，到具体数据指标主要会看GMV、成交率、取消率指标，在进一步会细分到城市、区域，一级品类、二级品类。数据的效果通过目标对比，横向对比、历史比较等方式进行分析确定。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012147.png" alt=""></p> <h4 id="场的视角"><a href="#场的视角" class="header-anchor">#</a> 场的视角</h4> <p>从&quot;场&quot;的视角，我们比较关心的就是哪个渠道用户点击量大曝光率大，带来了多少新用户，完成多少交易订单，客单价是多少；或者是哪个活动拉新或促活效果怎么样转化率多少，结合场景数据实际情况制定对应策略。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012209" alt=""></p> <p>以上分别从&quot;人&quot;、&quot;货&quot;、&quot;场&quot;三个角度进行了数据指标和分析维度的提炼，下面我们把三类指标结合指标分级方法进行分解关联。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012216.png" alt=""></p> <h2 id="_7-3-如何管理指标体系"><a href="#_7-3-如何管理指标体系" class="header-anchor">#</a> 7.3 如何管理指标体系</h2> <h3 id="_7-3-1-痛点分析"><a href="#_7-3-1-痛点分析" class="header-anchor">#</a> 7.3.1 痛点分析</h3> <p>主要从业务、技术、产品三个视角来看：</p> <ul><li><p>业务视角</p> <p>业务分析场景指标、维度不明确；</p> <p>频繁的需求变更和反复迭代，数据报表臃肿，数据参差不齐；</p> <p>用户分析具体业务问题找数据、核对确认数据成本较高。</p></li> <li><p>技术视角</p> <p>指标定义，指标命名混乱，指标不唯一，指标维护口径不一致；</p> <p>指标生产，重复建设；数据汇算成本较高；</p> <p>指标消费，数据出口不统一，重复输出，输出口径不一致；</p></li> <li><p>产品视角</p> <p>缺乏系统产品化支持从生产到消费数据流没有系统产品层面打通；</p></li></ul> <h3 id="_7-3-2-管理目标"><a href="#_7-3-2-管理目标" class="header-anchor">#</a> 7.3.2 管理目标</h3> <ul><li><p>技术目标</p> <p>统一指标和维度管理，指标命名、计算口径、统计来源唯一， 维度定义规范、维度值一致</p></li> <li><p>业务目标<br>
统一数据出口、场景化覆盖</p></li> <li><p>产品目标<br>
指标体系管理工具产品化落地；指标体系内容产品化落地支持决策、分析、运营例如决策北极星、智能运营分析产品等</p></li></ul> <h3 id="_7-3-3-模型架构"><a href="#_7-3-3-模型架构" class="header-anchor">#</a> 7.3.3 模型架构</h3> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012225.png" alt=""></p> <h4 id="业务线"><a href="#业务线" class="header-anchor">#</a> 业务线</h4> <p>业务板块定义原则：业务逻辑层面进行抽象、物理组织架构层面进行细分，可根据实际业务情况进行层级分拆细化，层级分级建议进行最多进行三级分拆，一级细分可公司层面统一规范确定，二级及后续拆分可根据业务线实际业务进行拆分。例如滴滴出行领域业务逻辑层面两轮车和四轮车都属于出行领域可抽象出行业务板块(level一级)，根据物理组织架构层面在进行细分普惠、网约车、出租车、顺风车（level二级），后续根据实际业务需求可在细分,网约车可细分独乘、合乘，普惠可细分单车、企业级。</p> <p><strong>规范定义：</strong></p> <ul><li><p>数据域
指面向业务分析，将业务过程或者维度进行抽象的集合。其中，业务过程可以概括为一个个不拆分的行为事件，在业务过程之下，可以定义指标；维度，是度量的环境，如乘客呼单事件，呼单类型是维度。为了保障整个体系的生命力，数据域是需要抽象提炼，并且长期维护更新的，变动需执行变更流程。</p></li> <li><p>业务过程</p> <p>指公司的业务活动事件，如，呼单、支付都是业务过程。其中，业务过程不可拆分。</p></li> <li><p>时间周期</p></li> <li><p>用来明确统计的时间范围或者时间点，如最近30天、自然周、截止当日等。</p></li> <li><p>修饰类型</p> <p>是对修饰词的一种抽象划分。修饰类型从属于某个业务域，如日志域的访问终端类型涵盖APP端、PC端等修饰词。</p></li> <li><p>修饰词</p> <p>指的是统计维度以外指标的业务场景限定抽象，修饰词属于一种修饰类型，如在日志域的访问终端类型下，有修饰词APP、PC端等。</p></li> <li><p>度量/原子指标</p> <p>原子指标和度量含义相同，基于某一业务事件行为下的度量，是业务定义中不可再拆分的指标，具有明确业务含义的名称，如支付金额。</p></li> <li><p>维度</p> <p>维度是度量的环境，用来反映业务的一类属性，这类属性的集合构成一个维度，也可以称为实体对象。维度属于一个数据域，如地理维度（其中包括国家、地区、省市等）、时间维度（其中包括年、季、月、周、日等级别内容）。</p></li> <li><p>维度属性</p> <p>维度属性隶属于一个维度，如地理维度里面的国家名称、国家ID、省份名称等都属于维度属性。</p></li> <li><p>指标分类</p> <p>主要分为原子指标、派生指标、衍生指标</p></li></ul> <p><strong>原子指标</strong><br>
基于某一业务事件行为下的度量，是业务定义中不可再拆分的指标，具有明确业务含义的名称，如呼单量、交易金额</p> <p><strong>派生指标</strong>
是1个原子指标+多个修饰词（可选）+时间周期，是原子指标业务统计范围的圈定。派生指标又分以下二种类型：</p> <ol><li><ul><li>事务型指标：
是指对业务过程进行衡量的指标。例如，呼单量、订单支付金额，这类指标需要维护原子指标以及修饰词，在此基础上创建派生指标。</li></ul></li> <li><ul><li>存量型指标：</li></ul></li> <li><p>是指对实体对象（如司机、乘客）某些状态的统计，例如注册司机总数、注册乘客总数，这类指标需要维护原子指标以及修饰词，在此基础上创建派生指标，对应的时间周期一般为“历史截止当前某个时间”。</p></li> <li><p><strong>衍生指标</strong>
是在事务性指标和存量型指标的基础上复合成的。主要有比率型、比例型、统计型均值</p></li></ol> <h4 id="模型设计"><a href="#模型设计" class="header-anchor">#</a> 模型设计</h4> <p>主要采用维度建模方法进行构建，基础业务明细事实表主要存储维度属性集合和度量/原子指标；分析业务汇总事实表按照指标类别(去重指标、非去重指标)分类存储，非去重指标汇总事实表存储统计维度集合、原子指标或派生指标，去重指标汇总事实表只存储分析实体统计标签集合。</p> <p>指标体系在数仓物理实现层面主要是结合数仓模型分层架构进行指导建设，指标数据主要存储在DWS层，作为指标的核心管理层。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012235.png" alt=""></p> <h3 id="_7-3-4-指标体系元数据管理"><a href="#_7-3-4-指标体系元数据管理" class="header-anchor">#</a> 7.3.4 指标体系元数据管理</h3> <p><strong>维度管理：</strong></p> <p>包括基础信息和技术信息，由不同角色进行维护管理。</p> <ul><li>基础信息对应维度的业务信息，由业务管理人员、数据产品或BI分析师维护，主要包括维度名称、业务定义、业务分类。</li> <li>技术信息对应维度的数据信息，由数据研发维护，主要包括是否有维表（是枚举维度还是有独立的物理维表）、是否是日期维、对应code英文名称和中文名称、对应name英文名称和中文名称。如果维度有维度物理表，则需要和对应的维度物理表绑定，设置code和name对应的字段。如果维度是枚举维，则需要填写对应的code和name。维度的统一管理，有利于以后数据表的标准化，也便于用户的查询使用。</li></ul> <p><strong>指标管理：</strong></p> <p>包括基础信息、技术信息和衍生信息，由不同角色进行维护管理。</p> <ul><li>基础信息对应指标的业务信息，由业务管理人员、数据产品或BI分析师维护，主要包括归属信息(业务板块、数据域、业务过程)，基本信息(指标名称、指标英文名称、指标定义、统计算法说明、指标类型(去重、非去重))，业务场景信息(分析维度，场景描述)；</li> <li>技术信息对应指标的物理模型信息，由数据研发进行维护，主要包括对应物理表及字段信息；</li> <li>衍生信息对应关联派生或衍生指标信息、关联数据应用和业务场景信息，便于用户查询指标被哪些其它指标和数据应用使用，提供指标血缘分析追查数据来源的能力。</li></ul> <p>原子指标定义归属信息 + 基本信息 + 业务场景信息</p> <p>派生指标定义时间周期 + 修饰词集合 + 原子指标</p> <p>修饰类型主要包含类型说明、统计算法说明、数据源(可选)</p> <h2 id="_7-4-实时指标定义与模型设计"><a href="#_7-4-实时指标定义与模型设计" class="header-anchor">#</a> 7.4 实时指标定义与模型设计</h2> <p>假设我们是一个初创型的电商互联网公司，涉及APP、小程序、Web等终端应用。作为整个公司指标体系的一部分，实时指标的管理方式和离线数仓中的指标是完全一致的，一般会有30% - 40%的公司核心指标会做实时指标，作为实时监控大屏、实时数据看板等。不同的互联网行业会关注不同的运营数据，细化来看，复杂的互联网产品关注的运营指标成百上千。但有一些指标时最常用的，这些指标反映了运营的核心状态。</p> <p>下面介绍几个常见的互联网运营指标，各位看官可以结合AARRR模型来理解这些指标含义：</p> <ul><li><p>新增用户数</p> <p>新增用户数是网站增长性的关键指标，指新增加的访问网站的用户数（或者新下载 App 的用户数），对于一个处于爆发期的网站，新增用户数会在短期内出现倍增的走势，是网站的战略机遇期，很多大型网站都经历过一个甚至多个短期内用户暴增的阶段。新增用户数有日新增用户数、周新增用户数、月新增用户数等几种统计口径。</p></li> <li><p>用户留存率</p> <p>新增的用户并不一定总是对网站（App）满意，在使用网站（App）后感到不满意，可能会注销账户（卸载 App），这些辛苦获取来的用户就流失掉了。网站把经过一段时间依然没有流失的用户称作留存用户，留存用户数比当期新增用户数就是用户留存率。</p> <div class="language- extra-class"><pre class="language-text"><code>用户留存率 = 留存用户数 / 当期新增用户数
</code></pre></div><p>当期新增用户数计算留存有时间窗口，即和当期数据比，3 天前新增用户留存的，称作 3 日留存；相应的，还有 5 日留存、7 日留存等。新增用户可以通过广告、促销、病毒营销等手段获取，但是要让用户留下来，就必须要使产品有实打实的价值。用户留存率是反映用户体验和产品价值的一个重要指标，一般说来，3 日留存率能做到 40% 以上就算不错了。和用户留存率对应的是用户流失率。</p> <div class="language- extra-class"><pre class="language-text"><code>用户流失率 = 1 - 用户留存率
</code></pre></div></li> <li><p>活跃用户数</p> <p>用户下载注册，但是很少打开产品，表示产品缺乏黏性和吸引力。活跃用户数表示打开使用产品的用户数，根据统计口径不同，有日活跃用户数、月活跃用户数等。提升活跃是网站运营的重要目标，各类 App 常用推送优惠促销消息给用户的手段促使用户打开产品。</p></li> <li><p>PV</p> <p>打开产品就算活跃，打开以后是否频繁操作，就用 PV 这个指标衡量，用户每次点击，每个页面跳转，被称为一个 PV（Page View）。PV 是网页访问统计的重要指标，在移动 App 上，需要进行一些变通来进行统计。</p></li> <li><p>GMV</p> <p>即成交总金额（Gross Merchandise Volume），是电商网站统计营业额（流水）、反映网站营收能力的重要指标。和 GMV 配合使用的还有订单量（用户下单总量）、客单价（单个订单的平均价格）等。</p></li> <li><p>转化率</p> <div class="language- extra-class"><pre class="language-text"><code>转化率 = 有购买行为的用户数 / 总访问用户数
</code></pre></div><p>用户从进入网站（App）到最后购买成功，可能需要经过复杂的访问路径，每个环节都有可能会离开：进入首页想了想没什么要买的，然后离开；搜索结果看了看不想买，然后离开；进入商品详情页面，看看评价、看看图片、看看价格，然后离开；放入购物车后又想了想自己的钱包，然后离开；支付的时候发现不支持自己喜欢的支付方式，然后离开…一个用户从进入网站到支付，完成一笔真正的消费，中间会有很大概率流失，网站必须要想尽各种办法：个性化推荐、打折促销、免运费、送红包、分期支付，以留住用户，提高转化率。以上是一些具有普适性的网站运营数据指标，具体到不同的网站根据自身特点，会有自己的指标。比如百度可能会关注“广告点击率”这样的指标，游戏公司可能会关注“付费玩家数”这样的指标。每个产品都应该根据自身特点寻找能够反映自身运营状况的数据指标。为了便于分析决策，这些指标通常会以图表的方式展示，即数据可视化。</p></li></ul> <h3 id="_7-4-1-实时指标定义"><a href="#_7-4-1-实时指标定义" class="header-anchor">#</a> 7.4.1 实时指标定义</h3> <p>实时指标的定义，也就是公司有哪些核心的指标数据需要实时展示，协助分析、运营人员查看运营效果，从而改变运营策略，另一方面，实时的指标数据做成实时大屏展示也能展示公司的实力。一般来说，实时指标的定义会有产品编写规范的PRD文档，研发和产品沟通确定实时指标。但不是<code>人人不是产品经理</code>吗！以下结合AARRR模型、OSM模型以及结合自身的理解，将实时指标分为以下几类：</p> <h4 id="基础指标监控"><a href="#基础指标监控" class="header-anchor">#</a> 基础指标监控</h4> <p>一般是公司从老板到运营到研发都会关注的一级指标，也就是核心KPI。</p> <p><strong>交易域</strong></p> <ul><li>订单金额</li> <li>下单人数</li> <li>客单价</li> <li>新客人数</li> <li>GMV</li> <li>商品销量</li> <li>商品销售金额</li> <li>复购</li></ul> <p><strong>用户域</strong></p> <p>可以从AARRR模型出发</p> <ul><li>新增注册用户数</li> <li>活跃用户数</li> <li>留存率/流失率</li> <li>用户参与度
<ul><li>人均启动APP次数</li> <li>人均使用时长</li></ul></li></ul> <p><strong>流量域</strong></p> <ul><li>PV：页面访问次数</li></ul> <p>以上只是列出了一些常见的一级指标，基于这些指标，已经可以支撑比较丰富的数据看板了。实时上，在实时监控大屏中，有两种数据指标的展现方式：</p> <p>一种是直接对原子指标展示，如以上的：</p> <ul><li><p>当日订单金额，并配置同比、环比</p></li> <li><p>当日下单人数，并配置同比、环比</p> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012258.png" alt="image-20210518232504987" style="zoom:50%;"></li></ul> <p>除了原子指标，更多的时候是一些派生的指标的展示，如在数仓建模过程中，完成了维度丰富的DWD层明细数据，往往关注的指标如：</p> <ul><li><p>小时级不同设备终端的活跃用户数</p></li> <li><p>小时级订单金额</p></li> <li><p>小时级不同渠道进来的新用户数</p> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012323.png" alt="image-20210518233251037" style="zoom:50%;"></li></ul> <h4 id="业务关键指标"><a href="#业务关键指标" class="header-anchor">#</a> 业务关键指标</h4> <p>如用户行为分析中，用户实时的点击、收藏、加购、下单次数等；</p> <h3 id="_7-4-2-实时数仓dws"><a href="#_7-4-2-实时数仓dws" class="header-anchor">#</a> 7.4.2 实时数仓DWS</h3> <p>说到这里，先看看离线数仓的DWS的含义。数据仓库汇总层数据(Data Warehouse Summary)，基于指标需求，构建初步汇总事实表，一般是宽表。基于上层的应用和产品的指标需求，构建公共粒度的汇总指标表。以宽表化手段物理化模型，构建命名规范、口径一致的统计指标，为上层提供公共指标。</p> <h4 id="dws的基本特点"><a href="#dws的基本特点" class="header-anchor">#</a> DWS的基本特点</h4> <ul><li>DWS层是面向分析维度进行设计的，分析维度通常是业务经常需要的看数据的角度。</li> <li>DWS层的指标要保持命名和口径一致，避免ADS层的指标数据混乱</li> <li>DWS是公共汇总层，提供不同维度的统计指标，指标的口径要保持一致，并且要提供详细的描述</li> <li>以宽表的形式进行设计，比如相同粒度的统计指标可以放在一起，避免创建太多的表</li> <li>公共汇总层的一个表通常会对应一个派生指标</li> <li>DWS存储派生指标(统计周期+修饰词+统计粒度+原子指标)，原子指标存储在DWD层的事实表中</li></ul> <h4 id="dws设计步骤"><a href="#dws设计步骤" class="header-anchor">#</a> DWS设计步骤</h4> <ul><li><p>首先，确定聚集维度，即确定统计粒度，比如商品粒度</p></li> <li><p>然后，确定统计周期，比如小时</p></li> <li><p>最后，确定聚集事实，即派生指标</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> dws_asale_trd_itm_ord_1h
<span class="token punctuation">(</span>
    item_id                 <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品ID'</span><span class="token punctuation">,</span>
    item_title              STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品名称'</span><span class="token punctuation">,</span>
    cate_id                 <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品类目ID'</span><span class="token punctuation">,</span>
    cate_name           STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品类目名称'</span><span class="token punctuation">,</span>
    mord_prov            STRING <span class="token keyword">COMMENT</span> <span class="token string">'收货人省份'</span><span class="token punctuation">,</span>
    confirm_paid_amt_sum_1d <span class="token keyword">DOUBLE</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近一小时订单已经确认收货的金额总和'</span>
<span class="token punctuation">)</span>
<span class="token keyword">COMMENT</span> <span class="token string">'商品粒度交易最近一小时汇总事实表'</span>
<span class="token keyword">WITH</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <h4 id="实时数仓dws汇总层建设"><a href="#实时数仓dws汇总层建设" class="header-anchor">#</a> 实时数仓DWS汇总层建设</h4> <p>在建设实时数仓汇总层的时候，跟离线数仓的分层设计上是一致的，但其具体技术实现会有很大不同。</p> <ul><li>第一：对于一些共性指标的加工，比如<code>pv，uv，订单业务过程指标</code>等，会在汇总层进行统一的运算，确保关于指标的口径是统一在一个固定的模型中完成。对于一些个性指标，从指标复用性的角度出发，确定唯一的时间字段，同时该字段尽可能与其他指标在时间维度上完成拉齐，例如行中异常订单数需要与交易域指标在事件时间上做到拉齐。</li> <li>第二：在实际汇总层建设中，需要进行多维的主题汇总，因为实时数仓本身是面向主题的，可能每个主题会关心的维度都不一样，所以需要在不同的主题下，按照这个主题关心的维度对数据进行汇总，最后来算业务方需要的汇总指标。在具体操作中：
<ul><li>对于pv类指标使用Flink SQL实现分钟汇总指标作为最小汇总单位指标(具体的时间统计周期也就是窗口大小的选择取决于业务方对指标数据时效性的要求)，在此基础上进行时间维度上的指标累加；</li> <li>对于uv类指标,直接KV数据库作为指标汇总容器，如HBase或者Redis，然后基于此提供API数据服务。</li></ul></li> <li>第三：汇总层建设过程中，还会涉及到衍生维度的加工。在汇总指标加工中可以使用Hbase的版本机制来构建一个衍生维度的拉链表，通过事件流和Hbase维表关联的方式得到实时数据当时的准确维度</li></ul> <h4 id="关于建设dws的一些问题"><a href="#关于建设dws的一些问题" class="header-anchor">#</a> 关于建设DWS的一些问题</h4> <p>一般在离线数仓中，一张DWS表通常只会对应一个派生指标，在设计DWS表的时候，很多人会把所有可以聚合的维度进行cube，这样就得到了很多个派生指标，而这些派生指标放在同一张表中无疑会增加这张表的使用难度，比如在实际的取数时，往往只关心某个统计粒度的指标。实际上cube的数据尽量放在ADS层，这样在开发数据接口或者应用层取数时都会比较方便。</p> <p>但实时计算是一个讲究延迟性，且实时数仓层级过多会造成任务依赖、复杂度变高，所以实时数仓又会强调尽量减少分层。所以个人任务，设计实时数仓，不应该照搬离线数仓的一套理论，比如在设计DWS表的时候，完全把所有可以聚合的维度进行cube，因为派生指标一个任务一个任务的算，而实时任务会7 * 24小时运行，无疑会增加很多额外计算资源，完全可以考虑将可以所有可以聚合的维度进行cube，比如计算小时级商品销量，可以将每小时商品销量、商品销售金额这两个派生指标放在一个表里。</p> <p>甚至直接由DWD -&gt; ADS，将ADS指标数据存外部数据库，提供API服务。</p> <h2 id="_7-5-实时指标开发"><a href="#_7-5-实时指标开发" class="header-anchor">#</a> 7.5 实时指标开发</h2> <h3 id="_7-5-1-flink-sql简单介绍"><a href="#_7-5-1-flink-sql简单介绍" class="header-anchor">#</a> 7.5.1 Flink Sql简单介绍</h3> <blockquote><p>以下文档粘贴于官方文档，Flink的官方文档非常详细，建议开发之前读两遍官方文档。</p></blockquote> <p>在之前的案例中，都是使用Flink DataStream进行业务需求开发的，但随着最近两年Flink Sql在社区的发展、SQL开发的便捷，各大小公司都在做基于Flink Sql的实时计算平台。在本项目中，实时指标计算与Flink Sql完美契合，一般实时指标的开发都是基于平台开发，这里不关注如何搭建一个简单的实时计算平台，下面简单介绍一下Flink Sql中的一些概念：</p> <h4 id="动态表-连续查询-continuous-query"><a href="#动态表-连续查询-continuous-query" class="header-anchor">#</a> 动态表 &amp; 连续查询(Continuous Query)</h4> <p><em>动态表</em> 是 Flink 的支持流数据的 Table API 和 SQL 的核心概念。与表示批处理数据的静态表不同，动态表是随时间变化的。可以像查询静态批处理表一样查询它们。查询动态表将生成一个 <em>连续查询</em> 。一个连续查询永远不会终止，结果会生成一个动态表。查询不断更新其(动态)结果表，以反映其(动态)输入表上的更改。本质上，动态表上的连续查询非常类似于定义物化视图的查询。</p> <p>需要注意的是，连续查询的结果在语义上总是等价于以批处理模式在输入表快照上执行的相同查询的结果。</p> <p>下图显示了流、动态表和连续查询之间的关系:</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012344.png" alt="Dynamic tables"></p> <ol><li>将流转换为动态表。</li> <li>在动态表上计算一个连续查询，生成一个新的动态表。</li> <li>生成的动态表被转换回流。</li></ol> <p><strong>注意：</strong> 动态表首先是一个逻辑概念。在查询执行期间不一定(完全)物化动态表。</p> <p>在下面，我们将解释动态表和连续查询的概念，并使用具有以下模式的单击事件流:</p> <div class="language- extra-class"><pre class="language-text"><code>[
  user:  VARCHAR,   // 用户名
  cTime: TIMESTAMP, // 访问 URL 的时间
  url:   VARCHAR    // 用户访问的 URL
]
</code></pre></div><h4 id="在流上定义表"><a href="#在流上定义表" class="header-anchor">#</a> 在流上定义表</h4> <p>为了使用关系查询处理流，必须将其转换成 <code>Table</code>。从概念上讲，流的每条记录都被解释为对结果表的 <code>INSERT</code> 操作。本质上我们正在从一个 <code>INSERT</code>-only 的 changelog 流构建表。</p> <p>下图显示了单击事件流(左侧)如何转换为表(右侧)。当插入更多的单击流记录时，结果表将不断增长。</p> <p><img src="D:%5CDocuments%5Cblog_doc%5Cdocs%5Cdatahouse%5C%E5%AE%9E%E6%97%B6%E6%95%B0%E4%BB%93%5Crealtime-dw-main%5Cdocs%5C8%E5%AE%9E%E6%97%B6%E6%8C%87%E6%A0%87.assets%5Cappend-mode.png" alt="Append mode"></p> <p><strong>注意：</strong> 在流上定义的表在内部没有物化。</p> <h4 id="连续查询"><a href="#连续查询" class="header-anchor">#</a> 连续查询</h4> <hr> <p>在动态表上计算一个连续查询，并生成一个新的动态表。与批处理查询不同，连续查询从不终止，并根据其输入表上的更新更新其结果表。在任何时候，连续查询的结果在语义上与以批处理模式在输入表快照上执行的相同查询的结果相同。</p> <p>在接下来的代码中，我们将展示 <code>clicks</code> 表上的两个示例查询，这个表是在点击事件流上定义的。</p> <p>第一个查询是一个简单的 <code>GROUP-BY COUNT</code> 聚合查询。它基于 <code>user</code> 字段对 <code>clicks</code> 表进行分组，并统计访问的 URL 的数量。下面的图显示了当 <code>clicks</code> 表被附加的行更新时，查询是如何被评估的。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012356.png" alt="Continuous Non-Windowed Query"></p> <p>当查询开始，<code>clicks</code> 表(左侧)是空的。当第一行数据被插入到 <code>clicks</code> 表时，查询开始计算结果表。第一行数据 <code>[Mary,./home]</code> 插入后，结果表(右侧，上部)由一行 <code>[Mary, 1]</code> 组成。当第二行 <code>[Bob, ./cart]</code> 插入到 <code>clicks</code> 表时，查询会更新结果表并插入了一行新数据 <code>[Bob, 1]</code>。第三行 <code>[Mary, ./prod?id=1]</code> 将产生已计算的结果行的更新，<code>[Mary, 1]</code> 更新成 <code>[Mary, 2]</code>。最后，当第四行数据加入 <code>clicks</code> 表时，查询将第三行 <code>[Liz, 1]</code> 插入到结果表中。</p> <p>第二条查询与第一条类似，但是除了用户属性之外，还将 <code>clicks</code> 分组至<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sql/#group-windows" target="_blank" rel="noopener noreferrer">每小时滚动窗口<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中，然后计算 url 数量(基于时间的计算，例如基于特定<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/streaming/time_attributes.html" target="_blank" rel="noopener noreferrer">时间属性<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的窗口，后面会讨论)。同样，该图显示了不同时间点的输入和输出，以可视化动态表的变化特性。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012403.png" alt="Continuous Group-Window Query"></p> <p>与前面一样，左边显示了输入表 <code>clicks</code>。查询每小时持续计算结果并更新结果表。clicks表包含四行带有时间戳(<code>cTime</code>)的数据，时间戳在 <code>12:00:00</code> 和 <code>12:59:59</code> 之间。查询从这个输入计算出两个结果行(每个 <code>user</code> 一个)，并将它们附加到结果表中。对于 <code>13:00:00</code> 和 <code>13:59:59</code> 之间的下一个窗口，<code>clicks</code> 表包含三行，这将导致另外两行被追加到结果表。随着时间的推移，更多的行被添加到 <code>click</code> 中，结果表将被更新。</p> <h4 id="更新和追加查询"><a href="#更新和追加查询" class="header-anchor">#</a> 更新和追加查询</h4> <p>虽然这两个示例查询看起来非常相似(都计算分组计数聚合)，但它们在一个重要方面不同:</p> <ul><li>第一个查询更新先前输出的结果，即定义结果表的 changelog 流包含 <code>INSERT</code> 和 <code>UPDATE</code> 操作。</li> <li>第二个查询只附加到结果表，即结果表的 changelog 流只包含 <code>INSERT</code> 操作。</li></ul> <p>一个查询是产生一个只追加的表还是一个更新的表有一些含义:</p> <ul><li>产生更新更改的查询通常必须维护更多的状态(请参阅以下部分)。</li> <li>将 append-only 的表转换为流与将已更新的表转换为流是不同的(参阅<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/streaming/dynamic_tables.html#table-to-stream-conversion" target="_blank" rel="noopener noreferrer">表到流的转换<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>章节)。</li></ul> <h3 id="_7-5-2-需求"><a href="#_7-5-2-需求" class="header-anchor">#</a> 7.5.2 需求</h3> <p>详细指标参考以上指标定义，下面以几个指标为例：</p> <p><strong>实时监控大屏</strong></p> <ul><li>实时订单金额</li> <li>实时下单人数</li> <li>实时UV</li> <li>实时PV</li></ul> <p><strong>实时指标</strong></p> <ul><li><p>渠道维度分时新增用户</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012412.png" alt=""></p></li> <li><p>商品维度分时销售金额</p></li> <li><p>终端维度分时PV</p></li></ul> <h3 id="_7-5-3-数据开发"><a href="#_7-5-3-数据开发" class="header-anchor">#</a> 7.5.3 数据开发</h3> <h4 id="创建dwd层kafka源表"><a href="#创建dwd层kafka源表" class="header-anchor">#</a> 创建DWD层Kafka源表</h4> <p><strong>交易域订单明细表</strong>：定义允许延迟5秒的watermark</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> dwd_order_detail <span class="token punctuation">(</span>
  ts <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  detail_id STRING<span class="token punctuation">,</span>
  order_id STRING<span class="token punctuation">,</span>
  sku_id STRING<span class="token punctuation">,</span>
  sku_name STRING<span class="token punctuation">,</span>
  sku_num STRING<span class="token punctuation">,</span>
  order_price STRING<span class="token punctuation">,</span>
  source_type STRING<span class="token punctuation">,</span>
  province_id STRING<span class="token punctuation">,</span>
  user_id STRING<span class="token punctuation">,</span>
  order_status STRING<span class="token punctuation">,</span>
  total_amount STRING<span class="token punctuation">,</span>
  activity_reduce_amount STRING<span class="token punctuation">,</span>
  coupon_reduce_amount STRING<span class="token punctuation">,</span>
  original_total_amount STRING<span class="token punctuation">,</span>
  feight_fee STRING<span class="token punctuation">,</span>
  split_total_amount STRING<span class="token punctuation">,</span>
  split_activity_amount STRING<span class="token punctuation">,</span>
  split_coupon_amount STRING<span class="token punctuation">,</span>
  create_time <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  operate_time <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  expire_time <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  coupon_id STRING<span class="token punctuation">,</span>
  province_name STRING<span class="token punctuation">,</span>
  province_area_code STRING<span class="token punctuation">,</span>
  province_iso_code STRING<span class="token punctuation">,</span>
  province_3166_2_code STRING<span class="token punctuation">,</span>
  user_birthday STRING<span class="token punctuation">,</span>
  user_gender STRING<span class="token punctuation">,</span>
  user_login_name STRING<span class="token punctuation">,</span>
  spu_id STRING<span class="token punctuation">,</span>
  tm_id STRING<span class="token punctuation">,</span>
  category3_id STRING<span class="token punctuation">,</span>
  spu_name STRING<span class="token punctuation">,</span>
  tm_name STRING<span class="token punctuation">,</span>
  category3_name STRING<span class="token punctuation">,</span>
  dt STRING<span class="token punctuation">,</span>
  WATERMARK <span class="token keyword">FOR</span> <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> <span class="token keyword">SECOND</span>
<span class="token punctuation">)</span>
<span class="token keyword">COMMENT</span> <span class="token string">'订单明细宽表'</span>
<span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'localhost:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'dwd-dws'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'earliest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'dwd_order_detail'</span>
<span class="token punctuation">)</span>
</code></pre></div><p><strong>流量域</strong></p> <p>在前面<code>流量数据DWD层</code>的建设中，一共做了3张关于埋点的用户行为事件表，分别是：</p> <ul><li>用户行为-点击事件明细表</li> <li>用户行为-曝光事件明细表</li> <li>用户行为-页面浏览明细表</li></ul> <p>本次案例中，这三张表的数据结构均一致，以点击事件用细表为例，创建一张点击事件明细Kafka源表：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> dwd_user_action_log	<span class="token punctuation">(</span>
 event STRING <span class="token keyword">COMMENT</span> <span class="token string">'事件'</span><span class="token punctuation">,</span>
 event_name STRING <span class="token keyword">COMMENT</span> <span class="token string">'时间名称'</span><span class="token punctuation">,</span>
 user_id STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>
 distinct_id STRING <span class="token keyword">COMMENT</span> <span class="token string">'唯一ID'</span><span class="token punctuation">,</span>
 event_time <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'事件时间'</span><span class="token punctuation">,</span>
 event_time_stamp <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'事件时间戳'</span><span class="token punctuation">,</span>
 app_name STRING <span class="token keyword">COMMENT</span> <span class="token string">'应用端'</span><span class="token punctuation">,</span>
 app_version STRING <span class="token keyword">COMMENT</span> <span class="token string">'应用的版本'</span><span class="token punctuation">,</span>
 is_login STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否首次登陆'</span><span class="token punctuation">,</span>
 is_vip STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否VIP'</span><span class="token punctuation">,</span>
 wifi STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否wifi'</span><span class="token punctuation">,</span>
 page_title STRING <span class="token keyword">COMMENT</span> <span class="token string">'所在页面'</span><span class="token punctuation">,</span>
 page_type STRING <span class="token keyword">COMMENT</span> <span class="token string">'页面类型'</span><span class="token punctuation">,</span>
 platform_type STRING <span class="token keyword">COMMENT</span> <span class="token string">'平台类型'</span><span class="token punctuation">,</span>
 store_id STRING <span class="token keyword">COMMENT</span> <span class="token string">'门店ID'</span><span class="token punctuation">,</span>
 store_name STRING <span class="token keyword">COMMENT</span> <span class="token string">'门店名称'</span><span class="token punctuation">,</span>
 supplier_id STRING <span class="token keyword">COMMENT</span> <span class="token string">'供应商ID'</span><span class="token punctuation">,</span>
 supplier_name STRING <span class="token keyword">COMMENT</span> <span class="token string">'供应商名称'</span><span class="token punctuation">,</span>
 room_id STRING <span class="token keyword">COMMENT</span> <span class="token string">'直播间id'</span><span class="token punctuation">,</span>
 room_name STRING <span class="token keyword">COMMENT</span> <span class="token string">'直播间名称'</span><span class="token punctuation">,</span>
 vip_level STRING <span class="token keyword">COMMENT</span> <span class="token string">'VIP等级'</span><span class="token punctuation">,</span>
 lib STRING <span class="token keyword">COMMENT</span> <span class="token string">'SDK类型，例如python、iOS等'</span><span class="token punctuation">,</span>
 browser STRING <span class="token keyword">COMMENT</span> <span class="token string">'浏览器名，例如Chrome'</span><span class="token punctuation">,</span>
 browser_version STRING <span class="token keyword">COMMENT</span> <span class="token string">'浏览器版本，例如Chrome 45'</span><span class="token punctuation">,</span>
 carrier STRING <span class="token keyword">COMMENT</span> <span class="token string">'运营商名称，例如ChinaNet'</span><span class="token punctuation">,</span>
 province STRING<span class="token punctuation">,</span>
 city STRING<span class="token punctuation">,</span>
 country STRING<span class="token punctuation">,</span>
 os STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作系统，例如iOS'</span><span class="token punctuation">,</span>
 os_version STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作系统版本，例如8.1.1'</span><span class="token punctuation">,</span>
 model STRING <span class="token keyword">COMMENT</span> <span class="token string">'设备型号，例如iphone6'</span><span class="token punctuation">,</span>
 utm_campaign STRING <span class="token keyword">COMMENT</span> <span class="token string">'广告系列名称'</span><span class="token punctuation">,</span>
 utm_content STRING <span class="token keyword">COMMENT</span> <span class="token string">'广告系列内容'</span><span class="token punctuation">,</span>
 utm_matching_type STRING <span class="token keyword">COMMENT</span> <span class="token string">'渠道追踪匹配模式'</span><span class="token punctuation">,</span>
 utm_medium STRING <span class="token keyword">COMMENT</span> <span class="token string">'广告系列媒介'</span><span class="token punctuation">,</span>
 utm_source STRING <span class="token keyword">COMMENT</span> <span class="token string">'广告系列来源'</span><span class="token punctuation">,</span>
 utm_term STRING <span class="token keyword">COMMENT</span> <span class="token string">'广告系列字词'</span><span class="token punctuation">,</span>
 url STRING <span class="token keyword">COMMENT</span> <span class="token string">'url'</span><span class="token punctuation">,</span>
 referrer STRING <span class="token keyword">COMMENT</span> <span class="token string">'向前地址'</span><span class="token punctuation">,</span>
 scene STRING <span class="token keyword">COMMENT</span> <span class="token string">'启动场景'</span><span class="token punctuation">,</span>
 spu_id STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品ID'</span><span class="token punctuation">,</span>
 spu_name STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品名'</span><span class="token punctuation">,</span>
 spu_quantity <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品数量'</span><span class="token punctuation">,</span>
 WATERMARK <span class="token keyword">FOR</span> <span class="token punctuation">`</span>event_time_stamp<span class="token punctuation">`</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>event_time_stamp<span class="token punctuation">`</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> <span class="token keyword">SECOND</span>
<span class="token punctuation">)</span>
<span class="token keyword">COMMENT</span> <span class="token string">'订单明细宽表'</span>
<span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'localhost:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'dwd-dws'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'earliest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'dwd_user_action_log'</span>
<span class="token punctuation">)</span>
</code></pre></div><h4 id="uv类指标"><a href="#uv类指标" class="header-anchor">#</a> UV类指标</h4> <p>该类指标如：当天页面的访问人数、下单人数、新客人数等，需要对用户做精准去重，且直接做数据大屏展示。所以DWS层的设计中，直接使用KV数据库来存储指标的聚合值，一个思路是可以使用HBase的列可以动态扩展的特性，或者redis的Hash结构存储，将此类指标统一存储到一张Hash表中，减少重复建表等开发。</p> <p>值的一提的是，Flink社区并没有实现<code>flink-sql-redis-connector</code>,需要自己实现；或者到github找一个开源项目，但一般需要二次开发才能用。</p> <h5 id="指标需求"><a href="#指标需求" class="header-anchor">#</a> 指标需求</h5> <ol><li>实时UV指标</li></ol> <p>对该指标进行梳理：统计维度是app_id/app_name，事件周期为当天，派生指标为不同端当天(实时)UV。</p> <ul><li><p>创建Redis结果表,并设置key的TTL为7天</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> dws_core_point <span class="token punctuation">(</span>
  <span class="token keyword">key</span> STRING<span class="token punctuation">,</span>
  field STRING<span class="token punctuation">,</span>
  <span class="token keyword">value</span> STRING<span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token keyword">key</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED
<span class="token punctuation">)</span> <span class="token keyword">with</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'redis'</span><span class="token punctuation">,</span>
  <span class="token string">'mode'</span> <span class="token operator">=</span> <span class="token string">'hashmap'</span><span class="token punctuation">,</span>
  <span class="token string">'host'</span> <span class="token operator">=</span> <span class="token string">'${Config.redisHost}'</span><span class="token punctuation">,</span>
  <span class="token string">'port'</span> <span class="token operator">=</span> <span class="token string">'6379'</span><span class="token punctuation">,</span>
  <span class="token string">'password'</span> <span class="token operator">=</span> <span class="token string">'${Config.redisPassword}'</span><span class="token punctuation">,</span>
  <span class="token string">'dbNum'</span> <span class="token operator">=</span> <span class="token string">'0'</span><span class="token punctuation">,</span>
  <span class="token string">'key.ttl'</span> <span class="token operator">=</span> <span class="token string">'604800'</span>
<span class="token punctuation">)</span>
</code></pre></div></li> <li><p>Flink SQL任务基于event_time计算当日uv并写入Redis的hash结构中</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> dws_core_point
<span class="token keyword">SELECT</span>
 CONCAT_WS<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> <span class="token string">'dws_core_point'</span><span class="token punctuation">,</span> DATE_FORMAT<span class="token punctuation">(</span>event_time_stamp<span class="token punctuation">,</span> <span class="token string">'yyyyMMdd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token string">'uv'</span><span class="token punctuation">,</span>
 CAST<span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> dwd_user_action_log
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> CONCAT_WS<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> <span class="token string">'dws_core_point'</span><span class="token punctuation">,</span> DATE_FORMAT<span class="token punctuation">(</span>event_time_stamp<span class="token punctuation">,</span> <span class="token string">'yyyyMMdd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>查看redis中的数据，uv指标数据实时更新</p> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012431.png" alt="image-20210522004416835" style="zoom:50%;"></li></ul> <ol start="2"><li>下单人数、新客人数等指标的计算方式和UV指标的计算方式一致，当然指标结果也可以使用HBase存储，参考官方文档开发就行。</li></ol> <h4 id="pv类指标"><a href="#pv类指标" class="header-anchor">#</a> PV类指标</h4> <p>对于pv类指标使用Flink SQL实现分钟汇总指标作为最小汇总单位指标(具体的时间统计周期也就是窗口大小的选择取决于业务方对指标数据时效性的要求)，在此基础上进行时间维度上的指标累加。此类指标一般还会做分钟级或者小时级的同比环比等需求。</p> <h5 id="指标需求-2"><a href="#指标需求-2" class="header-anchor">#</a> 指标需求</h5> <ol><li>计算不同端每10分钟页面浏览次数</li></ol> <p>对该指标进行梳理：统计维度是app_id/app_name，事件周期为10分钟，派生指标为端维度10分钟PV。</p> <ul><li><p>创建mysql结果表</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> dws_flow_app_pv_10min <span class="token punctuation">(</span>
  app_name STRING<span class="token punctuation">,</span>
  start_time STRING<span class="token punctuation">,</span>
  end_time <span class="token keyword">INT</span><span class="token punctuation">,</span>
  pv <span class="token keyword">BIGINT</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
   <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'jdbc'</span><span class="token punctuation">,</span>
   <span class="token string">'url'</span> <span class="token operator">=</span> <span class="token string">'jdbc:mysql://localhost:3306/ads'</span><span class="token punctuation">,</span>
   <span class="token string">'table-name'</span> <span class="token operator">=</span> <span class="token string">'dws_flow_app_pv_10min'</span><span class="token punctuation">,</span>
   <span class="token string">'username'</span> <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
   <span class="token string">'password'</span> <span class="token operator">=</span> <span class="token string">'******'</span>
<span class="token punctuation">)</span>
</code></pre></div></li> <li><p>Flink SQL任务基于滚动窗口聚合将每10分钟分端UV写入mysql</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> dws_flow_app_pv_10min
<span class="token keyword">SELECT</span>
   app_name<span class="token punctuation">,</span>
   TUMBLE_START<span class="token punctuation">(</span>event_time_stamp<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   TUMBLE_END<span class="token punctuation">(</span>event_time_stamp<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">FROM</span> dwd_user_action_log
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> TUMBLE<span class="token punctuation">(</span>event_time_stamp<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">,</span> app_name&quot;<span class="token punctuation">)</span>
</code></pre></div></li></ul> <blockquote><h3 id="实时指标总结"><a href="#实时指标总结" class="header-anchor">#</a> 实时指标总结</h3> <ul><li>从计算层面来说，使用Flink Sql开发比较方便，一般相应的SQL也比较简单。</li> <li>实时的DWS表根据指标的特点不同，可以选择不同的存储引擎，<code>但不管选择什么存储，建设DWS的目的都是一致性的指标口径，保证所有的核心指标都是在一个固定模型中计算出来的。</code></li></ul> <h2 id="写在后面"><a href="#写在后面" class="header-anchor">#</a> 写在后面</h2> <ul><li>作为研发，从数据产品的角度去理解业务是非常有意义的。</li> <li>实时指标属于数据指标平台的一部分，指标体系的设计、选择AARRR模型结合OSM模型。</li> <li>实时数仓分层设计参考离线数仓，DWS存储派生指标。指标计算依赖于Flink SQL平台。</li></ul> <h3 id="todo-2"><a href="#todo-2" class="header-anchor">#</a> TODO</h3> <ul><li>实时Flink SQL计算平台</li> <li>实时指标、实时特征计算、管理平台</li></ul></blockquote> <h1 id="_8-实时olap"><a href="#_8-实时olap" class="header-anchor">#</a> 8. 实时OLAP</h1> <p><code>写在前面</code></p> <p>在实时数仓的应用场景中，除了实时数据指标平台以外，实时OLAP应该算是最重要的场景了。以下也会从数据产品的角度出发，理解数据分析需求，从0到1设计、搭建一个实时OLAP系统。</p> <p>一些技术文章：</p> <blockquote><p><a href="https://mp.weixin.qq.com/s/TyeT1JvV1NZRJW5dIiV4zA" target="_blank" rel="noopener noreferrer">1.Kylin与ClickHouse的对比<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://mp.weixin.qq.com/s/unGF2-D7_HhIK8qZu7Vz0Q" target="_blank" rel="noopener noreferrer">2.Kylin、Druid、ClickHouse核心技术对比<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="_8-1-olap简介"><a href="#_8-1-olap简介" class="header-anchor">#</a> 8.1 OLAP简介</h2> <h3 id="_8-1-1-什么是olap"><a href="#_8-1-1-什么是olap" class="header-anchor">#</a> 8.1.1 什么是OLAP</h3> <p><strong>OLAP是Online analytical processing的英文缩写，指联机分析处理</strong>。从字面上可以看出是做分析类操作。通过分析数据库中的数据来得出一些结论性的东西。比如给老总们看的报表，用于进行市场开拓的用户行为统计，不同维度的汇总分析结果等等。操作主体一般是运营、产品和数据分析师等团队人员而不是用户。区别于OLTP，On-Line Transaction Processing，联机事务处理。</p> <ul><li><p>OLTP和OLAP的简单总结：</p> <table><thead><tr><th></th> <th>OLTP</th> <th>OLAP</th> <th></th></tr></thead> <tbody><tr><td>操作对象</td> <td>数据库</td> <td>数据仓库</td> <td></td></tr> <tr><td>数据量</td> <td>较小</td> <td>较大</td> <td></td></tr> <tr><td>数据模型</td> <td>实体-关系(ER)</td> <td>星型或雪花型</td> <td></td></tr> <tr><td>数据时效</td> <td>当前数据</td> <td>当前及历史数据</td> <td></td></tr> <tr><td>数据操作</td> <td>支持DDL/DML</td> <td>一般不支持更新和删除</td> <td></td></tr> <tr><td>操作粒度</td> <td>记录型</td> <td>涉及多表</td> <td></td></tr> <tr><td>性能要求</td> <td>高吞吐，低延迟</td> <td>性能要求相对较低</td> <td></td></tr> <tr><td>操作目的</td> <td>增删改查</td> <td>分析</td> <td></td></tr> <tr><td>业务类型</td> <td>面对用户：账户查询，转账等</td> <td>面对业务：统计，多维度分析</td> <td></td></tr></tbody></table></li></ul> <p>数据仓库与OLAP的关系是互补的，现代OLAP系统一般以数据仓库作为基础，即从数据仓库中抽取详细数据的一个子集并经过必要的聚集存储到OLAP存储器中供前端分析工具读取。</p> <h3 id="_8-1-2-olap的基本操作"><a href="#_8-1-2-olap的基本操作" class="header-anchor">#</a> 8.1.2 OLAP的基本操作</h3> <h4 id="数据立方体"><a href="#数据立方体" class="header-anchor">#</a> 数据立方体</h4> <p>中国作为信息技术领域的后起之秀，我们现在介绍的这些概念都源于英文。数据立方体就是从英文“Data Cube”而来。下图就是一个商品销售模型的数据立方体。</p> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012503.png" alt="Data-Cube" style="zoom:67%;"> <p>其实也可以叫它”数据魔方体“，因为立方体是三维的，而多维数据模型并不仅仅三维，虽然受图形化展示限制，一般仅展示其三个维度。而”魔方“一词，则凸现出了其变化性，通过对其进行不同的操作，让数据呈现出千变万化的结果。</p> <p>上图来源于参考资料，比较好展示了多维模型，从大立方体上可以看到商品类型、季度和地区三个维度。但对于每个维度又是一个小立方体，比如第一季度浙江的书籍销售情况就是左下角的小立方体。在这个小立方体中，根据需要，我们还可以按照书籍类型，从季度拆分为月度，浙江拆出各地级市。</p> <h4 id="olap的操作"><a href="#olap的操作" class="header-anchor">#</a> OLAP的操作</h4> <p>OLAP的操作是以查询——也就是数据库的SELECT操作为主，但是查询可以很复杂，比如基于关系数据库的查询可以多表关联，可以使用COUNT、SUM、AVG等聚合函数。OLAP正是基于多维模型定义了一些常见的面向分析的操作类型是这些操作显得更加直观。</p> <p>OLAP的多维分析操作包括：<code>钻取（Drill-down）</code>、<code>上卷（Roll-up）</code>、<code>切片（Slice）</code>、<code>切块（Dice）</code>以及<code>旋转（Pivot）</code></p> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012526.png" alt="OLAP" style="zoom:50%;"> <ul><li><strong>钻取（Drill-down）</strong>：在维的不同层次间的变化，从上层降到下一层，或者说是将汇总数据拆分到更细节的数据，比如通过对2010年第二季度的总销售数据进行钻取来查看2010年第二季度4、5、6每个月的消费数据，如上图；当然也可以钻取浙江省来查看杭州市、宁波市、温州市……这些城市的销售数据。</li> <li><strong>上卷（Roll-up）</strong>：钻取的逆操作，即从细粒度数据向高层的聚合，如将江苏省、上海市和浙江省的销售数据进行汇总来查看江浙沪地区的销售数据，如上图。</li> <li><strong>切片（Slice）</strong>：选择维中特定的值进行分析，比如只选择电子产品的销售数据，或者2010年第二季度的数据。</li> <li><strong>切块（Dice）</strong>：选择维中特定区间的数据或者某批特定值进行分析，比如选择2010年第一季度到2010年第二季度的销售数据，或者是电子产品和日用品的销售数据。</li> <li><strong>旋转（Pivot）</strong>：即维的位置的互换，就像是二维表的行列转换，如图中通过旋转实现产品维和地域维的互换。</li></ul> <h3 id="_8-1-3-olap分类"><a href="#_8-1-3-olap分类" class="header-anchor">#</a> 8.1.3 OLAP分类</h3> <p>一般来说OLAP根据建模方式可分为MOLAP、ROLAP和HOLAP 3种类型，下面分别进行介绍并分析优缺点。</p> <h4 id="molap"><a href="#molap" class="header-anchor">#</a> MOLAP</h4> <p>基于多维数组的存储模型，也是OLAP最初的形态，特点是对数据进行预计算，以空间换效率，明细和聚合数据都保存在cube中。但生成cube需要大量时间和空间。</p> <p>由于所有可能结果均已计算出来并持久化存储，查询时无需进行复杂计算，且以数组形式可以进行高效的免索引数据访问，因此用户发起的查询均能够稳定地快速响应。这些结果集是高度结构化的，可以进行压缩/编码来减少存储占用空间。</p> <p>但高性能并不是没有代价的。首先，MOLAP需要进行预计算，这会花去很多时间。如果每次写入增量数据后均要进行全量预计算，显然是低效率的，因此支持仅对增量数据进行迭代计算非常重要。其次，如果业务发生需求变更，需要进行预定模型之外新的查询操作，现有的MOLAP实例就无能为力了，只能重新进行建模和预计算。</p> <p>因此，<strong>MOLAP适合业务需求比较固定，数据量较大的场景</strong>。在开源软件中，由eBay开发并贡献给Apache基金会的Kylin即属于这类OLAP引擎，支持在百亿规模的数据集上进行亚秒级查询。</p> <p><strong>Kylin的构建步骤</strong></p> <ul><li>确定Hadoop上的星型/雪花模式。</li> <li>2个从已识别的表中构建多维数据集。</li> <li>3通过ODBC，JDBC或RESTful API使用ANSI-SQL查询并在不到一秒的时间内获得结果。</li></ul> <p>其架构图较直观得反映了基于cube的预计算模型（build），如下所示：</p> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012600.png" style="zoom:50%;"> <p><strong>Kylin的特性：</strong></p> <ul><li>可扩展超快olap引擎，Hadoop/Spark上百亿数据规模</li> <li>提供 Hadoop ANSI SQL 接口</li> <li>交互式查询能力，用户可以与Hadoop数据进行亚秒级交互</li> <li>百亿以上数据集构建多维立方体（MOLAP CUBE）</li> <li>与BI工具无缝整合，如Tableau，PowerBI/Excel，MSTR，QlikSense，Hue和SuperSet</li></ul> <h4 id="rolap"><a href="#rolap" class="header-anchor">#</a> ROLAP</h4> <p>与MOLAP相反，ROLAP无需预计算，直接在构成多维数据模型的事实表和维度表上进行计算。R即表示关系型（Relational）。显然，这种方式相比MOLAP更具可扩展性，增量数据导入后，无需进行重新计算，用户有新的查询需求时只需写好正确的SQL语句既能完成获取所需的结果。</p> <p>但ROLAP的不足也很明显，尤其是在数据体量巨大的场景下，用户提交SQL后，获取查询结果所需的时间无法准确预知，可能秒回，也可能需要花费数十分钟甚至数小时。本质上，ROLAP是把MOLAP预计算所需的时间分摊到了用户的每次查询上，肯定会影响用户的查询体验。当然ROLAP的性能是否能够接受，取决于用户查询的SQL类型，数据规模以及用户对性能的预期。</p> <p>相比MOLAP，ROLAP的使用门槛更低，在完成星型或雪花型模型的构建，创建对应schema的事实表和维度表并导入数据后，用户只需会写出符合需求的SQL，就可以得到想要的结果。相比创建“数据立方体”，显然更加方便。</p> <p>目前使用ROLAP的公司多一些，更灵活易用。</p> <h4 id="hsap"><a href="#hsap" class="header-anchor">#</a> HSAP</h4> <p>HSAP是最近阿里云提出的一种分析、服务一体化的架构。SAP 是指Hybrid serving and analytical processing，理念是能够支持这种很高QPS 的Serverless 场景的查询写入，并且将复杂的分析场景在一套体系里面完成，hologres是代表作品。</p> <h3 id="_8-1-4-olap的核心设计"><a href="#_8-1-4-olap的核心设计" class="header-anchor">#</a> 8.1.4 OLAP的核心设计</h3> <h4 id="mpp架构"><a href="#mpp架构" class="header-anchor">#</a> MPP架构</h4> <p>MPP (Massively Parallel Processing)，即大规模并行处理。简单来说，MPP是将任务并行的分散到多个服务器和节点上，在每个节点上计算完成后，将各自部分的结果汇总在一起得到最终的结果(与Hadoop相似)。平时熟悉的Impala、ClickHouse、Druid、Doris等都是MPP架构</p> <p><strong>MPP架构特征</strong></p> <ul><li>任务并行执行</li> <li>数据分布式存储(本地化)</li> <li>分布式计算</li> <li>私有资源</li> <li>横向扩展</li> <li>Shared Nothing架构</li></ul> <h4 id="向量化执行引擎"><a href="#向量化执行引擎" class="header-anchor">#</a> 向量化执行引擎</h4> <p>火山引擎与向量化执行引擎后面慢慢了解后再总结。</p> <h3 id="_8-1-5-开源rolap产品"><a href="#_8-1-5-开源rolap产品" class="header-anchor">#</a> 8.1.5 开源ROLAP产品</h3> <p>从技术影响力的角度来说，Github Star 排名前5 的系统也是目前市面上比较流行的开源OLAP 系统，它们的开源时间以及产品的定位各不相同。</p> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012621.png" alt="image-20210523194032047" style="zoom:50%;"> <p>目前生产环境使用较多的开源ROLAP主要可以分为2大类，一个是宽表模型，另一个是多表组合模型（就是前述的星型或雪花型）。</p> <p><strong>宽表模型</strong></p> <p>宽表模型能够提供比多表组合模型更好的查询性能，不足的是支持的SQL操作类型比较有限，比如对Join等复杂操作支持较弱或不支持。</p> <p>目前该类OLAP系统包括Druid和ClickHouse等，两者各有优势，Druid支持更大的数据规模，具备一定的预聚合能力，通过倒排索引和位图索引进一步优化查询性能，在广告分析场景、监控报警等时序类应用均有广泛使用；ClickHouse部署架构简单，易用，保存明细数据，依托其向量化查询、减枝等优化能力，具备强劲的查询性能。两者均具备较高的数据实时性，在互联网企业均有广泛使用。</p> <p>除了上面介绍的Druid和ClickHouse外，ElasticSearch和Solar也可以归为宽表模型。但其系统设计架构有较大不同，这两个一般称为搜索引擎，通过倒排索引，应用Scatter-Gather计算模型提高查询性能。对于搜索类的查询效果较好，但当数据量较大或进行扫描聚合类查询时，查询性能会有较大影响。</p> <p><strong>多表组合模型</strong></p> <p>采用星型或雪花型建模是最通用的一种ROLAP系统，常见的包括<code>GreenPlum、Presto和Impala</code>等，他们均基于MPP架构，采用该模型和架构的系统具有支持的数据量大、扩展性较好、灵活易用和支持的SQL类型多样等优点。</p> <p>相比其他类型ROLAP和MOLAP，该类系统性能不具有优势，实时性较一般。通用系统往往比专用系统更难实现和进行优化，这是因为通用系统需要考虑的场景更多，支持的查询类型更丰富。而专用系统只需要针对所服务的某个特定场景进行优化即可，相对复杂度会有所降低。</p> <h4 id="presto"><a href="#presto" class="header-anchor">#</a> Presto</h4> <p>Presto 是由 Facebook 开源的大数据分布式 SQL 查询引擎，基于内存的低延迟高并发并行计算（mpp），适用于交互式分析查询。</p> <ul><li>本身并不存储数据，但是可以接入多种数据源，包括Hive、RDBMS（Mysql、Oracle、Tidb等）、Kafka、MongoDB、Redis等</li> <li>完全支持ANSI SQL标准，用户可以直接使用 ANSI SQL 进行数据查询和计算</li> <li>可以混合多个catalog进行join查询和计算，支持跨数据源的级联查询</li> <li>基于PipeLine进行设计的，流水管道式数据处理，支持数据规模GB~PB，计算中拿出一部分放在内存、计算、抛出、再拿。</li> <li>SQL on Hadoop：弥补Hive的效率性能和灵活性的不足，Presto和Spark SQL、Impala有很多异曲同工之处。</li></ul> <p><strong>presto架构</strong>（master+slaver模式）：</p> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012742.jpeg" alt="图片" style="zoom:67%;"> <h4 id="druid"><a href="#druid" class="header-anchor">#</a> Druid</h4> <p>Druid是一个用于大数据实时查询和分析的高容错、高性能开源分布式系统，用于解决如何在大规模数据集下进行快速的、交互式的查询和分析。</p> <p>数据可以实时摄入，进入到Druid后立即可查，同时数据是几乎是不可变。通常是基于时序的事实事件，事实发生后进入Druid，外部系统就可以对该事实进行查询。</p> <p><strong>Druid架构</strong></p> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012814.png" style="zoom:67%;"> <p><strong>基本特点</strong></p> <p>Apache Druid 具有以下特点：</p> <ul><li>亚秒级 OLAP 查询，包括多维过滤、Ad-hoc 的属性分组、快速聚合数据等等。</li> <li>实时的数据消费，真正做到数据摄入实时、查询结果实时。</li> <li>高效的多租户能力，最高可以做到几千用户同时在线查询。</li> <li>扩展性强，支持 PB 级数据、千亿级事件快速处理，支持每秒数千查询并发。</li> <li>极高的高可用保障，支持滚动升级。</li></ul> <p><strong>应用场景</strong></p> <p>实时数据分析是 Apache Druid 最典型的使用场景。该场景涵盖的面很广，例如：</p> <ul><li>实时指标监控</li> <li>推荐模型</li> <li>广告平台</li> <li>搜索模型</li></ul> <p>Druid也有很多不足需要注意，由于druid属于时间存储，删除操作比较繁琐，且不支持查询条件删除数据，只能根据时间范围删除数据。Druid能接受的数据的格式相对简单，比如不能处理嵌套结构的数据。</p> <h4 id="clickhouse"><a href="#clickhouse" class="header-anchor">#</a> Clickhouse</h4> <p>Clickhouse是一个用于在线分析处理（OLAP）的列式数据库管理系统（DBMS）。</p> <p>是由俄罗斯的Yandex公司为了Yandex Metrica网络分析服务而开发。它支持分析实时更新的数据，Clickhouse以高性能著称。</p> <p><strong>场景特征：</strong></p> <ul><li>大多数是读请求</li> <li>数据总是以相当大的批(&gt; 1000 rows)进行写入</li> <li>不修改已添加的数据</li> <li>每次查询都从数据库中读取大量的行，但是同时又仅需要少量的列</li> <li>宽表，即每个表包含着大量的列</li> <li>较少的查询(通常每台服务器每秒数百个查询或更少)</li> <li>对于简单查询，允许延迟大约50毫秒</li> <li>列中的数据相对较小：数字和短字符串(例如，每个URL 60个字节)</li> <li>处理单个查询时需要高吞吐量（每个服务器每秒高达数十亿行）</li> <li>事务不是必须的</li> <li>对数据一致性要求低</li> <li>每一个查询除了一个大表外都很小</li> <li>查询结果明显小于源数据，换句话说，数据被过滤或聚合后能够被盛放在单台服务器的内存中</li></ul> <p><strong>clickhouse自身限制：</strong></p> <ul><li>不支持真正的删除/更新支持 不支持事务</li> <li>不支持二级索引</li> <li>有限的SQL支持，join实现与众不同</li> <li>不支持窗口功能</li> <li>元数据管理需要人工干预维护</li></ul> <p>ClickHouse开源的出现让许多想做大数据并且想做大数据分析的很多公司和企业耳目一新。ClickHouse 正是以不依赖Hadoop 生态、安装和维护简单、查询速度快、可以支持SQL等特点在大数据分析领域披荆斩棘越走越远。</p> <h2 id="_8-2-为什么需要olap"><a href="#_8-2-为什么需要olap" class="header-anchor">#</a> 8.2 为什么需要OLAP</h2> <ul><li>从数据产品、数据分析角度来说，说到数据分析，OLAP大概是最常见的选择，往往会对流量以及订单数据等进行多维灵活查询，使用OLAP分析工具对数据立方体捷快速查询、分析，将数据以柱状图、折线图、双轴图（或叫柱线图）、散点图等方式展现出来，以支持运营决策。</li> <li>从研发的角度来说，多维度的实时指标的需求往往是灵活多变的，对一些固定不变的需求可以使用Flink SQL计算出指标数据做大屏展示、提供API接口等是可以的，但对于一些不确定的数据指标需求很容易变成烟囱式的开发，对于用户行为数据分析领域，还需要看明细数据，如用户行为轨迹等，因此提供一个OLAP数据分析平台十分必要。</li></ul> <h3 id="olap实施阶段"><a href="#olap实施阶段" class="header-anchor">#</a> OLAP实施阶段</h3> <h4 id="需求阶段"><a href="#需求阶段" class="header-anchor">#</a> 需求阶段</h4> <p>需求分析包括：通过调研得出的业务需求（从维度、各业务的分析主题等方面进行描述）、性能需求（系统相应时间的要求）、技术需求、安全性需求以及需求的优先级等。</p> <p>在需求阶段，是我们熟悉相关业务知识的过程，这对我们接下来的设计环节至关重要。</p> <p>以神策数据分析平台为例，一些常见的数据分析需求:</p> <img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012844.png" alt="image-20210524001623967" style="zoom:50%;"> <h4 id="规划阶段"><a href="#规划阶段" class="header-anchor">#</a> 规划阶段</h4> <p>在需求分析的基础上，需要对项目的整体结构有一定的了解，按照软件工程的一般规则和方法规划整个项目的过程。在此需求中，主要是一些用户行为数据分析的需求，如用户路径、用户生命周期分析等，需要对最近半年的用户行为数据做灵活的分析，且对分析的实时性非常高，因此应该选择ROLAP类型的分析数据库，在开源领域可以选择ClickHouse是比较合适的，这里特别安利一波阿里云商业化的Hologres。</p> <h4 id="设计阶段"><a href="#设计阶段" class="header-anchor">#</a> 设计阶段</h4> <p>设计阶段是整个OLAP实施最重要的阶段，主要包括一些几个方面：</p> <ul><li>模型的设计</li> <li>维度的分析和设计</li> <li>实时表的设计</li></ul> <p>其中模型的分析包括定义问题和确定分析的目标和内容，A这家电商公司全年销售的毛衣的利润总额是多少？在2020年第一年度，牛仔裤的利润趋势是什么？</p> <p>维度的分析包括分析问题中所涉及的维度是哪些，每个主题中维度和度量值是多少。</p> <h4 id="构建模型阶段"><a href="#构建模型阶段" class="header-anchor">#</a> 构建模型阶段</h4> <p>根据业务需求确定需要分析的主题，根据分析的主题确定分析的粒度和度量值，包括分析的维度。例如，商品销售情况信息主题主要从商品类目、日期两个维度进行分析，最后测试和验证模型的正确性。</p> <h4 id="报表展现阶段"><a href="#报表展现阶段" class="header-anchor">#</a> 报表展现阶段</h4> <p>报表展现阶段，就是将分析的结果以一种直观、清晰明了的方式展现出来，可以利用一些成熟的报表工具展示（例如Apache Superset），也可以选择自己开发，在OLAP模型的基础上进行多角度的分析并展示，达到说明问题的效果。</p> <h2 id="_8-3-数据分析"><a href="#_8-3-数据分析" class="header-anchor">#</a> 8.3 数据分析</h2> <p>实时OLAP应用最多的场景就是数据分析。以下介绍几种数据分析模型，更多的从数据分析、产品的角度去理解需求，不专注于接口的定义以及API实现。</p> <p>常见的数据分析模型大致有几种：</p> <ul><li>事件分析</li> <li>漏斗分析</li> <li>留存分析</li> <li>用户路径分析</li> <li>LTV分析</li> <li>网页热力分析</li> <li>APP点击分析</li> <li>间隔(session)分析</li> <li>归因分析</li> <li>用户属性(画像)分析</li> <li>用户分群</li></ul> <h3 id="事件分析"><a href="#事件分析" class="header-anchor">#</a> 事件分析</h3> <h3 id="漏斗分析-2"><a href="#漏斗分析-2" class="header-anchor">#</a> 漏斗分析</h3> <h3 id="留存分析-2"><a href="#留存分析-2" class="header-anchor">#</a> 留存分析</h3> <h3 id="用户分布分析"><a href="#用户分布分析" class="header-anchor">#</a> 用户分布分析</h3> <h3 id="用户路径-2"><a href="#用户路径-2" class="header-anchor">#</a> 用户路径</h3> <h3 id="网页热力分析"><a href="#网页热力分析" class="header-anchor">#</a> 网页热力分析</h3> <h3 id="app点击分析"><a href="#app点击分析" class="header-anchor">#</a> APP点击分析</h3> <h3 id="间隔分析"><a href="#间隔分析" class="header-anchor">#</a> 间隔分析</h3> <h3 id="归因分析-2"><a href="#归因分析-2" class="header-anchor">#</a> 归因分析</h3> <h3 id="用户属性分析"><a href="#用户属性分析" class="header-anchor">#</a> 用户属性分析</h3> <h3 id="用户分群-2"><a href="#用户分群-2" class="header-anchor">#</a> 用户分群</h3> <blockquote><h2 id="总结-4"><a href="#总结-4" class="header-anchor">#</a> 总结</h2> <ul><li>OLAP系统的简介，主要分为MOLAP、ROLAP两种类型。</li> <li>常见的OLAP：Prosto、Druid、ClickHouse、Hologres</li> <li>OLAP最重要的领域是数据分析，关于用户行为分析，有几种常见的数据分析模型，这个慢慢学习再总结，内容有点多的。</li></ul> <h2 id="todo-3"><a href="#todo-3" class="header-anchor">#</a> TODO</h2> <ul><li>OLAP的生产实践</li> <li>数据分析模型设计与解读</li></ul></blockquote> <hr> <h1 id="番外篇-如何从0到1构建指标体系"><a href="#番外篇-如何从0到1构建指标体系" class="header-anchor">#</a> 番外篇：如何从0到1构建指标体系</h1> <blockquote><p>编辑导语：如今早已经进入了大数据时代，现在的数据指标体系对于促进产品和业务增长是至关重要的；在实际操作中，需要根据相应的数据分析和业务需求进行相应的构建；本文是作者分享了关于如何从0到1构建指标体系的方法，我们一起来看一下。</p></blockquote> <p>假设豆豆在小区附近开了一家小型超市，花花每周二下班后，都会来店里买半斤猪头肉，风雨无阻，从不间断。</p> <p>豆豆心想：“花花每次来的时间都很固定，并且已经坚持了好几个月，我如果提前把肉准备好，这样就可以节省彼此的时间了。”此后每周二，只要花花一到店里，豆豆就跟他说，“猪头肉已经调好啦，还特意为你多加了花生碎，直接拎走就行”。</p> <p>花花笑了，心里想：“嘿，这服务员挺贴心的，不错嘛”。在上面案例中，豆豆通过对花花 “每周二下班后买猪头肉” 行为的观察，提前“调好多加花生碎的猪头肉”。</p> <p>豆豆的这种做法不仅刷新了顾客的好感度，还提升了用户的忠诚度；豆豆观察花花的行为在互联网行业中叫做数据分析，要做好数据分析，并将数据分析应用于业务中，首先就需要构建好指标体系。</p> <p>接下来，笔者就会聊聊如何构建指标体系。</p> <h2 id="一、数据指标体系"><a href="#一、数据指标体系" class="header-anchor">#</a> 一、数据指标体系</h2> <h3 id="_1-什么是数据指标体系"><a href="#_1-什么是数据指标体系" class="header-anchor">#</a> 1. 什么是数据指标体系？</h3> <p>通常我们讲述的指标是对当前业务有参考价值的统计数据，换句话说，不是所有的数据都叫指标；指标的核心意义是它使得业务目标可描述、可度量、可拆解；常用的指标有PV、UV等。</p> <p>指标可分为原子指标和派生指标，按照笔者的理解，原子指标就是不加任何修饰词的指标，又叫度量，例如订单量、用户量、支付金额等；衍生/派生指标就是在原子指标上进行加减乘除或者修饰词的限定等等。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012910.png" alt=""></p> <p>派生指标是对原子指标业务统计范围的圈定，例如：昨日境外输入病例、网站近一周的访问量等。</p> <p>衍生指标是基于原子指标组合构建的，例如：客单价 = 支付金额 / 买家数。</p> <p>指标体系是从不同维度梳理业务，并将零散单点的具有相互联系的指标，系统化地组织起来；其中，维度分为定性维度和定量维度，定性维度主要是文字描述类，例如姓名、地名等；定量维度主要是数值描述类，如工资、年龄等。</p> <p>举个某电商限时秒杀的栗子（如下图）：</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012923.png" alt=""></p> <p>上方红框代表市场活跃度，中间红框代表当前价格波动幅度，下方红框代表价格趋势；三个红框中的指标，可以构成一个最简单的指标体系，用来描述伊利纯牛奶秒杀的现状，属于描述指标体系。</p> <p>总的来说，指标体系是对业务指标体系化的汇总，主要用来明确指标的维度、口径、指标取数逻辑等信息，并能够迅速获得指标的相关信息。</p> <h3 id="_2-为什么需要指标体系"><a href="#_2-为什么需要指标体系" class="header-anchor">#</a> 2. 为什么需要指标体系？</h3> <p>对于数据产品经理来说，搭建指标体系可以更好地梳理业务，提高问题分析效率。</p> <p>因此，笔者认为指标体系的主要目的为：</p> <ul><li>给业务发展提供指引；</li> <li>建立共同愿景，凝聚团队，激励团队。</li></ul> <h2 id="二、如何设计指标体系"><a href="#二、如何设计指标体系" class="header-anchor">#</a> 二、如何设计指标体系？</h2> <p>下面分五部分（如下图），讲一讲如何设计指标体系：</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012933.png" alt=""></p> <h3 id="_1-定目标"><a href="#_1-定目标" class="header-anchor">#</a> 1. 定目标</h3> <p>这是第一步，也是最重要的一步，同时也是很多产品上线运营后进行评估的标准，并以此形成闭环。</p> <p>好的目标具有以下三个特征：</p> <ul><li>与高层目标一致；</li> <li>目标应当符合 SMART 原则；</li> <li>具有挑战性。</li></ul> <p>下面笔者就先说说 SMART 原则：</p> <p>1）S 代表具体（Specific）</p> <p>目标必须是明确的、具体的，要对标特定的工作指标，不能笼统。</p> <p>下面举个栗子：</p> <ul><li>无效的目标：我要成为一名内容运营；</li> <li>具体的目标：我要掌握文案技巧。</li></ul> <p>2）M 代表可衡量（Measurable）</p> <p>目标必须是可衡量的，可衡量的指标是数量化或者行为化的，验证这些指标的数据或者信息是可以获取的。</p> <p>上面的栗子进一步细化，让目标可衡量。</p> <p>可衡量的目标：我要掌握文章设主题、切痛点、找创意、定标题等技巧。</p> <p>3）A 代表可实现（Attainable）</p> <p>目标必须是可实现的，具体指在付出努力的情况下可以实现，避免设立过高或过低的目标。</p> <p>假如笔者刚接触内容运营，定下了 “我要在两个月内成为写文案的专家” 这个目标，那么这就是一个不切实际的目标。</p> <p>较接地气的目标是：我要在三个月内掌握文章设主题、切痛点、找创意、定标题等技巧。</p> <p>4）R 代表相关性（Relevant）</p> <p>目标是与工作中的其它目标相关联。</p> <p>比如我的中期目标是：一年内能够独立完成文章的一系列创作与发布，我的短期目标就是：三个月内掌握文章基本创作技巧。</p> <p>只有中期目标与短期目标具有很强的相关性，那么中期目标才更容易实现。</p> <p>5）T 代表有时限（Time-bound）</p> <p>目标的时限性就是指目标是有时间限制的，比如我在运营公众号时给自己定的目标是 “截止到 2021 年 12 月 31 日创作并发布 12 篇文章”，这里的 2021 年 12 月 31 日就是确定的时间限制。</p> <h3 id="_2-建模型"><a href="#_2-建模型" class="header-anchor">#</a> 2. 建模型</h3> <p>1）PLC 模型</p> <p>产品生命周期（Product Life Cycle），简称 PLC，指产品的市场寿命，即一种产品从开始进入市场到被市场淘汰的整个过程；产品的生命周期有探索期、成长期、成熟期、衰退期（如下图）。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012948.png" alt=""></p> <p>在产品不同的生命周期阶段，各业务方侧重点不同，关注的数据指标亦有所不同。</p> <p>探索期：</p> <p>探索期的重点在于验证产品的核心价值，是否能够满足市场需求并从中获利；要做到：假设、验证、迭代、执行。这个阶段会着重关注目标用户画像、关键行为、留存率。下面以早期的土巴兔为例（如下图）。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128012954.png" alt=""></p> <p>根据上图对土巴兔业务流程的梳理，以及对土巴兔的定位（为探索期），因此当前主要关注点是打磨服务能力，了解用户群体的需求与产品服务的匹配度，重点关注的指标如下：</p> <ul><li>目标用户画像：性别、年龄、学历、地域、职业；</li> <li>关键行为：图文发表量、浏览人数、传播量、使用量；</li> <li>质量：文章转化率、完成率。</li></ul> <p>成长期：</p> <p>经过了打磨产品的探索期，产品有了较好的留存率，这时候产品开始进入用户增长期；处于成长期时，需要将注意力放在用户的整个生命周期的前半段上，即提高留存、用户激活、自传播。</p> <p>成熟期：</p> <p>随着市场趋于饱和，用户的增速放缓，逐渐趋于稳定，关注的核心指标应该是用户活跃度，同时关注商业转化路径；实际上如果市场本身是增量市场，可以考虑通过获客，把一个成熟期的产品做出一个不一样的增长曲线。</p> <p>衰退期：</p> <p>新产品或替代品出现，用户转向其他产品，导致原产品用户量迅速下降，从而使原来的销售额和利润迅速下降，于是产品就进入衰退期；处于衰退期，需要重点关注用户流失与维系。</p> <p>2）OSM 模型</p> <p>OSM 模型（Objective，Strategy，Measurement）是指标体系建设过程中辅助确定核心的重要方法，包含业务目标、业务策略、业务度量，是指标内容横向的思考。</p> <p>业务目标：</p> <p>主要从用户视角和业务视角确定目标，原则是切实可行、易理解、可干预、正向有益。</p> <ul><li>用户使用产品的目标是什么？</li> <li>产品满足了用户的什么需求？</li> <li>公司/业务/产品等存在的目的是什么？</li></ul> <p>业务策略：</p> <p>为了达成上述目标采取的策略。换句话说，用户在什么时候感受到诉求被满足？</p> <p>业务度量：</p> <p>这些策略随之带来的数据指标变化有哪些？是否有效满足了用户的诉求，达成了业务目标。</p> <p>以 PMCAFF 为例，按照 OSM 模型，它的指标是什么样？</p> <p>① 业务目标：用户来使用 PMCAFF 这个产品，目标是什么？</p> <p>需要涉及两类用户：内容生产者和内容消费者，接下来简单介绍内容生产者的分析思路。</p> <p>用户需求：发布文章或分享观点，建立行业影响力或者内容受到反馈。</p> <p>那么，如何让用户感受到自己的需求被满足了呢？</p> <p>② 业务策略</p> <p>③ 业务度量</p> <p>接下来，我们需要针对这些策略去做指标，在这里我们的指标分别是结果指标和过程指标。</p> <p>备注：</p> <ul><li>结果指标：用来反映某些业务产出或结果的指标项，通常是延后知道的，很难进行干预；结果指标通常更多的是监控数据是否异常，或者监控某个场景下用户的需求是否被满足。</li> <li>过程指标：用户在做某个操作的时候所产生的指标，可以通过某些策略来影响过程指标，从而影响结果指标，过程指标通常更加关注用户的需求为什么被满足或没有被满足。</li></ul> <p>指标选取之后，就是选择分析维度了，而维度选择层面主要是通过数据分析视角结合实际业务场景来确定；例如：用户标签维度、时间维度、渠道维度等。</p> <p>3）指标分级</p> <p>指标分级主要是将指标化解为不同层级并逐级分析。根据企业战略、企业组织及业务进行自上而下的分级，对指标进行层层剖析，其中可结合 OSM 模型来确定指标。</p> <p>一级指标：公司战略层</p> <p>用于衡量公司整体目标完成情况，与公司当前业务紧密结合，并对所有员工均有核心的指导意义。一级指标通常指引着公司的战略。</p> <p>一级指标通常根据市场、产品生命周期、产品品类和商业模式确定，一个时间点只有一个最关键的指标（OMTM，One Metric That Matters）。</p> <p>例如：小红书的OMTM（又称：北极星指标）如何演变？</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128013004.png" alt=""></p> <p>二级指标：业务策略层</p> <p>为达成战略目标，公司会对其进一步拆解为业务线或事业群的核心指标；通常为了实现一级指标，企业会做出相应的策略，二级指标也会与这些策略有所关联。</p> <p>例如：小红书当前的一级指标是销售额，那么二级指标可以设定为不同品类商品的销售额，分地区的销售额等；这样当一级指标出现问题的时候，我们可以快速定位问题所在。</p> <p>三级指标：业务执行层</p> <p>三级指标是将二级指标纵向展开，进行路径拆解、漏斗拆解、公式拆解；三级指标通常用于定位二级指标的问题，通常指导一线运营或分析人员开展工作，三级指标是业务中最多的指标。</p> <p>路径拆解需要对业务流程进行分析，例如：打开应用、浏览首页、浏览商品详情页、加入购物车、提交订单、订单支付、支付成功。</p> <p>运用公式拆解月活跃用户，如下图。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128013011.png" alt=""></p> <p>4）AARRR</p> <p>AARRR 模型就是海盗模型，也是用户分析的经典模型。它反映了增长贯穿于用户生命周期的各个阶段，即获取（Acquisition）、激活（Activation）、留存（Retention）、变现（Revenue）、自传播（Referral）。</p> <p>获取：</p> <p>运营人员通过各种渠道进行推广，以各种手段获取目标用户，评估各种营销渠道效果，并不断调整运营策略，以不断降低获客成本。</p> <p>关键指标：曝光量、点击、下载、安装、激活、安装率、激活率、注册转化率、留存率、付费率等。</p> <p>激活：</p> <p>激活指目标用户开始使用产品。产品经理通过新手奖励、产品引导等方式，来引导用户使用产品核心功能；我们需要掌握用户的行为数据，监控产品健康程度。</p> <p>关键指标：新老用户占比、DAU/WAU/MAU、日均登录次数、日均使用时长等。</p> <p>留存：</p> <p>通常维护一个老用户的成本要远远低于获取一个新用户的成本，所以不仅要拉新用户，还需要关注用户粘性，以及关注用户在哪里流失、为什么流失。</p> <p>关键指标：新用户留存率、老用户留存率、活跃用户留存率、日周月留存率、流失率等。</p> <p>变现：</p> <p>主要用来衡量产品的商业价值，这也是商业的本质。</p> <p>关键指标：ARPU、ARPPU、付费率（区分新老用户）、客单价、LTV 等。</p> <p>自传播：</p> <p>主要是基于产品、营销、明星等事件的吸引力，从而使用户自发地传播。</p> <p>关键指标：裂变系数等。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128013020.png" alt=""></p> <h2 id="三、埋点"><a href="#三、埋点" class="header-anchor">#</a> 三、埋点</h2> <p>数据采集，就是采集相应的数据，是数据流的起点，采集的对不对、全不全，直接决定数据的质量，影响后续的所有环节。</p> <p>那么采集什么样的数据才算是质量高？这就需要提前规划埋点。</p> <h3 id="_1-什么是埋点"><a href="#_1-什么是埋点" class="header-anchor">#</a> 1. 什么是埋点</h3> <p>埋点是（用户行为）数据采集领域的术语。它的学名叫做事件追踪（Event Tracking）；它主要是针对特定用户行为或事件进行捕获、处理和发生的相关技术及其实施过程，如用户点击某个按钮的次数、阅读某篇文章的时长等等。</p> <p>埋点是一种常用的数据采集方法，它是为了满足丰富的数据应用而做的用户行为过程及结果记录。</p> <p>埋点是数据采集的一种重要方法，并且是数据的起源，采集的数据常常用于分析产品的使用情况、用户行为偏好等，于是延伸出用户画像、用户推荐系统等数据产品。</p> <h3 id="_2-埋点流程"><a href="#_2-埋点流程" class="header-anchor">#</a> 2. 埋点流程</h3> <p>业务部门根据业务提出需求，产品经理将需求整理为数据需求，并输出数据需求文档（DRD，Data Requirements Document）。</p> <p>接下来，产品经理就跟数据团队进行需求评审，评审通过与否，会后都要给相关人员发送需求评审纪要邮件；评审通过之后，产品经理需要跟开发工程师确定开发时间，并发送排期邮件。</p> <p>开发完成后，测试工程师、数据分析师、产品经理需要验证埋点是否完整且准确，提交验收报告；功能上线后，产品经理或开发工程师需要发送上线邮件。如下图：</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128013029.png" alt=""></p> <h3 id="_3-如何埋点"><a href="#_3-如何埋点" class="header-anchor">#</a> 3. 如何埋点</h3> <p>怎么埋呢？从业务角度出发，划分五个角度：</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128013036.png" alt=""></p> <p>Who：对行为的发起者进行标识，一般使用账号或设备号进行标识。账号是常用的方式，通过身份证号、手机号、账号 ID 等信息区分用户；设备号多用于不需要登录的产品，通过设备的编码来区分用户。</p> <p>When：记录行为是什么时候发生的，一般使用服务器时间，即 Unix 时间戳记录行为发生时间；它是全球统一时间，不受地区的干扰。</p> <p>Where：记录行为发生的地点，一般通过 GPS 进行定位，或者通过设备 IP 判断用户位置。</p> <p>What：指用户行为的具体内容是什么，比如用户阅读一本书，那么购买的书名是什么？价格是多少？哪个出版社出版等信息。</p> <p>How：行为是怎么发生的，一般包含在行为名称中，如提交某订单，也有若干行为是可以通过多种方式完成，如解锁 iPhone，可以输入密码解锁，也可以刷脸解锁，无论使用哪种方式都是一种可以记录的信息。</p> <h3 id="_4-案例-浏览app首页行为埋点"><a href="#_4-案例-浏览app首页行为埋点" class="header-anchor">#</a> 4. 案例：浏览APP首页行为埋点</h3> <p>针对浏览某电商 APP 首页行为，从五个角度分析，分为特有指标和公共指标两类，如下图：</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128013044.png" alt=""></p> <h3 id="_5-案例-支付订单行为埋点"><a href="#_5-案例-支付订单行为埋点" class="header-anchor">#</a> 5. 案例：支付订单行为埋点</h3> <p>针对支付订单行为，从五个角度分析，分为特有指标和公共指标两类，如下图。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128013051.png" alt=""></p> <h2 id="四、数据分析"><a href="#四、数据分析" class="header-anchor">#</a> 四、数据分析</h2> <h3 id="_1-什么是数据分析"><a href="#_1-什么是数据分析" class="header-anchor">#</a> 1. 什么是数据分析？</h3> <p>数据分析是指用适当的统计、分析方法对收集来的大量数据进行分析，提取有用信息和形成结论，并对数据加以详细研究和概括总结的过程；简单地说，就是对数据进行分析。</p> <p>数据分析的目的是把隐藏在一些看似杂乱无章的数据背后的信息挖掘出来，提炼出目标对象的内在规律。对于企业来说，数据分析的本质在于创造商业价值，驱动企业业务增长。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128013101.png" alt="数据指标体系从构思到落地"></p> <h3 id="_2-数据分析方法"><a href="#_2-数据分析方法" class="header-anchor">#</a> 2. 数据分析方法</h3> <p>我们以一个电商网站为例，用数据产品对该网站进行数据采集，然后使用常见的数据分析方法分析，如漏斗分析、留存分析、时间分析、用户画像、渠道分析、分布分析等方法。</p> <p>1）漏斗分析</p> <p>漏斗分析能够科学反映用户行为状态，以及从起点到终点各业务流程的用户转化率情况，是一种重要的流程式数据分析模型；漏斗分析模型已经广泛应用于用户行为分析中，例如渠道质量评估、产品销售等日常数据运营与数据分析工作中。</p> <p>比如：对于电商产品来说，最终目的是让用户购买商品，但整个流程的转化率由每一步的转化率综合而定；这时，我们就可以通过漏斗分析模型进行监测。</p> <p>如下图所示，我们可以观察用户在每一个层级上的转化率，寻找转化路径的薄弱点，优化产品，提升用户体验，最终提升整体的转化率。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128013109.png" alt=""></p> <p>2）留存分析</p> <p>留存分析是一种用来分析用户参与情况/活跃程度的分析模型，即由初期的新用户转化为活跃用户、忠诚用户的过程；随着统计数字的变化，相关人员可看到不同阶段的用户变化情况，从而判断产品对用户的粘性。</p> <p>比如：对某电商平台来说，用户最近 30 日的 7 日留存率（如下图），从图中得知，用户留存率较低；接下来，按照地区、年龄、行为等，将用户分为不同的群体，观察留存的区别，找到产品可优化点。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128013117.png" alt=""></p> <p>3）事件分析</p> <p>事件分析用来研究某事件的发生对企业的影响以及影响的程度。通常来说，事件分析包括事件定义与选择、下钻分析、结果等环节。</p> <p>事件，是一个用户在某个时间点、某个地方、以某种方式完成了某个具体的事情，它的关键因素包括 Who、When、Where、What、How。</p> <p>比如：运营人员发现过去 30 日支付成功次数波动较大（如下图）；这时企业可以先定义事件，通过筛选条件配送方式为 “自营”，再从其他多个维度细分下钻，如 “订单金额”、“是否使用优惠券”、“商品ID”等；当进行细分筛选时，异常数据无处遁形。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128013125.png" alt=""></p> <p>4）渠道分析</p> <p>渠道，是指产品与用户发生互动的各个接触点，比如 SEO、SEM、社交媒体等等。</p> <p>渠道分析主要用于分析用户的访问来源及访问深度，通过访问用户数、访问次数、停留时长等指标来评估渠道质量，同时也通过转化率来衡量渠道转化的效果。</p> <p>一个完整的渠道流程，常常包括：站外渠道 -&gt;展示广告-&gt;着陆页-&gt;访问着陆页的转化文案-&gt;激活用户-&gt;产品转化 六大关键环节，每个环节都有相应的指标来衡量。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20211128013134.png" alt=""></p> <p>① 用户在站外渠道，包括 SEO、SEM、社交媒体等，看到各种宣传广告。</p> <p>关键指标：展示量、点击量、CTR（Click Through Rate，点击率）。</p> <p>② 有兴趣的用户点击 URL 链接进入着陆页。</p> <p>关键指标：着陆页 PV、着陆页 UV、加载时长、跳出率等。</p> <p>③ 对产品或服务感兴趣的用户下载、注册或者试用产品或服务，这个过程通常称之为激活。</p> <p>关键指标：停留时长、访问深度等。</p> <p>④ 用户激活后，点击 CTA（Call To Action，召唤用户行为）选择商品加入购物车并提交、支付，这就是一个完整的购买流程。</p> <p>关键指标：购买用户人数、产品内转化率等。</p> <p>以上是四种常用的数据分析方法，在不同行业中，它们常常以不同的样式展示出来。</p> <p>当我们面对不同的问题时，需要清楚地知道哪个或哪几个方法最为有效，需要结合具体场景灵活运用，没有最好的分析方法只有最适合的。</p> <h1 id="番外篇-数据埋点需求"><a href="#番外篇-数据埋点需求" class="header-anchor">#</a> 番外篇：数据埋点需求</h1> <p>模拟神策埋点造数据。</p> <h2 id="数据模型简介"><a href="#数据模型简介" class="header-anchor">#</a> 数据模型简介</h2> <p>在神策分析中，我们使用事件模型（Event 模型）来描述用户在产品上的各种行为，这也是神策分析所有的接口和功能设计的核心依据。</p> <p>在传统的 Web 时代，通常使用 PV（Page View 的简写，也即页面访问量）来衡量和分析一个产品的好坏，然后，到了移动互联网以及 O2O 电商时代，PV 已经远远不能满足产品和运营人员的分析需求了。</p> <p>在这个年代，每个产品都有着独一无二的核心指标用来衡量产品是否成功，这个指标可能是发帖数量、视频播放数量、订单量或者其它的可以体现产品核心价值的指标，这些都是一个简单的 PV 无法衡量的。</p> <p>除此之外，PV 模型也无法满足一些更加细节的、更加精细化的分析。例如，我们想分析哪类产品销量最好，访问网站的用户的年龄和性别构成，每个渠道过来的用户的转化率、留存和重复购买率分别如何，新老用户的客单价、流水、补贴比例分别是多少等等。这些问题，都是以 PV 为核心的传统统计分析没办法解答的问题。</p> <p>因此，神策分析采用事件模型作为基本的数据模型。事件模型可以给我们更多的信息，让我们知道用户用我们的产品具体做了什么事情。事件模型给予我们更全面且更具体的视野，指导我们做出更好的决策。</p> <h3 id="event实体"><a href="#event实体" class="header-anchor">#</a> Event实体</h3> <p>简单来说，一个 Event 就是描述了：一个用户在某个时间点、某个地方，以某种方式完成了某个具体的事情。从这可以看出，一个完整的 Event，包含如下的几个关键因素：</p> <ul><li><p>Who：即参与这个事件的用户是谁。在我们的数据接口中，使用 distinct_id 来设置用户的唯一 ID：对于未登录用户，这个 ID 可以是 cookie_id、设备 ID 等匿名 ID；对于登录用户，则建议使用后台分配的实际用户 ID。同时，我们也提供了 track_signup 这个接口，在用户注册的时候调用，用来将同一个用户注册之前的匿名 ID 和注册之后的实际 ID 贯通起来进行分析。</p></li> <li><p>When：即这个事件发生的实际时间。在我们的数据接口中，使用 time 字段来记录精确到毫秒的事件发生时间。如果调用者不主动设置，则各个 SDK 会自动获取当前时间作为 time 字段的取值。</p></li> <li><p>Where：即事件发生的地点。使用者可以设置 properties 中的 ip 属性，这样系统会自动根据 ip 来解析相应的省份和城市，当然，使用者也可以根据应用的 GPS 定位结果，或者其它方式来获取地理位置信息，然后手动设置 $city 和 $province。除了 $city 和 $province 这两个预置字段以外，也可以自己设置一些其它地域相关的字段。例如，某个从事社区 O2O 的产品，可能需要关心每个小区的情况，则可以添加自定义字段 “HousingEstate”；或者某个从事跨国业务的产品，需要关心不同国家的情况，则可以添加自定义字段 “Country”。</p></li> <li><p>How：即用户从事这个事件的方式。这个概念就比较广了，包括用户使用的设备、使用的浏览器、使用的 App 版本、操作系统版本、进入的渠道、跳转过来时的 referer 等，目前，神策分析预置了如下字段用来描述这类信息，使用者也可以根据自己的需要来增加相应的自定义字段。</p> <div class="language-undefined extra-class"><pre class="language-text"><code>$app_version：应用版本
$city： 城市
$manufacturer： 设备制造商，字符串类型，如&quot;Apple&quot;
$model： 设备型号，字符串类型，如&quot;iphone6&quot;
$os： 操作系统，字符串类型，如&quot;iOS&quot;
$os_version： 操作系统版本，字符串类型，如&quot;8.1.1&quot;
$screen_height： 屏幕高度，数字类型，如1920
$screen_width： 屏幕宽度，数字类型，如1080
$wifi： 是否 WIFI，BOOL类型，如true
</code></pre></div></li> <li><p>What：描述用户所做的这个事件的具体内容。在我们的数据接口中，首先是使用 event 这个事件名称，来对用户所做的内容做初步的分类。event 的划分和设计也有一定的指导原则，我们会在后文详细描述。除了 event 这个至关重要的字段以外，我们并没有设置太多预置字段，而是请使用者根据每个产品以及每个事件的实际情况和分析的需求，来进行具体的设置，下面给出一些典型的例子：
- 对于一个“购买”类型的事件，则可能需要记录的字段有：商品名称、商品类型、购买数量、购买金额、 付款方式等；
- 对于一个“搜索”类型的事件，则可能需要记录的字段有：搜索关键词、搜索类型等；
- 对于一个“点击”类型的事件，则可能需要记录的字段有：点击 URL、点击 title、点击位置等；
- 对于一个“用户注册”类型的事件，则可能需要记录的字段有：注册渠道、注册邀请码等；
- 对于一个“用户投诉”类型的事件，则可能需要记录的字段有：投诉内容、投诉对象、投诉渠道、投诉方式等；
- 对于一个“申请退货”类型的事件，则可能需要记录的字段有：退货金额、退货原因、退货方式等。</p></li></ul> <h2 id="埋点数据"><a href="#埋点数据" class="header-anchor">#</a> 埋点数据</h2> <h3 id="数据整体格式"><a href="#数据整体格式" class="header-anchor">#</a> 数据整体格式</h3> <h4 id="track"><a href="#track" class="header-anchor">#</a> track</h4> <p>日志文件是一行一个 JSON，物理上对应一条数据，逻辑上对应一个描述了用户行为的事件，或是描述一个或多个用户属性的 Profile 操作。</p> <p>记录一个 Event 及关联的 Properties。</p> <p>数据样例：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;distinct_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;time&quot;</span><span class="token operator">:</span> <span class="token number">1434556935000</span><span class="token punctuation">,</span>
	<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;track&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;event&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ViewProduct&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;project&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ebiz_test&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;time_free&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//建议在导入历史数据时使用，SDK 采集的实时数据不建议使用</span>
	<span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;$is_login_id&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//此参数请慎重使用，详细介绍请参考文档底部 8.1 $is_login_id 参数说明</span>
		<span class="token property">&quot;$app_version&quot;</span><span class="token operator">:</span><span class="token string">&quot;1.3&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;$wifi&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
		<span class="token property">&quot;$ip&quot;</span><span class="token operator">:</span><span class="token string">&quot;180.79.35.65&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;$province&quot;</span><span class="token operator">:</span><span class="token string">&quot;湖南&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;$city&quot;</span><span class="token operator">:</span><span class="token string">&quot;长沙&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;$user_agent&quot;</span><span class="token operator">:</span><span class="token string">&quot;Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_2 like Mac OS X) AppleWebKit/602.1.50 (KHTML, like Gecko) CriOS/58.0.3029.113 Mobile/14F89 Safari/602.1&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;$screen_width&quot;</span><span class="token operator">:</span><span class="token number">320</span><span class="token punctuation">,</span>
		<span class="token property">&quot;$screen_height&quot;</span><span class="token operator">:</span><span class="token number">568</span><span class="token punctuation">,</span>
		<span class="token property">&quot;product_id&quot;</span><span class="token operator">:</span><span class="token number">12345</span><span class="token punctuation">,</span>
		<span class="token property">&quot;product_name&quot;</span><span class="token operator">:</span><span class="token string">&quot;苹果&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;product_classify&quot;</span><span class="token operator">:</span><span class="token string">&quot;水果&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;product_price&quot;</span><span class="token operator">:</span><span class="token number">14.0</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于上述字段的说明如下：</p> <ul><li>distinct_id：<em><strong>类型是字符串</strong></em>，对用户的标识，对未登录用户，可以填充设备标识、CookieID 等，对于登录用户，则应该填充注册账号；这里的例子，我们假设是一个未注册用户，所以填充的是一个设备编号；</li> <li>time：<em><strong>类型是数值</strong></em>，事件发生的实际时间戳，精确到毫秒；</li> <li>type：track 表明是记录一个 Event ，这里我们假设是一个商品浏览行为；</li> <li>event：事件名，需是合法的变量名，即不能以数字开头，且只包含：大小写字母、数字、下划线和 $，其中以 $ 开头的表明是系统的预置事件，自定义事件名请不要以 $ 开头，且 event 字段长度最大为 100；</li> <li>project：这条数据所属项目名，若不指定该参数，则需要使用该字段时取值 <em><strong>default</strong></em>，即默认项目。指定的项目必须是系统中已经存在的项目，否则这条数据将无效，更多项目相关请参见<a href="https://manual.sensorsdata.cn/sa/latest/tech_knowledge_more-1573783.html" target="_blank" rel="noopener noreferrer">多项目<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；</li> <li>time_free：可选字段，表示不根据事件发生时间过滤该事件。<em><strong>只要出现 time_free 这个 key 且 value 不为 null，将不再校验 time 是否在允许导入的时间范围内</strong></em>。导入历史数据时可能会用到该字段；</li> <li>properties：这个 Event 的具体属性，以 dict 的形式存在。其中以 <code>$</code> 开头的表明是系统的预置属性，它的类型和中文名已经预先定义好了。自定义属性名需要是合法的变量名，不能以数字开头，且只包含：大小写字母、数字、下划线，自定义属性不能以 $ 开头；同一个名称的 property，在不同 event 中，必须保持一致的定义和类型；同一个名称的 property 大小写不可以相同，如果已经存在小写属性就不可再导入对应大写属性（比如元数据中有 abc 属性名，不能再传 ABC,Abc 等属性名），否则数据会校验失败不入库。
<ul><li>$is_login_id：distinct_id 对应的是否是一个注册 ID；</li> <li>$app_version：用户所使用的 App 的版本；</li> <li>$wifi：这条事件发生时，用户是否在使用 wifi；</li> <li>$ip：用户使用设备的 IP。若数据中出现 $ip，且数据中没有 $province 或 $city 字段，将使用该 IP 解析出省市信息填入缺失字段；</li> <li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>r</mi><mi>o</mi><mi>v</mi><mi>i</mi><mi>n</mi><mi>c</mi><mi>e</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">province、</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">ro</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">in</span><span class="mord mathnormal">ce</span><span class="mord cjk_fallback">、</span></span></span></span>city：省、市，在没有填充这两个字段的时候，会根据 IP 进行解析；</li> <li>user_agent：可选参数。如果传入该参数，则解析 User-Agent，解析结果包括：设备制造商、设备型号、操作系统、操作系统版本、浏览器、浏览器版本、爬虫名称（如果是爬虫）；目前是神策是通过 UA 判断并有一个默认的属性 $bot_name （爬虫名称），但是有两种情况无法判断，第一种：如果 UA 里没有标明、且会触发 JS 脚本的非法爬虫。第二种：如果爬虫没有触发 JS 脚本，那么也不会触发我们的 SDK ，所以本身就不会被统计到。对于爬虫种类，不能提前把所有的种类都加进去，主流的神策都加了，其它的属于不太常见的，量较少。</li> <li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>c</mi><mi>r</mi><mi>e</mi><mi>e</mi><msub><mi>n</mi><mi>w</mi></msub><mi>i</mi><mi>d</mi><mi>t</mi><mi>h</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">screen_width、</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord mathnormal">scree</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord cjk_fallback">、</span></span></span></span>screen_height：屏幕的宽和高；</li> <li>product_id、product_name、product_classify、product_price：跟商品相关的一些具体属性。</li></ul></li></ul> <h4 id="事件"><a href="#事件" class="header-anchor">#</a> 事件</h4> <ul><li><p>事件名: AppStart</p></li> <li><p>数据格式:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;distinct_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;time&quot;</span><span class="token operator">:</span> <span class="token number">1434556935000</span><span class="token punctuation">,</span>
	<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;track&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;event&quot;</span><span class="token operator">:</span> <span class="token string">&quot;AppStart&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;$is_login_id&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// distinct_id是否为登录id</span>
    <span class="token property">&quot;device_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;A45ED365-8F92-48A9-9F4B-48F50323974A&quot;</span><span class="token punctuation">,</span> <span class="token comment">//设备id</span>
    <span class="token property">&quot;user_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span> <span class="token comment">//用户id，如果未登录则没有该字段</span>
    <span class="token property">&quot;app_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token comment">//应用的唯一id</span>
		<span class="token property">&quot;app_version&quot;</span><span class="token operator">:</span><span class="token string">&quot;1.3&quot;</span><span class="token punctuation">,</span> <span class="token comment">//app版本</span>
    <span class="token property">&quot;carrier&quot;</span><span class="token operator">:</span><span class="token string">&quot;中国电信&quot;</span><span class="token punctuation">,</span> <span class="token comment">//运营商:中国移动、中国联通、中国电信</span>
    
		<span class="token property">&quot;wifi&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//是否是wifi</span>
		<span class="token property">&quot;ip&quot;</span><span class="token operator">:</span><span class="token string">&quot;180.79.35.65&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;province&quot;</span><span class="token operator">:</span><span class="token string">&quot;湖南&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;city&quot;</span><span class="token operator">:</span><span class="token string">&quot;长沙&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;user_agent&quot;</span><span class="token operator">:</span><span class="token string">&quot;Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_2 like Mac OS X) AppleWebKit/602.1.50 (KHTML, like Gecko) CriOS/58.0.3029.113 Mobile/14F89 Safari/602.1&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;screen_width&quot;</span><span class="token operator">:</span><span class="token number">320</span><span class="token punctuation">,</span>
		<span class="token property">&quot;screen_height&quot;</span><span class="token operator">:</span><span class="token number">568</span><span class="token punctuation">,</span>
		<span class="token property">&quot;product_id&quot;</span><span class="token operator">:</span><span class="token number">12345</span><span class="token punctuation">,</span>
		<span class="token property">&quot;product_name&quot;</span><span class="token operator">:</span><span class="token string">&quot;苹果&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;product_classify&quot;</span><span class="token operator">:</span><span class="token string">&quot;水果&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;product_price&quot;</span><span class="token operator">:</span><span class="token number">14.0</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/./datahouse/实时数仓/kudu.html" class="prev">
        Kudu
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="./assets/js/app.dbe5dc78.js" defer></script><script src="./assets/js/2.fa5f1a4a.js" defer></script><script src="./assets/js/94.2701ba5d.js" defer></script>
  </body>
</html>
