<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SQL类型题总结 | 大数据技术文档</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="./favicon.ico">
    <meta name="description" content="从入门到入土">
    
    <link rel="preload" href="./assets/css/0.styles.e88c5000.css" as="style"><link rel="preload" href="./assets/js/app.dc5b0715.js" as="script"><link rel="preload" href="./assets/js/2.47c06342.js" as="script"><link rel="preload" href="./assets/js/71.54649836.js" as="script"><link rel="prefetch" href="./assets/js/10.ef98acb1.js"><link rel="prefetch" href="./assets/js/11.37b04a4d.js"><link rel="prefetch" href="./assets/js/12.cee383a4.js"><link rel="prefetch" href="./assets/js/13.d47b2b52.js"><link rel="prefetch" href="./assets/js/14.77b2b060.js"><link rel="prefetch" href="./assets/js/15.a024878c.js"><link rel="prefetch" href="./assets/js/16.a7201fbc.js"><link rel="prefetch" href="./assets/js/17.79e79675.js"><link rel="prefetch" href="./assets/js/18.7639ae91.js"><link rel="prefetch" href="./assets/js/19.280df9d2.js"><link rel="prefetch" href="./assets/js/20.25a38eac.js"><link rel="prefetch" href="./assets/js/21.0aaf754a.js"><link rel="prefetch" href="./assets/js/22.abdec3c1.js"><link rel="prefetch" href="./assets/js/23.454fb1a0.js"><link rel="prefetch" href="./assets/js/24.5118d094.js"><link rel="prefetch" href="./assets/js/25.b239a8e2.js"><link rel="prefetch" href="./assets/js/26.4af89c7f.js"><link rel="prefetch" href="./assets/js/27.b338361b.js"><link rel="prefetch" href="./assets/js/28.225e99c8.js"><link rel="prefetch" href="./assets/js/29.1749fe14.js"><link rel="prefetch" href="./assets/js/3.376b8cdf.js"><link rel="prefetch" href="./assets/js/30.422f2538.js"><link rel="prefetch" href="./assets/js/31.b1265e4d.js"><link rel="prefetch" href="./assets/js/32.7f4a7aa0.js"><link rel="prefetch" href="./assets/js/33.e8f1b887.js"><link rel="prefetch" href="./assets/js/34.ea398359.js"><link rel="prefetch" href="./assets/js/35.046ac0f0.js"><link rel="prefetch" href="./assets/js/36.f0d4cc9b.js"><link rel="prefetch" href="./assets/js/37.0a7a5f8f.js"><link rel="prefetch" href="./assets/js/38.d06cfcca.js"><link rel="prefetch" href="./assets/js/39.d164c990.js"><link rel="prefetch" href="./assets/js/4.6d1a6719.js"><link rel="prefetch" href="./assets/js/40.6bc1f68d.js"><link rel="prefetch" href="./assets/js/41.e1d9e6f4.js"><link rel="prefetch" href="./assets/js/42.b9146544.js"><link rel="prefetch" href="./assets/js/43.3d89ef90.js"><link rel="prefetch" href="./assets/js/44.e75043b3.js"><link rel="prefetch" href="./assets/js/45.fa675a86.js"><link rel="prefetch" href="./assets/js/46.5e1bd863.js"><link rel="prefetch" href="./assets/js/47.8287576d.js"><link rel="prefetch" href="./assets/js/48.7f50621f.js"><link rel="prefetch" href="./assets/js/49.1273014b.js"><link rel="prefetch" href="./assets/js/5.c4786839.js"><link rel="prefetch" href="./assets/js/50.0ace36ad.js"><link rel="prefetch" href="./assets/js/51.955bc85d.js"><link rel="prefetch" href="./assets/js/52.e3bb73d6.js"><link rel="prefetch" href="./assets/js/53.70bca49a.js"><link rel="prefetch" href="./assets/js/54.4f6fe468.js"><link rel="prefetch" href="./assets/js/55.d0ae6f7c.js"><link rel="prefetch" href="./assets/js/56.5bfe7854.js"><link rel="prefetch" href="./assets/js/57.20ab4e15.js"><link rel="prefetch" href="./assets/js/58.cd6e845e.js"><link rel="prefetch" href="./assets/js/59.e31f564e.js"><link rel="prefetch" href="./assets/js/6.81b9d3e2.js"><link rel="prefetch" href="./assets/js/60.7e997bce.js"><link rel="prefetch" href="./assets/js/61.ae3effab.js"><link rel="prefetch" href="./assets/js/62.d40d2f3b.js"><link rel="prefetch" href="./assets/js/63.c7ab6850.js"><link rel="prefetch" href="./assets/js/64.c317433a.js"><link rel="prefetch" href="./assets/js/65.bee18659.js"><link rel="prefetch" href="./assets/js/66.9bc2ca3c.js"><link rel="prefetch" href="./assets/js/67.36393d6f.js"><link rel="prefetch" href="./assets/js/68.50d2a85d.js"><link rel="prefetch" href="./assets/js/69.bbac38d8.js"><link rel="prefetch" href="./assets/js/7.9979a04e.js"><link rel="prefetch" href="./assets/js/70.318eb4aa.js"><link rel="prefetch" href="./assets/js/72.3ebd3c24.js"><link rel="prefetch" href="./assets/js/73.24b6f12b.js"><link rel="prefetch" href="./assets/js/74.1dd537ea.js"><link rel="prefetch" href="./assets/js/75.59231e92.js"><link rel="prefetch" href="./assets/js/76.b8f3ef78.js"><link rel="prefetch" href="./assets/js/77.11821a18.js"><link rel="prefetch" href="./assets/js/78.f63e0308.js"><link rel="prefetch" href="./assets/js/79.1c7441a7.js"><link rel="prefetch" href="./assets/js/8.db54d2a5.js"><link rel="prefetch" href="./assets/js/80.0d3fa419.js"><link rel="prefetch" href="./assets/js/81.53362836.js"><link rel="prefetch" href="./assets/js/82.6a9be763.js"><link rel="prefetch" href="./assets/js/83.11a41a2c.js"><link rel="prefetch" href="./assets/js/84.2e76a3fb.js"><link rel="prefetch" href="./assets/js/85.c61a2184.js"><link rel="prefetch" href="./assets/js/86.7d905d1b.js"><link rel="prefetch" href="./assets/js/87.4c907051.js"><link rel="prefetch" href="./assets/js/88.82047d34.js"><link rel="prefetch" href="./assets/js/89.3457441e.js"><link rel="prefetch" href="./assets/js/9.c83a911f.js"><link rel="prefetch" href="./assets/js/90.cc103581.js"><link rel="prefetch" href="./assets/js/91.68961351.js"><link rel="prefetch" href="./assets/js/92.fbb8f838.js">
    <link rel="stylesheet" href="./assets/css/0.styles.e88c5000.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><!----> <span class="site-name">大数据技术文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程基础" class="dropdown-title"><span class="title">编程基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程基础" class="mobile-dropdown-title"><span class="title">编程基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Java基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/java基础语法/" class="nav-link">
  Java基础语法
</a></li><li class="dropdown-subitem"><a href="/./coding-base/" class="nav-link">
  Java基础实战
</a></li></ul></li><li class="dropdown-item"><h4>
          Java进阶(选学)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/java并发编程/java并发编程.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-subitem"><a href="/./coding-base/" class="nav-link">
  Java网络编程
</a></li><li class="dropdown-subitem"><a href="/./coding-base/java集合/Java集合（永盛）.html" class="nav-link">
  Java集合
</a></li><li class="dropdown-subitem"><a href="/./coding-base/java虚拟机/" class="nav-link">
  Java虚拟机
</a></li></ul></li><li class="dropdown-item"><h4>
          计算机基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-subitem"><a href="/./coding-base/数据结构与算法/" class="nav-link">
  数据结构（重要）
</a></li><li class="dropdown-subitem"><a href="/./coding-base/计算机网络/计算机网络（双祥）.html" class="nav-link">
  计算机网络
</a></li><li class="dropdown-subitem"><a href="/./coding-base/操作系统/" class="nav-link">
  操作系统
</a></li></ul></li><li class="dropdown-item"><h4>
          Python（选学）
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/Python/python基础/" class="nav-link">
  Python基础语法
</a></li><li class="dropdown-subitem"><a href="/./coding-base/Python/python库/" class="nav-link">
  Python数据科学库
</a></li></ul></li><li class="dropdown-item"><h4>
          框架（选学）
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/框架/springboot/springboot.html" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-subitem"><a href="/./coding-base/框架/flask/falsk.html" class="nav-link">
  Flask
</a></li><li class="dropdown-subitem"><a href="/./coding-base/框架/vue/flask.html" class="nav-link">
  Vue
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./database/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/./database/hbase/" class="nav-link">
  HBase
</a></li><li class="dropdown-item"><!----> <a href="/./database/clickhouse/" class="nav-link">
  ClickHouse
</a></li><li class="dropdown-item"><!----> <a href="/./database/tidb/" class="nav-link">
  TiDB
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据仓库" class="dropdown-title"><span class="title">数据仓库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据仓库" class="mobile-dropdown-title"><span class="title">数据仓库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./datahouse/大数据基础/bigdata-base.html" class="nav-link">
  大数据基础
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/离线数仓/" class="nav-link">
  离线数仓
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/实时数仓/" class="nav-link">
  实时数仓
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/广告技术/" class="nav-link">
  广告技术
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/电商业务/" class="nav-link">
  电商业务
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据框架及组件" class="dropdown-title"><span class="title">大数据框架及组件</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据框架及组件" class="mobile-dropdown-title"><span class="title">大数据框架及组件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./bigdata/hadoop/" class="nav-link">
  Hadoop
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/hive/" class="nav-link">
  Hive
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/zookeeper/" class="nav-link">
  Zookeeper
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/kafka/" class="nav-link">
  kafka
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/spark/" class="nav-link">
  Spark
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/flink/" class="nav-link">
  Flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./other/面经/" class="nav-link">
  面经
</a></li><li class="dropdown-item"><!----> <a href="/./other/机器学习/" class="nav-link">
  机器学习
</a></li></ul></div></div><div class="nav-item"><a href="https://www.memorydrive.online" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/./" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程基础" class="dropdown-title"><span class="title">编程基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程基础" class="mobile-dropdown-title"><span class="title">编程基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Java基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/java基础语法/" class="nav-link">
  Java基础语法
</a></li><li class="dropdown-subitem"><a href="/./coding-base/" class="nav-link">
  Java基础实战
</a></li></ul></li><li class="dropdown-item"><h4>
          Java进阶(选学)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/java并发编程/java并发编程.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-subitem"><a href="/./coding-base/" class="nav-link">
  Java网络编程
</a></li><li class="dropdown-subitem"><a href="/./coding-base/java集合/Java集合（永盛）.html" class="nav-link">
  Java集合
</a></li><li class="dropdown-subitem"><a href="/./coding-base/java虚拟机/" class="nav-link">
  Java虚拟机
</a></li></ul></li><li class="dropdown-item"><h4>
          计算机基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-subitem"><a href="/./coding-base/数据结构与算法/" class="nav-link">
  数据结构（重要）
</a></li><li class="dropdown-subitem"><a href="/./coding-base/计算机网络/计算机网络（双祥）.html" class="nav-link">
  计算机网络
</a></li><li class="dropdown-subitem"><a href="/./coding-base/操作系统/" class="nav-link">
  操作系统
</a></li></ul></li><li class="dropdown-item"><h4>
          Python（选学）
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/Python/python基础/" class="nav-link">
  Python基础语法
</a></li><li class="dropdown-subitem"><a href="/./coding-base/Python/python库/" class="nav-link">
  Python数据科学库
</a></li></ul></li><li class="dropdown-item"><h4>
          框架（选学）
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/框架/springboot/springboot.html" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-subitem"><a href="/./coding-base/框架/flask/falsk.html" class="nav-link">
  Flask
</a></li><li class="dropdown-subitem"><a href="/./coding-base/框架/vue/flask.html" class="nav-link">
  Vue
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./database/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/./database/hbase/" class="nav-link">
  HBase
</a></li><li class="dropdown-item"><!----> <a href="/./database/clickhouse/" class="nav-link">
  ClickHouse
</a></li><li class="dropdown-item"><!----> <a href="/./database/tidb/" class="nav-link">
  TiDB
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据仓库" class="dropdown-title"><span class="title">数据仓库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据仓库" class="mobile-dropdown-title"><span class="title">数据仓库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./datahouse/大数据基础/bigdata-base.html" class="nav-link">
  大数据基础
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/离线数仓/" class="nav-link">
  离线数仓
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/实时数仓/" class="nav-link">
  实时数仓
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/广告技术/" class="nav-link">
  广告技术
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/电商业务/" class="nav-link">
  电商业务
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据框架及组件" class="dropdown-title"><span class="title">大数据框架及组件</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据框架及组件" class="mobile-dropdown-title"><span class="title">大数据框架及组件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./bigdata/hadoop/" class="nav-link">
  Hadoop
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/hive/" class="nav-link">
  Hive
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/zookeeper/" class="nav-link">
  Zookeeper
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/kafka/" class="nav-link">
  kafka
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/spark/" class="nav-link">
  Spark
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/flink/" class="nav-link">
  Flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./other/面经/" class="nav-link">
  面经
</a></li><li class="dropdown-item"><!----> <a href="/./other/机器学习/" class="nav-link">
  机器学习
</a></li></ul></div></div><div class="nav-item"><a href="https://www.memorydrive.online" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Sql</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./datahouse/sql/SQL类型题总结.html" class="active sidebar-link">SQL类型题总结</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/sql/SQL类型题总结.html#累计求和" class="sidebar-link">累计求和</a></li><li class="sidebar-sub-header"><a href="/./datahouse/sql/SQL类型题总结.html#自连接" class="sidebar-link">自连接</a></li><li class="sidebar-sub-header"><a href="/./datahouse/sql/SQL类型题总结.html#中位数" class="sidebar-link">中位数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/sql/SQL类型题总结.html#取整" class="sidebar-link">取整</a></li><li class="sidebar-sub-header"><a href="/./datahouse/sql/SQL类型题总结.html#正序-逆序" class="sidebar-link">正序+逆序</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/sql/SQL类型题总结.html#字符串处理" class="sidebar-link">字符串处理</a></li><li class="sidebar-sub-header"><a href="/./datahouse/sql/SQL类型题总结.html#描述" class="sidebar-link">描述</a></li><li class="sidebar-sub-header"><a href="/./datahouse/sql/SQL类型题总结.html#字段拼接" class="sidebar-link">字段拼接</a></li><li class="sidebar-sub-header"><a href="/./datahouse/sql/SQL类型题总结.html#排序" class="sidebar-link">排序</a></li><li class="sidebar-sub-header"><a href="/./datahouse/sql/SQL类型题总结.html#连续" class="sidebar-link">连续</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/sql/SQL类型题总结.html#连续数字" class="sidebar-link">连续数字</a></li><li class="sidebar-sub-header"><a href="/./datahouse/sql/SQL类型题总结.html#连续登录" class="sidebar-link">连续登录</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/sql/SQL类型题总结.html#比例" class="sidebar-link">比例</a></li><li class="sidebar-sub-header"><a href="/./datahouse/sql/SQL类型题总结.html#日期" class="sidebar-link">日期</a></li><li class="sidebar-sub-header"><a href="/./datahouse/sql/SQL类型题总结.html#描述-2" class="sidebar-link">描述</a></li><li class="sidebar-sub-header"><a href="/./datahouse/sql/SQL类型题总结.html#行列转换" class="sidebar-link">行列转换</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/sql/SQL类型题总结.html#行转列" class="sidebar-link">行转列</a></li><li class="sidebar-sub-header"><a href="/./datahouse/sql/SQL类型题总结.html#列转行" class="sidebar-link">列转行</a></li></ul></li></ul></li><li><a href="/./datahouse/sql/数仓SQL真题.html" class="sidebar-link">数仓SQL真题</a></li><li><a href="/./datahouse/sql/牛客SQL二刷.html" class="sidebar-link">牛客SQL二刷</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="sql类型题总结"><a href="#sql类型题总结" class="header-anchor">#</a> SQL类型题总结</h1> <p>[toc]</p> <blockquote><p><strong>书写规范：</strong></p> <p>类型名</p> <p>[题号](链接）</p> <p>题目描述</p> <p>​	思路</p> <p>​	方法一</p> <p>​	方法二（如果有多个方法，则列出方法x，否则不写）</p></blockquote> <blockquote><p><strong>阅读提示：</strong></p> <p>为了SQL语句的简洁和便于阅读，每道题中的子查询在下一步骤中可能用表别名表示而不全写出来</p> <p>例如：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 子查询（表别名命名为a）</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t

<span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> a <span class="token comment">--这里的a表示上面的子查询，在SQL中这样是不可运行的，这里只是为了方便阅读</span>

<span class="token comment">-- 正确写法（鉴于易读性，中间步骤通常不这样写，会写成像上面那样，只有最后的完整SQL语句才这样写出）</span>
<span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t
<span class="token punctuation">)</span> a
</code></pre></div></blockquote> <h2 id="累计求和"><a href="#累计求和" class="header-anchor">#</a> 累计求和</h2> <h4 id="sql60-统计salary的累计和running-total-较难"><a href="#sql60-统计salary的累计和running-total-较难" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/58824cd644ea47d7b2b670c506a159a6?tpId=82&amp;&amp;tqId=29828&amp;rp=1&amp;ru=/ta/sql&amp;qru=/ta/sql/question-ranking" target="_blank" rel="noopener noreferrer"><strong>SQL60</strong> <strong>统计salary的累计和running_total</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（较难）</h4> <blockquote><p>描述</p> <p>按照salary的累计和running_total，其中running_total为前N个当前( to_date = '9999-01-01')员工的salary累计和，其他以此类推。 具体结果如下Demo展示。。
CREATE TABLE <code>salaries</code> ( <code>emp_no</code> int(11) NOT NULL,
<code>salary</code> int(11) NOT NULL,
<code>from_date</code> date NOT NULL,
<code>to_date</code> date NOT NULL,
PRIMARY KEY (<code>emp_no</code>,<code>from_date</code>));
输出格式:</p> <table><thead><tr><th style="text-align:left;">emp_no</th> <th style="text-align:left;">salary</th> <th style="text-align:left;">running_total</th></tr></thead> <tbody><tr><td style="text-align:left;">10001</td> <td style="text-align:left;">88958</td> <td style="text-align:left;">88958</td></tr> <tr><td style="text-align:left;">10002</td> <td style="text-align:left;">72527</td> <td style="text-align:left;">161485</td></tr> <tr><td style="text-align:left;">10003</td> <td style="text-align:left;">43311</td> <td style="text-align:left;">204796</td></tr> <tr><td style="text-align:left;">10004</td> <td style="text-align:left;">74057</td> <td style="text-align:left;">278853</td></tr></tbody></table></blockquote> <p>根据题目描述，简单得说就是给定一个表，两个字段（emp_no，salary），按照emp_no进行排序，生成一个名为running_total的字段，该字段是salary的累计和。（WHERE s2.to_date = '9999-01-01'这个条件是牛客的奇葩条件，不过他这么说我们就这么写吧）</p> <ul><li>方法一</li></ul> <p>最朴素的解法就是来个自连接，原表简写为<code>s1</code>，再来一个表并命名为<code>s2</code>，并对<code>s2</code>的salary字段进行求和，这里有个关键的条件是<code>s2.emp_no &lt;= s1.emp_no</code>，这样就可以把范围限定在所在行从而实现累计求和了，SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 方法一（用另一个表来限定求和范围）</span>
<span class="token keyword">SELECT</span> s1<span class="token punctuation">.</span>emp_no<span class="token punctuation">,</span> s1<span class="token punctuation">.</span>salary<span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">SUM</span><span class="token punctuation">(</span>s2<span class="token punctuation">.</span>salary<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> salaries <span class="token keyword">AS</span> s2
<span class="token keyword">WHERE</span> s2<span class="token punctuation">.</span>emp_no <span class="token operator">&lt;=</span> s1<span class="token punctuation">.</span>emp_no
<span class="token operator">AND</span> s2<span class="token punctuation">.</span>to_date <span class="token operator">=</span> <span class="token string">'9999-01-01'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> running_total
<span class="token keyword">FROM</span> salaries <span class="token keyword">AS</span> s1
<span class="token keyword">WHERE</span> s1<span class="token punctuation">.</span>to_date <span class="token operator">=</span> <span class="token string">'9999-01-01'</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> s1<span class="token punctuation">.</span>emp_no
</code></pre></div><ul><li>方法二</li></ul> <p>上面这种方法比较原始，SQL也提供了开窗函数（或称作窗口函数）来实现这样的功能，<code>SUM+OVER</code>可以达到开窗函数的功能，SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 方法二（开窗函数）</span>
<span class="token keyword">SELECT</span> emp_no<span class="token punctuation">,</span>salary<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> emp_no<span class="token punctuation">)</span> <span class="token keyword">AS</span> running_total
<span class="token keyword">FROM</span> salaries
<span class="token keyword">WHERE</span> to_date <span class="token operator">=</span> <span class="token string">'9999-01-01'</span>
</code></pre></div><h4 id="sql71-牛客每个人最近的登录日期-六-较难"><a href="#sql71-牛客每个人最近的登录日期-六-较难" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/572a027e52804c058e1f8b0c5e8a65b4?tpId=82&amp;&amp;tqId=35089&amp;rp=1&amp;ru=/activity/oj&amp;qru=/ta/sql/question-ranking" target="_blank" rel="noopener noreferrer"><strong>SQL71</strong> <strong>牛客每个人最近的登录日期(六)</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（较难）</h4> <blockquote><p>描述</p> <p>牛客每天有很多人登录，请你统计一下牛客每个用户查询刷题信息，包括: 用户的名字，以及截止到某天，累计总共通过了多少题。 不存在没有登录却刷题的情况，但是存在登录了没刷题的情况，不会存在刷题表里面，有提交代码没有通过的情况，但是会记录在刷题表里，只不过通过数目是0。
有一个登录(login)记录表，简况如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20200820/557336_1597903934415_A5E822A1E15CEBC7E16183ECD9D7CC7A" alt="img"></p> <p>第1行表示user_id为2的用户在2020-10-12使用了客户端id为1的设备登录了牛客网
。。。
第5行表示user_id为3的用户在2020-10-13使用了客户端id为2的设备登录了牛客网</p> <p>有一个刷题（passing_number)表，简况如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20200820/557336_1597903944909_9C60ECB78BE56145269BDFA74F1074D3" alt="img"></p> <p>第1行表示user_id为2的用户在2020-10-12通过了4个题目。
。。。
第3行表示user_id为1的用户在2020-10-13提交了代码但是没有通过任何题目。
第4行表示user_id为4的用户在2020-10-13通过了2个题目</p> <p>还有一个用户(user)表，简况如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20200820/557336_1597903952301_4763AF7B377AF42CB5A87C53B965DC45" alt="img"></p> <p>请你写出一个sql语句查询刷题信息，包括: 用户的名字，以及截止到某天，累计总共通过了多少题，并且查询结果先按照日期升序排序，再按照姓名升序排序，有登录却没有刷题的哪一天的数据不需要输出，上面的例子查询结果如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20201015/557336_1602736313104_6BE4C7264FB9F7CED1DD6A6D44652D6C" alt="img"></p> <p>查询结果表明:
fh在2020-10-12为止，总共通过了4道题，输出为4
wangchao在2020-10-12为止，总共通过了1道题，总计为1
tm在2020-10-12为止只登陆了没有刷题，故没有显示出来
tm在2020-10-13为止刷了题，但是却没有通过任何题目，总计为0
wangchao在2020-10-13通过2道，但是加上前面2020-10-12通过1道，故在2020-10-13为止总共通过了3道题，总计为3</p></blockquote> <p>还是排序，但是这里需要先分区再排序</p> <ol><li><p>分组排序</p> <p><code>SELECT user_id,date,SUM(number) OVER(PARTITION BY user_id ORDER BY user_id,date) FROM passing_number</code></p> <p>这样基本上就完成的差不多了</p></li> <li><p><code>JOIN</code>连接，将 user_id 替换成 user_name</p></li> <li><p><code>ORDER BY</code>排序</p></li></ol> <p>完整SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">user</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> user_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> user_id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> passing_number
<span class="token keyword">JOIN</span> <span class="token keyword">user</span> <span class="token keyword">ON</span> passing_number<span class="token punctuation">.</span>user_id <span class="token operator">=</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">date</span><span class="token punctuation">,</span><span class="token keyword">user</span><span class="token punctuation">.</span>name
</code></pre></div><h2 id="自连接"><a href="#自连接" class="header-anchor">#</a> 自连接</h2> <h4 id="sql73-考试分数-二-中等"><a href="#sql73-考试分数-二-中等" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/f456dedf88a64f169aadd648491a27c1?tpId=82&amp;tags=&amp;title=&amp;difficulty=0&amp;judgeStatus=0&amp;rp=1" target="_blank" rel="noopener noreferrer"><strong>SQL73</strong> <strong>考试分数(二)</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（中等）</h4> <blockquote><p>描述</p> <p>牛客每次考试完，都会有一个成绩表(grade)，如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210204/557336_1612434140530/A40EBCABDBC68539EE224EE1DC2A7FE7" alt="img"></p> <p>第1行表示用户id为1的用户选择了C++岗位并且考了11001分</p> <p>。。。</p> <p>第8行表示用户id为8的用户选择了前端岗位并且考了9999分</p> <p>请你写一个sql语句查询用户分数大于其所在工作(job)分数的平均分的所有grade的属性，并且以id的升序排序，如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210204/557336_1612434164748/393D7F7211F18AF58DCC405ABAAB04DD" alt="img"></p> <p>(注意: sqlite 1/2得到的不是0.5，得到的是0，只有1*1.0/2才会得到0.5，sqlite四舍五入的函数为round)</p></blockquote> <ol><li><p>先求出每个岗位的平均分</p> <blockquote><p>-- 子查询（平均分）</p> <div class="language-sql extra-class"><pre class="language-sql"><code>    <span class="token keyword">SELECT</span> job<span class="token punctuation">,</span><span class="token function">AVG</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">AS</span> score <span class="token keyword">FROM</span> grade
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> job
</code></pre></div></blockquote></li> <li><p>表连接</p> <p><code>JOIN</code>连接两个表之后，相当于把两个表拼接，那么子查询就相当于是一个字段了</p></li> <li><p>WHERE 条件过滤</p> <p><code>a.score &gt; b.score</code></p></li></ol> <p>完整SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>a<span class="token punctuation">.</span>job<span class="token punctuation">,</span>a<span class="token punctuation">.</span>score <span class="token keyword">FROM</span> grade a
<span class="token keyword">JOIN</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> job<span class="token punctuation">,</span><span class="token function">AVG</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">AS</span> score <span class="token keyword">FROM</span> grade
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> job
<span class="token punctuation">)</span> b
<span class="token keyword">ON</span> a<span class="token punctuation">.</span>job <span class="token operator">=</span> b<span class="token punctuation">.</span>job
<span class="token keyword">WHERE</span> a<span class="token punctuation">.</span>score <span class="token operator">&gt;</span> b<span class="token punctuation">.</span>score
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> id
</code></pre></div><h4 id="sql86-实习广场投递简历分析-三-困难"><a href="#sql86-实习广场投递简历分析-三-困难" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/83f84aa5c32b4cf5a75558d02dd7743c?tpId=82&amp;tags=&amp;title=&amp;difficulty=0&amp;judgeStatus=0&amp;rp=1" target="_blank" rel="noopener noreferrer"><strong>SQL86</strong> <strong>实习广场投递简历分析(三)</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（困难）</h4> <blockquote><p>描述</p> <p>在牛客实习广场有很多公司开放职位给同学们投递，同学投递完就会把简历信息存到数据库里。</p> <p>现在有简历信息表(resume_info)，部分信息简况如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210305/301499_1614930662852/E587507D0FC15C77027A0B0E39B12F10" alt="img"></p> <p>第1行表示，在2025年1月2号，C++岗位收到了53封简历</p> <p>。。。</p> <p>最后1行表示，在2027年2月6号，C++岗位收到了231封简历</p> <p>请你写出SQL语句查询在2025年投递简历的每个岗位，每一个月内收到简历的数目，和对应的2026年的同一个月同岗位，收到简历的数目，最后的结果先按first_year_mon月份降序，再按job降序排序显示，以上例子查询结果如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210305/301499_1614931927046/10AF6822A92E37CE34B3EFFF8522E033" alt="img"></p> <p>解析:</p> <p>第1行表示Python岗位在2025年2月收到了93份简历，在对应的2026年2月收到了846份简历</p> <p>。。。</p> <p>最后1行表示C++岗位在2025年1月收到了107份简历，在对应的2026年1月收到了470份简历</p></blockquote> <p>这道题难度说是困难，但其实很简单。</p> <ol><li><p>首先看字段，像不像是两个<code>(job,date,cnt)</code>字段的表进行连接。得到只有左边三个字段很容易的，所以我们先查询得到这部分：</p> <blockquote><p>-- 子查询</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> job<span class="token punctuation">,</span>DATE_FORMAT<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> mon<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt
<span class="token keyword">FROM</span> resume_info
<span class="token keyword">WHERE</span> DATE_FORMAT<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span><span class="token string">'%Y'</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2025</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> job<span class="token punctuation">,</span>mon
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> mon <span class="token keyword">DESC</span><span class="token punctuation">,</span>cnt <span class="token keyword">DESC</span>
</code></pre></div></blockquote> <p>​		那么要得到2026年的数据，只需要把上面的WHERE条件中的2025改成2026即可。</p></li> <li><p>我们将上面两个子表（2025年数据和2026年数据）分别命名为a、b，然后进行连接</p> <blockquote><p>-- 表连接</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> a<span class="token punctuation">.</span>job<span class="token punctuation">,</span>a<span class="token punctuation">.</span>mon<span class="token punctuation">,</span>a<span class="token punctuation">.</span>cnt<span class="token punctuation">,</span>b<span class="token punctuation">.</span>mon<span class="token punctuation">,</span>b<span class="token punctuation">.</span>cnt
<span class="token keyword">FROM</span> a<span class="token punctuation">,</span> b
<span class="token keyword">WHERE</span> a<span class="token punctuation">.</span>job <span class="token operator">=</span>b<span class="token punctuation">.</span>job
<span class="token operator">AND</span> SUBSTR<span class="token punctuation">(</span>a<span class="token punctuation">.</span>mon<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> SUBSTR<span class="token punctuation">(</span>b<span class="token punctuation">.</span>mon<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a<span class="token punctuation">.</span>mon <span class="token keyword">DESC</span><span class="token punctuation">,</span>job <span class="token keyword">DESC</span>
</code></pre></div></blockquote> <p>这里表连接有两个连接词，一个是<code>job</code>，另一个是<code>mon的后面两个字符串</code>(即月份)，因为2025年和2026年不同，所以需要把年份去掉，即只取月份。这里用<code>SUBSTR()</code>函数实现（该函数仅用于字符串类型），<code>SUBSTR(mon,-2)</code>表示取mon字段的最后两个字符。</p></li></ol> <p>完整SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> a<span class="token punctuation">.</span>job<span class="token punctuation">,</span>a<span class="token punctuation">.</span>mon<span class="token punctuation">,</span>a<span class="token punctuation">.</span>cnt<span class="token punctuation">,</span>b<span class="token punctuation">.</span>mon<span class="token punctuation">,</span>b<span class="token punctuation">.</span>cnt
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> job<span class="token punctuation">,</span>DATE_FORMAT<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> mon<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt
    <span class="token keyword">FROM</span> resume_info
    <span class="token keyword">WHERE</span> DATE_FORMAT<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span><span class="token string">'%Y'</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2025</span>
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> job<span class="token punctuation">,</span>mon
    <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> mon <span class="token keyword">DESC</span><span class="token punctuation">,</span>cnt <span class="token keyword">DESC</span>
<span class="token punctuation">)</span> a<span class="token punctuation">,</span>
<span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> job<span class="token punctuation">,</span>DATE_FORMAT<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> mon<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt
    <span class="token keyword">FROM</span> resume_info
    <span class="token keyword">WHERE</span> DATE_FORMAT<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span><span class="token string">'%Y'</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2026</span>
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> job<span class="token punctuation">,</span>mon
    <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> mon <span class="token keyword">DESC</span><span class="token punctuation">,</span>cnt <span class="token keyword">DESC</span>
<span class="token punctuation">)</span> b
<span class="token keyword">WHERE</span> a<span class="token punctuation">.</span>job <span class="token operator">=</span>b<span class="token punctuation">.</span>job
<span class="token operator">AND</span> SUBSTR<span class="token punctuation">(</span>a<span class="token punctuation">.</span>mon<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> SUBSTR<span class="token punctuation">(</span>b<span class="token punctuation">.</span>mon<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a<span class="token punctuation">.</span>mon <span class="token keyword">DESC</span><span class="token punctuation">,</span>job <span class="token keyword">DESC</span>
</code></pre></div><h2 id="中位数"><a href="#中位数" class="header-anchor">#</a> 中位数</h2> <h3 id="取整"><a href="#取整" class="header-anchor">#</a> 取整</h3> <h4 id="sql75-考试分数-四-较难"><a href="#sql75-考试分数-四-较难" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/502fb6e2b1ad4e56aa2e0dd90c6edf3c?tpId=82&amp;tags=&amp;title=&amp;difficulty=0&amp;judgeStatus=0&amp;rp=1" target="_blank" rel="noopener noreferrer"><strong>SQL75</strong> <strong>考试分数(四)</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（较难）</h4> <blockquote><p>描述</p> <p>牛客每次考试完，都会有一个成绩表(grade)，如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210204/557336_1612434754935/ECC08FF796C5751177B2300798551D67" alt="img"></p> <p>第1行表示用户id为1的用户选择了C++岗位并且考了11001分</p> <p>。。。</p> <p>第8行表示用户id为8的用户选择了B语言岗位并且考了9999分</p> <p>请你写一个sql语句查询各个岗位分数升序排列之后的中位数位置的范围，并且按job升序排序，结果如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210204/557336_1612434773205/02F13D43D70927AC143B7ADE08DC301F" alt="img"></p> <p>解释:</p> <p>第1行表示C++岗位的中位数位置范围为[2,2]，也就是2。因为C++岗位总共3个人，是奇数，所以中位数位置为2是正确的(即位置为2的10000是中位数)</p> <p>第2行表示Java岗位的中位数位置范围为[1,2]。因为Java岗位总共2个人，是偶数，所以要知道中位数，需要知道2个位置的数字，而因为只有2个人，所以中位数位置为[1,2]是正确的(即需要知道位置为1的12000与位置为2的13000才能计算出中位数为12500)</p> <p>第3行表示前端岗位的中位数位置范围为[2,2]，也就是2。因为B语言岗位总共3个人，是奇数，所以中位数位置为2是正确的(即位置为2的11000是中位数)</p> <p>(注意: sqlite 1/2得到的不是0.5，得到的是0，只有1*1.0/2才会得到0.5，sqlite四舍五入的函数为round，sqlite不支持floor函数，支持cast(x as integer) 函数，不支持if函数，支持case when ...then ...else ..end函数)</p></blockquote> <p>中位数！！！咋一看以为这是排序题，然后发现并不需要排序</p> <p>思路：</p> <ol><li><p>GROUP BY + COUNT(*)统计各个岗位的数量</p> <p><code>SELECT job,COUNT(*) AS num FROM grade GROUP BY job</code></p> <p>将查询结果命名为子表a</p></li> <li><p>用<code>IF(expr1,a,b)</code>将岗位数分为单数、双数两种情况处理</p> <p>其中，当岗位数为单数时，start和end相同，其中位数都是(这里岗位数命名为num) num/2并向上取整【例如，5的中位数是5/2并向上取整，即3】</p> <p>当岗位数为双数时，其中位数start是num/2，end是num/2+1【例如，6的两个中位数分别是6/2即3，以及6/2+1即4】</p></li></ol> <p>完整SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> job<span class="token punctuation">,</span><span class="token keyword">IF</span><span class="token punctuation">(</span>num<span class="token operator">%</span><span class="token number">2</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>CEILING<span class="token punctuation">(</span>num<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">ROUND</span><span class="token punctuation">(</span>num<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token keyword">IF</span><span class="token punctuation">(</span>num<span class="token operator">%</span><span class="token number">2</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>CEILING<span class="token punctuation">(</span>num<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">ROUND</span><span class="token punctuation">(</span>num<span class="token operator">/</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token keyword">FROM</span> <span class="token punctuation">(</span> 
    <span class="token keyword">SELECT</span> job<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> num <span class="token keyword">FROM</span> grade
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> job
<span class="token punctuation">)</span> a
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> job
</code></pre></div><h4 id="sql76-考试分数-五"><a href="#sql76-考试分数-五" class="header-anchor">#</a> <a href="#NIUKE_SQL76">SQL76 考试分数(五)</a></h4> <h3 id="正序-逆序"><a href="#正序-逆序" class="header-anchor">#</a> 正序+逆序</h3> <h4 id="sql88-最差是第几名-二-较难"><a href="#sql88-最差是第几名-二-较难" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/165d88474d434597bcd2af8bf72b24f1?tpId=82&amp;tags=&amp;title=&amp;difficulty=0&amp;judgeStatus=0&amp;rp=1" target="_blank" rel="noopener noreferrer"><strong>SQL88</strong> <strong>最差是第几名(二)</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（较难）</h4> <blockquote><p>描述</p> <p>TM小哥和FH小妹在牛客大学若干年后成立了牛客SQL班，班的每个人的综合成绩用A,B,C,D,E表示，90分以上都是A，80~90分都是B，60~70分为C，50~60为D，E为50分以下</p> <p>因为每个名次最多1个人，比如有2个A，那么必定有1个A是第1名，有1个A是第2名(综合成绩同分也会按照某一门的成绩分先后)。</p> <p>每次SQL考试完之后，老师会将班级成绩表展示给同学看。</p> <p>现在有班级成绩表(class_grade)如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210310/301499_1615348808889/89751765A8ABF251A21CBC1F35C7E2D8" alt="img"></p> <p>第1行表示成绩为A的学生有2个</p> <p>.......</p> <p>最后1行表示成绩为D的学生有2个</p> <p>老师想知道学生们综合成绩的中位数是什么档位，请你写SQL帮忙查询一下，如果只有1个中位数，输出1个，如果有2个中位数，按grade升序输出，以上例子查询结果如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210310/301499_1615348944255/9CE3BEF4C093F1FBE8525594E5882325" alt="img"></p> <p>解析:</p> <p>总体学生成绩排序如下:A, A, B, B, B, B, C, C, C, C, D, D，总共12个数，取中间的2个，取6，7为:B,</p></blockquote> <p>思路：</p> <p>因为中位数可能有两个（累计和为单数和双数两种情况），故可以采用另一种思路，<strong>正逆序累计和都大于等于综合的一半</strong>。</p> <p>生成两个累计和，一个正序一个逆序，当正序和逆序都大于等于总和的一半时，即为中位数，如下图：</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210810013846.png" alt=""></p> <ol><li><p>生成正逆序累计和</p> <blockquote><p>-- 子查询（正逆序累计和）</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span>  grade<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> grade<span class="token punctuation">)</span> <span class="token keyword">AS</span> rs1<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> grade <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rs2
<span class="token keyword">FROM</span> class_grade
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>  grade
</code></pre></div></blockquote></li> <li><p>外层嵌套，加上过滤条件</p></li></ol> <p>完整SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> grade <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span>  grade<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> grade<span class="token punctuation">)</span> <span class="token keyword">AS</span> rs1<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> grade <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rs2
    <span class="token keyword">FROM</span> class_grade
    <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>  grade
<span class="token punctuation">)</span> t
<span class="token keyword">WHERE</span> t<span class="token punctuation">.</span>rs1 <span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">SUM</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token keyword">FROM</span> class_grade<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>
<span class="token operator">AND</span> t<span class="token punctuation">.</span>rs2 <span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">SUM</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token keyword">FROM</span> class_grade<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>
</code></pre></div><h2 id="字符串处理"><a href="#字符串处理" class="header-anchor">#</a> 字符串处理</h2> <h4 id="sql51-查找字符串-10-a-b-中逗号-出现的次数cnt-中等"><a href="#sql51-查找字符串-10-a-b-中逗号-出现的次数cnt-中等" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/e3870bd5d6744109a902db43c105bd50?tpId=82&amp;&amp;tqId=29819&amp;rp=1&amp;ru=/activity/oj&amp;qru=/ta/sql/question-ranking" target="_blank" rel="noopener noreferrer"><strong>SQL51</strong> <strong>查找字符串 10,A,B 中逗号,出现的次数cnt</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（中等）</h4> <blockquote><p>描述</p> <p>查找字符串'10,A,B' 中逗号','出现的次数cnt。</p> <p>示例1</p> <p>输入：</p> <div class="language- extra-class"><pre class="language-text"><code>&quot;10,A,B&quot;
</code></pre></div><p>输出：</p> <div class="language- extra-class"><pre class="language-text"><code>2.0000
</code></pre></div></blockquote> <p>思路：用<code>REPLACE()</code>函数替换需要处理的字符串，将逗号替换为空，用<code>length()</code>函数统计原字符串长度以及处理后的字符串长度，相减得到个数</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">(</span>length<span class="token punctuation">(</span><span class="token string">'10,A,B'</span><span class="token punctuation">)</span> <span class="token operator">-</span> length<span class="token punctuation">(</span><span class="token keyword">REPLACE</span><span class="token punctuation">(</span><span class="token string">'10,A,B'</span><span class="token punctuation">,</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt
</code></pre></div><blockquote><p>拓展：此题不需要取整，如果需要取整的话可以用<code>ROUND()</code>函数</p></blockquote> <h4 id="sql52-获取employees中的first-name-中等"><a href="#sql52-获取employees中的first-name-中等" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/74d90728827e44e2864cce8b26882105?tpId=82&amp;&amp;tqId=29820&amp;rp=1&amp;ru=/activity/oj&amp;qru=/ta/sql/question-ranking" target="_blank" rel="noopener noreferrer"><strong>SQL52</strong> <strong>获取Employees中的first_name</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（中等）</h4> <p>（我觉得题名该写成<strong>SQL52</strong> <strong>获取Employees中的first_name并按照first_name后两个字符串排序</strong>）</p> <blockquote><h2 id="描述"><a href="#描述" class="header-anchor">#</a> 描述</h2> <p>获取Employees中的first_name，查询按照first_name最后两个字母，按照升序进行排列
CREATE TABLE <code>employees</code> (
<code>emp_no</code> int(11) NOT NULL,
<code>birth_date</code> date NOT NULL,
<code>first_name</code> varchar(14) NOT NULL,
<code>last_name</code> varchar(16) NOT NULL,
<code>gender</code> char(1) NOT NULL,
<code>hire_date</code> date NOT NULL,
PRIMARY KEY (<code>emp_no</code>));
输出格式：</p> <table><thead><tr><th style="text-align:left;">first_name</th></tr></thead> <tbody><tr><td style="text-align:left;">Chirstian</td></tr> <tr><td style="text-align:left;">Tzvetan</td></tr> <tr><td style="text-align:left;">Bezalel</td></tr> <tr><td style="text-align:left;">Duangkaew</td></tr></tbody></table></blockquote> <p>这个是很常规的<code>select 字段名 from tablename order by</code>型题，但是这里重在<strong>按照字段的最后两个字母排序</strong>。<code>SUBSTR()</code>函数可以获取字符串的部分字符，所以这里可以用<code>SUBSTR(first_name,-2)</code>，表示获取first_name字符串的最后两个字符，于是SQL实现如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> first_name <span class="token keyword">FROM</span> employees <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> SUBSTR<span class="token punctuation">(</span>first_name<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>拓展</p> <p>1、substr函数格式  (字符截取函数)</p> <div class="language-sql extra-class"><pre class="language-sql"><code>　　<span class="token comment">-- 格式1 </span>
　　substr<span class="token punctuation">(</span>stringname<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>

　　<span class="token comment">-- 格式2</span>
　　substr<span class="token punctuation">(</span>stringname<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token punctuation">;</span>
</code></pre></div><p>解析：</p> <p>格式1：
1、string 需要截取的字符串
2、a 截取字符串的开始位置（注：当a等于0或1时，都是从第一位开始截取）
3、b 要截取的字符串的长度</p> <p>格式2：
1、string 需要截取的字符串
2、a 可以理解为从第a个字符开始截取后面所有的字符串。</p></blockquote> <p>此外，也可以用<code>RIGHT()</code>函数，这题将SUBSRT函数换成``RIGHT(first_name,2)<code>也可以达到同样的效果，表示从右开始数截取两个字符（所以</code>LEFT(first_name,2)<code>函数就表示从左开始截取first_name字段的2个字符）。限于认知水平，本人觉得</code>RIGHT()<code>和</code>LEFT()`很鸡肋。</p> <h4 id="sql83-牛客的课程订单分析-七-较难"><a href="#sql83-牛客的课程订单分析-七-较难" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/d6f4a37f966145da8900ba9edcc4c068?tpId=82&amp;tags=&amp;title=&amp;difficulty=0&amp;judgeStatus=0&amp;rp=1" target="_blank" rel="noopener noreferrer"><strong>SQL83</strong> <strong>牛客的课程订单分析(七)</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（较难）</h4> <blockquote><p>描述</p> <p>有很多同学在牛客购买课程来学习，购买会产生订单存到数据库里。</p> <p>有一个订单信息表(order_info)，简况如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210226/310548_1614323798769/031537881B33EBB979D8E6E63131CE63" alt="img"></p> <p>第1行表示user_id为557336的用户在2025-10-10的时候使用了client_id为1的客户端下了C++课程的**非拼团****(is_group_buy<strong><strong>为</strong></strong>N<strong><strong>o</strong></strong>)**订单，但是状态为没有购买成功。</p> <p>第2行表示user_id为230173543的用户在2025-10-12的时候使用了client_id为2的客户端下了Python课程的非拼团**(is_group_buy<strong><strong>为</strong></strong>N<strong><strong>o</strong></strong>)**订单，状态为购买成功。</p> <p>。。。</p> <p>最后1行表示user_id为557336的用户在2025-10-25的时候使用了下了C++课程的拼团**(is_group_buy<strong><strong>为</strong></strong>Yes)<strong>订单，拼团不统计客户端，所以</strong>client_id<strong>所以为</strong>0**，状态为购买成功。</p> <p>有一个客户端表(client)，简况如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210226/310548_1614323833226/E5783422025D1F46BE7EF16FEE660647" alt="img"></p> <p>请你写出一个sql语句查询在2025-10-15以后，同一个用户下单2个以及2个以上状态为购买成功的C++课程或Java课程或Python课程的来源信息，第一列是显示的是客户端名字，如果是拼团订单则显示GroupBuy，第二列显示这个客户端(或者是拼团订单)有多少订单，最后结果按照第一列(source)升序排序，以上例子查询结果如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210226/310548_1614323840965/A1722B1F53A15FC02282C10E33E90645" alt="img"></p> <p>解析:</p> <p>id为4，6的订单满足以上条件，且因为4是通过IOS下单的非拼团订单，则记: IOS 1</p> <p>，6是通过PC下单的非拼团订单，则记: PC 1;</p> <p>id为5，7的订单满足以上条件，且因为5与7都是拼团订单，则记: GroupBuy 2;</p> <p>最后按照source升序排序。</p></blockquote> <p>思路：</p> <ol><li><p>先获得符合条件的数据作为子表，还是依赖WHERE 条件实现过滤，整体思路是：</p> <p><code>SELECT * FROM order_info WHERE user_id IN ( )</code></p> <p>然后将条件补充完整，如下：</p> <blockquote><p>-- 子查询</p> <div class="language-sql extra-class"><pre class="language-sql"><code>    <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> order_info
    <span class="token keyword">WHERE</span> user_id <span class="token operator">IN</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> user_id <span class="token keyword">FROM</span> order_info
        <span class="token keyword">WHERE</span> <span class="token keyword">status</span> <span class="token operator">=</span> <span class="token string">'completed'</span>
        <span class="token operator">AND</span> product_name <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'C++'</span><span class="token punctuation">,</span><span class="token string">'Java'</span><span class="token punctuation">,</span><span class="token string">'Python'</span><span class="token punctuation">)</span>
        <span class="token operator">AND</span> <span class="token keyword">date</span> <span class="token operator">&gt;</span> <span class="token string">'2025-10-15'</span>
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
        <span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2</span>
    <span class="token punctuation">)</span>
    <span class="token operator">AND</span> <span class="token keyword">status</span> <span class="token operator">=</span> <span class="token string">'completed'</span>
    <span class="token operator">AND</span> product_name <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'C++'</span><span class="token punctuation">,</span><span class="token string">'Java'</span><span class="token punctuation">,</span><span class="token string">'Python'</span><span class="token punctuation">)</span>
    <span class="token operator">AND</span> <span class="token keyword">date</span> <span class="token operator">&gt;</span> <span class="token string">'2025-10-15'</span>
</code></pre></div></blockquote></li> <li><p>上述已经是一个符合条件的数据，所以接下来只需要进行<code>GROUP BY</code>分组查询即可</p> <p>这里注意要用LEFT/RIGHT JOIN连接，并且将NULL替换成'GroupBuy'</p> <blockquote><p>-- 分组查询</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> IFNULL<span class="token punctuation">(</span>client<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">'GroupBuy'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> source<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt
<span class="token keyword">FROM</span>  a <span class="token comment">-- 上述的子查询表</span>
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> client <span class="token keyword">ON</span> a<span class="token punctuation">.</span>client_id <span class="token operator">=</span> client<span class="token punctuation">.</span>id
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> client<span class="token punctuation">.</span>name
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> source

</code></pre></div></blockquote></li></ol> <p>完整SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> IFNULL<span class="token punctuation">(</span>client<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">'GroupBuy'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> source<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>

    <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> order_info
    <span class="token keyword">WHERE</span> user_id <span class="token operator">IN</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> user_id <span class="token keyword">FROM</span> order_info
        <span class="token keyword">WHERE</span> <span class="token keyword">status</span> <span class="token operator">=</span> <span class="token string">'completed'</span>
        <span class="token operator">AND</span> product_name <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'C++'</span><span class="token punctuation">,</span><span class="token string">'Java'</span><span class="token punctuation">,</span><span class="token string">'Python'</span><span class="token punctuation">)</span>
        <span class="token operator">AND</span> <span class="token keyword">date</span> <span class="token operator">&gt;</span> <span class="token string">'2025-10-15'</span>
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
        <span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2</span>
    <span class="token punctuation">)</span>
    <span class="token operator">AND</span> <span class="token keyword">status</span> <span class="token operator">=</span> <span class="token string">'completed'</span>
    <span class="token operator">AND</span> product_name <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'C++'</span><span class="token punctuation">,</span><span class="token string">'Java'</span><span class="token punctuation">,</span><span class="token string">'Python'</span><span class="token punctuation">)</span>
    <span class="token operator">AND</span> <span class="token keyword">date</span> <span class="token operator">&gt;</span> <span class="token string">'2025-10-15'</span>
    
<span class="token punctuation">)</span> a
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> client <span class="token keyword">ON</span> a<span class="token punctuation">.</span>client_id <span class="token operator">=</span> client<span class="token punctuation">.</span>id
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> client<span class="token punctuation">.</span>name
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> source

</code></pre></div><h2 id="字段拼接"><a href="#字段拼接" class="header-anchor">#</a> 字段拼接</h2> <h4 id="将employees表中的所有员工的last-name和first-name通过引号连接起来-中等"><a href="#将employees表中的所有员工的last-name和first-name通过引号连接起来-中等" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/810bf4ee3ac64949b08983aa66ec7bee?tpId=82&amp;&amp;tqId=29818&amp;rp=1&amp;ru=/activity/oj&amp;qru=/ta/sql/question-ranking" target="_blank" rel="noopener noreferrer"><strong>将employees表中的所有员工的last_name和first_name通过引号连接起来</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（中等）</h4> <blockquote><p>描述</p> <p>将employees表中的所有员工的last_name和first_name通过(')连接起来。(sqlite不支持concat，请用||实现，mysql支持concat)
CREATE TABLE <code>employees</code> (
<code>emp_no</code> int(11) NOT NULL,
<code>birth_date</code> date NOT NULL,
<code>first_name</code> varchar(14) NOT NULL,
<code>last_name</code> varchar(16) NOT NULL,
<code>gender</code> char(1) NOT NULL,
<code>hire_date</code> date NOT NULL,
PRIMARY KEY (<code>emp_no</code>));
输出格式:</p> <table><thead><tr><th style="text-align:left;">name</th></tr></thead> <tbody><tr><td style="text-align:left;">Facello'Georgi</td></tr> <tr><td style="text-align:left;">Simmel'Bezalel</td></tr> <tr><td style="text-align:left;">Bamford'Parto</td></tr></tbody></table></blockquote> <p><code>CONCAT( )</code>函数可以实现两个字段拼接，例如<code>CONCAT(a,b)</code>可以将字段a和字段b拼接成一个字段，如果拼接三个字段则<code>CONCAT(a,b,c)</code>，因而该题SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> CONCAT<span class="token punctuation">(</span>last_name<span class="token punctuation">,</span><span class="token string">&quot;'&quot;</span><span class="token punctuation">,</span>first_name<span class="token punctuation">)</span> <span class="token keyword">FROM</span> employees
</code></pre></div><h4 id="sql53-按照dept-no进行汇总-中等"><a href="#sql53-按照dept-no进行汇总-中等" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/6e86365af15e49d8abe2c3d4b5126e87?tpId=82&amp;tqId=29813&amp;rp=1&amp;ru=%2Factivity%2Foj&amp;qru=%2Fta%2Fsql%2Fquestion-ranking" target="_blank" rel="noopener noreferrer"><strong>SQL53</strong> <strong>按照dept_no进行汇总</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（中等）</h4> <blockquote><p>描述</p> <p>按照dept_no进行汇总，属于同一个部门的emp_no按照逗号进行连接，结果给出dept_no以及连接出的结果employees
CREATE TABLE <code>dept_emp</code> (
<code>emp_no</code> int(11) NOT NULL,
<code>dept_no</code> char(4) NOT NULL,
<code>from_date</code> date NOT NULL,
<code>to_date</code> date NOT NULL,
PRIMARY KEY (<code>emp_no</code>,<code>dept_no</code>));
输出格式:</p> <table><thead><tr><th style="text-align:left;">dept_no</th> <th style="text-align:left;">employees</th></tr></thead> <tbody><tr><td style="text-align:left;">d001</td> <td style="text-align:left;">10001,10002</td></tr> <tr><td style="text-align:left;">d002</td> <td style="text-align:left;">10006</td></tr> <tr><td style="text-align:left;">d003</td> <td style="text-align:left;">10005</td></tr> <tr><td style="text-align:left;">d004</td> <td style="text-align:left;">10003,10004</td></tr></tbody></table></blockquote> <p><code>CONCAT()</code>函数可以拼接两个或多个字段，所以这里的思路是对每个dept_no分组，然后拼接。</p> <p>但CONCAT并不是聚合函数，在GROUP BY操作之后用CONCAT并不会将字段拼接（只会显示第一个），所以这里需要用聚合函数<code>GROUP_CONCAT</code>，正确SQL实现如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> dept_no<span class="token punctuation">,</span>GROUP_CONCAT<span class="token punctuation">(</span>emp_no<span class="token punctuation">)</span> employees
<span class="token keyword">FROM</span> dept_emp <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> dept_no
</code></pre></div><h2 id="排序"><a href="#排序" class="header-anchor">#</a> 排序</h2> <h4 id="sql61-对于employees表中-给出奇数行的first-name-较难"><a href="#sql61-对于employees表中-给出奇数行的first-name-较难" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/e3cf1171f6cc426bac85fd4ffa786594?tpId=82&amp;&amp;tqId=29829&amp;rp=1&amp;ru=/activity/oj&amp;qru=/ta/sql/question-ranking" target="_blank" rel="noopener noreferrer"><strong>SQL61</strong> <strong>对于employees表中，给出奇数行的first_name</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（较难）</h4> <p>（我觉得题名该写成<strong>SQL61</strong> <strong>对于employees表中，first_name的行号由升序排序，给出结果数据顺序与原表相同的奇数行的first_name</strong>）</p> <blockquote><p>描述</p> <p>对于employees表中，输出first_name排名(按first_name升序排序)为奇数的first_name
CREATE TABLE <code>employees</code> (
<code>emp_no</code> int(11) NOT NULL,
<code>birth_date</code> date NOT NULL,
<code>first_name</code> varchar(14) NOT NULL,
<code>last_name</code> varchar(16) NOT NULL,
<code>gender</code> char(1) NOT NULL,
<code>hire_date</code> date NOT NULL,</p> <p>PRIMARY KEY (<code>emp_no</code>));</p> <p>如，输入为：</p> <p>INSERT INTO employees VALUES(10001,'1953-09-02','Georgi','Facello','M','1986-06-26');
INSERT INTO employees VALUES(10002,'1964-06-02','Bezalel','Simmel','F','1985-11-21');
INSERT INTO employees VALUES(10005,'1955-01-21','Kyoichi','Maliniak','M','1989-09-12');
INSERT INTO employees VALUES(10006,'1953-04-20','Anneke','Preusig','F','1989-06-02');</p> <p>输出格式:</p> <table><thead><tr><th style="text-align:left;">first_name</th></tr></thead> <tbody><tr><td style="text-align:left;">Georgi</td></tr> <tr><td style="text-align:left;">Anneke</td></tr></tbody></table> <p>因为Georgi按first_name排名为3，Anneke按first_name排名为1，所以会输出这2个，且输出时不需排序。</p></blockquote> <p>先不看题目描述的最后一行（因为Georgi按first_name排名为3，Anneke按first_name排名为1，所以会输出这2个，且输出时不需排序。）</p> <p>这种情况用开窗函数<code>ROW_NUMBER() OVER(ORDER BY 排序字段名)</code>先得到一个有序号的字段，然后将这个表作为子查询结果（因为最终结果不要ROW_NUMBER() OVER( )得到的这个字段），只保留first_name这个字段，并且加上WHERE条件筛选出奇数行，SQL语句如下（由里到外看）：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> first_name <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
 <span class="token keyword">SELECT</span> first_name<span class="token punctuation">,</span>ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> first_name<span class="token punctuation">)</span> <span class="token keyword">AS</span> rs
    <span class="token keyword">FROM</span> employees
<span class="token punctuation">)</span> a 
<span class="token keyword">WHERE</span> rs <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> first_name
</code></pre></div><p>OK，如果没有题目的最后一行描述，那么已经大功告成了，但是事情并没有那么简单。</p> <p>当加上最后一行的题目描述，我们需要结果是原来插入的那个顺序输出，所以不能是开窗函数排序后的结果那样输出。</p> <ul><li>方法一（套娃）</li></ul> <p>思路：因为排序需要用原表的顺序，所以总体思路是最后还是FROM 原表，也就是<code>FROM employees</code></p> <p>在上述的基础上，我们将筛选得到的first_name字段用在WHERE语句上再嵌套一层，用<code>WHERE 字段名 IN</code>的方法实现，SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> first_name <span class="token keyword">FROM</span> employees
<span class="token keyword">WHERE</span> first_name <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> first_name <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
     <span class="token keyword">SELECT</span> first_name<span class="token punctuation">,</span>ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> first_name<span class="token punctuation">)</span> <span class="token keyword">AS</span> rs
        <span class="token keyword">FROM</span> employees
    <span class="token punctuation">)</span> a 
    <span class="token keyword">WHERE</span> rs <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> first_name
<span class="token punctuation">)</span>
</code></pre></div><p>简单粗暴哈哈哈</p> <ul><li><p>方法二（表连接）</p> <p><a href="https://blog.nowcoder.net/n/ec78e0fb848b46f4b7d431775ca41b9b?f=comment" target="_blank" rel="noopener noreferrer">牛客用户：77栗子松糕<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>本质上都一样（都是from原表），只是这里将子查询作为一个表来与原表连接了</p></li></ul> <h4 id="sql63-刷题通过的题目排名-中等"><a href="#sql63-刷题通过的题目排名-中等" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/cd2e10a588dc4c1db0407d0bf63394f3?tpId=82&amp;&amp;tqId=35080&amp;rp=1&amp;ru=/ta/sql&amp;qru=/ta/sql/question-ranking" target="_blank" rel="noopener noreferrer"><strong>SQL63</strong> <strong>刷题通过的题目排名</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（中等）</h4> <blockquote><p>描述</p> <p>在牛客刷题有一个通过题目个数的(passing_number)表，id是主键，简化如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20200813/557336_1597308916086_6B7E692D15E9D27D855F76C56E00D52A" alt="img"></p> <p>第1行表示id为1的用户通过了4个题目;.....第6行表示id为6的用户通过了4个题目;请你根据上表，输出通过的题目的排名，通过题目个数相同的，排名相同，此时按照id升序排列，数据如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20201105/557336_1604558013211_15EB7DEE744C7810B57ED3EF3D65D7FE" alt="img"></p> <p>id为5的用户通过了5个排名第1，id为1和id为6的都通过了2个，并列第2</p></blockquote> <p>这题与普通的排序题类似，不一样的是这里的排名有重复的，所以不能用<code>row_number()</code>函数，需要用<code>dense_rank()</code>函数，直接<code>DENSE_RANK() OVER(ORDER BY number DESC)</code>将number降序排序（即number值大的排序序号较小），SQL实现如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>number<span class="token punctuation">,</span>DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> number <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> t_rank 
<span class="token keyword">FROM</span> passing_number
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> t_rank<span class="token punctuation">,</span>id
</code></pre></div><blockquote><p>拓展</p> <p><a href="https://www.cnblogs.com/qiuting/p/7880500.html" target="_blank" rel="noopener noreferrer">row_number()、rank()、dense_rank() 的区别<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>row_numbe</strong>r的用途非常广泛，排序最好用它，它会为查询出来的每一行记录生成一个序号，依次排序且不会重复，注意使用row_number函数时必须要用over子句选择对某一列进行排序才能生成序号。</p> <p><strong>rank</strong>函数用于返回结果集的分区内每行的排名，行的排名是相关行之前的排名数加一。简单来说rank函数就是对查询出来的记录进行排名，与row_number函数不同的是，rank函数考虑到了over子句中排序字段值相同的情况，如果使用rank函数来生成序号，over子句中排序字段值相同的序号是一样的，后面字段值不相同的序号将跳过相同的排名号排下一个，也就是相关行之前的排名数加一，可以理解为根据当前的记录数生成序号，后面的记录依此类推。</p> <p><strong>dense_rank</strong>函数的功能与rank函数类似，dense_rank函数在生成序号时是连续的，而rank函数生成的序号有可能不连续。dense_rank函数出现相同排名时，将不跳过相同排名号，rank值紧接上一次的rank值。在各个分组内，rank()是跳跃排序，有两个第一名时接下来就是第三名，dense_rank()是连续排序，有两个第一名时仍然跟着第二名。</p></blockquote> <h4 id="sql74-考试分数-三-较难"><a href="#sql74-考试分数-三-较难" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/b83f8b0e7e934d95a56c24f047260d91?tpId=82&amp;tags=&amp;title=&amp;difficulty=0&amp;judgeStatus=0&amp;rp=1" target="_blank" rel="noopener noreferrer"><strong>SQL74</strong> <strong>考试分数(三)</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（较难）</h4> <blockquote><p>描述</p> <p>牛客每次举办企业笔试的时候，企业一般都会有不同的语言岗位，比如C++工程师，JAVA工程师，Python工程师，每个用户笔试完有不同的分数，现在有一个分数(grade)表简化如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20200817/557336_1597652427039_07E19104EBD63DA9EDB41F5DD4489F99" alt="img"></p> <p>第1行表示用户id为1的选择了language_id为1岗位的最后考试完的分数为12000，
....
第7行表示用户id为7的选择了language_id为2岗位的最后考试完的分数为11000，</p> <p>不同的语言岗位(language)表简化如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20200817/557336_1597652437695_C8AFE1A16BE6BBA7929B73D79DE0E398" alt="img"></p> <p>请你找出每个岗位分数排名前2名的用户，得到的结果先按照language的name升序排序，再按照积分降序排序，最后按照grade的id升序排序，得到结果如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20200817/557336_1597652444918_D40D8F8B37A92E9E7A15A5231F7D3822" alt="img"></p></blockquote> <p>思路：</p> <ol><li><p>因为要筛选出前两名，所以还是用排序。从案例中来看，重复的也算入了前两名内，所以这里用于生成排序序号的函数应该用<code>DENSE_RANK()</code>（相同排名会生成相同排名号，连续；<code>RANK()</code>也是相同排名会生成相同排名号，但不连续）</p> <blockquote><p>-- 子查询（分组排序）</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>language_id<span class="token punctuation">,</span>score<span class="token punctuation">,</span>DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> language_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> score <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rs <span class="token keyword">FROM</span> grade
</code></pre></div></blockquote></li> <li><p>表连接，WHERE过滤等</p></li></ol> <p>完整SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> a<span class="token punctuation">.</span>id<span class="token punctuation">,</span>c<span class="token punctuation">.</span>name<span class="token punctuation">,</span>a<span class="token punctuation">.</span>score <span class="token keyword">FROM</span> grade a
<span class="token keyword">JOIN</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>language_id<span class="token punctuation">,</span>score<span class="token punctuation">,</span>DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> language_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> score <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rs
    <span class="token keyword">FROM</span> grade
<span class="token punctuation">)</span> b
<span class="token keyword">ON</span> a<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>id
<span class="token keyword">JOIN</span> <span class="token keyword">language</span> c
<span class="token keyword">ON</span> a<span class="token punctuation">.</span>language_id <span class="token operator">=</span> c<span class="token punctuation">.</span>id
<span class="token keyword">WHERE</span> b<span class="token punctuation">.</span>rs <span class="token operator">&lt;=</span> <span class="token number">2</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> c<span class="token punctuation">.</span>name<span class="token punctuation">,</span>a<span class="token punctuation">.</span>score <span class="token keyword">DESC</span><span class="token punctuation">,</span>a<span class="token punctuation">.</span>id
</code></pre></div><h4 id="sql76-考试分数-五-困难"><a href="#sql76-考试分数-五-困难" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/b626ff9e2ad04789954c2132c74c0512?tpId=82&amp;tags=&amp;title=&amp;difficulty=0&amp;judgeStatus=0&amp;rp=1" target="_blank" rel="noopener noreferrer"><strong>SQL76</strong> <strong>考试分数(五)</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（困难）</h4> <p><span id="NIUKE_SQL76">锚点：中位数</span></p> <blockquote><p>描述</p> <p>牛客每次考试完，都会有一个成绩表(grade)，如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210204/557336_1612434987195/17DF5669D7379DF505A49E7E33701DDF" alt="img"></p> <p>第1行表示用户id为1的用户选择了C++岗位并且考了11001分</p> <p>。。。</p> <p>第8行表示用户id为8的用户选择了B语言岗位并且考了9999分</p> <p>请你写一个sql语句查询各个岗位分数的中位数位置上的所有grade信息，并且按id升序排序，结果如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210204/557336_1612435020053/E4B68B27A8EAB1FDC2576B68F209167D" alt="img"></p> <p>解释：</p> <p>第1行表示C++岗位的中位数位置上的为用户id为2，分数为10000，在C++岗位里面排名是第2</p> <p>第2，3行表示Java岗位的中位数位置上的为用户id为4,5，分数为12000,13000，在Java岗位里面排名是第2,1</p> <p>第4行表示B语言岗位的中位数位置上的为用户id为7，分数为11000，在前端岗位里面排名是第2</p> <p>(注意: sqlite 1/2得到的不是0.5，得到的是0，只有1*1.0/2才会得到0.5，sqlite四舍五入的函数为round，sqlite不支持floor函数，支持cast(x as integer) 函数，不支持if函数，支持case when ...then ...else ..end函数，sqlite不支持自定义变量)</p></blockquote> <p>方法：无限套娃~~</p> <ol><li><p>是这题[<strong>SQL75</strong> <strong>考试分数(四)</strong>](<a href="https://www.nowcoder.com/practice/502fb6e2b1ad4e56aa2e0dd90c6edf3c?tpId=82&amp;tags=&amp;title=&amp;difficulty=0&amp;judgeStatus=0&amp;rp=1" target="_blank" rel="noopener noreferrer">考试分数(四)_牛客题霸_牛客网 (nowcoder.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)的进阶版本（这题要给出score是中位数的所有数据），还是先分组查询，但与（四）题不同的是，这里需要把中位数号合并，以下分别是单数、双数（双数有两个中位数）的情况，将其合并成(job,t_rank)两个字段的数据</p> <blockquote><p>-- 子查询（获取(job,t_rank)）</p> <div class="language-sql extra-class"><pre class="language-sql"><code>    <span class="token keyword">SELECT</span> job<span class="token punctuation">,</span><span class="token keyword">IF</span><span class="token punctuation">(</span>num<span class="token operator">%</span><span class="token number">2</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>CEILING<span class="token punctuation">(</span>num<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> t_rank
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span> 
        <span class="token keyword">SELECT</span> job<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> num <span class="token keyword">FROM</span> grade
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> job
    <span class="token punctuation">)</span> a
    <span class="token keyword">UNION</span>
    <span class="token keyword">SELECT</span> job<span class="token punctuation">,</span><span class="token keyword">IF</span><span class="token punctuation">(</span>num<span class="token operator">%</span><span class="token number">2</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>num<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> t_rank
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span> 
        <span class="token keyword">SELECT</span> job<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> num <span class="token keyword">FROM</span> grade
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> job
    <span class="token punctuation">)</span> a
    <span class="token keyword">UNION</span>
    <span class="token keyword">SELECT</span> job<span class="token punctuation">,</span><span class="token keyword">IF</span><span class="token punctuation">(</span>num<span class="token operator">%</span><span class="token number">2</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>num<span class="token operator">/</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> t_rank
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span> 
        <span class="token keyword">SELECT</span> job<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> num <span class="token keyword">FROM</span> grade
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> job
        <span class="token punctuation">)</span> a
</code></pre></div></blockquote> <p>（备注：<code>UNION</code>后面不能接<code>ORDER BY</code>）</p></li> <li><p>去重，WHERE过滤</p> <p>上面的子查询得到的数据里，还有null和重复的数据。所以外层再嵌套一个</p> <blockquote><p>-- 子查询（去重并过滤）</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> job<span class="token punctuation">,</span><span class="token function">ROUND</span><span class="token punctuation">(</span>t_rank<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
	<span class="token comment">-- 此前的三个子查询a</span>
    <span class="token punctuation">)</span> b
    <span class="token keyword">WHERE</span> t_rank <span class="token operator">&lt;&gt;</span> <span class="token string">'NULL'</span>
</code></pre></div></blockquote></li> <li><p>现在得到准确的(job,t_rank)格式了，那么对原表也用一次<code>ROW_NUMBER()</code>分组排序生成一个序号。都有(job,t_rank)，那么剩下就是老套的<code>WHERE 字段 IN</code>大法了</p> <blockquote><p>-- 子查询（再次套娃）</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>job<span class="token punctuation">,</span>score<span class="token punctuation">,</span>t_rank <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>job<span class="token punctuation">,</span>score<span class="token punctuation">,</span>ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> job <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> score <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> t_rank
    <span class="token keyword">FROM</span> grade
<span class="token punctuation">)</span> c
<span class="token keyword">WHERE</span> <span class="token punctuation">(</span>job<span class="token punctuation">,</span>t_rank<span class="token punctuation">)</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
	<span class="token comment">-- 此前的子查询结果</span>
<span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> id
</code></pre></div></blockquote></li></ol> <p>完整SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>job<span class="token punctuation">,</span>score<span class="token punctuation">,</span>t_rank <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>job<span class="token punctuation">,</span>score<span class="token punctuation">,</span>ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> job <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> score <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> t_rank
    <span class="token keyword">FROM</span> grade
<span class="token punctuation">)</span> c
<span class="token keyword">WHERE</span> <span class="token punctuation">(</span>job<span class="token punctuation">,</span>t_rank<span class="token punctuation">)</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>

    <span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> job<span class="token punctuation">,</span><span class="token function">ROUND</span><span class="token punctuation">(</span>t_rank<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span>

    <span class="token keyword">SELECT</span> job<span class="token punctuation">,</span><span class="token keyword">IF</span><span class="token punctuation">(</span>num<span class="token operator">%</span><span class="token number">2</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>CEILING<span class="token punctuation">(</span>num<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> t_rank
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span> 
        <span class="token keyword">SELECT</span> job<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> num <span class="token keyword">FROM</span> grade
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> job
    <span class="token punctuation">)</span> a
    <span class="token keyword">UNION</span>
    <span class="token keyword">SELECT</span> job<span class="token punctuation">,</span><span class="token keyword">IF</span><span class="token punctuation">(</span>num<span class="token operator">%</span><span class="token number">2</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>num<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> t_rank
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span> 
        <span class="token keyword">SELECT</span> job<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> num <span class="token keyword">FROM</span> grade
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> job
    <span class="token punctuation">)</span> a
    <span class="token keyword">UNION</span>
    <span class="token keyword">SELECT</span> job<span class="token punctuation">,</span><span class="token keyword">IF</span><span class="token punctuation">(</span>num<span class="token operator">%</span><span class="token number">2</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>num<span class="token operator">/</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> t_rank
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span> 
        <span class="token keyword">SELECT</span> job<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> num <span class="token keyword">FROM</span> grade
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> job
        <span class="token punctuation">)</span> a

    <span class="token punctuation">)</span> b
    <span class="token keyword">WHERE</span> t_rank <span class="token operator">&lt;&gt;</span> <span class="token string">'NULL'</span>

<span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> id

</code></pre></div><h2 id="连续"><a href="#连续" class="header-anchor">#</a> 连续</h2> <h3 id="连续数字"><a href="#连续数字" class="header-anchor">#</a> 连续数字</h3> <h4 id="_180-连续出现的数字-中等"><a href="#_180-连续出现的数字-中等" class="header-anchor">#</a> <a href="https://leetcode-cn.com/problems/consecutive-numbers/" target="_blank" rel="noopener noreferrer"><strong>180. 连续出现的数字</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（中等）</h4> <blockquote><p>表：Logs</p> <p>+-------------+---------+
| Column Name | Type    |
+-------------+---------+
| id          | int     |
| num         | varchar |
+-------------+---------+
id 是这个表的主键。</p> <p>编写一个 SQL 查询，查找所有至少连续出现三次的数字。</p> <p>返回的结果表中的数据可以按 任意顺序 排列。</p> <p>查询结果格式如下面的例子所示：</p> <p>Logs 表：
+----+-----+
| Id | Num |
+----+-----+
| 1  | 1   |
| 2  | 1   |
| 3  | 1   |
| 4  | 2   |
| 5  | 1   |
| 6  | 2   |
| 7  | 2   |
+----+-----+</p> <p>Result 表：
+-----------------+
| ConsecutiveNums |
+-----------------+
| 1               |
+-----------------+
1 是唯一连续出现至少三次的数字。</p> <p>来源：力扣（LeetCode）
链接：https://leetcode-cn.com/problems/consecutive-numbers
著作权归领扣网络所有。</p></blockquote> <p>这里因为id是连续的，所以可以利用id来作为判断是否连续的重要依据。</p> <p>以第一行的id为基准，将第二行数据的id减1，第二行数据的id减2，这样三行数据的id都相同了</p> <p>之后再以id为连接键进行表连接，当连接后的表里同一行的num都相同时，即该num是一个出现了连续三次的num</p> <p>SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> a<span class="token punctuation">.</span>num <span class="token keyword">AS</span> ConsecutiveNums <span class="token keyword">FROM</span> logs a
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> id<span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">AS</span> id<span class="token punctuation">,</span>num <span class="token keyword">FROM</span> logs<span class="token punctuation">)</span> b <span class="token keyword">ON</span> a<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>id
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> id<span class="token operator">-</span><span class="token number">2</span> <span class="token keyword">AS</span> id<span class="token punctuation">,</span>num <span class="token keyword">FROM</span> logs<span class="token punctuation">)</span> c <span class="token keyword">ON</span> a<span class="token punctuation">.</span>id <span class="token operator">=</span> c<span class="token punctuation">.</span>id
<span class="token keyword">WHERE</span> a<span class="token punctuation">.</span>num <span class="token operator">=</span> b<span class="token punctuation">.</span>num
<span class="token operator">AND</span> a<span class="token punctuation">.</span>num <span class="token operator">=</span> c<span class="token punctuation">.</span>num
</code></pre></div><h3 id="连续登录"><a href="#连续登录" class="header-anchor">#</a> 连续登录</h3> <h4 id="连续登陆7天以上的用户-困难"><a href="#连续登陆7天以上的用户-困难" class="header-anchor">#</a> <a href="https://www.cnblogs.com/ikww/p/12012831.html" target="_blank" rel="noopener noreferrer"><strong>连续登陆7天以上的用户</strong> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（困难）</h4> <blockquote><p>描述</p> <p>表order，表结构如下：（分别是用户id和登录时间）</p> <table><thead><tr><th>user_id</th> <th>date</th></tr></thead> <tbody><tr><td>int</td> <td>datetime</td></tr></tbody></table> <p>求连续登录七天的用户ID</p></blockquote> <p>思路：</p> <ol><li>按用户及日期去重</li> <li>按用户为分区，以时间排序</li> <li>将步骤2得到的序号与步骤1的时间相减</li> <li>将步骤三得到的新字段以用户和差值分组并筛选单个分组大于7的用户id</li></ol> <p>SQL实现：</p> <ol><li><p>GROUP BY 分组并 DISTINCT 去重（因为每个用户每天的数据可能有很多）</p> <blockquote><p>-- 子查询（t1）</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">order</span> 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id<span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token keyword">date</span><span class="token punctuation">`</span>
</code></pre></div></blockquote></li> <li><p>PARTITION BY 用户 ORDER BY 时间</p> <blockquote><p>-- 子查询（t2）</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span>ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> user_id<span class="token punctuation">,</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span><span class="token keyword">date</span><span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rs <span class="token keyword">FROM</span> t1
</code></pre></div></blockquote></li> <li><p>相减</p> <p>经过前面两个步骤操作后，对同一个用户，如果是连续登录的，那么他的<code>日期</code>和<code>rs</code>这两个字段应该都是以步长为1的等差数列。所以对连续登录的用户，将这个两个字段相减，会得到多行相同的数值，接下来先进行相减的操作：</p> <blockquote><p>-- 子查询（t3）</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token punctuation">(</span>t2<span class="token punctuation">.</span><span class="token punctuation">`</span><span class="token keyword">date</span><span class="token punctuation">`</span> <span class="token operator">-</span> t2<span class="token punctuation">.</span>rs<span class="token punctuation">)</span> <span class="token keyword">AS</span> d <span class="token keyword">FROM</span> t2
</code></pre></div></blockquote></li> <li><p>分组筛选</p> <blockquote><p>-- 最终步骤</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_id <span class="token keyword">FROM</span> t3
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id<span class="token punctuation">,</span>d
<span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">7</span>
</code></pre></div></blockquote></li></ol> <p>完整SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_id <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token punctuation">(</span>t2<span class="token punctuation">.</span><span class="token punctuation">`</span><span class="token keyword">date</span><span class="token punctuation">`</span> <span class="token operator">-</span> t2<span class="token punctuation">.</span>rs<span class="token punctuation">)</span> <span class="token keyword">AS</span> d <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
		<span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span>ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> user_id<span class="token punctuation">,</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span><span class="token keyword">date</span><span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rs <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
			<span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">order</span> 
			<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id<span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token keyword">date</span><span class="token punctuation">`</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">)</span> t2
<span class="token punctuation">)</span> t3
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id<span class="token punctuation">,</span>d
<span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">7</span>
</code></pre></div><h2 id="比例"><a href="#比例" class="header-anchor">#</a> 比例</h2> <h4 id="sql65-异常的邮件概率-较难"><a href="#sql65-异常的邮件概率-较难" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/d6dd656483b545159d3aa89b4c26004e?tpId=82&amp;&amp;tqId=35083&amp;rp=1&amp;ru=/activity/oj&amp;qru=/ta/sql/question-ranking" target="_blank" rel="noopener noreferrer"><strong>SQL65</strong> <strong>异常的邮件概率</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（较难）</h4> <p>（题目很长，你忍一下）简单来说就统计每天正常用户对正常用户发送邮件失败的比例</p> <blockquote><p>描述</p> <p>现在有一个需求，让你统计正常用户发送给正常用户邮件失败的概率:
有一个邮件(email)表，id为主键， type是枚举类型，枚举成员为(completed，no_completed)，completed代表邮件发送是成功的，no_completed代表邮件是发送失败的。简况如下:
<img src="https://uploadfiles.nowcoder.com/images/20200817/557336_1597652115615_43081841018939871F6352EF230E6D8E" alt="img"></p> <p>第1行表示为id为2的用户在2020-01-11成功发送了一封邮件给了id为3的用户;
...
第3行表示为id为1的用户在2020-01-11<strong>没有成功</strong>发送一封邮件给了id为4的用户;
...
第6行表示为id为4的用户在2020-01-12成功发送了一封邮件给了id为1的用户;</p> <p>下面是一个用户(user)表，id为主键，is_blacklist为0代表为正常用户，is_blacklist为1代表为黑名单用户，简况如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20200817/557336_1597652932880_7440E658C1F32DF28A6F4360EAB2D9BB" alt="img"></p> <p>第1行表示id为1的是正常用户;
第2行表示id为2的不是正常用户，是黑名单用户，如果发送大量邮件或者出现各种情况就会容易发送邮件失败的用户
。。。
第4行表示id为4的是正常用户</p> <p>现在让你写一个sql查询，每一个日期里面，正常用户发送给正常用户邮件失败的概率是多少，结果保留到小数点后面3位(3位之后的四舍五入)，并且按照日期升序排序，上面例子查询结果如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20200817/557336_1597652145337_6DF0297941EF626E9F6560F28F60E2C7" alt="img"></p> <p>结果表示:</p> <p>2020-01-11失败的概率为0.500，因为email的第1条数据，发送的用户id为2是黑名单用户，所以不计入统计，正常用户发正常用户总共2次，但是失败了1次，所以概率是0.500;</p> <p>2020-01-12没有失败的情况，所以概率为0.000.
(注意: sqlite 1/2得到的不是0.5，得到的是0，只有1*1.0/2才会得到0.5，sqlite四舍五入的函数为round)</p></blockquote> <p>因为题目要求的是每天的比例，所以显然需要用到<code>GROUP BY</code>函数对日期(date)进行分组，但是题目有一个<strong>正常用户对正常用户</strong>，因而我们先取出正常用户这部分。</p> <p>通过<code>SELECT id FROM user WHERE is_blacklist = 0</code>筛选出正常用户id，那么还是用<code>WHERE 字段名 IN</code>的方法来实现筛选出 id正常的发送用户和 id正常的接受用户，两个条件用<code>AND</code>连接，写成</p> <blockquote><p>--  子查询（筛选出用户 id是正常的数据）</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> email 
<span class="token keyword">WHERE</span> send_id <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> <span class="token keyword">user</span>
    <span class="token keyword">WHERE</span> is_blacklist <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">)</span>
<span class="token operator">AND</span> receive_id <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> <span class="token keyword">user</span>
    <span class="token keyword">WHERE</span> is_blacklist <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">)</span>
</code></pre></div></blockquote> <p>为了方便描述，我们将上面这个子查询得到的表给个别名a，在表a里所有的用户id都是正常id了。那么接下来只需要统计type字段中no_completed占的比例即可，那么在使用表a的情况下，统计no_completed占用比例可以这样写：</p> <p><code>SUM(IF(type = 'no_completed',1,0))/COUNT(*)</code></p> <p>上面里层的<code>IF()</code>语句中，如果type 等于'no_completed'则返回数值1，否则返回数值0</p> <p>外层嵌套一个<code>SUM()/COUNT(*)</code>就可以实现统计发送失败的比例了（因为发送失败返回了1，所以用<code>SUM( )</code> ）</p> <p>因为题目要求保留三位小数，所以外层还得套一个<code>ROUND(value,3)</code>函数，即：</p> <p><code>ROUND(SUM(IF(type = 'no_completed',1,0))/COUNT(*),3)</code></p> <p>那么，SQL逻辑为</p> <blockquote><p>-- SQL查询逻辑</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">date</span><span class="token punctuation">,</span><span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">'no_completed'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span>  a
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
</code></pre></div></blockquote> <p>这里表a是用户id全为正常的一个子表，把这个子表的SQL语句拼接上去就完成了，完整SQL语句如下：</p> <p>（注意，子表即子查询结果需要命名否则会报错，下面将子表命名为a）</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">`</span><span class="token keyword">date</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">'no_completed'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span>

    <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> email 
    <span class="token keyword">WHERE</span> send_id <span class="token operator">IN</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> <span class="token punctuation">`</span><span class="token keyword">user</span><span class="token punctuation">`</span>
        <span class="token keyword">WHERE</span> is_blacklist <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">)</span>
    <span class="token operator">AND</span> receive_id <span class="token operator">IN</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> <span class="token punctuation">`</span><span class="token keyword">user</span><span class="token punctuation">`</span>
        <span class="token keyword">WHERE</span> is_blacklist <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span> a
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
</code></pre></div><blockquote><p>拓展</p> <p>在表名或字段名两边加上<kbd>`</kbd> 是用来防止占用特殊字符串</p> <p>例如 <code>date</code>就防止date字段跟date函数冲突（加上了就明确表示date是字段而不是函数也不是特殊符号）</p></blockquote> <h4 id="_262-行程和用户-困难"><a href="#_262-行程和用户-困难" class="header-anchor">#</a> <a href="https://leetcode-cn.com/problems/trips-and-users/" target="_blank" rel="noopener noreferrer"><strong>262. 行程和用户</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（困难）</h4> <blockquote><p>SQL架构</p> <p>表：<code>Trips</code></p> <div class="language- extra-class"><pre class="language-text"><code>+-------------+----------+
| Column Name | Type     |
+-------------+----------+
| Id          | int      |
| Client_Id   | int      |
| Driver_Id   | int      |
| City_Id     | int      |
| Status      | enum     |
| Request_at  | date     |     
+-------------+----------+
Id 是这张表的主键。
这张表中存所有出租车的行程信息。每段行程有唯一 Id ，其中 Client_Id 和 Driver_Id 是 Users 表中 Users_Id 的外键。
Status 是一个表示行程状态的枚举类型，枚举成员为(‘completed’, ‘cancelled_by_driver’, ‘cancelled_by_client’) 。
</code></pre></div><p>表：<code>Users</code></p> <div class="language- extra-class"><pre class="language-text"><code>+-------------+----------+
| Column Name | Type     |
+-------------+----------+
| Users_Id    | int      |
| Banned      | enum     |
| Role        | enum     |
+-------------+----------+
Users_Id 是这张表的主键。
这张表中存所有用户，每个用户都有一个唯一的 Users_Id ，Role 是一个表示用户身份的枚举类型，枚举成员为 (‘client’, ‘driver’, ‘partner’) 。
Banned 是一个表示用户是否被禁止的枚举类型，枚举成员为 (‘Yes’, ‘No’) 。
</code></pre></div><p>写一段 SQL 语句查出 <code>&quot;2013-10-01&quot;</code> 至 <code>&quot;2013-10-03&quot;</code> 期间非禁止用户（<strong>乘客和司机都必须未被禁止</strong>）的取消率。非禁止用户即 Banned 为 No 的用户，禁止用户即 Banned 为 Yes 的用户。</p> <p><strong>取消率</strong> 的计算方式如下：(被司机或乘客取消的非禁止用户生成的订单数量) / (非禁止用户生成的订单总数)。</p> <p>返回结果表中的数据可以按任意顺序组织。其中取消率 <code>Cancellation Rate</code> 需要四舍五入保留 <strong>两位小数</strong> 。</p> <p>查询结果格式如下例所示：</p> <div class="language-sql extra-class"><pre class="language-sql"><code>Trips 表：
<span class="token operator">+</span><span class="token comment">----+-----------+-----------+---------+---------------------+------------+</span>
<span class="token operator">|</span> Id <span class="token operator">|</span> Client_Id <span class="token operator">|</span> Driver_Id <span class="token operator">|</span> City_Id <span class="token operator">|</span> <span class="token keyword">Status</span>              <span class="token operator">|</span> Request_at <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-----------+-----------+---------+---------------------+------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">10</span>        <span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span> completed           <span class="token operator">|</span> <span class="token number">2013</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">11</span>        <span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span> cancelled_by_driver <span class="token operator">|</span> <span class="token number">2013</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>  <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">12</span>        <span class="token operator">|</span> <span class="token number">6</span>       <span class="token operator">|</span> completed           <span class="token operator">|</span> <span class="token number">2013</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>  <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span> <span class="token number">13</span>        <span class="token operator">|</span> <span class="token number">6</span>       <span class="token operator">|</span> cancelled_by_client <span class="token operator">|</span> <span class="token number">2013</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>  <span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">10</span>        <span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span> completed           <span class="token operator">|</span> <span class="token number">2013</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>  <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">11</span>        <span class="token operator">|</span> <span class="token number">6</span>       <span class="token operator">|</span> completed           <span class="token operator">|</span> <span class="token number">2013</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">12</span>        <span class="token operator">|</span> <span class="token number">6</span>       <span class="token operator">|</span> completed           <span class="token operator">|</span> <span class="token number">2013</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">8</span>  <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">12</span>        <span class="token operator">|</span> <span class="token number">12</span>      <span class="token operator">|</span> completed           <span class="token operator">|</span> <span class="token number">2013</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">03</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">9</span>  <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">10</span>        <span class="token operator">|</span> <span class="token number">12</span>      <span class="token operator">|</span> completed           <span class="token operator">|</span> <span class="token number">2013</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">03</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">10</span> <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span> <span class="token number">13</span>        <span class="token operator">|</span> <span class="token number">12</span>      <span class="token operator">|</span> cancelled_by_driver <span class="token operator">|</span> <span class="token number">2013</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">03</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-----------+-----------+---------+---------------------+------------+</span>

Users 表：
<span class="token operator">+</span><span class="token comment">----------+--------+--------+</span>
<span class="token operator">|</span> Users_Id <span class="token operator">|</span> Banned <span class="token operator">|</span> Role   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+--------+--------+</span>
<span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token keyword">No</span>     <span class="token operator">|</span> client <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> Yes    <span class="token operator">|</span> client <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>        <span class="token operator">|</span> <span class="token keyword">No</span>     <span class="token operator">|</span> client <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>        <span class="token operator">|</span> <span class="token keyword">No</span>     <span class="token operator">|</span> client <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">10</span>       <span class="token operator">|</span> <span class="token keyword">No</span>     <span class="token operator">|</span> driver <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">11</span>       <span class="token operator">|</span> <span class="token keyword">No</span>     <span class="token operator">|</span> driver <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">12</span>       <span class="token operator">|</span> <span class="token keyword">No</span>     <span class="token operator">|</span> driver <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">13</span>       <span class="token operator">|</span> <span class="token keyword">No</span>     <span class="token operator">|</span> driver <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+--------+--------+</span>

Result 表：
<span class="token operator">+</span><span class="token comment">------------+-------------------+</span>
<span class="token operator">|</span> <span class="token keyword">Day</span>        <span class="token operator">|</span> Cancellation Rate <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-------------------+</span>
<span class="token operator">|</span> <span class="token number">2013</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">0.33</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2013</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">0.00</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2013</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">03</span> <span class="token operator">|</span> <span class="token number">0.50</span>              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-------------------+</span>

<span class="token number">2013</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span>：
  <span class="token operator">-</span> 共有 <span class="token number">4</span> 条请求，其中 <span class="token number">2</span> 条取消。
  <span class="token operator">-</span> 然而，Id<span class="token operator">=</span><span class="token number">2</span> 的请求是由禁止用户（User_Id<span class="token operator">=</span><span class="token number">2</span>）发出的，所以计算时应当忽略它。
  <span class="token operator">-</span> 因此，总共有 <span class="token number">3</span> 条非禁止请求参与计算，其中 <span class="token number">1</span> 条取消。
  <span class="token operator">-</span> 取消率为 <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.33</span>
<span class="token number">2013</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">02</span>：
  <span class="token operator">-</span> 共有 <span class="token number">3</span> 条请求，其中 <span class="token number">0</span> 条取消。
  <span class="token operator">-</span> 然而，Id<span class="token operator">=</span><span class="token number">6</span> 的请求是由禁止用户发出的，所以计算时应当忽略它。
  <span class="token operator">-</span> 因此，总共有 <span class="token number">2</span> 条非禁止请求参与计算，其中 <span class="token number">0</span> 条取消。
  <span class="token operator">-</span> 取消率为 <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.00</span>
<span class="token number">2013</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">03</span>：
  <span class="token operator">-</span> 共有 <span class="token number">3</span> 条请求，其中 <span class="token number">1</span> 条取消。
  <span class="token operator">-</span> 然而，Id<span class="token operator">=</span><span class="token number">8</span> 的请求是由禁止用户发出的，所以计算时应当忽略它。
  <span class="token operator">-</span> 因此，总共有 <span class="token number">2</span> 条非禁止请求参与计算，其中 <span class="token number">1</span> 条取消。
  <span class="token operator">-</span> 取消率为 <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.50</span>
</code></pre></div></blockquote> <p>简单来说就是去除掉禁止用户后，看取消率</p> <p>那么，思路是先去除禁止用户，然后进行表连接并将取消操作转换为数值，最后求出比例即可</p> <ol><li><p>去除禁止用户</p> <blockquote><p>-- 子查询（子表t1）</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> Trips
<span class="token keyword">WHERE</span> Client_Id <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> Users_Id <span class="token keyword">FROM</span> Users
	<span class="token keyword">WHERE</span> Banned <span class="token operator">=</span> <span class="token string">'Yes'</span>
<span class="token punctuation">)</span>
<span class="token operator">AND</span> Driver_Id <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> Users_Id <span class="token keyword">FROM</span> Users
	<span class="token keyword">WHERE</span> Banned <span class="token operator">=</span> <span class="token string">'Yes'</span>
<span class="token punctuation">)</span>
</code></pre></div></blockquote> <p>经过上述操作后，得到的数据是Trips表去除用户后的数据</p> <p>上述子查询操作得到的结果给个表别名 t1，为了方便阅读，之后把子查询简单得用t1表示（如果想要SQL运行得补充完整）</p></li> <li><p>将取消操作转换为数值</p> <blockquote><p>-- 取消操作转换为数值（子表t2）</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span>  Request_at<span class="token punctuation">,</span>
		<span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token keyword">Status</span> <span class="token operator">=</span> <span class="token string">'cancelled_by_client'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> status1<span class="token punctuation">,</span> 
		<span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token keyword">Status</span> <span class="token operator">=</span> <span class="token string">'cancelled_by_driver'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> status2
<span class="token keyword">FROM</span> t1
<span class="token keyword">WHERE</span> request_at <span class="token operator">BETWEEN</span> <span class="token string">'2013-10-01'</span> <span class="token operator">AND</span> <span class="token string">'2013-10-03'</span>
</code></pre></div></blockquote> <p>这里把<strong>被用户取消</strong>和<strong>被司机取消</strong>的操作都转换为数值1，其他的换成0</p> <p>WHERE条件放在外层也行，但是放在内层先过滤掉则速度会更快</p></li> <li><p>计算比例</p> <p>因为取消操作都换成1了，即每一条数据如果有取消操作，则在 status1 和 status2 这两个字段中有且只有一个1</p> <p>那么相加再除以总行数即可</p> <blockquote><p>-- 查询逻辑</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> 
	t2<span class="token punctuation">.</span>Request_at<span class="token punctuation">,</span>
	<span class="token function">ROUND</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token function">SUM</span><span class="token punctuation">(</span>t2<span class="token punctuation">.</span>status1<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">SUM</span><span class="token punctuation">(</span>t2<span class="token punctuation">.</span>status2<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">FROM</span> t2
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> Request_at
</code></pre></div></blockquote></li></ol> <p>完整SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> t2<span class="token punctuation">.</span>Request_at <span class="token keyword">AS</span> <span class="token keyword">Day</span><span class="token punctuation">,</span><span class="token function">ROUND</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token function">SUM</span><span class="token punctuation">(</span>t2<span class="token punctuation">.</span>status1<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">SUM</span><span class="token punctuation">(</span>t2<span class="token punctuation">.</span>status2<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>Cancellation Rate<span class="token punctuation">`</span>
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span>  Request_at<span class="token punctuation">,</span>
            <span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token keyword">Status</span> <span class="token operator">=</span> <span class="token string">'cancelled_by_client'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> status1<span class="token punctuation">,</span> 
            <span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token keyword">Status</span> <span class="token operator">=</span> <span class="token string">'cancelled_by_driver'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> status2
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> Trips
        <span class="token keyword">WHERE</span> Client_Id <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
            <span class="token keyword">SELECT</span> Users_Id <span class="token keyword">FROM</span> Users
            <span class="token keyword">WHERE</span> Banned <span class="token operator">=</span> <span class="token string">'Yes'</span>
        <span class="token punctuation">)</span>
        <span class="token operator">AND</span> Driver_Id <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
            <span class="token keyword">SELECT</span> Users_Id <span class="token keyword">FROM</span> Users
            <span class="token keyword">WHERE</span> Banned <span class="token operator">=</span> <span class="token string">'Yes'</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span> t1
    <span class="token keyword">WHERE</span> request_at <span class="token operator">BETWEEN</span> <span class="token string">'2013-10-01'</span> <span class="token operator">AND</span> <span class="token string">'2013-10-03'</span>
<span class="token punctuation">)</span> t2
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> Request_at
</code></pre></div><h2 id="日期"><a href="#日期" class="header-anchor">#</a> 日期</h2> <h4 id="sql66-牛客每个人最近的登录日期-一-简单"><a href="#sql66-牛客每个人最近的登录日期-一-简单" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/ca274ebe6eac40ab9c33ced3f2223bb2?tpId=82&amp;&amp;tqId=35084&amp;rp=1&amp;ru=/activity/oj&amp;qru=/ta/sql/question-ranking" target="_blank" rel="noopener noreferrer"><strong>SQL66</strong> <strong>牛客每个人最近的登录日期(一)</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（简单）</h4> <blockquote><p>描述</p> <p>牛客每天有很多人登录，请你统计一下牛客每个用户最近登录是哪一天。</p> <p>有一个登录(login)记录表，简况如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20200817/557336_1597652540640_64D4B3DE58C69D6263B209D2B1AB6393" alt="img"></p> <p>第1行表示user_id为2的用户在2020-10-12使用了客户端id为1的设备登录了牛客网
。。。
第4行表示user_id为3的用户在2020-10-13使用了客户端id为2的设备登录了牛客网</p> <p>请你写出一个sql语句查询每个用户最近一天登录的日子，并且按照user_id升序排序，上面的例子查询结果如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20201026/557336_1603700593855_F4BBCB1D5E81A508C2A06167DCF2F5ED" alt="img"></p> <p>查询结果表明:
user_id为2的最近的登录日期在2020-10-13
user_id为3的最近的登录日期也是2020-10-13</p></blockquote> <p>思路：因为是按用户分的，显然是<code>GROUP BY user_id</code>。在SQL中，可以用<code>MAX()</code>函数来取距离现在最近的时间（反之，用<code>MIN()</code>函数则可以取到最早之前的时间）。该题SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token function">MAX</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> login
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> user_id
</code></pre></div><h4 id="sql67-牛客每个人最近的登录日期-二-较难"><a href="#sql67-牛客每个人最近的登录日期-二-较难" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/7cc3c814329546e89e71bb45c805c9ad?tpId=82&amp;tags=&amp;title=&amp;difficulty=0&amp;judgeStatus=0&amp;rp=1" target="_blank" rel="noopener noreferrer"><strong>SQL67</strong> <strong>牛客每个人最近的登录日期(二)</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（较难）</h4> <blockquote><p>描述</p> <p>牛客每天有很多人登录，请你统计一下牛客每个用户最近登录是哪一天，用的是什么设备.</p> <p>有一个登录(login)记录表，简况如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210106/557336_1609907092884/B7BB8B84A2534ED56DAB6420C6D02C42" alt="img"></p> <p>第1行表示user_id为2的用户在2020-10-12使用了客户端id为1的设备登录了牛客网
。。。
第4行表示user_id为3的用户在2020-10-13使用了客户端id为2的设备登录了牛客网</p> <p>还有一个用户(user)表，简况如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20200817/557336_1597652611050_C098FF7CF52D3DC2ECE5019F4E7A5E88" alt="img"></p> <p>还有一个客户端(client)表，简况如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20200817/557336_1597652618264_F2C14AA3F53E74C2FE5A266283E56241" alt="img"></p> <p>请你写出一个sql语句查询每个用户最近一天登录的日子，用户的名字，以及用户用的设备的名字，并且查询结果按照user的name升序排序，上面的例子查询结果如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210106/557336_1609907127708/7B7FC5B3933D957E9FD6C914ACE1D91A" alt="img"></p> <p>查询结果表明:
fh最近的登录日期在2020-10-13，而且是使用ios登录的
wangchao最近的登录日期也是2020-10-13，而且是使用ios登录的</p></blockquote> <p>就这，还较难？跟上一题不是很像嘛？就加一个表连接把字段换一下不就完事？</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">user</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> client<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token function">MAX</span><span class="token punctuation">(</span>login<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">)</span>
<span class="token keyword">FROM</span> login
<span class="token keyword">JOIN</span> <span class="token keyword">user</span> <span class="token keyword">ON</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id <span class="token operator">=</span> login<span class="token punctuation">.</span>user_id
<span class="token keyword">JOIN</span> client <span class="token keyword">ON</span> client<span class="token punctuation">.</span>id <span class="token operator">=</span> login<span class="token punctuation">.</span>client_id
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">user</span><span class="token punctuation">.</span>name
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">user</span><span class="token punctuation">.</span>name
</code></pre></div><p>我啪地一下，很快呀↑它就给我报答案错误了。。。</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210808180239.png" alt=""></p> <blockquote><p><strong>考点：group by 子句常见错误：</strong> <strong>select 子句中只能存在以下三种元素：常数、聚合函数、group by子句指定列(聚合键)</strong></p></blockquote> <p>也就是用了<code>GROUP BY</code>，那么选择的字段里就只能有这三种类型：</p> <ol><li>常数字段</li> <li>聚合函数作用的字段</li> <li>group by子句指定列(聚合键)</li></ol> <p>看看上面有user.name, client.name, MAX(login.date)这三个字段，其中user.name是聚合键，MAX(login.date)使用了聚合函数，都没问题。而client.name既不是常数也没有聚合函数，更不是聚合键，所以不能带上这个字段。</p> <p>看正确解法思路：既然没办法GROUP BY 后SELECT这么多字段，而且用户id和时间还是准确的（看上图运行结果，只是不符合GROUP BY后SELECT的字段才错误，也就是只有客户端是错误的），所以我们先拿到准去的 用户id 和 时间date</p> <blockquote><p>-- 子查询</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span> <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> login <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
</code></pre></div></blockquote> <p>然后将三个表连接</p> <blockquote><p>-- 三个表连接</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">user</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>client<span class="token punctuation">.</span>name<span class="token punctuation">,</span>login<span class="token punctuation">.</span><span class="token keyword">date</span>
<span class="token keyword">FROM</span> login
<span class="token keyword">JOIN</span> <span class="token keyword">user</span> <span class="token keyword">ON</span> login<span class="token punctuation">.</span>user_id <span class="token operator">=</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id
<span class="token keyword">JOIN</span> client <span class="token keyword">ON</span> login<span class="token punctuation">.</span>client_id <span class="token operator">=</span> client<span class="token punctuation">.</span>id
</code></pre></div></blockquote> <p>三个表连接后考虑用WHERE来过滤得到符合条件的结果，要筛选出最近登录，只需要用<code>WHERE 字段名 IN</code>即可实现</p> <p>因为这里是需要用户id和时间date两个字段来判断，所以写出来是<code>WHERE (user_id,date) IN ( 子查询 )</code></p> <p>（注意：因为WHERE IN 后面的不是一个子表，所以不需要也不可以给这里子查询加上表别名）</p> <p>完整的SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">user</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>client<span class="token punctuation">.</span>name<span class="token punctuation">,</span>login<span class="token punctuation">.</span><span class="token keyword">date</span>
<span class="token keyword">FROM</span> login
<span class="token keyword">JOIN</span> <span class="token keyword">user</span> <span class="token keyword">ON</span> login<span class="token punctuation">.</span>user_id <span class="token operator">=</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id
<span class="token keyword">JOIN</span> client <span class="token keyword">ON</span> login<span class="token punctuation">.</span>client_id <span class="token operator">=</span> client<span class="token punctuation">.</span>id
<span class="token keyword">WHERE</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span> <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> login
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
    <span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">user</span><span class="token punctuation">.</span>name
</code></pre></div><h4 id="sql68-牛客每个人最近的登录日期-三-较难"><a href="#sql68-牛客每个人最近的登录日期-三-较难" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/16d41af206cd4066a06a3a0aa585ad3d?tpId=82&amp;tags=&amp;title=&amp;difficulty=0&amp;judgeStatus=0&amp;rp=1" target="_blank" rel="noopener noreferrer"><strong>SQL68</strong> <strong>牛客每个人最近的登录日期(三)</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（较难）</h4> <blockquote><p>描述</p> <p>牛客每天有很多人登录，请你统计一下牛客新登录用户的次日成功的留存率，
有一个登录(login)记录表，简况如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20201026/557336_1603701796116_54BBC7EED94F0CAAFEC8DB042BBBCD01" alt="img"></p> <p>第1行表示user_id为2的用户在2020-10-12使用了客户端id为1的设备第一次新登录了牛客网
。。。</p> <p>第4行表示user_id为3的用户在2020-10-12使用了客户端id为2的设备登录了牛客网</p> <p>。。。</p> <p>最后1行表示user_id为1的用户在2020-10-14使用了客户端id为2的设备登录了牛客网</p> <p>请你写出一个sql语句查询新登录用户次日成功的留存率，即第1天登陆之后，第2天再次登陆的概率,保存小数点后面3位(3位之后的四舍五入)，上面的例子查询结果如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20200820/557336_1597903513290_CD24AA22EB7078641AEAF29B146D26FD" alt="img"></p> <p>查询结果表明:</p> <p>user_id为1的用户在2020-10-12第一次新登录了，在2020-10-13又登录了，算是成功的留存</p> <p>user_id为2的用户在2020-10-12第一次新登录了，在2020-10-13又登录了，算是成功的留存</p> <p>user_id为3的用户在2020-10-12第一次新登录了，在2020-10-13没登录了，算是失败的留存</p> <p>user_id为4的用户在2020-10-13第一次新登录了，在2020-10-14没登录了，算是失败的留存</p> <p>固次日成功的留存率为 2/4=0.5</p> <p>(sqlite里查找某一天的后一天的用法是:date(yyyy-mm-dd, '+1 day')，四舍五入的函数为round，sqlite 1/2得到的不是0.5，得到的是0，只有1*1.0/2才会得到0.5</p> <p>mysql里查找某一天的后一天的用法是:DATE_ADD(yyyy-mm-dd,INTERVAL 1 DAY)，四舍五入的函数为round)</p></blockquote> <ol><li><p>先取出新用户第二天的登录数据</p> <blockquote><p>-- 所有用户的第二天登录数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token keyword">DATE</span><span class="token punctuation">(</span><span class="token function">MIN</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> login <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
</code></pre></div></blockquote> <p>这里有一个问题，因为如果是字符串类型的时间，例如<code>2020-10-12</code>对其用了<code>MIN( )</code>函数后，会变成<code>20201012</code>，为了的后续操作，我们需要对其套上<code>DATE()</code>函数使其变回<code>2020-10-12</code>这种日期格式。</p></li> <li><p>再用子查询（老套路，还是<code>WHERE 字段名 IN</code>）</p> <blockquote><p>-- WHERE IN大法</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token keyword">FROM</span> login
<span class="token keyword">WHERE</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token keyword">DATE</span><span class="token punctuation">(</span><span class="token function">MIN</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> login 
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
<span class="token punctuation">)</span> 
</code></pre></div></blockquote></li> <li><p>查询用户数</p> <p>接下来获取用户数，需要用<code>DISTINCT</code>（字段前加上这个可以去重）</p> <blockquote><p>-- 用户数</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> user_id<span class="token punctuation">)</span> <span class="token keyword">FROM</span> login
</code></pre></div></blockquote></li> <li><p>相除，并且用<code>ROUND(value,3)</code>保留三位小数</p></li></ol> <p>最终SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span> <span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> user_id<span class="token punctuation">)</span> <span class="token keyword">FROM</span> login<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">FROM</span> login
<span class="token keyword">WHERE</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token keyword">DATE</span><span class="token punctuation">(</span><span class="token function">MIN</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> login 
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
<span class="token punctuation">)</span> 
</code></pre></div><h4 id="sql69-牛客每个人最近的登录日期-四-较难"><a href="#sql69-牛客每个人最近的登录日期-四-较难" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/e524dc7450234395aa21c75303a42b0a?tpId=82&amp;tags=&amp;title=&amp;difficulty=0&amp;judgeStatus=0&amp;rp=1" target="_blank" rel="noopener noreferrer"><strong>SQL69</strong> <strong>牛客每个人最近的登录日期(四)</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（较难）</h4> <blockquote><h2 id="描述-2"><a href="#描述-2" class="header-anchor">#</a> 描述</h2> <p>牛客每天有很多人登录，请你统计一下牛客每个日期登录新用户个数，
有一个登录(login)记录表，简况如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20200820/557336_1597903671918_2C3C4BF94A59FB9AEEA6FEA89DEE17C9" alt="img"></p> <p>第1行表示user_id为2的用户在2020-10-12使用了客户端id为1的设备登录了牛客网，因为是第1次登录，所以是新用户
。。。
第4行表示user_id为2的用户在2020-10-13使用了客户端id为2的设备登录了牛客网，因为是第2次登录，所以是老用户
。。
最后1行表示user_id为4的用户在2020-10-15使用了客户端id为1的设备登录了牛客网，因为是第2次登录，所以是老用户</p> <p>请你写出一个sql语句查询每个日期登录新用户个数，并且查询结果按照日期升序排序，上面的例子查询结果如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20200820/557336_1597903683115_47DE8F52D6F847E788BB9EF6279481C4" alt="img"></p> <p>查询结果表明:
2020-10-12，有3个新用户(user_id为2，3，1)登录
2020-10-13，没有新用户登录
2020-10-14，有1个新用户(user_id为4)登录
2020-10-15，没有新用户登录</p></blockquote> <p>这不比上一道题更简单吗？先筛选出(新用户id,日期date)，然后WHERE IN，再GROUP BY分组COUNT统计行数，我啪地一声很快...</p> <blockquote><p>-- 错误写法</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">date</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> login
<span class="token keyword">WHERE</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token function">MIN</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> login
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
<span class="token punctuation">)</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
</code></pre></div></blockquote> <p>...就错了（这种情况没有得出新用户是0的情况，如图）</p> <p><img src="https://cdn.jsdelivr.net/gh/ChoiNgai/ImageServer/img/20210809015523.png" alt=""></p> <p>不慌，那就在上面这基础上改一下，毕竟天下没有白写的bug</p> <p>这里是因为用WHERE IN过滤了才会导致有些日期没有了，所以要保证都有思路上还是直接FROM 原表并且不做任何过滤。这种没有的情况，与其最近的则是NULL。那么，为了填补日期，我们考虑用表连接来完成（将没有的日期先补成NULL），这种显然可以通过<code>LEFT JOIN</code>或<code>RIGHT JOIN</code>完成。这里将原表写在左边，所以使用<code>LEFT JOIN</code>（LEFT JOIN ：以左表为基准，右表没有的行数返回NULL）</p> <p>为了SQL语句简介，先将上面的错误查询当作表a，并将a表中的COUNT(*)给个别名，这里写出<code>COUNT(*) AS num</code></p> <blockquote><p>-- 表连接（填补缺少的日期）</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> login<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">,</span>a<span class="token punctuation">.</span>num <span class="token keyword">FROM</span> login
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> a 
<span class="token keyword">ON</span> login<span class="token punctuation">.</span><span class="token keyword">date</span> <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token keyword">date</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
</code></pre></div></blockquote> <p>这种情况下，a.num会是NULL值，因而需要将NULL替换成0，使用<code>IFNULL(a.num,0)</code>即可完成，并将a表写入，最后SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> login<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">,</span>IFNULL<span class="token punctuation">(</span>a<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> login
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token keyword">date</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> num <span class="token keyword">FROM</span> login
    <span class="token keyword">WHERE</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token function">MIN</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> login
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
    <span class="token punctuation">)</span>
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
    <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
<span class="token punctuation">)</span> a 
<span class="token keyword">ON</span> login<span class="token punctuation">.</span><span class="token keyword">date</span> <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token keyword">date</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
</code></pre></div><h4 id="sql70-牛客每个人最近的登录日期-五-困难"><a href="#sql70-牛客每个人最近的登录日期-五-困难" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/ea0c56cd700344b590182aad03cc61b8?tpId=82&amp;tags=&amp;title=&amp;difficulty=0&amp;judgeStatus=0&amp;rp=1" target="_blank" rel="noopener noreferrer"><strong>SQL70</strong> <strong>牛客每个人最近的登录日期(五)</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（困难）</h4> <blockquote><p>描述</p> <p>牛客每天有很多人登录，请你统计一下牛客每个日期新用户的次日留存率。
有一个登录(login)记录表，简况如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20200820/557336_1597903752757_A02F3DF1419BC2D3D4EE9B2B4557053B" alt="img"></p> <p>第1行表示user_id为2的用户在2020-10-12使用了客户端id为1的设备登录了牛客网，因为是第1次登录，所以是新用户
。。。
第4行表示user_id为2的用户在2020-10-13使用了客户端id为2的设备登录了牛客网，因为是第2次登录，所以是老用户
。。
最后1行表示user_id为4的用户在2020-10-15使用了客户端id为1的设备登录了牛客网，因为是第2次登录，所以是老用户</p> <p>请你写出一个sql语句查询每个日期新用户的次日留存率，结果保留小数点后面3位数(3位之后的四舍五入)，并且查询结果按照日期升序排序，上面的例子查询结果如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20200820/557336_1597903761838_F734DB69B9941F0DF86776922B0CF347" alt="img"></p> <p>查询结果表明:
2020-10-12登录了3个(user_id为2，3，1)新用户，2020-10-13，只有2个(id为2,1)登录，故2020-10-12新用户次日留存率为2/3=0.667;
2020-10-13没有新用户登录，输出0.000;
2020-10-14登录了1个(user_id为4)新用户，2020-10-15，user_id为4的用户登录，故2020-10-14新用户次日留存率为1/1=1.000;</p> <p>2020-10-15没有新用户登录，输出0.000;</p> <p>(注意:sqlite里查找某一天的后一天的用法是:date(yyyy-mm-dd, '+1 day')，sqlite里1/2得到的不是0.5，得到的是0，只有1*1.0/2才会得到0.5)</p></blockquote> <p>如果前面日期的题都掌握了，其实这道题很容易。老套路，SQL语句从里到外看，无限套娃。</p> <ol><li><p>首先是计算每天的次日用户数</p> <blockquote><p>-- 子查询（次日留存用户数）</p> <div class="language-sql extra-class"><pre class="language-sql"><code>        <span class="token keyword">SELECT</span> <span class="token keyword">DATE</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">date</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> num <span class="token keyword">FROM</span> login
        <span class="token keyword">WHERE</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
            <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token keyword">DATE</span><span class="token punctuation">(</span><span class="token function">MIN</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> login
            <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
        <span class="token punctuation">)</span>
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
        <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
</code></pre></div></blockquote> <p>这里<code>MIN(date)+1</code>来作为留存筛选条件，然后在SELECT处将日期减回去</p></li> <li><p>每天的注册用户数</p> <blockquote><p>-- 子查询（注册用户数）</p> <div class="language-sql extra-class"><pre class="language-sql"><code>    <span class="token keyword">SELECT</span> a<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">,</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>num<span class="token operator">/</span>a<span class="token punctuation">.</span>num<span class="token punctuation">)</span> <span class="token keyword">AS</span> p <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> <span class="token keyword">date</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> num <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
            <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token keyword">DATE</span><span class="token punctuation">(</span><span class="token function">MIN</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">date</span> <span class="token keyword">FROM</span> login
                <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
        <span class="token punctuation">)</span> eee
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
</code></pre></div></blockquote></li> <li><p>将子查询（次日留存用户数）与子查询（注册用户数）连接相处，得到结果</p> <blockquote><p>-- 子查询（ 得到每天的留存率）</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> a<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">,</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>num<span class="token operator">/</span>a<span class="token punctuation">.</span>num<span class="token punctuation">)</span> <span class="token keyword">AS</span> p <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> <span class="token keyword">date</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> num <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
            <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token keyword">DATE</span><span class="token punctuation">(</span><span class="token function">MIN</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">date</span> <span class="token keyword">FROM</span> login
                <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
        <span class="token punctuation">)</span> eee
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
    <span class="token punctuation">)</span> a
    <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> <span class="token keyword">DATE</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">date</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> num <span class="token keyword">FROM</span> login
        <span class="token keyword">WHERE</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
            <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token keyword">DATE</span><span class="token punctuation">(</span><span class="token function">MIN</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> login
            <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
        <span class="token punctuation">)</span>
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
        <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
    <span class="token punctuation">)</span> b
    <span class="token keyword">ON</span> a<span class="token punctuation">.</span><span class="token keyword">date</span> <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token keyword">date</span>
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> a<span class="token punctuation">.</span><span class="token keyword">date</span>
    <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a<span class="token punctuation">.</span><span class="token keyword">date</span>
</code></pre></div></blockquote> <p>到这一步已经得到结果了，但是仍然出现了<strong>SQL69</strong> **牛客每个人最近的登录日期(四)**里最开始的那种情况：留存率为0的日期没有显示出来。</p></li> <li><p>再套娃</p> <p>再以原表作为基表，LEFT JOIN 操作一次</p></li></ol> <p>最终SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> login<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">,</span><span class="token function">ROUND</span><span class="token punctuation">(</span>IFNULL<span class="token punctuation">(</span>c<span class="token punctuation">.</span>p<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> p <span class="token keyword">FROM</span> login
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> a<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">,</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>num<span class="token operator">/</span>a<span class="token punctuation">.</span>num<span class="token punctuation">)</span> <span class="token keyword">AS</span> p <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> <span class="token keyword">date</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> num <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
            <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token keyword">DATE</span><span class="token punctuation">(</span><span class="token function">MIN</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">date</span> <span class="token keyword">FROM</span> login
                <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
        <span class="token punctuation">)</span> eee
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
    <span class="token punctuation">)</span> a
    <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> <span class="token keyword">DATE</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">date</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> num <span class="token keyword">FROM</span> login
        <span class="token keyword">WHERE</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
            <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token keyword">DATE</span><span class="token punctuation">(</span><span class="token function">MIN</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> login
            <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
        <span class="token punctuation">)</span>
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
        <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">date</span>
    <span class="token punctuation">)</span> b
    <span class="token keyword">ON</span> a<span class="token punctuation">.</span><span class="token keyword">date</span> <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token keyword">date</span>
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> a<span class="token punctuation">.</span><span class="token keyword">date</span>
    <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a<span class="token punctuation">.</span><span class="token keyword">date</span>
<span class="token punctuation">)</span> c
<span class="token keyword">ON</span> login<span class="token punctuation">.</span><span class="token keyword">date</span> <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token keyword">date</span>
</code></pre></div><h4 id="sql80-牛客的课程订单分析-四-较难"><a href="#sql80-牛客的课程订单分析-四-较难" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/c93d2079282f4943a3771ca6fd081c23?tpId=82&amp;tags=&amp;title=&amp;difficulty=0&amp;judgeStatus=0&amp;rp=1" target="_blank" rel="noopener noreferrer"><strong>SQL80</strong> <strong>牛客的课程订单分析(四)</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（较难）</h4> <blockquote><p>描述</p> <p>有很多同学在牛客购买课程来学习，购买会产生订单存到数据库里。</p> <p>有一个订单信息表(order_info)，简况如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210226/310548_1614310851199/05757BC2D70D6C85A451733582C84202" alt="img"></p> <p>第1行表示user_id为557336的用户在2025-10-10的时候使用了client_id为1的客户端下了C++课程的订单，但是状态为没有购买成功。</p> <p>第2行表示user_id为230173543的用户在2025-10-12的时候使用了client_id为2的客户端下了Python课程的订单，状态为购买成功。</p> <p>。。。</p> <p>最后1行表示user_id为557336的用户在2025-10-25的时候使用了client_id为1的客户端下了Python课程的订单，状态为购买成功。</p> <p>请你写出一个sql语句查询在2025-10-15以后，如果有一个用户下单2个以及2个以上状态为购买成功的C++课程或Java课程或Python课程，那么输出这个用户的user_id，以及满足前面条件的第一次购买成功的C++课程或Java课程或Python课程的日期first_buy_date，以及购买成功的C++课程或Java课程或Python课程的次数cnt，并且输出结果按照user_id升序排序，以上例子查询结果如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210226/310548_1614310860082/0CDA2587932AE43AF2BB6299FA683419" alt="img"></p> <p>解析:</p> <p>id为4，6的订单满足以上条件，输出57，id为4的订单为第一次购买成功，输出first_buy_date为2025-10-23，总共成功购买了2次;</p> <p>id为5，7，8的订单满足以上条件，输出557336，id为5的订单为第一次购买成功，输出first_buy_date为2025-10-23，总共成功购买了3次;</p></blockquote> <p>因为是分用户，所以还是需要<code>GROUP BY</code>操作，SELECE后面的字段可以有MIN(date),COUNT(*) ，这样SELECT之后的字段就没有出现（group by指定列，聚合函数，常熟）以外的字段了</p> <blockquote><p>-- 逻辑框架</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token function">MIN</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt <span class="token keyword">FROM</span> order_info
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
</code></pre></div></blockquote> <p>之后补充题目要求条件，完整SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token function">MIN</span><span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt <span class="token keyword">FROM</span> order_info
<span class="token keyword">WHERE</span> <span class="token keyword">status</span> <span class="token operator">=</span><span class="token string">'completed'</span>
<span class="token operator">AND</span> product_name <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'C++'</span><span class="token punctuation">,</span><span class="token string">'Java'</span><span class="token punctuation">,</span><span class="token string">'Python'</span><span class="token punctuation">)</span>
<span class="token operator">AND</span> <span class="token keyword">date</span> <span class="token operator">&gt;</span> <span class="token string">'2025-10-15'</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
<span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">2</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> user_id
</code></pre></div><h4 id="sql81-牛客的课程订单分析-五-困难"><a href="#sql81-牛客的课程订单分析-五-困难" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/348afda488554ceb922efd2f3effc427?tpId=82&amp;tags=&amp;title=&amp;difficulty=0&amp;judgeStatus=0&amp;rp=1" target="_blank" rel="noopener noreferrer"><strong>SQL81</strong> <strong>牛客的课程订单分析(五)</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（困难）</h4> <blockquote><p>描述</p> <p>有很多同学在牛客购买课程来学习，购买会产生订单存到数据库里。</p> <p>有一个订单信息表(order_info)，简况如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210226/310548_1614320881447/390E1A747B9D2D6DF976278C6AE5D0DB" alt="img"></p> <p>第1行表示user_id为557336的用户在2025-10-10的时候使用了client_id为1的客户端下了C++课程的订单，但是状态为没有购买成功。</p> <p>第2行表示user_id为230173543的用户在2025-10-12的时候使用了client_id为2的客户端下了Python课程的订单，状态为购买成功。</p> <p>。。。</p> <p>最后1行表示user_id为557336的用户在2025-10-26的时候使用了client_id为1的客户端下了Python课程的订单，状态为购买成功。</p> <p>请你写出一个sql语句查询在2025-10-15以后，如果有一个用户下单2个以及2个以上状态为购买成功的C++课程或Java课程或Python课程，那么输出这个用户的user_id，以及满足前面条件的第一次购买成功的C++课程或Java课程或Python课程的日期first_buy_date，以及满足前面条件的第二次购买成功的C++课程或Java课程或Python课程的日期second_buy_date，以及购买成功的C++课程或Java课程或Python课程的次数cnt，并且输出结果按照user_id升序排序，以上例子查询结果如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210226/310548_1614320891682/E781EA8A3E13F91AD1409831A1854DE3" alt="img"></p> <p>解析:</p> <p>id为4，6的订单满足以上条件，输出57，id为4的订单为第一次购买成功，输出first_buy_date为2025-10-23，id为6的订单为第二次购买，输出second_buy_date为2025-10-24，总共成功购买了2次;</p> <p>id为5，7，8的订单满足以上条件，输出557336，id为5的订单为第一次购买成功，输出first_buy_date为2025-10-23，id为7的订单为第二次购买，输出second_buy_date为2025-10-25，总共成功购买了3次;</p></blockquote> <ol><li><p>先取出(user_id,second_buy_date)作为一个子表</p> <blockquote><p>-- 子查询（第二次下单时间）</p> <div class="language-sql extra-class"><pre class="language-sql"><code>    <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token keyword">date</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">,</span>ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> user_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rs <span class="token keyword">FROM</span> order_info
    <span class="token keyword">WHERE</span> <span class="token keyword">status</span> <span class="token operator">=</span> <span class="token string">'completed'</span>
    <span class="token operator">AND</span> product_name <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'C++'</span><span class="token punctuation">,</span><span class="token string">'Java'</span><span class="token punctuation">,</span><span class="token string">'Python'</span><span class="token punctuation">)</span>
    <span class="token operator">AND</span> <span class="token keyword">date</span> <span class="token operator">&gt;</span> <span class="token string">'2025-10-15'</span>
    <span class="token punctuation">)</span> a
    <span class="token keyword">WHERE</span> rs <span class="token operator">=</span> <span class="token number">2</span>  <span class="token comment">--第二次下单</span>
    <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> user_id
</code></pre></div></blockquote></li> <li><p>表连接</p> <p>将上面的子查询得到的结果给个表别名b，为了简单描述下面我用b来代替上面的子查询</p> <p>因为用户id是唯一且共同的，因而可以作为连接键将两个表（子表b与原表）连接</p> <blockquote><p>-- 表连接</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span>  order_info<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
		<span class="token keyword">DATE</span><span class="token punctuation">(</span><span class="token function">MIN</span><span class="token punctuation">(</span>order_info<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token comment">--第一次下单</span>
		b<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">,</span>						<span class="token comment">--第二次下单</span>
		<span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> 
<span class="token keyword">FROM</span> order_info
<span class="token keyword">JOIN</span> b 
<span class="token keyword">ON</span> order_info<span class="token punctuation">.</span>user_id <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id

</code></pre></div></blockquote></li></ol> <p>完整SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> order_info<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span><span class="token keyword">DATE</span><span class="token punctuation">(</span><span class="token function">MIN</span><span class="token punctuation">(</span>order_info<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>b<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> 
<span class="token keyword">FROM</span> order_info
<span class="token keyword">JOIN</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token keyword">date</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">,</span>ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> user_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rs <span class="token keyword">FROM</span> order_info
    <span class="token keyword">WHERE</span> <span class="token keyword">status</span> <span class="token operator">=</span> <span class="token string">'completed'</span>
    <span class="token operator">AND</span> product_name <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'C++'</span><span class="token punctuation">,</span><span class="token string">'Java'</span><span class="token punctuation">,</span><span class="token string">'Python'</span><span class="token punctuation">)</span>
    <span class="token operator">AND</span> <span class="token keyword">date</span> <span class="token operator">&gt;</span> <span class="token string">'2025-10-15'</span>
    <span class="token punctuation">)</span> a
    <span class="token keyword">WHERE</span> rs <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> user_id
<span class="token punctuation">)</span> b 
<span class="token keyword">ON</span> order_info<span class="token punctuation">.</span>user_id <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id
<span class="token keyword">WHERE</span> <span class="token keyword">status</span> <span class="token operator">=</span> <span class="token string">'completed'</span>
<span class="token operator">AND</span> order_info<span class="token punctuation">.</span>product_name <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'C++'</span><span class="token punctuation">,</span><span class="token string">'Java'</span><span class="token punctuation">,</span><span class="token string">'Python'</span><span class="token punctuation">)</span>
<span class="token operator">AND</span> order_info<span class="token punctuation">.</span><span class="token keyword">date</span> <span class="token operator">&gt;</span> <span class="token string">'2025-10-15'</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> order_info<span class="token punctuation">.</span>user_id
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> order_info<span class="token punctuation">.</span>user_id
</code></pre></div><h4 id="sql90-获得积分最多的人-二-较难"><a href="#sql90-获得积分最多的人-二-较难" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/b6248d075d2d4213948b2e768080dc92?tpId=82&amp;tags=&amp;title=&amp;difficulty=0&amp;judgeStatus=0&amp;rp=1" target="_blank" rel="noopener noreferrer"><strong>SQL90</strong> <strong>获得积分最多的人(二)</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（较难）</h4> <blockquote><p>描述</p> <p>牛客每天有很多用户刷题，发帖，点赞，点踩等等，这些都会记录相应的积分。</p> <p>有一个用户表(user)，简况如下：</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210328/301499_1616896023720/B9EE61A3CF7F34EF411FE1A9C6B86FBC" alt="img"></p> <p>还有一个积分表(grade_info)，简况如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210328/301499_1616900022314/5A84E57F33739CFEC87F578CD60DB6A3" alt="img"></p> <p>第1行表示，user_id为1的用户积分增加了3分。</p> <p>第2行表示，user_id为2的用户积分增加了3分。</p> <p>第3行表示，user_id为1的用户积分又增加了1分。</p> <p>.......</p> <p>最后1行表示，user_id为3的用户积分增加了1分。</p> <p>请你写一个SQL查找积分增加最高的用户的id(可能有多个)，名字，以及他的总积分是多少，查询结果按照id升序排序，以上例子查询结果如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210328/301499_1616900118014/B64703D5542E7DE36EC9394C05E69FBF" alt="img"></p> <p>解释:</p> <p>user_id为1和3的2个人，积分都为4，都要输出</p></blockquote> <ol><li><p>因为是分组求和，所以还是先<code>GROUP BY</code>+<code>SUM()</code>一顿操作。</p> <p>此外，为了筛选出grade之和最多的，这里通过排序来实现，所以在上述分组求和的基础上再嵌套一层SELECT语句</p> <blockquote><p>-- 子查询（子表b）</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span>DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> grade_sum <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rs 
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>grade_num<span class="token punctuation">)</span> <span class="token keyword">AS</span> grade_sum <span class="token keyword">FROM</span> grade_info
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
<span class="token punctuation">)</span> a
</code></pre></div></blockquote></li> <li><p>上述查询结果中已经有了需要的直接或间接数据，所以只需要再做表连接和WHERE过滤操作即可。</p> <p>取排序最高的，即rs=1，SQL逻辑如下：</p> <blockquote><p>-- 查询逻辑</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token keyword">user</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>grade_sum
<span class="token keyword">FROM</span> b
<span class="token keyword">JOIN</span> <span class="token keyword">user</span>
<span class="token keyword">ON</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id
<span class="token keyword">WHERE</span> rs <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id
</code></pre></div></blockquote></li></ol> <p>完整SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token keyword">user</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>grade_sum
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    
    <span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span>DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> grade_sum <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rs 
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>grade_num<span class="token punctuation">)</span> <span class="token keyword">AS</span> grade_sum <span class="token keyword">FROM</span> grade_info
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
    <span class="token punctuation">)</span> a
    
<span class="token punctuation">)</span> b
<span class="token keyword">JOIN</span> <span class="token keyword">user</span>
<span class="token keyword">ON</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id
<span class="token keyword">WHERE</span> rs <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id
</code></pre></div><h4 id="sql91-获得积分最多的人-三-困难"><a href="#sql91-获得积分最多的人-三-困难" class="header-anchor">#</a> <a href="https://www.nowcoder.com/practice/d2b7e2a305a7499fb310dc82a43820e8?tpId=82&amp;tags=&amp;title=&amp;difficulty=0&amp;judgeStatus=0&amp;rp=1" target="_blank" rel="noopener noreferrer"><strong>SQL91</strong> <strong>获得积分最多的人(三)</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（困难）</h4> <blockquote><p>描述</p> <p>牛客每天有很多用户刷题，发帖，点赞，点踩等等，这些都会记录相应的积分。</p> <p>有一个用户表(user)，简况如下：</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210328/301499_1616896023720/B9EE61A3CF7F34EF411FE1A9C6B86FBC" alt="img"></p> <p>还有一个积分表(grade_info)，简况如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210328/301499_1616905385537/13C8EB67E494299F9396F462A8D0728D" alt="img"></p> <p>第1行表示，user_id为1的用户积分增加了3分。</p> <p>第2行表示，user_id为2的用户积分增加了3分。</p> <p>第3行表示，user_id为1的用户积分减少了1分。</p> <p>.......</p> <p>最后1行表示，user_id为3的用户积分减少了1分。</p> <p>请你写一个SQL查找积分最高的用户的id，名字，以及他的总积分是多少(可能有多个)，查询结果按照id升序排序，以上例子查询结果如下:</p> <p><img src="https://uploadfiles.nowcoder.com/images/20210328/301499_1616905506009/26B900CFF8FB6BE2B2077D494CA1F237" alt="img"></p> <p>解释:</p> <p>user_id为1和3的先加了3分，但是后面又减了1分，他们2个是2分，</p> <p>其他3个都是3分，所以输出其他三个的数据</p></blockquote> <p>这道题是牛客最后一道题，但是挺简单的。</p> <p>先来看这道题与众不同的是，有加（add）和减（reduce）两种操作，但是记录的数值都是正数，所以显然不能直接用<code>SUM()</code>，所以在用SUM之前我们先将其转换一下：</p> <ol><li><p>把type = 'reduce'的grade_num变成负数</p> <blockquote><p>-- grade_num数值的转换（子表a）</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span>grade_num <span class="token keyword">AS</span> g <span class="token keyword">FROM</span> grade_info
<span class="token keyword">WHERE</span> <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">'add'</span>
<span class="token keyword">UNION</span> <span class="token keyword">ALL</span>
<span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token operator">-</span>grade_num<span class="token punctuation">)</span> <span class="token keyword">AS</span> g <span class="token keyword">FROM</span> grade_info
<span class="token keyword">WHERE</span> <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">'reduce'</span>
</code></pre></div></blockquote> <p>将type字段是'add'的数据正常取出，将type字段是'reduce'给其grade_num加个负号</p> <p>注意：这里一定要用<code>UNION ALL</code>而不能用UNION（UNION会去重，而UNION ALL不去重）</p> <p>这样两个查询结果就上下拼接起来了（上面部分是grade_num为正数的行，下面部分是grade_num为负数的行，而它们都有相同的字段名）</p></li> <li><p>求和排序</p> <p>因为还是要求和并且取最高的，所以按老套路求和之后再套上一层SELECT</p> <blockquote><p>-- 求和排序（子表c）</p> <div class="language-sql extra-class"><pre class="language-sql"><code>    <span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span>DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> g_sum <span class="token keyword">DESC</span><span class="token punctuation">)</span> rs 
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span> <span class="token keyword">AS</span> g_sum
        <span class="token keyword">FROM</span>  a
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
    <span class="token punctuation">)</span> b
</code></pre></div></blockquote></li> <li><p>表连接</p> <p>最后user_id这些换成name，所以需要做表连接；并且WHERE条件过滤掉 rs = 1以外的数据</p> <blockquote><p>-- 表连接</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>g_sum <span class="token keyword">FROM</span>  c
<span class="token keyword">JOIN</span> <span class="token keyword">user</span>
<span class="token keyword">ON</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id <span class="token operator">=</span> c<span class="token punctuation">.</span>user_id
<span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>rs <span class="token operator">=</span> <span class="token number">1</span>
</code></pre></div></blockquote></li></ol> <p>完整SQL语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>g_sum <span class="token keyword">FROM</span> <span class="token punctuation">(</span>

    <span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span>DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> g_sum <span class="token keyword">DESC</span><span class="token punctuation">)</span> rs 
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span>

        <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span> <span class="token keyword">AS</span> g_sum
        <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span>grade_num <span class="token keyword">AS</span> g <span class="token keyword">FROM</span> grade_info
        <span class="token keyword">WHERE</span> <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">'add'</span>
        <span class="token keyword">UNION</span> <span class="token keyword">ALL</span>
        <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token operator">-</span>grade_num<span class="token punctuation">)</span> <span class="token keyword">AS</span> g <span class="token keyword">FROM</span> grade_info
        <span class="token keyword">WHERE</span> <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">'reduce'</span>
        <span class="token punctuation">)</span> a
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
    <span class="token punctuation">)</span> b
    
<span class="token punctuation">)</span> c
<span class="token keyword">JOIN</span> <span class="token keyword">user</span>
<span class="token keyword">ON</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id <span class="token operator">=</span> c<span class="token punctuation">.</span>user_id
<span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>rs <span class="token operator">=</span> <span class="token number">1</span>
</code></pre></div><h2 id="行列转换"><a href="#行列转换" class="header-anchor">#</a> 行列转换</h2> <h3 id="行转列"><a href="#行转列" class="header-anchor">#</a> 行转列</h3> <h4 id="静态行转列"><a href="#静态行转列" class="header-anchor">#</a> [静态行转列]</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">year</span><span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">THEN</span> amount <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> m1<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">THEN</span> amount <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> m2<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token number">3</span> <span class="token keyword">THEN</span> amount <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> m3<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token number">4</span> <span class="token keyword">THEN</span> amount <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> m4<span class="token punctuation">,</span>
<span class="token keyword">FROM</span> due
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">year</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>相关函数：</strong></p> <blockquote><p>​    1.collect_list和collect_set：它们都是将分组中的某列汇总转为一个数组返回，不同的是collect_list不去重而collect_set去重。（一般要配合group by使用）</p> <p>​    2. CONCAT_WS(separator,str1,str2,…)</p> <p>注意：CONCAT_WS must be “string or array”</p></blockquote> <p><img src="https://i.loli.net/2021/08/13/VdiUHYafOkK2JSr.jpg" alt=""></p> <h3 id="列转行"><a href="#列转行" class="header-anchor">#</a> 列转行</h3> <p><strong>相关函数：</strong></p> <blockquote><ol><li><p>SPLIT(str, separator)：将字符串按照后面的分隔符切割，转换成字符array。</p></li> <li><p>EXPLODE( col)：将 hive一列中复杂的Array或者Map结构拆分成多行。</p></li> <li><p>LATERAL VIEW（）：（一进多出）</p></li></ol> <p>用法：LATERAL VIEW udtf(expression) tableAlias AS columnAlias</p> <p>解释：用于和split, explode等UDTF一起使用它能够将一列数据拆成多行数据 在此基础上可以对拆分后的数据进行聚合。</p> <p>lateral view首先为原始表的每行调用UDTF，UDTF会把一行拆分成一或者多行，lateral view再把结果组合，产生一个支持别名表的虚拟表。</p> <p>注意：一个FROM语句后可以跟多个lateral view语句，后面的lateral view语句能够引用它前面的所有表和列名。</p></blockquote> <p><img src="https://i.loli.net/2021/08/13/urWN2l7RQj1PFhB.jpg" alt=""></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/./datahouse/sql/数仓SQL真题.html">
        数仓SQL真题
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="./assets/js/app.dc5b0715.js" defer></script><script src="./assets/js/2.47c06342.js" defer></script><script src="./assets/js/71.54649836.js" defer></script>
  </body>
</html>
