<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>用户画像：标签数据存储 | 大数据技术文档</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="./favicon.ico">
    <meta name="description" content="从入门到入土">
    
    <link rel="preload" href="./assets/css/0.styles.2c6e287f.css" as="style"><link rel="preload" href="./assets/js/app.9ce0d262.js" as="script"><link rel="preload" href="./assets/js/2.fa5f1a4a.js" as="script"><link rel="preload" href="./assets/js/110.eda784ab.js" as="script"><link rel="prefetch" href="./assets/js/10.6940d239.js"><link rel="prefetch" href="./assets/js/100.22cf6913.js"><link rel="prefetch" href="./assets/js/101.8a31dcdc.js"><link rel="prefetch" href="./assets/js/102.147ef11e.js"><link rel="prefetch" href="./assets/js/103.cc281f62.js"><link rel="prefetch" href="./assets/js/104.2e0465e5.js"><link rel="prefetch" href="./assets/js/105.910aa23c.js"><link rel="prefetch" href="./assets/js/106.5466141f.js"><link rel="prefetch" href="./assets/js/107.a92bd18e.js"><link rel="prefetch" href="./assets/js/108.51fca30a.js"><link rel="prefetch" href="./assets/js/109.6119ffd0.js"><link rel="prefetch" href="./assets/js/11.bd53d768.js"><link rel="prefetch" href="./assets/js/111.12c174e7.js"><link rel="prefetch" href="./assets/js/112.8f45d1d2.js"><link rel="prefetch" href="./assets/js/113.e0bb8777.js"><link rel="prefetch" href="./assets/js/114.2ffc5abc.js"><link rel="prefetch" href="./assets/js/115.264d88bb.js"><link rel="prefetch" href="./assets/js/116.43a8b13e.js"><link rel="prefetch" href="./assets/js/117.03317ae7.js"><link rel="prefetch" href="./assets/js/118.dee53adb.js"><link rel="prefetch" href="./assets/js/119.662a11fb.js"><link rel="prefetch" href="./assets/js/12.b25bd03a.js"><link rel="prefetch" href="./assets/js/120.8d1c0658.js"><link rel="prefetch" href="./assets/js/121.c866d980.js"><link rel="prefetch" href="./assets/js/122.141777da.js"><link rel="prefetch" href="./assets/js/123.64bf1df0.js"><link rel="prefetch" href="./assets/js/124.0f402852.js"><link rel="prefetch" href="./assets/js/125.adf420b6.js"><link rel="prefetch" href="./assets/js/126.5ac52ff6.js"><link rel="prefetch" href="./assets/js/127.31a2c0b9.js"><link rel="prefetch" href="./assets/js/128.ee1158fc.js"><link rel="prefetch" href="./assets/js/129.ea47f41d.js"><link rel="prefetch" href="./assets/js/13.127a8756.js"><link rel="prefetch" href="./assets/js/130.169a1c91.js"><link rel="prefetch" href="./assets/js/131.25141855.js"><link rel="prefetch" href="./assets/js/132.1961433f.js"><link rel="prefetch" href="./assets/js/133.4a4b3148.js"><link rel="prefetch" href="./assets/js/134.3cf3137b.js"><link rel="prefetch" href="./assets/js/135.25c96955.js"><link rel="prefetch" href="./assets/js/136.34bc078a.js"><link rel="prefetch" href="./assets/js/137.0d68c97e.js"><link rel="prefetch" href="./assets/js/138.06820a54.js"><link rel="prefetch" href="./assets/js/139.25951593.js"><link rel="prefetch" href="./assets/js/14.ee4f6d75.js"><link rel="prefetch" href="./assets/js/140.9631a9a0.js"><link rel="prefetch" href="./assets/js/141.7e3c7d7b.js"><link rel="prefetch" href="./assets/js/142.fc0ba6d0.js"><link rel="prefetch" href="./assets/js/143.a87cd9f4.js"><link rel="prefetch" href="./assets/js/144.b8153695.js"><link rel="prefetch" href="./assets/js/145.5bb910bf.js"><link rel="prefetch" href="./assets/js/146.48346688.js"><link rel="prefetch" href="./assets/js/147.14fdd265.js"><link rel="prefetch" href="./assets/js/148.910c7bb0.js"><link rel="prefetch" href="./assets/js/149.17e89273.js"><link rel="prefetch" href="./assets/js/15.4c07895d.js"><link rel="prefetch" href="./assets/js/150.c09b3d84.js"><link rel="prefetch" href="./assets/js/151.1c6f270e.js"><link rel="prefetch" href="./assets/js/152.14fbeaa5.js"><link rel="prefetch" href="./assets/js/153.2452da0e.js"><link rel="prefetch" href="./assets/js/154.b4df1979.js"><link rel="prefetch" href="./assets/js/155.22d7abd8.js"><link rel="prefetch" href="./assets/js/156.2f9a9ccc.js"><link rel="prefetch" href="./assets/js/157.969faec2.js"><link rel="prefetch" href="./assets/js/158.3500ec52.js"><link rel="prefetch" href="./assets/js/159.e527d9a4.js"><link rel="prefetch" href="./assets/js/16.c4323435.js"><link rel="prefetch" href="./assets/js/160.e9019d68.js"><link rel="prefetch" href="./assets/js/161.85c34333.js"><link rel="prefetch" href="./assets/js/162.a46ae7b7.js"><link rel="prefetch" href="./assets/js/163.7be9bd8c.js"><link rel="prefetch" href="./assets/js/164.0c6811d8.js"><link rel="prefetch" href="./assets/js/165.57bd5bac.js"><link rel="prefetch" href="./assets/js/166.afa88f4a.js"><link rel="prefetch" href="./assets/js/167.29d4d5ce.js"><link rel="prefetch" href="./assets/js/168.e653cd83.js"><link rel="prefetch" href="./assets/js/169.e6f17762.js"><link rel="prefetch" href="./assets/js/17.505c5524.js"><link rel="prefetch" href="./assets/js/170.ef23a402.js"><link rel="prefetch" href="./assets/js/171.cad09bfd.js"><link rel="prefetch" href="./assets/js/172.70b28875.js"><link rel="prefetch" href="./assets/js/173.bd26a56b.js"><link rel="prefetch" href="./assets/js/174.eb342099.js"><link rel="prefetch" href="./assets/js/175.e65fe97d.js"><link rel="prefetch" href="./assets/js/176.991a568d.js"><link rel="prefetch" href="./assets/js/177.14728a0e.js"><link rel="prefetch" href="./assets/js/178.dd08b87f.js"><link rel="prefetch" href="./assets/js/179.35f52dd6.js"><link rel="prefetch" href="./assets/js/18.a3c1984e.js"><link rel="prefetch" href="./assets/js/180.fce6e839.js"><link rel="prefetch" href="./assets/js/181.344642d1.js"><link rel="prefetch" href="./assets/js/182.cb6d50af.js"><link rel="prefetch" href="./assets/js/183.18ccb5d5.js"><link rel="prefetch" href="./assets/js/184.7a48514f.js"><link rel="prefetch" href="./assets/js/19.e0fa9e47.js"><link rel="prefetch" href="./assets/js/20.da04fed8.js"><link rel="prefetch" href="./assets/js/21.039b78b5.js"><link rel="prefetch" href="./assets/js/22.91b1dd94.js"><link rel="prefetch" href="./assets/js/23.f70b01e1.js"><link rel="prefetch" href="./assets/js/24.bf935b15.js"><link rel="prefetch" href="./assets/js/25.740be3c8.js"><link rel="prefetch" href="./assets/js/26.f310e9df.js"><link rel="prefetch" href="./assets/js/27.0650d6da.js"><link rel="prefetch" href="./assets/js/28.30bd72ee.js"><link rel="prefetch" href="./assets/js/29.765dccf5.js"><link rel="prefetch" href="./assets/js/3.aa27e9f3.js"><link rel="prefetch" href="./assets/js/30.0484ae09.js"><link rel="prefetch" href="./assets/js/31.e09e1f25.js"><link rel="prefetch" href="./assets/js/32.9048892a.js"><link rel="prefetch" href="./assets/js/33.47a85736.js"><link rel="prefetch" href="./assets/js/34.162be571.js"><link rel="prefetch" href="./assets/js/35.27a56cfa.js"><link rel="prefetch" href="./assets/js/36.e2b24ea4.js"><link rel="prefetch" href="./assets/js/37.660e2ae2.js"><link rel="prefetch" href="./assets/js/38.e115bc82.js"><link rel="prefetch" href="./assets/js/39.786d0e1f.js"><link rel="prefetch" href="./assets/js/4.dac57b37.js"><link rel="prefetch" href="./assets/js/40.1034d892.js"><link rel="prefetch" href="./assets/js/41.2952b19a.js"><link rel="prefetch" href="./assets/js/42.75753f7b.js"><link rel="prefetch" href="./assets/js/43.af07ba27.js"><link rel="prefetch" href="./assets/js/44.c64a1c19.js"><link rel="prefetch" href="./assets/js/45.a3f07fbe.js"><link rel="prefetch" href="./assets/js/46.cde01b57.js"><link rel="prefetch" href="./assets/js/47.ca2de71c.js"><link rel="prefetch" href="./assets/js/48.264c1471.js"><link rel="prefetch" href="./assets/js/49.733bd546.js"><link rel="prefetch" href="./assets/js/5.6ca2ea8d.js"><link rel="prefetch" href="./assets/js/50.7b9d16c8.js"><link rel="prefetch" href="./assets/js/51.f427baa6.js"><link rel="prefetch" href="./assets/js/52.112ba3d3.js"><link rel="prefetch" href="./assets/js/53.bc7a9bfd.js"><link rel="prefetch" href="./assets/js/54.258fa5ae.js"><link rel="prefetch" href="./assets/js/55.00d67ca6.js"><link rel="prefetch" href="./assets/js/56.ea8c85f2.js"><link rel="prefetch" href="./assets/js/57.8263a106.js"><link rel="prefetch" href="./assets/js/58.e0b33df6.js"><link rel="prefetch" href="./assets/js/59.4d5f847f.js"><link rel="prefetch" href="./assets/js/6.a67b19a4.js"><link rel="prefetch" href="./assets/js/60.d3638a19.js"><link rel="prefetch" href="./assets/js/61.33bd82a8.js"><link rel="prefetch" href="./assets/js/62.6287fa56.js"><link rel="prefetch" href="./assets/js/63.f043aec3.js"><link rel="prefetch" href="./assets/js/64.fd61b3bb.js"><link rel="prefetch" href="./assets/js/65.088db422.js"><link rel="prefetch" href="./assets/js/66.fa850071.js"><link rel="prefetch" href="./assets/js/67.6f9263db.js"><link rel="prefetch" href="./assets/js/68.a40fea6a.js"><link rel="prefetch" href="./assets/js/69.82a38b9c.js"><link rel="prefetch" href="./assets/js/7.130b2290.js"><link rel="prefetch" href="./assets/js/70.78387c60.js"><link rel="prefetch" href="./assets/js/71.c8bafdac.js"><link rel="prefetch" href="./assets/js/72.f6af738e.js"><link rel="prefetch" href="./assets/js/73.483631aa.js"><link rel="prefetch" href="./assets/js/74.7a295ce2.js"><link rel="prefetch" href="./assets/js/75.4ee52419.js"><link rel="prefetch" href="./assets/js/76.bfa2477e.js"><link rel="prefetch" href="./assets/js/77.36dbbf31.js"><link rel="prefetch" href="./assets/js/78.99a9055a.js"><link rel="prefetch" href="./assets/js/79.cf91068c.js"><link rel="prefetch" href="./assets/js/8.e81bc496.js"><link rel="prefetch" href="./assets/js/80.5091cf53.js"><link rel="prefetch" href="./assets/js/81.1ab1ac83.js"><link rel="prefetch" href="./assets/js/82.075a98b9.js"><link rel="prefetch" href="./assets/js/83.f6479725.js"><link rel="prefetch" href="./assets/js/84.36b72a58.js"><link rel="prefetch" href="./assets/js/85.5a115a90.js"><link rel="prefetch" href="./assets/js/86.e2e2bc5e.js"><link rel="prefetch" href="./assets/js/87.7498c4d7.js"><link rel="prefetch" href="./assets/js/88.424c69e2.js"><link rel="prefetch" href="./assets/js/89.5997766e.js"><link rel="prefetch" href="./assets/js/9.7d490254.js"><link rel="prefetch" href="./assets/js/90.ba4d2a78.js"><link rel="prefetch" href="./assets/js/91.920a9ee1.js"><link rel="prefetch" href="./assets/js/92.7903dbd3.js"><link rel="prefetch" href="./assets/js/93.e120bbac.js"><link rel="prefetch" href="./assets/js/94.cddc34d7.js"><link rel="prefetch" href="./assets/js/95.0a7a80fe.js"><link rel="prefetch" href="./assets/js/96.26590fe7.js"><link rel="prefetch" href="./assets/js/97.91bdc308.js"><link rel="prefetch" href="./assets/js/98.9a1146d2.js"><link rel="prefetch" href="./assets/js/99.d5e87370.js">
    <link rel="stylesheet" href="./assets/css/0.styles.2c6e287f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><!----> <span class="site-name">大数据技术文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程基础" class="dropdown-title"><span class="title">编程基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程基础" class="mobile-dropdown-title"><span class="title">编程基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Java基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/java基础语法/" class="nav-link">
  Java基础语法
</a></li><li class="dropdown-subitem"><a href="/./coding-base/" class="nav-link">
  Java基础实战
</a></li></ul></li><li class="dropdown-item"><h4>
          Java进阶(选学)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/java并发编程/java并发编程.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-subitem"><a href="/./coding-base/" class="nav-link">
  Java网络编程
</a></li><li class="dropdown-subitem"><a href="/./coding-base/java集合/Java集合（永盛）.html" class="nav-link">
  Java集合
</a></li><li class="dropdown-subitem"><a href="/./coding-base/java虚拟机/" class="nav-link">
  Java虚拟机
</a></li></ul></li><li class="dropdown-item"><h4>
          计算机基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-subitem"><a href="/./coding-base/数据结构与算法/" class="nav-link">
  数据结构（重要）
</a></li><li class="dropdown-subitem"><a href="/./coding-base/计算机网络/计算机网络（双祥）.html" class="nav-link">
  计算机网络
</a></li><li class="dropdown-subitem"><a href="/./coding-base/操作系统/" class="nav-link">
  操作系统
</a></li></ul></li><li class="dropdown-item"><h4>
          Python（选学）
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/Python/python基础/" class="nav-link">
  Python基础语法
</a></li><li class="dropdown-subitem"><a href="/./coding-base/Python/python库/" class="nav-link">
  Python数据科学库
</a></li></ul></li><li class="dropdown-item"><h4>
          框架（选学）
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/框架/sprin系列/" class="nav-link">
  Spring系列
</a></li><li class="dropdown-subitem"><a href="/./coding-base/框架/flask/falsk.html" class="nav-link">
  Flask
</a></li><li class="dropdown-subitem"><a href="/./coding-base/框架/vue/flask.html" class="nav-link">
  Vue
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./database/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/./database/hbase/" class="nav-link">
  HBase
</a></li><li class="dropdown-item"><!----> <a href="/./database/tidb/" class="nav-link">
  TiDB
</a></li><li class="dropdown-item"><!----> <a href="/./database/clickhouse/" class="nav-link">
  ClickHouse
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据仓库" class="dropdown-title"><span class="title">数据仓库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据仓库" class="mobile-dropdown-title"><span class="title">数据仓库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./datahouse/sql/" class="nav-link">
  SQL
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/大数据基础/bigdata-base.html" class="nav-link">
  大数据基础
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/离线数仓/" class="nav-link">
  离线数仓
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/实时数仓/" class="nav-link">
  实时数仓
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/商业化技术/" class="nav-link">
  商业化技术
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/电商业务/" class="nav-link">
  电商业务
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据框架及组件" class="dropdown-title"><span class="title">大数据框架及组件</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据框架及组件" class="mobile-dropdown-title"><span class="title">大数据框架及组件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./bigdata/hadoop/" class="nav-link">
  Hadoop
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/hive/" class="nav-link">
  Hive
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/zookeeper/" class="nav-link">
  Zookeeper
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/kafka/" class="nav-link">
  kafka
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/spark/" class="nav-link">
  Spark
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/flink/" class="nav-link">
  Flink
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/sqoop/Sqoop入门.html" class="nav-link">
  Sqoop
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/presto/Presto入门.html" class="nav-link">
  Presto
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/kylin/" class="nav-link">
  Kylin
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/Druid/Druid入门.html" class="nav-link">
  Druid
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/elasticsearch/ElasticSearch入门.html" class="nav-link">
  ElasticSearch
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./other/面经/" class="nav-link">
  面经
</a></li><li class="dropdown-item"><!----> <a href="/./other/机器学习/" class="nav-link">
  机器学习
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/./" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程基础" class="dropdown-title"><span class="title">编程基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程基础" class="mobile-dropdown-title"><span class="title">编程基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Java基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/java基础语法/" class="nav-link">
  Java基础语法
</a></li><li class="dropdown-subitem"><a href="/./coding-base/" class="nav-link">
  Java基础实战
</a></li></ul></li><li class="dropdown-item"><h4>
          Java进阶(选学)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/java并发编程/java并发编程.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-subitem"><a href="/./coding-base/" class="nav-link">
  Java网络编程
</a></li><li class="dropdown-subitem"><a href="/./coding-base/java集合/Java集合（永盛）.html" class="nav-link">
  Java集合
</a></li><li class="dropdown-subitem"><a href="/./coding-base/java虚拟机/" class="nav-link">
  Java虚拟机
</a></li></ul></li><li class="dropdown-item"><h4>
          计算机基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-subitem"><a href="/./coding-base/数据结构与算法/" class="nav-link">
  数据结构（重要）
</a></li><li class="dropdown-subitem"><a href="/./coding-base/计算机网络/计算机网络（双祥）.html" class="nav-link">
  计算机网络
</a></li><li class="dropdown-subitem"><a href="/./coding-base/操作系统/" class="nav-link">
  操作系统
</a></li></ul></li><li class="dropdown-item"><h4>
          Python（选学）
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/Python/python基础/" class="nav-link">
  Python基础语法
</a></li><li class="dropdown-subitem"><a href="/./coding-base/Python/python库/" class="nav-link">
  Python数据科学库
</a></li></ul></li><li class="dropdown-item"><h4>
          框架（选学）
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/框架/sprin系列/" class="nav-link">
  Spring系列
</a></li><li class="dropdown-subitem"><a href="/./coding-base/框架/flask/falsk.html" class="nav-link">
  Flask
</a></li><li class="dropdown-subitem"><a href="/./coding-base/框架/vue/flask.html" class="nav-link">
  Vue
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./database/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/./database/hbase/" class="nav-link">
  HBase
</a></li><li class="dropdown-item"><!----> <a href="/./database/tidb/" class="nav-link">
  TiDB
</a></li><li class="dropdown-item"><!----> <a href="/./database/clickhouse/" class="nav-link">
  ClickHouse
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据仓库" class="dropdown-title"><span class="title">数据仓库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据仓库" class="mobile-dropdown-title"><span class="title">数据仓库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./datahouse/sql/" class="nav-link">
  SQL
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/大数据基础/bigdata-base.html" class="nav-link">
  大数据基础
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/离线数仓/" class="nav-link">
  离线数仓
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/实时数仓/" class="nav-link">
  实时数仓
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/商业化技术/" class="nav-link">
  商业化技术
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/电商业务/" class="nav-link">
  电商业务
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据框架及组件" class="dropdown-title"><span class="title">大数据框架及组件</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据框架及组件" class="mobile-dropdown-title"><span class="title">大数据框架及组件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./bigdata/hadoop/" class="nav-link">
  Hadoop
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/hive/" class="nav-link">
  Hive
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/zookeeper/" class="nav-link">
  Zookeeper
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/kafka/" class="nav-link">
  kafka
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/spark/" class="nav-link">
  Spark
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/flink/" class="nav-link">
  Flink
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/sqoop/Sqoop入门.html" class="nav-link">
  Sqoop
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/presto/Presto入门.html" class="nav-link">
  Presto
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/kylin/" class="nav-link">
  Kylin
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/Druid/Druid入门.html" class="nav-link">
  Druid
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/elasticsearch/ElasticSearch入门.html" class="nav-link">
  ElasticSearch
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./other/面经/" class="nav-link">
  面经
</a></li><li class="dropdown-item"><!----> <a href="/./other/机器学习/" class="nav-link">
  机器学习
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>商业化技术</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./datahouse/%E5%95%86%E4%B8%9A%E5%8C%96%E6%8A%80%E6%9C%AF/" aria-current="page" class="sidebar-link">目录</a></li><li><a href="/./datahouse/商业化技术/广告技术：腾讯广告大数据平台核心架构设计.html" class="sidebar-link">广告技术：腾讯广告大数据平台核心架构设计</a></li><li><a href="/./datahouse/商业化技术/广告风控：计算广告反作弊概述.html" class="sidebar-link">广告风控：计算广告反作弊概述</a></li><li><a href="/./datahouse/商业化技术/用户画像：1 概述.html" class="sidebar-link">用户画像：概述</a></li><li><a href="/./datahouse/商业化技术/用户画像：2 数据标签体系.html" class="sidebar-link">用户画像：数据标签体系</a></li><li><a href="/./datahouse/商业化技术/用户画像：3 标签数据存储.html" class="active sidebar-link">用户画像：标签数据存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/商业化技术/用户画像：3 标签数据存储.html#_1-标签数据存储之hive" class="sidebar-link">1. 标签数据存储之Hive</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/商业化技术/用户画像：3 标签数据存储.html#数据存储建模" class="sidebar-link">数据存储建模</a></li><li class="sidebar-sub-header"><a href="/./datahouse/商业化技术/用户画像：3 标签数据存储.html#标签汇聚" class="sidebar-link">标签汇聚</a></li><li class="sidebar-sub-header"><a href="/./datahouse/商业化技术/用户画像：3 标签数据存储.html#id-mapping" class="sidebar-link">ID-MAPPING</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/商业化技术/用户画像：3 标签数据存储.html#_2-标签数据存储之mysql" class="sidebar-link">2. 标签数据存储之MySQL</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/商业化技术/用户画像：3 标签数据存储.html#元数据管理" class="sidebar-link">元数据管理</a></li><li class="sidebar-sub-header"><a href="/./datahouse/商业化技术/用户画像：3 标签数据存储.html#监控预警数据" class="sidebar-link">监控预警数据</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/商业化技术/用户画像：3 标签数据存储.html#_3-标签数据存储之hbase" class="sidebar-link">3. 标签数据存储之HBase</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/商业化技术/用户画像：3 标签数据存储.html#_1-hbase简介" class="sidebar-link">1. HBase简介</a></li><li class="sidebar-sub-header"><a href="/./datahouse/商业化技术/用户画像：3 标签数据存储.html#_2-应用场景" class="sidebar-link">2. 应用场景</a></li><li class="sidebar-sub-header"><a href="/./datahouse/商业化技术/用户画像：3 标签数据存储.html#_3-工程化案例" class="sidebar-link">3. 工程化案例</a></li></ul></li><li class="sidebar-sub-header"><a href="/./datahouse/商业化技术/用户画像：3 标签数据存储.html#_4-标签数据存储之elasticsearch" class="sidebar-link">4. 标签数据存储之Elasticsearch</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./datahouse/商业化技术/用户画像：3 标签数据存储.html#elasticsearch简介" class="sidebar-link">Elasticsearch简介</a></li><li class="sidebar-sub-header"><a href="/./datahouse/商业化技术/用户画像：3 标签数据存储.html#应用场景" class="sidebar-link">应用场景</a></li><li class="sidebar-sub-header"><a href="/./datahouse/商业化技术/用户画像：3 标签数据存储.html#工程化案例" class="sidebar-link">工程化案例</a></li></ul></li></ul></li><li><a href="/./datahouse/商业化技术/用户画像：4 业务数据调研及ETL.html" class="sidebar-link">用户画像：业务数据调研及ETL</a></li><li><a href="/./datahouse/商业化技术/用户画像：5 统计类标签数据开发.html" class="sidebar-link">用户画像：统计类标签数据开发</a></li><li><a href="/./datahouse/商业化技术/用户画像：6 开发性能调优.html" class="sidebar-link">用户画像：开发性能调优</a></li><li><a href="/./datahouse/商业化技术/用户画像：7 机器学习基础.html" class="sidebar-link">用户画像：机器学习基础</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="用户画像-标签数据存储"><a href="#用户画像-标签数据存储" class="header-anchor">#</a> 用户画像：标签数据存储</h1> <p>在用户画像简介 中提到过一个通用的用户画像建设架构，也就是一个典型的Lambda架构。这里参考用户画像工程化解决方案，在整个工程化方案中，系统依赖的基础设施包括<strong>Spark、Hive、HBase、Airflow、MySQL、Redis、Elasticsearch</strong>。除去基础设施外，系统主体还包括 <strong>Flink、ETL、产品端</strong> 3个重要组成部分。图 2-1 所示是用户画像数仓架构图，下面对其进行详细介绍。</p> <p><img src="https://gitee.com/joeyooa/data-images/raw/master/note/2021/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f32303231303131393030353731303936352e706e673f2c747970655f5a6d46755a33706f5a57356e6147567064476b2c736861646f775f31302c746578745f6148523063484d364c7939696247396e4c6d4e7a5a473475626d56304c.png" alt=""></p> <p>下方虚线框中为常见的<strong>数据仓库ETL加工流程</strong>，也就是将<strong>每日的业务数据、日志数据、埋点数据等经过ETL过程，加工到数据仓库对应的ODS层、DW层、DM层中</strong>。</p> <p>​    中间的虚线框即为用户画像建模的主要环节，<strong>用户画像不是产生数据的源头，而是对基于数据仓库ODS层、DW层、DM层中与用户相关数据的二次建模加工</strong>。在ETL过程中将用户标签计算结果写入<strong>Hive</strong>，由于不同数据库有不同的应用场景，后续需要进一步将数据同步到<code>MySQL</code>、<code>HBase</code>、<code>Elasticsearch</code> 等数据库中。</p> <ul><li>Hive：<strong>存储用户标签计算结果</strong>、<strong>用户人群计算结果</strong>、<strong>用户特征库计算结果</strong></li> <li>MySQL：<strong>存储标签元数据</strong>，<strong>监控相关数据</strong>，<strong>导出到业务系统的数据</strong></li> <li>HBase：<strong>存储线上接口实时调用类数据</strong></li> <li>Elasticserch：<strong>支持海量数据的实时查询分析</strong>，<strong>用于存储用户人群计算、用户群透视分析所需的用户标签数据</strong>（由于用户人群计算、用户群透视分析的条件转化成的SQL语句多条件嵌套较为复杂，使用 Impala 执行也需花费大量时间）</li></ul> <p>​    <strong>用户标签数据在Hive中加工完成后，部分标签通过Sqoop同步到MySQL数据库，提供用于BI报表展示的数据、多维透视分析数据、圈人服务数据；另一部分标签同步到HBase数据库用于产品的线上个性化推荐</strong></p> <h2 id="_1-标签数据存储之hive"><a href="#_1-标签数据存储之hive" class="header-anchor">#</a> 1. 标签数据存储之Hive</h2> <h3 id="数据存储建模"><a href="#数据存储建模" class="header-anchor">#</a> 数据存储建模</h3> <p>站在数仓开发的角度来看，即是将数仓中建模好的数据，包括业务数据与用户埋点数据，基于一定的统计、规则、算法将数仓中的数据加工成用户标签树。数仓建模、分层的方法这里不做多的介绍，按照规范，用户画像的输入数据为Hive中DWD表，输出为DWS层。重点考虑标签表的设计。Hive存储标签相关的数据涉及到的一些表：</p> <ul><li>用户标签表</li> <li>标签聚合的表</li> <li>人群计算的表</li></ul> <h4 id="宽表"><a href="#宽表" class="header-anchor">#</a> 宽表</h4> <p>如果将用户标签开发成一张大的宽表，以Hive为例，我们最常用的就是宽表，也就是一个 key，跟上它的所有标签。比如下面是一个简单的宽表。</p> <table><thead><tr><th style="text-align:left;">用户ID</th> <th style="text-align:left;">性别</th> <th style="text-align:left;">年龄</th> <th style="text-align:left;">学历</th> <th style="text-align:left;">职业</th> <th style="text-align:left;">月薪</th> <th style="text-align:left;">月消费能力</th></tr></thead> <tbody><tr><td style="text-align:left;">001</td> <td style="text-align:left;">男</td> <td style="text-align:left;">28</td> <td style="text-align:left;">本科</td> <td style="text-align:left;">程序员</td> <td style="text-align:left;">10k-20k</td> <td style="text-align:left;">1k-2k</td></tr> <tr><td style="text-align:left;">002</td> <td style="text-align:left;">女</td> <td style="text-align:left;">23</td> <td style="text-align:left;">大专</td> <td style="text-align:left;">销售</td> <td style="text-align:left;">不详</td> <td style="text-align:left;">100-200</td></tr></tbody></table> <p>那么用宽表有什么问题吗？</p> <ul><li>由于用户的标签会非常多，而且随着用户画像的深入，会有很多细分领域的标签，这就意味着标签的数量会随时增加，而且可能会很频繁。</li> <li>不同的标签计算频率不同，比如说学历一周计算一次都是可以接收的，但是APP登录活跃情况却可能需要每天都要计算。</li> <li>计算完成时间不同，如果是以宽表的形式存储，那么最终需要把各个小表的计算结果合并，此时如果出现了一部分结果早上3点计算完成，一部分要早上10点才能计算完成，那么宽表最终的生成时间就要很晚。</li> <li>大量空缺的标签会导致存储稀疏，有一些标签会有很多的缺失，这在用户画像中很常见。</li></ul> <p>当标签数量较多的时候，我们必须考虑以上问题，且增加ETL任务的时间，维护困难。</p> <h4 id="竖表"><a href="#竖表" class="header-anchor">#</a> 竖表</h4> <p>竖表即是将userId + 标签ID作为分组的key存储。竖表其实就是将标签都拆开，一个用户有多少标签，那么在这里面就会有几条数据。</p> <table><thead><tr><th style="text-align:left;">用户ID</th> <th style="text-align:left;">标签名</th> <th style="text-align:left;">标签值</th></tr></thead> <tbody><tr><td style="text-align:left;">001</td> <td style="text-align:left;">sex</td> <td style="text-align:left;">男</td></tr> <tr><td style="text-align:left;">001</td> <td style="text-align:left;">salary_month</td> <td style="text-align:left;">10k-20k</td></tr> <tr><td style="text-align:left;">002</td> <td style="text-align:left;">sex</td> <td style="text-align:left;">女</td></tr> <tr><td style="text-align:left;">002</td> <td style="text-align:left;">age</td> <td style="text-align:left;">23</td></tr></tbody></table> <p>竖表能比较好地解决上面宽表的问题。但是它也会带来了新的问题，比如说多标签组合的查询需求：“我们想看年龄在23-30之间，月薪在10-20k之间，喜欢听古典音乐的女性”，这种多标签查询条件组合情况在竖表中就不太容易支持。</p> <h4 id="横表-竖表"><a href="#横表-竖表" class="header-anchor">#</a> 横表+竖表</h4> <p>如前面所分析，竖表和横表各有所长和所短，那么能不能两者结合呢？</p> <p>这其实也要考虑横表和竖表的特性，整体来讲就是竖表对计算层支持的好，横表对查询层支持的好。那么设计的化就可以这样：</p> <img src="https://gitee.com/joeyooa/data-images/raw/master/note/2021/image-20210605155208457.png" alt="image-20210605155208457" style="zoom:50%;"> <h4 id="分区存储"><a href="#分区存储" class="header-anchor">#</a> 分区存储</h4> <p>如果将用户标签开发成一张大的宽表，在这张宽表下放几十种类型标签，那么每天该画像宽表的ETL作业将会花费很长时间，而且不便于向这张宽表中新增标签类型。</p> <p>​    要解决这种ETL花费时间较长的问题，可以从以下几个方面着手：</p> <ul><li>将数据分区存储，分别执行作业；</li> <li>标签脚本性能调优；</li> <li>基于一些标签共同的数据来源开发中间表。</li></ul> <p>​    下面介绍一种用户标签分表、分区存储的解决方案。</p> <p>​    根据标签指标体系的人口属性、行为属性、用户消费、风险控制、社交属性等维度分别建立对应的标签表进行分表存储对应的标签数据。如下图所示。</p> <ul><li>人口属性表：dw.userprofile_attritube_all；</li> <li>行为属性表：dw.userprofile_action_all；</li> <li>用户消费表：dw.userprofile_consume_all；</li> <li>风险控制表：dw.userprofile_riskmanage_all；</li> <li>社交属性表：dw.userprofile_social_all</li></ul> <p><img src="https://gitee.com/joeyooa/data-images/raw/master/note/2021/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f32303231303232313039353131393637332e706e673f2c747970655f5a6d46755a33706f5a57356e6147567064476b2c736861646f775f31302c746578745f6148523063484d364c7939696247396e4c6d4e7a5a473475626d56304c.png" alt="68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f32303231303232313039353131393637332e706e673f2c747970655f5a6d46755a33706f5a57356e6147567064476b2c736861646f775f31302c746578745f6148523063484d364c7939696247396e4c6d4e7a5a473475626d56304c"></p> <p>用户的人口属性宽表：</p> <p><img src="https://gitee.com/joeyooa/data-images/raw/master/note/2021/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f32303231303232313039353233323138312e706e673f2c747970655f5a6d46755a33706f5a57356e6147567064476b2c736861646f775f31302c746578745f6148523063484d364c7939696247396e4c6d4e7a5a473475626d56304c.png" alt="68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f32303231303232313039353233323138312e706e673f2c747970655f5a6d46755a33706f5a57356e6147567064476b2c736861646f775f31302c746578745f6148523063484d364c7939696247396e4c6d4e7a5a473475626d56304c"></p> <ul><li>其他id维度（如cookieid、deviceid、registerid等）的标签数据存储，也可以使用上面案例中的表结构。</li></ul> <p>​    在上面的创建中通过设立人口属性维度的宽表开发相关的用户标签，为了提高数据的插入和查询效率，在Hive中可以使用分区表的方式，将数据存储在不同的目录中。在Hive使用select查询时一般会扫描整个表中所有数据，将会花费很多时间扫描不是当前要查询的数据，为了扫描表中关心的一部分数据，在建表时引入了partition的概念。在查询时，可以通过Hive的分区机制来控制一次遍历的数据量。</p> <p>​	所以Hive中的各个维度的用户标签相关的表结构采用竖表的设计：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> dws_user_profile_attritube
<span class="token punctuation">(</span>
    user_id STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
    <span class="token keyword">value</span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'标签权重'</span>
<span class="token punctuation">)</span> 
<span class="token keyword">COMMENT</span> <span class="token string">'人口属性维度用户标签表'</span>
PARTITIONED <span class="token keyword">BY</span>
<span class="token punctuation">(</span>
    dt      STRING <span class="token keyword">COMMENT</span> <span class="token string">'日期分区'</span><span class="token punctuation">,</span>
    tag_id  STRING <span class="token keyword">COMMENT</span> <span class="token string">'标签id'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="标签汇聚"><a href="#标签汇聚" class="header-anchor">#</a> 标签汇聚</h3> <p>在上面一节提到的案例中，用户的每个标签都插入到相应的分区下面，<strong>但是对一个用户来说，打在他身上的全部标签存储在不同的分区下面。为了方便分析和查询，需要将用户身上的标签做聚合处理</strong>。标签汇聚后将一个每个用户身上的全量标签汇聚到一个字段中，表结构设计如下：</p> <div class="language- extra-class"><pre class="language-text"><code>CREATE TABLE `dw.userprofile_userlabel_map_all`
(
    `userid`     string COMMENT 'userid',
    `userlabels` map&lt;string,string&gt; COMMENT 'tagsmap',
)
    COMMENT 'userid 用户标签汇聚'
    PARTITIONED BY ( `data_date` string COMMENT '数据日期')
</code></pre></div><p><img src="https://gitee.com/joeyooa/data-images/raw/master/note/2021/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f32303231303232313039353630333134312e706e673f2c747970655f5a6d46755a33706f5a57356e6147567064476b2c736861646f775f31302c746578745f6148523063484d364c7939696247396e4c6d4e7a5a473475626d56304c.png" alt="68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f32303231303232313039353630333134312e706e673f2c747970655f5a6d46755a33706f5a57356e6147567064476b2c736861646f775f31302c746578745f6148523063484d364c7939696247396e4c6d4e7a5a473475626d56304c"></p> <ul><li>开发udf函数“cast_to_json”将用户身上的标签汇聚成json字符串，执行命令将按分区存储的标签进行汇聚：</li></ul> <div class="language- extra-class"><pre class="language-text"><code>insert overwrite table dw.userprofile_userlabel_map_all partition(data_date= &quot;data_date&quot;)  
  select userid,  
         cast_to_json(concat_ws(',',collect_set(concat(labelid,':',labelweight)))) as userlabels
      from “用户各维度的标签表” 
    where data_date= &quot; data_date &quot; 
group by userid
</code></pre></div><ul><li><p>汇聚后用户标签的存储格式如图所示</p> <p><img src="https://gitee.com/joeyooa/data-images/raw/master/note/2021/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f32303231303232313039353733313536372e706e673f2c747970655f5a6d46755a33706f5a57356e6147567064476b2c736861646f775f31302c746578745f6148523063484d364c7939696247396e4c6d4e7a5a473475626d56304c.png" alt="68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f32303231303232313039353733313536372e706e673f2c747970655f5a6d46755a33706f5a57356e6147567064476b2c736861646f775f31302c746578745f6148523063484d364c7939696247396e4c6d4e7a5a473475626d56304c"></p></li> <li><p>将用户身上的标签进行聚合便于查询和计算。例如，在画像产品中，输入用户id后通过直接查询该表，解析标签id和对应的标签权重后，即可在前端展示该用户的相关信息</p></li></ul> <h3 id="id-mapping"><a href="#id-mapping" class="header-anchor">#</a> ID-MAPPING</h3> <p>开发用户标签的时候，有项非常重要的内容——<strong>ID-MApping</strong>，<strong>即把用户不同来源的身份标识通过数据手段识别为同一个主体</strong>。用户的属性、行为相关数据分散在不同的数据来源中，通过ID-MApping能够把用户在不同场景下的行为串联起来，消除数据孤岛。下图展示了用户与设备间的多对多关系。</p> <p><img src="https://camo.githubusercontent.com/722c0b31c5d57bdf4d6d3987e48ea88edef2b19276dc39abca30c895737fb28d/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f32303231303232313130303031323438342e706e673f2c747970655f5a6d46755a33706f5a57356e6147567064476b2c736861646f775f31302c746578745f6148523063484d364c7939696247396e4c6d4e7a5a473475626d56304c33646c61586870626c38304e444d784f44677a4d413d3d2c73697a655f31362c636f6c6f725f4646464646462c745f3730237069635f63656e746572" alt="img"></p> <p>-举例来说，用户在未登录App的状态下，在App站内访问、搜索相关内容时，记录的是设备id（即cookieid）相关的行为数据。而用户在登录App后，访问、收藏、下单等相关的行为记录的是账号id（即userid）相关行为数据。虽然是同一个用户，但其在登录和未登录设备时记录的行为数据之间是未打通的。通过ID-MApping打通userid和cookieid的对应关系，可以在用户登录、未登录设备时都能捕获其行为轨迹。</p> <p>下面通过一个案例介绍如何通过Hive的ETL工作完成ID-Mapping的数据清洗工作。</p> <p><strong>缓慢变化维是在维表设计中常见的一种方式，维度并不是不变的，随时间也会发生缓慢变化</strong>。如用户的手机号、邮箱等信息可能会随用户的状态变化而改变，再如商品的价格也会随时间变化而调整上架的价格。因此在设计用户、商品等维表时会考虑用缓慢变化维来开发。同样，在设计ID-Mapping表时，由于一个用户可以在多个设备上登录，一个设备也能被多个用户登录，所以考虑用缓慢变化维表来记录这种不同时间点的状态变化（图3-9）。</p> <p><img src="https://gitee.com/joeyooa/data-images/raw/master/note/2021/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f32303231303232313130303230333138332e706e673f2c747970655f5a6d46755a33706f5a57356e6147567064476b2c736861646f775f31302c746578745f6148523063484d364c7939696247396e4c6d4e7a5a473475626d56304c.png" alt="68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f32303231303232313130303230333138332e706e673f2c747970655f5a6d46755a33706f5a57356e6147567064476b2c736861646f775f31302c746578745f6148523063484d364c7939696247396e4c6d4e7a5a473475626d56304c"></p> <p>拉链表是针对缓慢变化维表的一种设计方式，记录一个事物从开始到当前状态的全部状态变化信息。</p> <p>在上图中，通过拉链表记录了userid每一次关联到不同cookieid的情况。如userid为44463729的用户，在20190101这天登录某设备，在6号那天变换了另一个设备登录。其中start_date表示该记录的开始日期，end_date表示该记录的结束日期，当end_date为99991231时，表示该条记录当前仍然有效。</p> <p>​    首先需要从埋点表和访问日志表里面获取到cookieid和userid同时出现的访问记录。下面案例中，<code>ods.page_event_log</code>是埋点日志表，<code>ods.page_view_log</code>是访问日志表，将获取到的userid和cookieid信息插入cookieid-userid关系表（<code>ods.cookie_user_signin</code>）中。代码执行如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">INSERT</span> OVERWRITE <span class="token keyword">TABLE</span> ods<span class="token punctuation">.</span>cookie_user_signin <span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>data_date <span class="token operator">=</span> <span class="token string">'${data_date}'</span><span class="token punctuation">)</span>
  <span class="token keyword">SELECT</span> t<span class="token punctuation">.</span><span class="token operator">*</span>
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
         <span class="token keyword">SELECT</span> userid<span class="token punctuation">,</span>
                cookieid<span class="token punctuation">,</span>
                from_unixtime<span class="token punctuation">(</span>eventtime<span class="token punctuation">,</span><span class="token string">'yyyyMMdd'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> signdate
           <span class="token keyword">FROM</span> ods<span class="token punctuation">.</span>page_event_log      <span class="token comment">-- 埋点表</span>
           <span class="token keyword">WHERE</span> data_date <span class="token operator">=</span> <span class="token string">'${data_date}'</span>
        <span class="token keyword">UNION</span> <span class="token keyword">ALL</span>
         <span class="token keyword">SELECT</span> userid<span class="token punctuation">,</span>
                cookieid<span class="token punctuation">,</span>
                from_unixtime<span class="token punctuation">(</span>viewtime<span class="token punctuation">,</span><span class="token string">'yyyyMMdd'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> signdate
           <span class="token keyword">FROM</span> ods<span class="token punctuation">.</span>page_view_log   <span class="token comment">-- 访问日志表</span>
           <span class="token keyword">WHERE</span> data_date <span class="token operator">=</span> <span class="token string">'${data_date}'</span>
           <span class="token punctuation">)</span> t
</code></pre></div><p>​    创建ID-Map的拉链表，将每天新增到ods.cookie_user_signin表中的数据与拉链表历史数据做比较，如果有变化或新增数据则进行更新。</p> <div class="language- extra-class"><pre class="language-text"><code>CREATE TABLE `dw.cookie_user_zippertable`(
`userid` string COMMENT '账号ID', 
`cookieid` string COMMENT '设备ID', 
`start_date` string COMMENT 'start_date', 
`end_date` string COMMENT 'end_date')
COMMENT 'id-map拉链表'
ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
</code></pre></div><p>​    创建完成后，每天ETL调度将数据更新到ID-Mapping拉链表中，任务执行如下。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">INSERT</span> OVERWRITE <span class="token keyword">TABLE</span> dw<span class="token punctuation">.</span>cookie_user_zippertable
<span class="token keyword">SELECT</span> t<span class="token punctuation">.</span><span class="token operator">*</span> 
  <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
      <span class="token keyword">SELECT</span> t1<span class="token punctuation">.</span>user_num<span class="token punctuation">,</span>
             t1<span class="token punctuation">.</span>mobile<span class="token punctuation">,</span>
             t1<span class="token punctuation">.</span>reg_date<span class="token punctuation">,</span>
             t1<span class="token punctuation">.</span>start_date<span class="token punctuation">,</span>
             <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> t1<span class="token punctuation">.</span>end_date <span class="token operator">=</span> <span class="token string">'99991231'</span> <span class="token operator">AND</span> t2<span class="token punctuation">.</span>userid <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token string">'${data_date}'</span>
                  <span class="token keyword">ELSE</span> t1<span class="token punctuation">.</span>end_date
             <span class="token keyword">END</span> <span class="token keyword">AS</span> end_date
       <span class="token keyword">FROM</span> dw<span class="token punctuation">.</span>cookie_user_zippertable t1
    <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span>  <span class="token keyword">SELECT</span> <span class="token operator">*</span>
                 <span class="token keyword">FROM</span> ods<span class="token punctuation">.</span>cookie_user_signin
                <span class="token keyword">WHERE</span> data_date<span class="token operator">=</span><span class="token string">'${data_date}'</span>
              <span class="token punctuation">)</span>t2
           <span class="token keyword">ON</span> t1<span class="token punctuation">.</span>userid <span class="token operator">=</span> t2<span class="token punctuation">.</span>userid
<span class="token keyword">UNION</span>
       <span class="token keyword">SELECT</span> userid<span class="token punctuation">,</span>
              cookieid<span class="token punctuation">,</span>
              <span class="token string">'${data_date}'</span> <span class="token keyword">AS</span> start_date<span class="token punctuation">,</span>
              <span class="token string">'99991231'</span> <span class="token keyword">AS</span> end_date
        <span class="token keyword">FROM</span> ods<span class="token punctuation">.</span>cookie_user_signin
       <span class="token keyword">WHERE</span> data_date <span class="token operator">=</span> <span class="token string">'${data_date
       }'</span>
          <span class="token punctuation">)</span> t
</code></pre></div><p>​    数据写入表中，如上图所示。</p> <p>​    对于该拉链表，可查看某日（如20190801）的快照数据。</p> <div class="language- extra-class"><pre class="language-text"><code>select  * 
from dw.cookie_user_zippertable 
where start_date&lt;='20190801' and end_date&gt;='20190801'
</code></pre></div><p>​    例如，目前存在一个记录userid和cookieid关联关系的表，但是为<strong>多对多</strong>的记录（即一个userid对应多条cookieid记录，以及一条cookieid对应多条userid记录）。这里可以通过拉链表的日期来查看某个时间点userid对应的cookieid。查看某个用户（如32101029）在某天（如20190801）关联到的设备id</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> cookieid 
<span class="token keyword">from</span> dw<span class="token punctuation">.</span>cookie_user_zippertable 
<span class="token keyword">where</span> userid<span class="token operator">=</span><span class="token string">'32101029'</span> <span class="token operator">and</span> start_date<span class="token operator">&lt;=</span><span class="token string">'20190801'</span> <span class="token operator">and</span> end_date<span class="token operator">&gt;=</span><span class="token string">'20190801'</span>
</code></pre></div><p>​    可看出用户‘32101029’在历史中曾登录过3个设备，通过限定时间段可找到特定时间下用户的登录设备。</p> <p>​    在开发中需要注意关于userid与cookieid的多对多关联，如果不加条件限制就做关联，很可能引起数据膨胀问题：</p> <p>​    在实际应用中，会遇到许多需要将userid和cookieid做关联的情况。例如，需要在userid维度开发出该用户近30日的购买次数、购买金额、登录时长、登录天数等标签。前两个标签可以很容易地从相应的业务数据表中根据算法加工出来，而登录时长、登录天数的数据存储在相关日志数据中，日志数据表记录的userid与cookieid为多对多关系。因此在结合业务需求开发标签时，要确定好标签口径定义。</p> <h2 id="_2-标签数据存储之mysql"><a href="#_2-标签数据存储之mysql" class="header-anchor">#</a> 2. 标签数据存储之MySQL</h2> <hr> <p>        MySQL作为关系型数据库，在用户画像中可用于元数据管理、监控预警数据、结果集存储等应用中。下面详细介绍这3个应用场景。</p> <h3 id="元数据管理"><a href="#元数据管理" class="header-anchor">#</a> 元数据管理</h3> <p><font color="tomato">Hive适合于大数据量的批处理作业，对于量级较小的数据，MySQL具有更快的读写速度</font>。Web端产品读写MySQL数据库会有更快的速度，方便标签的定义、管理。</p> <p>        在介绍<strong>用户画像产品化</strong>的时候，我们会介绍元数据录入和查询功能，将相应的数据存储在MySQL中。用户标签的元数据表结构设计也会在之后进行详细的介绍。这里给出了平台标签视图和元数据管理页面。</p> <p><img src="https://img-blog.csdnimg.cn/20210221192719476.png?,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMxODgzMA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><img src="https://img-blog.csdnimg.cn/20210221192731558.png?,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMxODgzMA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <p>        平台标签视图中的标签元数据可以维护在MySQL关系数据库中，便于标签的编辑、查询和管理。</p> <h3 id="监控预警数据"><a href="#监控预警数据" class="header-anchor">#</a> 监控预警数据</h3> <p>        MySQL还可用于<strong>存储每天对ETL结果的监控信息</strong>。从整个画像调度流的关键节点来看，需要监控的环节主要包括对每天标签的产出量、服务层数据同步情况的监控等主要场景。下图展示的是用户画像调度流主要模块。</p> <p><img src="https://img-blog.csdnimg.cn/20210221193123119.png?,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMxODgzMA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h4 id="_1-标签计算数据监控"><a href="#_1-标签计算数据监控" class="header-anchor">#</a> 1.标签计算数据监控</h4> <p>        主要用于监控每天标签ETL的数据量是否出现异常，如果有异常情况则发出告警邮件，同时暂停后面的ETL任务。</p> <h4 id="_2-服务层同步数据监控"><a href="#_2-服务层同步数据监控" class="header-anchor">#</a> 2. 服务层同步数据监控</h4> <p>        服务层一般采用<code>HBase</code>、<code>Elasticsearch</code>等作为数据库<strong>存储标签数据</strong>供线上调用，将标签相关数据从Hive数仓向服务层同步的过程中，有出现差错的可能，<strong>因此需要记录相关数据在Hive中的数量及同步到对应服务层后的数量</strong>，如果数量不一致则触发告警。</p> <p>        在对画像的数据监控中，调度流每跑完相应的模块，就将该模块的监控数据插入MySQL中，当校验任务判断达到触发告警阈值时，发送告警邮件，同时中断后续的调度任务。待开发人员解决问题后，可重启后续调度。</p> <h4 id="_3-结果集存储"><a href="#_3-结果集存储" class="header-anchor">#</a> 3. 结果集存储</h4> <p>        结果集可以用来存储多维透视分析用的标签、圈人服务用的用户标签、当日记录各标签数量，用于校验标签数据是否出现异常。</p> <p>        有的线上业务系统使用MySQL、Oracle等关系型数据库存储数据，如短信系统、消息推送系统等。在打通画像数据与线上业务系统时，需要考虑将存储在Hive中的用户标签相关数据同步到各业务系统，此时<strong>MySQL可用于存储结果集</strong>。</p> <p><font color="tomato">Sqoop是一个用来将Hadoop和关系型数据库中的数据相互迁移的工具。它可以将一个关系型数据库（如MySQL、Oracle、PostgreSQL等）中的数据导入Hadoop的HDFS中，也可以将HDFS中的数据导入关系型数据库中</font></p> <p>        下面通过一个案例来讲解如何使用Sqoop将Hive中的标签数据迁移到MySQL中。</p> <p><font color="RoyalBlue">电商、保险、金融等公司的客服部门的日常工作内容之一是对目标用户群（如已流失用户、高价值用户等）进行主动外呼，以此召回用户来平台进行购买或复购</font>。这里可以借助用户画像系统实现该功能。</p> <p>        将Hive中存储的与用户身份相关的数据同步到客服系统中，首先在Hive中建立一张记录用户身份相关信息的表（例如<code>dw.userprofile_userservice_all</code>）。设置日期分区以满足按日期选取当前人群的需要。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>dw<span class="token punctuation">.</span>userprofile_userservice_all <span class="token punctuation">`</span><span class="token punctuation">(</span>
<span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'userid'</span><span class="token punctuation">,</span> 
<span class="token punctuation">`</span>user_sex<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'user_sex'</span><span class="token punctuation">,</span> 
<span class="token punctuation">`</span>city<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'city'</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>payid_money<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'payid_money'</span><span class="token punctuation">,</span> 
<span class="token punctuation">`</span>payid_num<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'payid_num'</span><span class="token punctuation">,</span> 
<span class="token punctuation">`</span>latest_product<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'latest_product'</span><span class="token punctuation">,</span> 
<span class="token punctuation">`</span><span class="token keyword">date</span><span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'date'</span><span class="token punctuation">,</span> 
<span class="token punctuation">`</span>data_status<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'data_status'</span><span class="token punctuation">)</span>
<span class="token keyword">COMMENT</span> <span class="token string">'userid 用户客服数据'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span> <span class="token punctuation">`</span>data_date<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'数据日期'</span><span class="token punctuation">)</span>
</code></pre></div><p>        在MySQL中建立一张用于接收同步数据的表（<code>userservice_data</code>）。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>userservice_data<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>user_sex<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户性别'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>city<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'城市'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>payid_money<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'消费金额'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>payid_num<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'消费次数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>latest_product<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近购买产品'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token keyword">date</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'传输日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>data_status<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'0:未传输,1:传输中,2:成功,3:失败'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">2261628</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'用户客服数据表'</span><span class="token punctuation">;</span>
</code></pre></div><p>        通过Python脚本调用shell命令，将Hive中的数据同步到MySQL中。执行如下脚本：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> MySQLdb
<span class="token keyword">import</span> sys
def export_data<span class="token punctuation">(</span>hive_tab<span class="token punctuation">,</span> data_date<span class="token punctuation">)</span>:
    sqoop_command <span class="token operator">=</span> <span class="token string">&quot;sqoop export --connect jdbc:mysql://10.xxx.xxx.xxx:3306/mysql_database --username username --password password  --table mysql_table --export-dir hdfs://nameservice1/user/hive/warehouse
/dw.db/&quot;</span> <span class="token operator">+</span> hive_tab <span class="token operator">+</span> <span class="token string">&quot;/data_date=&quot;</span> <span class="token operator">+</span> data_date <span class="token operator">+</span> <span class="token string">&quot; --input-fields-terminated-by '\001'&quot;</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>sqoop_command<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>sqoop_command<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">=</span><span class="token operator">=</span> <span class="token string">'__main__'</span>:
    export_data<span class="token punctuation">(</span><span class="token string">&quot;dw.userprofile_userservice_all&quot;</span><span class="token punctuation">,</span> <span class="token string">'20181201'</span><span class="token punctuation">)</span>
</code></pre></div><p>        其中用到了 sqoop 从 Hive 导出数据到 MySQL 的命令：</p> <div class="language-sql extra-class"><pre class="language-sql"><code>sqoop export
<span class="token comment">--connect 指定JDBC连接字符串,包括IP 端口 数据库名称 \</span>
<span class="token comment">--username  JDBC连接的用户名\</span>
<span class="token comment">--passowrd  JDBC连接的密码\</span>
<span class="token comment">--table  表名\</span>
<span class="token comment">--export-dir  导出的Hive表, 对应的是HDFS地址 \</span>
<span class="token comment">--input fileds-terminated-by ‘,’ 分隔符号</span>
</code></pre></div><p>        不熟悉Sqoop使用的小伙伴可以去看我的这篇文章<a href="https://alice.blog.csdn.net/article/details/113065391" target="_blank" rel="noopener noreferrer">《硬核 | Sqoop入门指南》<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>        同步后 MySQL中的数据如图所示</p> <p><img src="https://img-blog.csdnimg.cn/20210221195149779.png?,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMxODgzMA==,size_16,color_FFFFFF,t_70" alt=""></p> <h2 id="_3-标签数据存储之hbase"><a href="#_3-标签数据存储之hbase" class="header-anchor">#</a> 3. 标签数据存储之HBase</h2> <h3 id="_1-hbase简介"><a href="#_1-hbase简介" class="header-anchor">#</a> 1. HBase简介</h3> <p><font color="Tomato"><strong>HBase是一个高性能、列存储、可伸缩、实时读写的分布式存储系统</strong></font>，同样运行在HDFS之上。与Hive不同的是，HBase能够在数据库上实时运行，而不是跑MapReduce任务，适合进行大数据的<strong>实时查询</strong>。</p> <p>        画像系统中每天在Hive里跑出的结果集数据可同步到 HBase数据库 ，用于线上实时应用的场景。</p> <p>        下面介绍几个基本概念：</p> <ul><li><strong>row key</strong>：用来表示唯一一行记录的<strong>主</strong>键，HBase的数据是按照 row key 的<strong>字典顺序</strong>进行全局排列的。访问HBase中的行只有3种方式：</li> <li><strong>通过单个row key访问</strong>；</li> <li><strong>通过row key的正则访问</strong>；</li> <li><strong>全表扫描</strong></li></ul> <p>        由于HBase通过 rowkey 对数据进行检索，而rowkey 由于长度限制的因素不能将很多查询条件拼接在 rowkey 中，因此 HBase 无法像关系数据库那样根据多种条件对数据进行筛选。一般地，HBase需建立<strong>二级索引</strong>来满足根据复杂条件查询数据的需求。</p> <p>        Rowkey设计时需要遵循三大原则：</p> <ul><li><strong>唯一性原则</strong>：rowkey需要保证唯一性，不存在重复的情况。在画像中一般使用用户id作为rowkey</li> <li><strong>长度原则</strong>：rowkey的长度一般为10-100bytes</li> <li><strong>散列原则</strong>：rowkey的散列分布有利于数据均衡分布在每个RegionServer，可实现负载均衡</li></ul> <p>--  columns family：指列簇，HBase中的每个列都归属于某个列簇。列簇是表的schema的一部分，必须在使用表之前定义。划分columns family的原则如下：</p> <ul><li>是否具有相似的数据格式</li> <li>是否具有相似的访问类型</li></ul> <p>        常用的增删改查命令如下：</p> <p>        1）创建一个表，指定表名和列簇名：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span>  <span class="token string">'&lt;table name&gt;'</span><span class="token punctuation">,</span><span class="token string">'&lt;column family&gt;'</span>
</code></pre></div><p>        2）扫描表中数据，并显示其中的10条记录：</p> <div class="language-sql extra-class"><pre class="language-sql"><code>scan  <span class="token string">'&lt;table name&gt;'</span><span class="token punctuation">,</span>{<span class="token keyword">LIMIT</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token number">10</span>}
</code></pre></div><p>        3）使用get命令读取数据：</p> <div class="language-sql extra-class"><pre class="language-sql"><code>get  <span class="token string">'&lt;table name&gt;'</span><span class="token punctuation">,</span><span class="token string">'row1'</span>
</code></pre></div><p>        4）插入数据：</p> <div class="language-sql extra-class"><pre class="language-sql"><code>put  <span class="token string">'&lt;table name&gt;'</span><span class="token punctuation">,</span><span class="token string">'row1'</span><span class="token punctuation">,</span><span class="token string">'&lt;colfamily:colname&gt;'</span><span class="token punctuation">,</span><span class="token string">'&lt;value&gt;'</span>
</code></pre></div><p>        5）更新数据：</p> <div class="language-sql extra-class"><pre class="language-sql"><code>put  <span class="token string">'&lt;table name&gt;'</span><span class="token punctuation">,</span><span class="token string">'row '</span><span class="token punctuation">,</span><span class="token string">'Column family:column name'</span><span class="token punctuation">,</span><span class="token string">'new value'</span>
</code></pre></div><p>        6）在删除表之前先将其<strong>禁用</strong>，然后删除：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">disable</span>  <span class="token string">'&lt;table name&gt;'</span>
<span class="token keyword">drop</span>  <span class="token string">'&lt;table name&gt;'</span>
</code></pre></div><p>        下面通过一个案例来介绍HBase在画像系统中的应用场景和工程化实现方式。</p> <h3 id="_2-应用场景"><a href="#_2-应用场景" class="header-anchor">#</a> 2. 应用场景</h3> <p>        渠道运营人员为促进未注册的新安装用户注册、下单，计划通过App首页弹窗（如下图所示）发放红包或优惠券的方式进行引导。在该场景中可通过画像系统实现对应功能。</p> <p>        业务逻辑上，渠道运营人员通过组合用户标签（如“未注册用户”和“安装距今天数”小于××天）筛选出对应的用户群，然后选择将对应人群推送到“广告系统”，这样每天画像系统的ETL调度完成后对应人群数据就被推送到HBase数据库进行存储。满足条件的新用户来访App时，由在线接口读取HBase数据库，在查询到该用户时为其推送该弹窗。</p> <p>        下面通过某工程案例来讲解HBase在该触达用户场景中的应用方式。</p> <p><img src="https://img-blog.csdnimg.cn/20210222223852955.png?,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMxODgzMA==,size_16,color_FFFFFF,t_70#pic_center" alt=""></p> <h3 id="_3-工程化案例"><a href="#_3-工程化案例" class="header-anchor">#</a> 3. 工程化案例</h3> <p><strong>运营人员在画像系统中根据业务规则定义组合用户标签筛选出用户群，并将该人群上线到广告系统中</strong>。</p> <p><img src="https://img-blog.csdnimg.cn/20210222224208179.png?,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMxODgzMA==,size_16,color_FFFFFF,t_70#pic_center" alt=""></p> <p>        在业务人员配置好规则后，下面我们来看在数据调度层面是如何运行的。</p> <p>        用户标签数据经过ETL将每个用户身上的标签聚合后插入到目标表中，如<code>dw.userprofile_userlabel_map_all</code>。聚合后数据存储为每个用户id，以及他身上对应的标签集合，数据格式如图所示：</p> <p><img src="https://img-blog.csdnimg.cn/20210222230712227.png?,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMxODgzMA==,size_16,color_FFFFFF,t_70" alt=""></p> <p>        接下来需要将 Hive 中的数据导入HBase，便于线上接口实时调用库中数据。</p> <p><strong>HBase的服务器体系结构遵循主从服务器架构</strong>（如图所示），同一时刻只有一个<strong>HMaster</strong>处于活跃状态，当活跃的Master挂掉后，Backup HMaster自动接管整个HBase集群。在同步数据前，首先需要判断HBase的当前活跃节点是哪台机器。</p> <p><img src="https://img-blog.csdnimg.cn/20210222230813445.png?,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMxODgzMA==,size_16,color_FFFFFF,t_70" alt=""></p> <p>        执行如下脚本：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 判断活跃节点</span>
global activenode
<span class="token keyword">for</span> <span class="token for-or-select variable">node</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">&quot;10.xxx.xx.xxx&quot;</span>,<span class="token string">&quot;10.xxx.xx.xxx&quot;</span><span class="token punctuation">)</span>:   <span class="token comment"># 两台机器作为Master，判断哪台HMaster处于活跃状态</span>
    <span class="token builtin class-name">command</span> <span class="token operator">=</span> <span class="token string">&quot;curl http://&quot;</span>+ str<span class="token punctuation">(</span>node<span class="token punctuation">)</span> + <span class="token string">&quot;:9870/jmx?qry=Hadoop:service=NameNode,name=NameNodeStatus&quot;</span>
    status <span class="token operator">=</span> os.popen<span class="token punctuation">(</span>command<span class="token punctuation">)</span>.read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    print<span class="token punctuation">(</span><span class="token string">&quot;HBase Master status: &quot;</span>.format<span class="token punctuation">(</span>status<span class="token punctuation">))</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;active&quot;</span> <span class="token keyword">in</span> status<span class="token punctuation">)</span>:
        activenode <span class="token operator">=</span> node
</code></pre></div><p>        执行完毕后，可通过返回的“State”字段判断当前节点状态（活跃为“active”，不活跃为“standby”），如图所示。</p> <p><img src="https://img-blog.csdnimg.cn/20210222230930222.png?,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMxODgzMA==,size_16,color_FFFFFF,t_70" alt=""></p> <p>        为避免数据都写入一个region，造成HBase的数据倾斜问题。在当前HMaster活跃的节点上，创建预分区表：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token string">'userprofile_labels'</span><span class="token punctuation">,</span> { NAME <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;f&quot;</span><span class="token punctuation">,</span> BLOCKCACHE <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;true&quot;</span> <span class="token punctuation">,</span> BLOOMFILTER <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;ROWCOL&quot;</span> <span class="token punctuation">,</span> COMPRESSION <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'snappy'</span><span class="token punctuation">,</span> IN_MEMORY <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'true'</span> }<span class="token punctuation">,</span> {NUMREGIONS <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">,</span>SPLITALGO <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'HexStringSplit'</span>}
</code></pre></div><p>        将待同步的数据写入HFile，HFile中的数据以 key-value 键值对方式存储，然后将 HFile 数据使用 BulkLoad 批量写入 HBase 集群中。Scala脚本执行如下：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">import</span> org.apache.hadoop.fs.<span class="token punctuation">{</span>FileSystem, Path<span class="token punctuation">}</span>
<span class="token function">import</span> org.apache.hadoop.HBase.client.ConnectionFactory
<span class="token function">import</span> org.apache.hadoop.HBase.<span class="token punctuation">{</span>HBaseConfiguration, KeyValue, TableName<span class="token punctuation">}</span>
<span class="token function">import</span> org.apache.hadoop.HBase.io.ImmutableBytesWritable
<span class="token function">import</span> org.apache.hadoop.HBase.mapreduce.<span class="token punctuation">{</span>HFileOutputFormat2, LoadIncrementalHFiles<span class="token punctuation">}</span>
<span class="token function">import</span> org.apache.hadoop.HBase.util.Bytes
<span class="token function">import</span> org.apache.hadoop.mapreduce.Job
<span class="token function">import</span> org.apache.spark.sql.SparkSession

object Hive2HBase <span class="token punctuation">{</span>
  def main<span class="token punctuation">(</span>args: Array<span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">)</span>: Unit <span class="token operator">=</span> <span class="token punctuation">{</span>
      // 传入日期参数 和 当前活跃的master节点
    val data_date <span class="token operator">=</span> args<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    val node <span class="token operator">=</span> args<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>   //当前活跃的节点ip

    val spark <span class="token operator">=</span> SparkSession
      .builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      .appName<span class="token punctuation">(</span><span class="token string">&quot;Hive2HBase&quot;</span><span class="token punctuation">)</span>
      .config<span class="token punctuation">(</span><span class="token string">&quot;spark.serializer&quot;</span>,<span class="token string">&quot;org.apache.spark.serializer.KryoSerializer&quot;</span><span class="token punctuation">)</span>
      .config<span class="token punctuation">(</span><span class="token string">&quot;spark.storage.memoryFraction&quot;</span>, <span class="token string">&quot;0.1&quot;</span><span class="token punctuation">)</span>
      .config<span class="token punctuation">(</span><span class="token string">&quot;spark.shuffle.memoryFraction&quot;</span>, <span class="token string">&quot;0.7&quot;</span><span class="token punctuation">)</span>
      .config<span class="token punctuation">(</span><span class="token string">&quot;spark.memory.useLegacyMode&quot;</span>, <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span>
      .enableHiveSupport<span class="token punctuation">(</span><span class="token punctuation">)</span>
      .getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
       //创建HBase的配置
    val conf <span class="token operator">=</span> HBaseConfiguration.create<span class="token punctuation">(</span><span class="token punctuation">)</span>
        conf.set<span class="token punctuation">(</span><span class="token string">&quot;HBase.zookeeper.quorum&quot;</span>, <span class="token string">&quot;10.xxx.xxx.xxx,10.xxx.xxx.xxx&quot;</span><span class="token punctuation">)</span>
        conf.set<span class="token punctuation">(</span><span class="token string">&quot;HBase.zookeeper.property.clientPort&quot;</span>, <span class="token string">&quot;8020&quot;</span><span class="token punctuation">)</span>

    //为了预防hfile文件数过多无法进行导入，设置参数值
    conf.setInt<span class="token punctuation">(</span><span class="token string">&quot;HBase.hregion.max.filesize&quot;</span>, <span class="token number">10737418240</span><span class="token punctuation">)</span>
    conf.setInt<span class="token punctuation">(</span><span class="token string">&quot;HBase.mapreduce.bulkload.max.hfiles.perRegion.perFamily&quot;</span>, <span class="token number">3200</span><span class="token punctuation">)</span>
      
    val Data <span class="token operator">=</span> spark.sql<span class="token punctuation">(</span>s<span class="token string">&quot;select userid,userlabels from dw.userprofile_usergroup_labels_all where data_date='<span class="token variable">${data_date}</span>'&quot;</span><span class="token punctuation">)</span>
    val dataRdd <span class="token operator">=</span> Data.rdd.flatMap<span class="token punctuation">(</span>row <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>    
      val rowkey <span class="token operator">=</span> row.getAs<span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;userid&quot;</span>.toLowerCase<span class="token punctuation">)</span>
      val tagsmap <span class="token operator">=</span> row.getAs<span class="token punctuation">[</span>Map<span class="token punctuation">[</span>String, Object<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;userlabels&quot;</span>.toLowerCase<span class="token punctuation">)</span>
      val sbkey <span class="token operator">=</span> new StringBuffer<span class="token punctuation">(</span><span class="token punctuation">)</span>  // 对MAP结构转化 a-<span class="token operator">&gt;</span>b  <span class="token string">'a'</span><span class="token builtin class-name">:</span><span class="token string">'b'</span>
      val sbvalue <span class="token operator">=</span> new StringBuffer<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">-</span> tagsmap<span class="token punctuation">)</span>{
        sbkey.append<span class="token punctuation">(</span>key <span class="token operator">+</span> &quot;<span class="token operator">:</span>&quot;<span class="token punctuation">)</span>
        val labelght <span class="token operator">=</span> if <span class="token punctuation">(</span>value <span class="token operator">==</span> &quot;&quot;<span class="token punctuation">)</span>{
          &quot;<span class="token operator">-</span><span class="token number">999999</span>&quot;
        } else {
          value
        }
        sbvalue.append<span class="token punctuation">(</span>labelght <span class="token operator">+</span> &quot;<span class="token operator">:</span>&quot;<span class="token punctuation">)</span>
      }
      val item <span class="token operator">=</span> sbkey.substring<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>sbkey.length <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
      val score <span class="token operator">=</span> sbvalue.substring<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>sbvalue.length <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
      Array<span class="token punctuation">(</span>
        <span class="token punctuation">(</span>rowkey<span class="token punctuation">,</span><span class="token punctuation">(</span>&quot;f&quot;<span class="token punctuation">,</span>&quot;i&quot;<span class="token punctuation">,</span>item<span class="token punctuation">))</span></span>,
        <span class="token punctuation">(</span>rowkey,<span class="token punctuation">(</span><span class="token string">&quot;f&quot;</span>,<span class="token string">&quot;s&quot;</span>,score<span class="token punctuation">))</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    // 将rdd转换成HFile需要的格式
    val rdds <span class="token operator">=</span> dataRdd.filter<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token operator">&gt;</span>x._1 <span class="token operator">!=</span> null<span class="token punctuation">)</span>.sortBy<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>x._1,x._2._1, x._2._2<span class="token punctuation">))</span>.map<span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
      //KeyValue的实例为value
      val rowKey <span class="token operator">=</span> Bytes.toBytes<span class="token punctuation">(</span>x._1<span class="token punctuation">)</span>
      val family <span class="token operator">=</span> Bytes.toBytes<span class="token punctuation">(</span>x._2._1<span class="token punctuation">)</span>
      val colum <span class="token operator">=</span> Bytes.toBytes<span class="token punctuation">(</span>x._2._2<span class="token punctuation">)</span>
      val value <span class="token operator">=</span> Bytes.toBytes<span class="token punctuation">(</span>x._2._3.toString<span class="token punctuation">)</span>
      <span class="token punctuation">(</span>new ImmutableBytesWritable<span class="token punctuation">(</span>rowKey<span class="token punctuation">)</span>, new KeyValue<span class="token punctuation">(</span>rowKey, family, colum, value<span class="token punctuation">))</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    //文件保存在hdfs的位置
    val locatedir <span class="token operator">=</span> <span class="token string">&quot;hdfs://&quot;</span> + node.toString + <span class="token string">&quot;:8020/user/bulkload/hfile/usergroup_HBase_&quot;</span> + data_date

    //在locatedir生成的Hfile文件
    rdds.saveAsNewAPIHadoopFile<span class="token punctuation">(</span>locatedir,
      classOf<span class="token punctuation">[</span>ImmutableBytesWritable<span class="token punctuation">]</span>,
      classOf<span class="token punctuation">[</span>KeyValue<span class="token punctuation">]</span>,
      classOf<span class="token punctuation">[</span>HFileOutputFormat2<span class="token punctuation">]</span>,
      conf<span class="token punctuation">)</span>
    //HFile导入到HBase
    val load <span class="token operator">=</span> new LoadIncrementalHFiles<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>

    //HBase的表名
    val tableName <span class="token operator">=</span> <span class="token string">&quot;userprofile_labels&quot;</span>
    //创建HBase的链接,利用默认的配置文件,读取HBase的master地址
    val conn <span class="token operator">=</span> ConnectionFactory.createConnection<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
    //根据表名获取表
    val table <span class="token operator">=</span> conn.getTable<span class="token punctuation">(</span>TableName.valueOf<span class="token punctuation">(</span>tableName<span class="token punctuation">))</span>

    try <span class="token punctuation">{</span>
      //获取HBase表的region分布
      val regionLocation <span class="token operator">=</span> conn.getregionLocation<span class="token punctuation">(</span>TableName.valueOf<span class="token punctuation">(</span>tableName<span class="token punctuation">))</span>
      //创建一个hadoop的mapreduce的job
      val job <span class="token operator">=</span> Job.getInstance<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
      //设置job名称，任意命名
      job.setJobName<span class="token punctuation">(</span><span class="token string">&quot;Hive2HBase&quot;</span><span class="token punctuation">)</span>
      //输出文件的内容KeyValue
      job.setMapOutputValueClass<span class="token punctuation">(</span>classOf<span class="token punctuation">[</span>KeyValue<span class="token punctuation">]</span><span class="token punctuation">)</span>
      //设置文件输出key, outkey要用ImmutableBytesWritable
      job.setMapOutputKeyClass<span class="token punctuation">(</span>classOf<span class="token punctuation">[</span>ImmutableBytesWritable<span class="token punctuation">]</span><span class="token punctuation">)</span>
      //配置HFileOutputFormat2的信息
      HFileOutputFormat2.configureIncrementalLoad<span class="token punctuation">(</span>job, table, regionLocation<span class="token punctuation">)</span>
      //开始导入
      load.doBulkLoad<span class="token punctuation">(</span>new Path<span class="token punctuation">(</span>locatedir<span class="token punctuation">)</span>, conn.getAdmin, table, regionLocation<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> finally <span class="token punctuation">{</span>
      table.close<span class="token punctuation">(</span><span class="token punctuation">)</span>
      conn.close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    spark.close<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>        提交Spark任务，将HFile中数据bulkload到HBase中。执行完成后，可以在HBase中看到该数据已经写入“userprofile_labels”中</p> <p><img src="https://img-blog.csdnimg.cn/20210222231310996.png" alt=""> <font color="	tomato">在线接口在查询HBase中数据时，由于HBase无法像关系数据库那样根据多种条件对数据进行筛选</font>（类似SQL语言中的where筛选条件）。<font color="	tomato">一般地HBase需建立<strong>二级索引</strong>来满足根据复杂条件查询数据的需求</font>，本案中选用 <strong>Elasticsearch</strong> 存储HBase索引数据</p> <p>        在组合标签查询对应的用户人群场景中，首先通过组合标签的条件在 Elasticsearch 中查询对应的索引数据，然后通过索引数据去 HBase中批量获取 rowkey 对应的数据（<strong>Elasticsearch中的documentid和HBase中的rowkey都设计为用户id</strong>）</p> <p><img src="https://img-blog.csdnimg.cn/20210222231635143.png?,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMxODgzMA==,size_16,color_FFFFFF,t_70" alt="">
        为了避免从 Hive 向 HBase 灌入数据时缺失，在向HBase数据同步完成后，还需要<strong>校验HBase和Hive中数据量是否一致</strong>，如出现较大的波动则发送告警信息。</p> <p>        下面通过Python脚本来看该HBase状态表数据校验逻辑：</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token comment"># 查询Hive中数据</span>
def check_Hive_data<span class="token punctuation">(</span>data_date<span class="token punctuation">)</span>:
      r = os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">&quot;Hive -S -e\&quot;</span><span class="token function">select</span> count<span class="token punctuation">(</span>1<span class="token punctuation">)</span> <span class="token keyword">from</span> dw<span class="token punctuation">.</span>userprofile_usergroup_labels_all where data_date=<span class="token string">'&quot;+data_date+&quot;'</span>\<span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
      Hive_userid_count = r<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
      r<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
      Hive_count = str<span class="token punctuation">(</span>int<span class="token punctuation">(</span>Hive_userid_count<span class="token punctuation">)</span> 
      print <span class="token string">&quot;Hive_result: &quot;</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>Hive_count<span class="token punctuation">)</span>
      print <span class="token string">&quot;Hive select finished!&quot;</span>

<span class="token comment"># 查询HBase中数据 </span>
def check_HBase_data<span class="token punctuation">(</span>data_date<span class="token punctuation">)</span>:
      r = os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">&quot;HBase  org.apache.hadoop.HBase.mapreduce.RowCounter 'userprofile_labels'\&quot;</span> 2&gt;&amp;1 <span class="token punctuation">|</span>grep ROWS<span class="token string">&quot;)
      HBase_count = r.read().strip()[5:]
      r.close()
      print &quot;</span>HBase result: <span class="token string">&quot; + str(HBase_count)
      print &quot;</span>HBase <span class="token function">select</span> finished<span class="token operator">!</span><span class="token string">&quot;

# 连接 DB,将查询结果插入表
db = MySQLdb.connect(host=&quot;</span>xx<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>xx<span class="token string">&quot;,port=3306,user=&quot;</span>username<span class="token string">&quot;, passwd=&quot;</span>password<span class="token string">&quot;, db=&quot;</span>xxx<span class="token string">&quot;, charset=&quot;</span>utf8<span class="token string">&quot;)
cursor = db.cursor()
cursor.execute(&quot;</span>INSERT INTO service_monitor<span class="token punctuation">(</span>date<span class="token punctuation">,</span> service_type<span class="token punctuation">,</span> Hive_count<span class="token punctuation">,</span> HBase_count<span class="token punctuation">)</span> VALUES<span class="token punctuation">(</span><span class="token string">'&quot;+datestr_+&quot;'</span><span class="token punctuation">,</span> <span class="token string">'advertisement'</span><span class="token punctuation">,</span> <span class="token string">&quot;+str(Hive_userid_count)+&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;+str(HBase_count)+&quot;</span><span class="token punctuation">)</span>&quot;<span class="token punctuation">)</span>
db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>        本案例中将 userid 作为 rowkey 存入HBase，一方面在组合标签的场景中可以支持条件查询多用户人群，另一方面可以支持单个用户标签的查询，例如查看某 id 用户身上的标签，以便运营人员决定是否对其进行运营操作。</p> <p><strong>HBase在离线数仓环境的服务架构如图所示</strong>：</p> <p><img src="https://img-blog.csdnimg.cn/20210222232403415.png?,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMxODgzMA==,size_16,color_FFFFFF,t_70" alt=""></p> <h1 id=""><a href="#" class="header-anchor">#</a></h1> <h2 id="_4-标签数据存储之elasticsearch"><a href="#_4-标签数据存储之elasticsearch" class="header-anchor">#</a> 4. 标签数据存储之Elasticsearch</h2> <h3 id="elasticsearch简介"><a href="#elasticsearch简介" class="header-anchor">#</a> Elasticsearch简介</h3> <p><font color="tomato">Elasticsearch 是一个开源的分布式全文检索引擎，可以近乎实时地存储、检索数据</font>。而且<font color="RoyalBlue">可扩展性很好，可以扩展到上百台服务器，处理PB级别的数据</font>。对于<strong>用户标签查询</strong>、<strong>用户人群计算</strong>、<strong>用户群多维透视分析</strong>这类对响应时间要求较高的场景，也可以考虑选用Elasticsearch进行存储。</p> <p>        Elasticsearch是面向文档型数据库，<strong>一条数据在这里就是一个文档</strong>，用 json 作为文档格式。为了更清晰地理解 Elasticsearch 查询的一些概念，将其和关系型数据库的类型进行对照。</p> <table><thead><tr><th>Elasticsearch</th> <th>MySQL</th> <th></th></tr></thead> <tbody><tr><td>index</td> <td>database</td> <td>数据库</td></tr> <tr><td>type</td> <td>table</td> <td>表</td></tr> <tr><td>document</td> <td>row</td> <td>行</td></tr> <tr><td>mapping</td> <td>column</td> <td>列</td></tr> <tr><td>GET http://...</td> <td>SELECT * FROM ...</td> <td>查询数据</td></tr> <tr><td>PUT http://...</td> <td>UPDATE table SET...</td> <td>插入数据</td></tr></tbody></table> <p>        在关系型数据库中查询数据时可通过选中数据库、表、行、列来定位所查找的内容，在Elasticsearch中通过<strong>索引（index）、类型（type）、文档（document）、字段</strong>来定位查找内容。一个Elasticsearch集群可以包括多个索引（数据库），也就是说，其中包含了很多类型（表），这些类型中包含了很多的文档（行），然后每个文档中又包含了很多的字段（列）。Elasticsearch的交互可以使用Java API，也可以使用 <strong>HTTP</strong> 的<strong>RESTful API</strong>方式。</p> <h3 id="应用场景"><a href="#应用场景" class="header-anchor">#</a> 应用场景</h3> <p>        在上一节的内容中，我们谈到基于 HBase 的存储方案并没有解决数据的 <strong>高效检索</strong> 问题。在实际应用中，经常有<strong>根据特定的几个字段进行组合后检索</strong>的应用场景，而 <font color="blue">HBase 采用 rowkey 作为一级索引，不支持多条件查询</font>，如果要对库里的非 rowkey 进行数据检索和查询，往往需要通过 MapReduce 等分布式框架进行计算，时间延迟上会比较高，<strong>难以同时满足用户对于复杂条件查询和高效率响应这两方面的需求</strong>。</p> <p><font color="	Tomato">为了既能支持对数据的<strong>高效查询</strong>，同时也能支持通过条件筛选进行复杂查询，需要在HBase上构建<strong>二级索引</strong>，以满足对应的需要</font>。在本案中我们采用<strong>Elasticsearch</strong>存储 HBase 的索引信息，以支持复杂高效的查询功能。</p> <p>        主要查询过程包括：</p> <p>        1）在Elasticsearch中存放用于检索条件的数据，并将rowkey 也存储进去；</p> <p>        2）使用Elasticsearch的 API 根据组合标签的条件查询出rowkey的集合；</p> <p>        3）使用上一步得到的 rowkey 去HBase数据库查询对应的结果
<img src="https://img-blog.csdnimg.cn/20210224004308194.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMxODgzMA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">
        HBase存储数据的索引放在Elasticsearch中，实现了<strong>数据和索引的分离</strong>。在Elasticsearch中<code>documentid</code>是文档的唯一标识，在HBase中<code>rowkey</code>是记录的唯一标识。在工程实践中，两者可同时选用用户在平台上的唯一标识（如userid或deviceid）作为rowkey或documentid，进而解决 HBase 和 Elasticsearch 索引关联的问题。</p> <p>        下面通过使用 Elasticsearch 解决用户人群计算和分析应用场景的案例来了解这一过程。</p> <p>        对汇聚后的用户标签表dw.<code>userprofile_userlabel_map_all</code>中的数据进行清洗，过滤掉一些无效字符，达到导入Elasticsearch的条件，如图所示：</p> <p><img src="https://img-blog.csdnimg.cn/20210224230659422.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMxODgzMA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">
        然后将dw.<code>userprofile_userlabel_map_all</code>数据写入<strong>Elasticsearch</strong> 中，Scala代码如下：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">object</span> HiveDataToEs <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token keyword">val</span> spark <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>AppName<span class="token punctuation">(</span><span class="token string">&quot;EsData&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.serializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.spark.serializer.KryoSerializer&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.dynamicAllocation.enabled&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;es.index.auto.create&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;es.nodes&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;10.xx.xx.xx&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;es.batch.write.retry.count&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span>    <span class="token comment">// 默认重试3次</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;es.batch.write.retry.wait&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span>   <span class="token comment">// 每次重试等待时间为5秒</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;thread_pool.write.queue_size&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1000&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;thread_pool.write.size&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;50&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;thread_pool.write.type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fixed&quot;</span><span class="token punctuation">)</span>   
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;es.batch.size.bytes&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;20mb&quot;</span><span class="token punctuation">)</span>  
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;es.batch.size.entries&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2000&quot;</span><span class="token punctuation">)</span>  
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;es.http.timeout&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;100m&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>enableHiveSupport<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> data_date  <span class="token operator">=</span> args<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toString
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>sql</span>
    <span class="token keyword">val</span> hiveDF <span class="token operator">=</span> sql<span class="token punctuation">(</span>
      s<span class="token triple-quoted-string string">&quot;&quot;&quot;
         | SELECT userid, tagsmap FROM dw.userprofile_userlabel_map_all where data_date = '${data_date}'
      &quot;&quot;&quot;</span><span class="token punctuation">.</span>stripMargin<span class="token punctuation">)</span>    <span class="token comment">// dw.userprofile_userlabel_map_all 是聚合用户标签的表</span>

    <span class="token keyword">val</span> rdd <span class="token operator">=</span> hiveDF<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span>map <span class="token punctuation">{</span>
      row <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> userid <span class="token operator">=</span> row<span class="token punctuation">.</span>getAs<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;userid&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> userlabels <span class="token operator">=</span> row<span class="token punctuation">.</span>getAs<span class="token punctuation">[</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> Object<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;userlabels&quot;</span><span class="token punctuation">)</span>
        Map<span class="token punctuation">(</span><span class="token string">&quot;userid&quot;</span> <span class="token operator">-&gt;</span> userid<span class="token punctuation">,</span> <span class="token string">&quot;userlabels&quot;</span> <span class="token operator">-&gt;</span> userlabels<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    EsSpark<span class="token punctuation">.</span>saveToEs<span class="token punctuation">(</span>rdd <span class="token punctuation">,</span> <span class="token string">&quot;userprofile/tags&quot;</span><span class="token punctuation">,</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;es.mApping.id&quot;</span><span class="token operator">-&gt;</span><span class="token string">&quot;userid&quot;</span><span class="token punctuation">)</span>   
    spark<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>        工程依赖如下：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.elasticsearch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>elasticsearch-hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>6.4.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>        将该工程打包之后提交任务，传入日期分区参数 “20190101”执行。提交命令<code>“spark-submit--class com.example.HiveDataToEs--master yarn--deploy-mode client--executor-memory 2g--num-executors 50--driver-memory 3g--executor-cores 2 spark-hive-to-es.jar 20190101”</code></p> <p>        任务执行完毕后，当日 userid 维度的用户标签数据全部导入Elasticsearch中。使用RESTfulAPI查询包含某个标签的用户量，可实时得到返回结果。</p> <div class="language-json extra-class"><pre class="language-json"><code># 查询命令
GET userprofile/tags/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;tagcounts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tags.ACTION_U_01_003&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://img-blog.csdnimg.cn/20210224231410177.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMxODgzMA==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述">
        从返回结果中可以看到，用户总量（total）为100000000人，包含标签“<code>ACTION_U_01_003</code>”的用户有2500000人（doc_count）。</p> <p>        查询人群 index 查看标签总量：</p> <div class="language-json extra-class"><pre class="language-json"><code># 查询命令
GET userprofile/_search 
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>        查询结果如图所示：
<img src="https://img-blog.csdnimg.cn/2021022423172936.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMxODgzMA==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述">
        在人群的计算和分析场景中，经过产品的迭代，前期采用 <strong>Impala</strong> 进行计算，一般耗费几十秒到几分钟的时间，在使用 Elasticsearch 后，实现了对人群计算的秒级响应。</p> <h3 id="工程化案例"><a href="#工程化案例" class="header-anchor">#</a> 工程化案例</h3> <p>        下面通过一个工程案例来讲解实现画像产品中“用户人群”和“人群分析”功能对用户群计算秒级响应的一种解决方案。</p> <p>        在每天的 ETL 调度中，需要将 Hive 计算的标签数据导入Elasticsearch中。如图所示，在标签调度完成且通过校验后（图中的“标签监控预警”任务执行完成后），将标签数据同步到Elasticsearch中。</p> <p><img src="https://img-blog.csdnimg.cn/20210224232257644.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMxODgzMA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">
        在与 Elasticsearch 数据同步完成并通过校验后，向在  MySQL 中维护的状态表中插入一条状态记录，表示当前日期的 Elasticsearch 数据可用，线上计算用户人群的接口则读取最近日期对应的数据。如果某天因为调度延迟等方面的原因，没有及时将当日数据导入Elasticsearch中，接口也能读取最近一天对应的数据，是一种可行的灾备方案。</p> <p>        例如，数据同步完成后向MySQL状态表“elasticsearch_state”中插入记录（如图所示），当日数据产出正常时，state字段为“0”，产出异常时为“1”。图3-29中1月20日导入的数据出现异常，则“state”状态字段置1，线上接口扫描该状态记录位后不读取1月20日数据，而是取用最近的1月19日数据。</p> <p><img src="https://img-blog.csdnimg.cn/20210224232536590.png#pic_center" alt="在这里插入图片描述">
        为了避免从 Hive 向 Elasticsearch 中灌入数据时发生数据缺失，在向状态表更新状态位前需要校验 Elasticsearch 和 Hive 中的数据量是否一致。下面通过Python脚本来看<strong>数据校验逻辑</strong>：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 查询Hive中的数据</span>
<span class="token keyword">def</span> <span class="token function">monitor_hive_data</span><span class="token punctuation">(</span>data_date<span class="token punctuation">)</span><span class="token punctuation">:</span>
    hive_user <span class="token operator">=</span> <span class="token string">&quot; select count(1) from dw.userprofile_userlabel_map_all where data_date='{}' &quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>data_date<span class="token punctuation">)</span>
    user_count <span class="token operator">=</span> os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">&quot;hive -S -e \&quot;&quot;</span> <span class="token operator">+</span> hive_user <span class="token operator">+</span> <span class="token string">&quot;\&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> user_count

<span class="token comment"># 查询es中的数据</span>
<span class="token keyword">def</span> <span class="token function">monitor_es_data</span><span class="token punctuation">(</span>data_date<span class="token punctuation">)</span><span class="token punctuation">:</span>
    userid_search <span class="token operator">=</span> <span class="token string">&quot;curl http://10.xxx.xxx.xxx:9200/_cat/count/&quot;</span> <span class="token operator">+</span> data_date <span class="token operator">+</span> <span class="token string">&quot;_userid/&quot;</span>
    userid_num <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span>userid_search<span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> userid_num

<span class="token comment"># 比较Hive和es中的数据，如通过校验，更新MySQL状态位</span>
<span class="token keyword">def</span> <span class="token function">update_es_data</span><span class="token punctuation">(</span>data_date<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    data_date: 查询数据日期
    '''</span>
    esdata <span class="token operator">=</span> monitor_es_data<span class="token punctuation">(</span>data_date<span class="token punctuation">)</span>    <span class="token comment"># 查询es中的数据</span>
    hivedata <span class="token operator">=</span> monitor_hive_data<span class="token punctuation">(</span>data_date<span class="token punctuation">)</span>  <span class="token comment"># 查询Hive中的数据</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;esdata ======&gt;{}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>esdata<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;hivedata ======&gt;{}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>hivedata<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 更新MySQL状态位 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>esdata<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> hivedata<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">:</span>
        db <span class="token operator">=</span> MySQLdb<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">&quot;10.xx.xx.xx&quot;</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">3306</span><span class="token punctuation">,</span> user<span class="token operator">=</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span> passwd<span class="token operator">=</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span>
                             db<span class="token operator">=</span><span class="token string">&quot;userprofile&quot;</span><span class="token punctuation">,</span> charset<span class="token operator">=</span><span class="token string">&quot;utf8&quot;</span><span class="token punctuation">)</span>
        cursor <span class="token operator">=</span> db<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            select_command <span class="token operator">=</span> <span class="token string">&quot;INSERT INTO `elasticsearch_state` VALUES ('&quot;</span><span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>data_date<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">&quot;', 'elasticsearch', '0', '2');&quot;</span>
            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>select_command<span class="token punctuation">)</span>
            db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            db<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
           exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>        上面介绍了在工程化调度流中何时将Hive中的用户标签数据灌入Elasticsearch中，之后业务人员在画像产品端计算人群或透视分析人群时（如图所示），
<img src="https://img-blog.csdnimg.cn/20210224232746353.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMxODgzMA==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p> <p>通过RESTful API访问 Elasticsearch 进行计算</p> <p><img src="https://img-blog.csdnimg.cn/20210224232806313.png?type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMxODgzMA==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p> <blockquote><p>        结合前面几期文章，分别为大家讲解了使用 Hive、MySQL、HBase 和 Elasticsearch 存储标签数据的解决方案，包括：<font color="RoyalBlue">Hive存储数据相关标签表、人群计算表的表结构设计以及ID-Mapping的一种实现方式；MySQL存储标签元数据、监控数据及结果集数据；HBase存储线上接口实时调用的数据；Elasticsearch存储标签用于人群计算和人群多维透视分析</font>。存储过程中涉及如下相关表。</p> <ul><li><code>dw.userprofile_attritube_all</code>：存储人口属性维度的标签表；</li> <li><code>dw.userprofile_action_all</code>：存储行为属性维度的标签表；</li> <li><code>dw.userprofile_consume_all</code>：存储用户消费维度的标签表；</li> <li><code>dw.userprofile_riskmanage_all</code>：存储风险控制维度的标签表；</li> <li><code>dw.userprofile_social_all</code>：存储社交属性维度的标签表；</li> <li><code>dw.userprofile_userlabel_map_all</code>：汇聚用户各维度标签的表；</li> <li><code>dw.userprofile_usergroup_labels_all</code>：存储计算后人群数据的表。</li></ul></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/./datahouse/商业化技术/用户画像：2 数据标签体系.html" class="prev">
        用户画像：数据标签体系
      </a></span> <span class="next"><a href="/./datahouse/商业化技术/用户画像：4 业务数据调研及ETL.html">
        用户画像：业务数据调研及ETL
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="./assets/js/app.9ce0d262.js" defer></script><script src="./assets/js/2.fa5f1a4a.js" defer></script><script src="./assets/js/110.eda784ab.js" defer></script>
  </body>
</html>
