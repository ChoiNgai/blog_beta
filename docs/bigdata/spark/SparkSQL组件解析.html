<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SparkSQL组件解析 | 大数据技术文档</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="./favicon.ico">
    <meta name="description" content="从入门到入土">
    
    <link rel="preload" href="./assets/css/0.styles.e88c5000.css" as="style"><link rel="preload" href="./assets/js/app.dc5b0715.js" as="script"><link rel="preload" href="./assets/js/2.47c06342.js" as="script"><link rel="preload" href="./assets/js/44.e75043b3.js" as="script"><link rel="prefetch" href="./assets/js/10.ef98acb1.js"><link rel="prefetch" href="./assets/js/11.37b04a4d.js"><link rel="prefetch" href="./assets/js/12.cee383a4.js"><link rel="prefetch" href="./assets/js/13.d47b2b52.js"><link rel="prefetch" href="./assets/js/14.77b2b060.js"><link rel="prefetch" href="./assets/js/15.a024878c.js"><link rel="prefetch" href="./assets/js/16.a7201fbc.js"><link rel="prefetch" href="./assets/js/17.79e79675.js"><link rel="prefetch" href="./assets/js/18.7639ae91.js"><link rel="prefetch" href="./assets/js/19.280df9d2.js"><link rel="prefetch" href="./assets/js/20.25a38eac.js"><link rel="prefetch" href="./assets/js/21.0aaf754a.js"><link rel="prefetch" href="./assets/js/22.abdec3c1.js"><link rel="prefetch" href="./assets/js/23.454fb1a0.js"><link rel="prefetch" href="./assets/js/24.5118d094.js"><link rel="prefetch" href="./assets/js/25.b239a8e2.js"><link rel="prefetch" href="./assets/js/26.4af89c7f.js"><link rel="prefetch" href="./assets/js/27.b338361b.js"><link rel="prefetch" href="./assets/js/28.225e99c8.js"><link rel="prefetch" href="./assets/js/29.1749fe14.js"><link rel="prefetch" href="./assets/js/3.376b8cdf.js"><link rel="prefetch" href="./assets/js/30.422f2538.js"><link rel="prefetch" href="./assets/js/31.b1265e4d.js"><link rel="prefetch" href="./assets/js/32.7f4a7aa0.js"><link rel="prefetch" href="./assets/js/33.e8f1b887.js"><link rel="prefetch" href="./assets/js/34.ea398359.js"><link rel="prefetch" href="./assets/js/35.046ac0f0.js"><link rel="prefetch" href="./assets/js/36.f0d4cc9b.js"><link rel="prefetch" href="./assets/js/37.0a7a5f8f.js"><link rel="prefetch" href="./assets/js/38.d06cfcca.js"><link rel="prefetch" href="./assets/js/39.d164c990.js"><link rel="prefetch" href="./assets/js/4.6d1a6719.js"><link rel="prefetch" href="./assets/js/40.6bc1f68d.js"><link rel="prefetch" href="./assets/js/41.e1d9e6f4.js"><link rel="prefetch" href="./assets/js/42.b9146544.js"><link rel="prefetch" href="./assets/js/43.3d89ef90.js"><link rel="prefetch" href="./assets/js/45.fa675a86.js"><link rel="prefetch" href="./assets/js/46.5e1bd863.js"><link rel="prefetch" href="./assets/js/47.8287576d.js"><link rel="prefetch" href="./assets/js/48.7f50621f.js"><link rel="prefetch" href="./assets/js/49.1273014b.js"><link rel="prefetch" href="./assets/js/5.c4786839.js"><link rel="prefetch" href="./assets/js/50.0ace36ad.js"><link rel="prefetch" href="./assets/js/51.955bc85d.js"><link rel="prefetch" href="./assets/js/52.e3bb73d6.js"><link rel="prefetch" href="./assets/js/53.70bca49a.js"><link rel="prefetch" href="./assets/js/54.4f6fe468.js"><link rel="prefetch" href="./assets/js/55.d0ae6f7c.js"><link rel="prefetch" href="./assets/js/56.5bfe7854.js"><link rel="prefetch" href="./assets/js/57.20ab4e15.js"><link rel="prefetch" href="./assets/js/58.cd6e845e.js"><link rel="prefetch" href="./assets/js/59.e31f564e.js"><link rel="prefetch" href="./assets/js/6.81b9d3e2.js"><link rel="prefetch" href="./assets/js/60.7e997bce.js"><link rel="prefetch" href="./assets/js/61.ae3effab.js"><link rel="prefetch" href="./assets/js/62.d40d2f3b.js"><link rel="prefetch" href="./assets/js/63.c7ab6850.js"><link rel="prefetch" href="./assets/js/64.c317433a.js"><link rel="prefetch" href="./assets/js/65.bee18659.js"><link rel="prefetch" href="./assets/js/66.9bc2ca3c.js"><link rel="prefetch" href="./assets/js/67.36393d6f.js"><link rel="prefetch" href="./assets/js/68.50d2a85d.js"><link rel="prefetch" href="./assets/js/69.bbac38d8.js"><link rel="prefetch" href="./assets/js/7.9979a04e.js"><link rel="prefetch" href="./assets/js/70.318eb4aa.js"><link rel="prefetch" href="./assets/js/71.54649836.js"><link rel="prefetch" href="./assets/js/72.3ebd3c24.js"><link rel="prefetch" href="./assets/js/73.24b6f12b.js"><link rel="prefetch" href="./assets/js/74.1dd537ea.js"><link rel="prefetch" href="./assets/js/75.59231e92.js"><link rel="prefetch" href="./assets/js/76.b8f3ef78.js"><link rel="prefetch" href="./assets/js/77.11821a18.js"><link rel="prefetch" href="./assets/js/78.f63e0308.js"><link rel="prefetch" href="./assets/js/79.1c7441a7.js"><link rel="prefetch" href="./assets/js/8.db54d2a5.js"><link rel="prefetch" href="./assets/js/80.0d3fa419.js"><link rel="prefetch" href="./assets/js/81.53362836.js"><link rel="prefetch" href="./assets/js/82.6a9be763.js"><link rel="prefetch" href="./assets/js/83.11a41a2c.js"><link rel="prefetch" href="./assets/js/84.2e76a3fb.js"><link rel="prefetch" href="./assets/js/85.c61a2184.js"><link rel="prefetch" href="./assets/js/86.7d905d1b.js"><link rel="prefetch" href="./assets/js/87.4c907051.js"><link rel="prefetch" href="./assets/js/88.82047d34.js"><link rel="prefetch" href="./assets/js/89.3457441e.js"><link rel="prefetch" href="./assets/js/9.c83a911f.js"><link rel="prefetch" href="./assets/js/90.cc103581.js"><link rel="prefetch" href="./assets/js/91.68961351.js"><link rel="prefetch" href="./assets/js/92.fbb8f838.js">
    <link rel="stylesheet" href="./assets/css/0.styles.e88c5000.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><!----> <span class="site-name">大数据技术文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程基础" class="dropdown-title"><span class="title">编程基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程基础" class="mobile-dropdown-title"><span class="title">编程基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Java基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/java基础语法/" class="nav-link">
  Java基础语法
</a></li><li class="dropdown-subitem"><a href="/./coding-base/" class="nav-link">
  Java基础实战
</a></li></ul></li><li class="dropdown-item"><h4>
          Java进阶(选学)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/java并发编程/java并发编程.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-subitem"><a href="/./coding-base/" class="nav-link">
  Java网络编程
</a></li><li class="dropdown-subitem"><a href="/./coding-base/java集合/Java集合（永盛）.html" class="nav-link">
  Java集合
</a></li><li class="dropdown-subitem"><a href="/./coding-base/java虚拟机/" class="nav-link">
  Java虚拟机
</a></li></ul></li><li class="dropdown-item"><h4>
          计算机基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-subitem"><a href="/./coding-base/数据结构与算法/" class="nav-link">
  数据结构（重要）
</a></li><li class="dropdown-subitem"><a href="/./coding-base/计算机网络/计算机网络（双祥）.html" class="nav-link">
  计算机网络
</a></li><li class="dropdown-subitem"><a href="/./coding-base/操作系统/" class="nav-link">
  操作系统
</a></li></ul></li><li class="dropdown-item"><h4>
          Python（选学）
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/Python/python基础/" class="nav-link">
  Python基础语法
</a></li><li class="dropdown-subitem"><a href="/./coding-base/Python/python库/" class="nav-link">
  Python数据科学库
</a></li></ul></li><li class="dropdown-item"><h4>
          框架（选学）
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/框架/springboot/springboot.html" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-subitem"><a href="/./coding-base/框架/flask/falsk.html" class="nav-link">
  Flask
</a></li><li class="dropdown-subitem"><a href="/./coding-base/框架/vue/flask.html" class="nav-link">
  Vue
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./database/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/./database/hbase/" class="nav-link">
  HBase
</a></li><li class="dropdown-item"><!----> <a href="/./database/clickhouse/" class="nav-link">
  ClickHouse
</a></li><li class="dropdown-item"><!----> <a href="/./database/tidb/" class="nav-link">
  TiDB
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据仓库" class="dropdown-title"><span class="title">数据仓库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据仓库" class="mobile-dropdown-title"><span class="title">数据仓库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./datahouse/大数据基础/bigdata-base.html" class="nav-link">
  大数据基础
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/离线数仓/" class="nav-link">
  离线数仓
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/实时数仓/" class="nav-link">
  实时数仓
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/广告技术/" class="nav-link">
  广告技术
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/电商业务/" class="nav-link">
  电商业务
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据框架及组件" class="dropdown-title"><span class="title">大数据框架及组件</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据框架及组件" class="mobile-dropdown-title"><span class="title">大数据框架及组件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./bigdata/hadoop/" class="nav-link">
  Hadoop
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/hive/" class="nav-link">
  Hive
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/zookeeper/" class="nav-link">
  Zookeeper
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/kafka/" class="nav-link">
  kafka
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/spark/" class="nav-link router-link-active">
  Spark
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/flink/" class="nav-link">
  Flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./other/面经/" class="nav-link">
  面经
</a></li><li class="dropdown-item"><!----> <a href="/./other/机器学习/" class="nav-link">
  机器学习
</a></li></ul></div></div><div class="nav-item"><a href="https://www.memorydrive.online" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/./" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程基础" class="dropdown-title"><span class="title">编程基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程基础" class="mobile-dropdown-title"><span class="title">编程基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Java基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/java基础语法/" class="nav-link">
  Java基础语法
</a></li><li class="dropdown-subitem"><a href="/./coding-base/" class="nav-link">
  Java基础实战
</a></li></ul></li><li class="dropdown-item"><h4>
          Java进阶(选学)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/java并发编程/java并发编程.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-subitem"><a href="/./coding-base/" class="nav-link">
  Java网络编程
</a></li><li class="dropdown-subitem"><a href="/./coding-base/java集合/Java集合（永盛）.html" class="nav-link">
  Java集合
</a></li><li class="dropdown-subitem"><a href="/./coding-base/java虚拟机/" class="nav-link">
  Java虚拟机
</a></li></ul></li><li class="dropdown-item"><h4>
          计算机基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-subitem"><a href="/./coding-base/数据结构与算法/" class="nav-link">
  数据结构（重要）
</a></li><li class="dropdown-subitem"><a href="/./coding-base/计算机网络/计算机网络（双祥）.html" class="nav-link">
  计算机网络
</a></li><li class="dropdown-subitem"><a href="/./coding-base/操作系统/" class="nav-link">
  操作系统
</a></li></ul></li><li class="dropdown-item"><h4>
          Python（选学）
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/Python/python基础/" class="nav-link">
  Python基础语法
</a></li><li class="dropdown-subitem"><a href="/./coding-base/Python/python库/" class="nav-link">
  Python数据科学库
</a></li></ul></li><li class="dropdown-item"><h4>
          框架（选学）
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/./coding-base/框架/springboot/springboot.html" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-subitem"><a href="/./coding-base/框架/flask/falsk.html" class="nav-link">
  Flask
</a></li><li class="dropdown-subitem"><a href="/./coding-base/框架/vue/flask.html" class="nav-link">
  Vue
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./database/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/./database/hbase/" class="nav-link">
  HBase
</a></li><li class="dropdown-item"><!----> <a href="/./database/clickhouse/" class="nav-link">
  ClickHouse
</a></li><li class="dropdown-item"><!----> <a href="/./database/tidb/" class="nav-link">
  TiDB
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据仓库" class="dropdown-title"><span class="title">数据仓库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据仓库" class="mobile-dropdown-title"><span class="title">数据仓库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./datahouse/大数据基础/bigdata-base.html" class="nav-link">
  大数据基础
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/离线数仓/" class="nav-link">
  离线数仓
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/实时数仓/" class="nav-link">
  实时数仓
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/广告技术/" class="nav-link">
  广告技术
</a></li><li class="dropdown-item"><!----> <a href="/./datahouse/电商业务/" class="nav-link">
  电商业务
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据框架及组件" class="dropdown-title"><span class="title">大数据框架及组件</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据框架及组件" class="mobile-dropdown-title"><span class="title">大数据框架及组件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./bigdata/hadoop/" class="nav-link">
  Hadoop
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/hive/" class="nav-link">
  Hive
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/zookeeper/" class="nav-link">
  Zookeeper
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/kafka/" class="nav-link">
  kafka
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/spark/" class="nav-link router-link-active">
  Spark
</a></li><li class="dropdown-item"><!----> <a href="/./bigdata/flink/" class="nav-link">
  Flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./other/面经/" class="nav-link">
  面经
</a></li><li class="dropdown-item"><!----> <a href="/./other/机器学习/" class="nav-link">
  机器学习
</a></li></ul></div></div><div class="nav-item"><a href="https://www.memorydrive.online" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Spark</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./bigdata/spark/" aria-current="page" class="sidebar-link">目录</a></li><li><a href="/./bigdata/spark/Spark SQL Catalyst优化器.html" class="sidebar-link">Spark SQL Catalyst优化器</a></li><li><a href="/./bigdata/spark/SparkSQL组件解析.html" class="active sidebar-link">SparkSQL组件解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#_1-sqlparser" class="sidebar-link">1. SqlParser</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#scala的词法和语法解析器" class="sidebar-link">Scala的词法和语法解析器</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#sqlparser入口" class="sidebar-link">SqlParser入口</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#sqlparser" class="sidebar-link">SqlParser</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#abstractsparksqlparser" class="sidebar-link">AbstractSparkSQLParser</a></li></ul></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#_2-physical-plan" class="sidebar-link">2. Physical Plan</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#sparkplanner" class="sidebar-link">SparkPlanner</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#prepareforexecution" class="sidebar-link">prepareForExecution</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#spark-plan" class="sidebar-link">Spark Plan</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#strategies" class="sidebar-link">Strategies</a></li></ul></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#_3-udf" class="sidebar-link">3. UDF</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#udf注册" class="sidebar-link">UDF注册</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#udf计算" class="sidebar-link">UDF计算</a></li></ul></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#_4-in-memory-columnar-storage" class="sidebar-link">4. In-Memory Columnar Storage</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#用法" class="sidebar-link">用法</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#inmemoryrelation" class="sidebar-link">InMemoryRelation</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#columnbuilder" class="sidebar-link">ColumnBuilder</a></li></ul></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#_5-external-data-source" class="sidebar-link">5. External Data Source</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#外部数据源的注册流程" class="sidebar-link">外部数据源的注册流程</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#外部数据源的核心类" class="sidebar-link">外部数据源的核心类</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#外部数据源table查询的计划解析流程" class="sidebar-link">外部数据源Table查询的计划解析流程</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#如何自定义一个外部数据源" class="sidebar-link">如何自定义一个外部数据源</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#参考" class="sidebar-link">参考</a></li></ul></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#_6-code-generation" class="sidebar-link">6. Code Generation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#scala-reflection" class="sidebar-link">Scala Reflection</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#scala-quasiquotes" class="sidebar-link">Scala Quasiquotes</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#sparksql-code-generation" class="sidebar-link">SparkSQL Code Generation</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#参考-2" class="sidebar-link">参考</a></li></ul></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#_99-推荐资料" class="sidebar-link">99. 推荐资料</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#官方资料" class="sidebar-link">官方资料</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#spark博客" class="sidebar-link">Spark博客</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#spark深入研究" class="sidebar-link">Spark深入研究</a></li><li class="sidebar-sub-header"><a href="/./bigdata/spark/SparkSQL组件解析.html#spark论文" class="sidebar-link">Spark论文</a></li></ul></li></ul></li><li><a href="/./bigdata/spark/SparkSQL调优.html" class="sidebar-link">SparkSQL调优</a></li><li><a href="/./bigdata/spark/Spark运行过程.html" class="sidebar-link">Spark运行过程</a></li><li><a href="/./bigdata/spark/Spark面试题.html" class="sidebar-link">Spark面试题</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="sparksql组件解析"><a href="#sparksql组件解析" class="header-anchor">#</a> SparkSQL组件解析</h1> <h2 id="_1-sqlparser"><a href="#_1-sqlparser" class="header-anchor">#</a> 1. SqlParser</h2> <p>SqlParser是一个SQL语言的解析器，功能是将SQL语句解析成Unresolved Logical Plan。</p> <h3 id="scala的词法和语法解析器"><a href="#scala的词法和语法解析器" class="header-anchor">#</a> Scala的词法和语法解析器</h3> <p>SqlParser使用的是Scala提供的StandardTokenParsers和PackratParsers，分别用于词法解析和语法解析，首先为了理解对SQL语句解析过程的理解，先来看看下面这个简单数字表达式的解析过程。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>util<span class="token punctuation">.</span>parsing<span class="token punctuation">.</span>combinator<span class="token punctuation">.</span></span><span class="token class-name">PackratParsers</span>
<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>util<span class="token punctuation">.</span>parsing<span class="token punctuation">.</span>combinator<span class="token punctuation">.</span>syntactical<span class="token punctuation">.</span></span>_

object <span class="token class-name">MyLexical</span> <span class="token keyword">extends</span> <span class="token class-name">StandardTokenParsers</span> <span class="token keyword">with</span> <span class="token class-name">PackratParsers</span><span class="token punctuation">{</span>

  <span class="token comment">//定义分割符</span>
  lexical<span class="token punctuation">.</span>delimiters <span class="token operator">++</span><span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;+&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">//定义表达式，支持加，减，乘</span>
  lazy val expr<span class="token operator">:</span> <span class="token class-name">PackratParser</span><span class="token punctuation">[</span><span class="token class-name">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> plus <span class="token operator">|</span> minus <span class="token operator">|</span> multi
  <span class="token comment">//加法表示式的实现</span>
  lazy val plus<span class="token operator">:</span> <span class="token class-name">PackratParser</span><span class="token punctuation">[</span><span class="token class-name">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> num <span class="token operator">~</span> <span class="token string">&quot;+&quot;</span> <span class="token operator">~</span> num <span class="token operator">^</span><span class="token operator">^</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> n1 <span class="token operator">~</span> <span class="token string">&quot;+&quot;</span> <span class="token operator">~</span> n2 <span class="token operator">=</span><span class="token operator">&gt;</span> n1<span class="token punctuation">.</span>toInt <span class="token operator">+</span> n2<span class="token punctuation">.</span>toInt<span class="token punctuation">}</span>
  <span class="token comment">//减法表达式的实现</span>
  lazy val minus<span class="token operator">:</span> <span class="token class-name">PackratParser</span><span class="token punctuation">[</span><span class="token class-name">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> num <span class="token operator">~</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">~</span> num <span class="token operator">^</span><span class="token operator">^</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> n1 <span class="token operator">~</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">~</span> n2 <span class="token operator">=</span><span class="token operator">&gt;</span> n1<span class="token punctuation">.</span>toInt <span class="token operator">-</span> n2<span class="token punctuation">.</span>toInt<span class="token punctuation">}</span>
  <span class="token comment">//乘法表达式的实现</span>
  lazy val multi<span class="token operator">:</span> <span class="token class-name">PackratParser</span><span class="token punctuation">[</span><span class="token class-name">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> num <span class="token operator">~</span> <span class="token string">&quot;*&quot;</span> <span class="token operator">~</span> num <span class="token operator">^</span><span class="token operator">^</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> n1 <span class="token operator">~</span> <span class="token string">&quot;*&quot;</span> <span class="token operator">~</span> n2 <span class="token operator">=</span><span class="token operator">&gt;</span> n1<span class="token punctuation">.</span>toInt <span class="token operator">*</span> n2<span class="token punctuation">.</span>toInt<span class="token punctuation">}</span>
  lazy val num <span class="token operator">=</span> numericLit

  def <span class="token function">parse</span><span class="token punctuation">(</span>input<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//定义词法读入器myread，并将扫描头放置在input的首位</span>
    val myread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackratReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">lexical<span class="token punctuation">.</span></span>Scanner</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;处理表达式 &quot;</span> <span class="token operator">+</span> input<span class="token punctuation">)</span>
    <span class="token function">phrase</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span><span class="token punctuation">(</span>myread<span class="token punctuation">)</span> match <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token class-name">Success</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot; Success!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
      <span class="token keyword">case</span> n <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Err!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">None</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    val prg <span class="token operator">=</span> <span class="token string">&quot;6 * 3&quot;</span> <span class="token operator">::</span> <span class="token string">&quot;24-/*aaa*/4&quot;</span> <span class="token operator">::</span> <span class="token string">&quot;a+5&quot;</span> <span class="token operator">::</span> <span class="token string">&quot;21/3&quot;</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
    prg<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parse<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>运行结果：</p> <div class="language-java extra-class"><pre class="language-java"><code>处理表达式 <span class="token number">6</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token class-name">Success</span><span class="token operator">!</span>     <span class="token comment">//lexical对空格进行了处理，得到6*3</span>
<span class="token number">18</span>     <span class="token comment">//6*3符合乘法表达式，调用n1.toInt * n2.toInt，得到结果并返回</span>
处理表达式 <span class="token number">24</span><span class="token operator">-</span><span class="token comment">/*aaa*/</span><span class="token number">4</span> <span class="token class-name">Success</span><span class="token operator">!</span>  <span class="token comment">//lexical对注释进行了处理，得到20-4</span>
<span class="token number">20</span>    <span class="token comment">//20-4符合减法表达式，调用n1.toInt - n2.toInt，得到结果并返回</span>
处理表达式 a<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">]</span> failure<span class="token operator">:</span> number expected
      <span class="token comment">//lexical在解析到a，发现不是整数型，故报错误位置和内容</span>
a<span class="token operator">+</span><span class="token number">5</span>
<span class="token operator">^</span>
<span class="token class-name">Err</span><span class="token operator">!</span>
处理表达式 <span class="token number">21</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">[</span><span class="token number">1.3</span><span class="token punctuation">]</span> failure<span class="token operator">:</span> ``<span class="token operator">*</span><span class="token string">''</span> expected but <span class="token class-name">ErrorToken</span><span class="token punctuation">(</span>illegal character<span class="token punctuation">)</span> found
      <span class="token comment">//lexical在解析到/，发现不是分割符，故报错误位置和内容</span>
<span class="token number">21</span><span class="token operator">/</span><span class="token number">3</span>
  <span class="token operator">^</span>
<span class="token class-name">Err</span><span class="token operator">!</span>
</code></pre></div><p>在运行的时候，首先对表达式 6 * 3 进行解析，词法读入器myread将扫描头置于6的位置；当phrase()函数使用定义好的数字表达式expr处理6 * 3的时候，每读入一个词就和expr进行匹配，如读入6*3和expr进行匹配，先匹配表达式plus，*和+匹配不上；就继续匹配表达式minus，*和-匹配不上；就继续匹配表达式multi，这次匹配上了，等读入3的时候，因为3是num类型，就调用调用n1.toInt * n2.toInt进行计算。</p> <p>注意，这里的expr、plus、minus、multi、num都是表达式，|、~、^^是复合因子，表达式和复合因子可以组成一个新的表达式，如plus（num ~ &quot;+&quot; ~ num ^^ { case n1 ~ &quot;+&quot; ~ n2 =&gt; n1.toInt + n2.toInt}）就是一个由num、+、num、函数构成的复合表达式；而expr（plus | minus | multi）是由plus、minus、multi构成的复合表达式；复合因子的含义定义在类scala/util/parsing/combinator/Parsers.scala，下面是几个常用的复合因子：</p> <table><thead><tr><th>表达式</th> <th>含义</th></tr></thead> <tbody><tr><td>p ~ q</td> <td>p成功，才会q，放回p,q的结果</td></tr> <tr><td>p ~&gt; q</td> <td>p成功，才会q，返回q的结果</td></tr> <tr><td>p &lt;~ q</td> <td>p成功，才会q，返回p的结果</td></tr> <tr><td>p 或 q</td> <td>p失败则q，返回第一个成功的结果</td></tr> <tr><td>p ^^ f</td> <td>如果p成功，将函数f应用到p的结果上</td></tr> <tr><td>p ^? f</td> <td>如果p成功，如果函数f可以应用到p的结果上的话，就将p的结果用f进行转换</td></tr></tbody></table> <p>针对上面的6 * 3使用的是multi表达式</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token punctuation">(</span>num <span class="token operator">~</span> <span class="token string">&quot;\*&quot;</span> <span class="token operator">~</span> num <span class="token operator">^</span><span class="token operator">^</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> n1 <span class="token operator">~</span> <span class="token string">&quot;\*&quot;</span> <span class="token operator">~</span> n2 <span class="token operator">=</span><span class="token operator">&gt;</span> n1<span class="token punctuation">.</span>toInt \<span class="token operator">*</span> n2<span class="token punctuation">.</span>toInt<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>其含义就是：num后跟*再跟num，如果满足就将使用函数n1.toInt * n2.toInt。</p> <h3 id="sqlparser入口"><a href="#sqlparser入口" class="header-anchor">#</a> SqlParser入口</h3> <p>SqlParser的入口在SqlContext的sql()函数，该函数会调用parserSql并返回SchemaRDD。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
   * Executes a SQL query using Spark, returning the result as a SchemaRDD.  The dialect that is
   * used for SQL parsing can be configured with 'spark.sql.dialect'.
   *
   * @group userf
   */</span>
  def <span class="token function">sql</span><span class="token punctuation">(</span>sqlText<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">SchemaRDD</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dialect <span class="token operator">==</span> <span class="token string">&quot;sql&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">new</span> <span class="token class-name">SchemaRDD</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">parseSql</span><span class="token punctuation">(</span>sqlText<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      sys<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>s<span class="token string">&quot;Unsupported SQL dialect: $dialect&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>parseSql会调用ddlParser，如果不成功就调用sqlParser。接着sqlParser会调用SparkSQLParser，并且把catalyst.SqlParser传递进去。</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token keyword">protected</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> def <span class="token function">parseSql</span><span class="token punctuation">(</span>sql<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">LogicalPlan</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">ddlParser</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span><span class="token function">sqlParser</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

    <span class="token keyword">protected</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> val sqlParser <span class="token operator">=</span> <span class="token punctuation">{</span>
    val fallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">catalyst<span class="token punctuation">.</span></span>SqlParser</span>
    <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">catalyst<span class="token punctuation">.</span></span>SparkSQLParser</span><span class="token punctuation">(</span><span class="token function">fallback</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>SparkSQLParser的功能是解析SparkSQL特有的语法，例如cache，lazy等。SparkSQLParser会首先按照自己定义的词法和语法进行解析，当遇到以下两种情况的时候，会调用传递进来的catalyst.SqlParser:</p> <ol><li>Cache关键字后面的语法解析</li> <li>其他SparkSQLParser未定义的语法</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> <span class="token keyword">class</span> <span class="token class-name">SparkSQLParser</span><span class="token punctuation">(</span>fallback<span class="token operator">:</span> <span class="token class-name">String</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSparkSQLParser</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">private</span> lazy val cache<span class="token operator">:</span> <span class="token class-name">Parser</span><span class="token punctuation">[</span><span class="token class-name">LogicalPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span>
    CACHE <span class="token operator">~</span><span class="token operator">&gt;</span> LAZY<span class="token punctuation">.</span>? <span class="token operator">~</span> <span class="token punctuation">(</span>TABLE <span class="token operator">~</span><span class="token operator">&gt;</span> ident<span class="token punctuation">)</span> <span class="token operator">~</span> <span class="token punctuation">(</span>AS <span class="token operator">~</span><span class="token operator">&gt;</span> restInput<span class="token punctuation">)</span><span class="token punctuation">.</span>? <span class="token operator">^</span><span class="token operator">^</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> isLazy <span class="token operator">~</span> tableName <span class="token operator">~</span> plan <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name">CacheTableCommand</span><span class="token punctuation">(</span>tableName<span class="token punctuation">,</span> plan<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>fallback<span class="token punctuation">)</span><span class="token punctuation">,</span> isLazy<span class="token punctuation">.</span>isDefined<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">private</span> lazy val others<span class="token operator">:</span> <span class="token class-name">Parser</span><span class="token punctuation">[</span><span class="token class-name">LogicalPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span>
    wholeInput <span class="token operator">^</span><span class="token operator">^</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> input <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">fallback</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="sqlparser"><a href="#sqlparser" class="header-anchor">#</a> SqlParser</h3> <p>SqlParser继承自AbstractSparkSQLParser，而AbstractSparkSQLParser继承自StandardTokenParsers和 PackratParsers。SqlParser中定义了SQL语言的词法和语法规则：</p> <p><strong>词法：</strong> SqlParser首先定义了一堆Keyword，然后通过反射机制把这些Keyword全部加到一个reservedWords的集合当中，最后把这些关键字加到SqlLexical中。SqlLexical中除了定义关键字以外，还定义了分隔符。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">SqlParser</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSparkSQLParser</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">protected</span> val ABS <span class="token operator">=</span> <span class="token class-name">Keyword</span><span class="token punctuation">(</span><span class="token string">&quot;ABS&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">protected</span> val ALL <span class="token operator">=</span> <span class="token class-name">Keyword</span><span class="token punctuation">(</span><span class="token string">&quot;ALL&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">protected</span> val AND <span class="token operator">=</span> <span class="token class-name">Keyword</span><span class="token punctuation">(</span><span class="token string">&quot;AND&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">protected</span> val APPROXIMATE <span class="token operator">=</span> <span class="token class-name">Keyword</span><span class="token punctuation">(</span><span class="token string">&quot;APPROXIMATE&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">protected</span> val AS <span class="token operator">=</span> <span class="token class-name">Keyword</span><span class="token punctuation">(</span><span class="token string">&quot;AS&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">protected</span> val ASC <span class="token operator">=</span> <span class="token class-name">Keyword</span><span class="token punctuation">(</span><span class="token string">&quot;ASC&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">protected</span> val AVG <span class="token operator">=</span> <span class="token class-name">Keyword</span><span class="token punctuation">(</span><span class="token string">&quot;AVG&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">protected</span> val BETWEEN <span class="token operator">=</span> <span class="token class-name">Keyword</span><span class="token punctuation">(</span><span class="token string">&quot;BETWEEN&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">protected</span> val reservedWords <span class="token operator">=</span>
    <span class="token keyword">this</span>
      <span class="token punctuation">.</span>getClass
      <span class="token punctuation">.</span>getMethods
      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>getReturnType <span class="token operator">==</span> classOf<span class="token punctuation">[</span><span class="token class-name">Keyword</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span><span class="token class-name">Keyword</span><span class="token punctuation">]</span><span class="token punctuation">.</span>str<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  override val lexical <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlLexical</span><span class="token punctuation">(</span>reservedWords<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">SqlLexical</span><span class="token punctuation">(</span>val keywords<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> <span class="token class-name">StdLexical</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  reserved <span class="token operator">++</span><span class="token operator">=</span> keywords<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>w <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">allCaseVersions</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">)</span>

  delimiters <span class="token operator">+=</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;@&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;+&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;=&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;&gt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;!=&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;=&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&gt;=&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&gt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;(&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;%&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;{&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;}&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;[&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;|&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;^&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;~&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;=&gt;&quot;</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>语法：</strong> sql语法的根节点是<code>val start: Parser[LogicalPlan]</code>，语法树的返回类型是<code>LogicalPlan</code>。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">SqlParser</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSparkSQLParser</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">protected</span> lazy val start<span class="token operator">:</span> <span class="token class-name">Parser</span><span class="token punctuation">[</span><span class="token class-name">LogicalPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span>
    <span class="token punctuation">(</span> select <span class="token operator">*</span>
      <span class="token punctuation">(</span> UNION <span class="token operator">~</span> ALL        <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>q1<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">,</span> q2<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Union</span><span class="token punctuation">(</span>q1<span class="token punctuation">,</span> q2<span class="token punctuation">)</span> <span class="token punctuation">}</span>
      <span class="token operator">|</span> INTERSECT          <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>q1<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">,</span> q2<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Intersect</span><span class="token punctuation">(</span>q1<span class="token punctuation">,</span> q2<span class="token punctuation">)</span> <span class="token punctuation">}</span>
      <span class="token operator">|</span> EXCEPT             <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>q1<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">,</span> q2<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Except</span><span class="token punctuation">(</span>q1<span class="token punctuation">,</span> q2<span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">|</span> UNION <span class="token operator">~</span> DISTINCT<span class="token punctuation">.</span>? <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>q1<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">,</span> q2<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Distinct</span><span class="token punctuation">(</span><span class="token class-name">Union</span><span class="token punctuation">(</span>q1<span class="token punctuation">,</span> q2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
    <span class="token operator">|</span> insert
    <span class="token punctuation">)</span>

  <span class="token keyword">protected</span> lazy val select<span class="token operator">:</span> <span class="token class-name">Parser</span><span class="token punctuation">[</span><span class="token class-name">LogicalPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span>
    SELECT <span class="token operator">~</span><span class="token operator">&gt;</span> DISTINCT<span class="token punctuation">.</span>? <span class="token operator">~</span>
      <span class="token function">repsep</span><span class="token punctuation">(</span>projection<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span> <span class="token operator">~</span>
      <span class="token punctuation">(</span>FROM   <span class="token operator">~</span><span class="token operator">&gt;</span> relations<span class="token punctuation">)</span><span class="token punctuation">.</span>? <span class="token operator">~</span>
      <span class="token punctuation">(</span>WHERE  <span class="token operator">~</span><span class="token operator">&gt;</span> expression<span class="token punctuation">)</span><span class="token punctuation">.</span>? <span class="token operator">~</span>
      <span class="token punctuation">(</span>GROUP  <span class="token operator">~</span>  BY <span class="token operator">~</span><span class="token operator">&gt;</span> <span class="token function">rep1sep</span><span class="token punctuation">(</span>expression<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>? <span class="token operator">~</span>
      <span class="token punctuation">(</span>HAVING <span class="token operator">~</span><span class="token operator">&gt;</span> expression<span class="token punctuation">)</span><span class="token punctuation">.</span>? <span class="token operator">~</span>
      <span class="token punctuation">(</span>ORDER  <span class="token operator">~</span>  BY <span class="token operator">~</span><span class="token operator">&gt;</span> ordering<span class="token punctuation">)</span><span class="token punctuation">.</span>? <span class="token operator">~</span>
      <span class="token punctuation">(</span>LIMIT  <span class="token operator">~</span><span class="token operator">&gt;</span> expression<span class="token punctuation">)</span><span class="token punctuation">.</span>? <span class="token operator">^</span><span class="token operator">^</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> d <span class="token operator">~</span> p <span class="token operator">~</span> r <span class="token operator">~</span> f <span class="token operator">~</span> g <span class="token operator">~</span> h <span class="token operator">~</span> o <span class="token operator">~</span> l  <span class="token operator">=</span><span class="token operator">&gt;</span>
          val base <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span><span class="token class-name">NoRelation</span><span class="token punctuation">)</span>
          val withFilter <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Filter</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
          val withProjection <span class="token operator">=</span> g
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Aggregate</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token function">assignAliases</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> withFilter<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span><span class="token class-name">Project</span><span class="token punctuation">(</span><span class="token function">assignAliases</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> withFilter<span class="token punctuation">)</span><span class="token punctuation">)</span>
          val withDistinct <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>_ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Distinct</span><span class="token punctuation">(</span>withProjection<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span>withProjection<span class="token punctuation">)</span>
          val withHaving <span class="token operator">=</span> h<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Filter</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> withDistinct<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span>withDistinct<span class="token punctuation">)</span>
          val withOrder <span class="token operator">=</span> o<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Sort</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> withHaving<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span>withHaving<span class="token punctuation">)</span>
          val withLimit <span class="token operator">=</span> l<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Limit</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> withOrder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span>withOrder<span class="token punctuation">)</span>
          withLimit
      <span class="token punctuation">}</span>

  <span class="token keyword">protected</span> lazy val insert<span class="token operator">:</span> <span class="token class-name">Parser</span><span class="token punctuation">[</span><span class="token class-name">LogicalPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span>
    INSERT <span class="token operator">~</span><span class="token operator">&gt;</span> OVERWRITE<span class="token punctuation">.</span>? <span class="token operator">~</span> <span class="token punctuation">(</span>INTO <span class="token operator">~</span><span class="token operator">&gt;</span> relation<span class="token punctuation">)</span> <span class="token operator">~</span> select <span class="token operator">^</span><span class="token operator">^</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> o <span class="token operator">~</span> r <span class="token operator">~</span> s <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">InsertIntoTable</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span>empty<span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Option</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> o<span class="token punctuation">.</span>isDefined<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="abstractsparksqlparser"><a href="#abstractsparksqlparser" class="header-anchor">#</a> AbstractSparkSQLParser</h3> <p>sql真正的解析是在AbstractSparkSQLParser中进行的，AbstractSparkSQLParser继承自StandardTokenParsers和PackratParsers。解析功能的核心代码就是：<code>phrase(start)(new lexical.Scanner(input))</code>。可以看得出来，该语句就是调用phrase()函数，使用SQL语法表达式start，对词法读入器lexical读入的SQL语句进行解析，其中</p> <ol><li>词法分析器lexical定义在SqlParser中<code>override val lexical = new SqlLexical(reservedWords)</code></li> <li>语法分析器start定义在SqlParser中<code>protected lazy val start: Parser[LogicalPlan] =...</code></li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractSparkSQLParser</span>
  <span class="token keyword">extends</span> <span class="token class-name">StandardTokenParsers</span> <span class="token keyword">with</span> <span class="token class-name">PackratParsers</span> <span class="token punctuation">{</span>

  def <span class="token function">apply</span><span class="token punctuation">(</span>input<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">LogicalPlan</span> <span class="token operator">=</span> <span class="token function">phrase</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">lexical<span class="token punctuation">.</span></span>Scanner</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span> match <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token class-name">Success</span><span class="token punctuation">(</span>plan<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> plan
    <span class="token keyword">case</span> failureOrError <span class="token operator">=</span><span class="token operator">&gt;</span> sys<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>failureOrError<span class="token punctuation">.</span>toString<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_2-physical-plan"><a href="#_2-physical-plan" class="header-anchor">#</a> 2. Physical Plan</h2> <p>物理计划是Spark SQL执行Spark job的前置，也是最后一道计划。</p> <h3 id="sparkplanner"><a href="#sparkplanner" class="header-anchor">#</a> SparkPlanner</h3> <p>Optimizer接受输入的Analyzed Logical Plan后，会由SparkPlanner来对Optimized Logical Plan进行转换，生成Physical Plan。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">QueryExecution</span> <span class="token punctuation">{</span>
    lazy val analyzed <span class="token operator">=</span> <span class="token class-name">ExtractPythonUdfs</span><span class="token punctuation">(</span><span class="token function">analyzer</span><span class="token punctuation">(</span>logical<span class="token punctuation">)</span><span class="token punctuation">)</span>
    lazy val withCachedData <span class="token operator">=</span> <span class="token function">useCachedData</span><span class="token punctuation">(</span>analyzed<span class="token punctuation">)</span>
    lazy val optimizedPlan <span class="token operator">=</span> <span class="token function">optimizer</span><span class="token punctuation">(</span>withCachedData<span class="token punctuation">)</span>
    lazy val sparkPlan <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token class-name">SparkPlan</span><span class="token punctuation">.</span>currentContext<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span>
      <span class="token function">planner</span><span class="token punctuation">(</span>optimizedPlan<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>SparkPlanner的apply方法，会返回一个Iterator[PhysicalPlan]。SparkPlanner继承了SparkStrategies，SparkStrategies继承了QueryPlanner。SparkStrategies包含了一系列特定的Strategies，这些Strategies是继承自QueryPlanner中定义的Strategy，它定义接受一个Logical Plan，生成一系列的Physical Plan。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> <span class="token keyword">class</span> <span class="token class-name">SparkPlanner</span> <span class="token keyword">extends</span> <span class="token class-name">SparkStrategies</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    val strategies<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Strategy</span><span class="token punctuation">]</span> <span class="token operator">=</span>
      extraStrategies <span class="token operator">++</span> <span class="token punctuation">(</span>
      <span class="token class-name">CommandStrategy</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">::</span>
      <span class="token class-name">DataSourceStrategy</span> <span class="token operator">::</span>
      <span class="token class-name">TakeOrdered</span> <span class="token operator">::</span>
      <span class="token class-name">HashAggregation</span> <span class="token operator">::</span>
      <span class="token class-name">LeftSemiJoin</span> <span class="token operator">::</span>
      <span class="token class-name">HashJoin</span> <span class="token operator">::</span>
      <span class="token class-name">InMemoryScans</span> <span class="token operator">::</span>
      <span class="token class-name">ParquetOperations</span> <span class="token operator">::</span>
      <span class="token class-name">BasicOperators</span> <span class="token operator">::</span>
      <span class="token class-name">CartesianProduct</span> <span class="token operator">::</span>
      <span class="token class-name">BroadcastNestedLoopJoin</span> <span class="token operator">::</span> <span class="token class-name">Nil</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>QueryPlanner 是SparkPlanner的基类，定义了一系列的关键点，如Strategy，planLater和apply。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">QueryPlanner</span><span class="token punctuation">[</span><span class="token class-name">PhysicalPlan</span> <span class="token operator">&lt;</span><span class="token operator">:</span> <span class="token class-name">TreeNode</span><span class="token punctuation">[</span><span class="token class-name">PhysicalPlan</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token comment">/** A list of execution strategies that can be used by the planner */</span>
  def strategies<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">GenericStrategy</span><span class="token punctuation">[</span><span class="token class-name">PhysicalPlan</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

  <span class="token comment">/**
   * Returns a placeholder for a physical plan that executes `plan`. This placeholder will be
   * filled in automatically by the QueryPlanner using the other execution strategies that are
   * available.
   */</span>
  <span class="token keyword">protected</span> def <span class="token function">planLater</span><span class="token punctuation">(</span>plan<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">apply</span><span class="token punctuation">(</span>plan<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  def <span class="token function">apply</span><span class="token punctuation">(</span>plan<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Iterator</span><span class="token punctuation">[</span><span class="token class-name">PhysicalPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// Obviously a lot to do here still...</span>
    val iter <span class="token operator">=</span> strategies<span class="token punctuation">.</span>view<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token function">_</span><span class="token punctuation">(</span>plan<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toIterator
    <span class="token keyword">assert</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span>hasNext<span class="token punctuation">,</span> s<span class="token string">&quot;No plan for $plan&quot;</span><span class="token punctuation">)</span>
    iter
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="prepareforexecution"><a href="#prepareforexecution" class="header-anchor">#</a> prepareForExecution</h3> <p>Spark Plan是Catalyst里经过所有Strategies apply 的最终的物理执行计划的抽象类，它只是用来执行spark job的。</p> <div class="language-java extra-class"><pre class="language-java"><code>  lazy val executedPlan<span class="token operator">:</span> <span class="token class-name">SparkPlan</span> <span class="token operator">=</span> <span class="token function">prepareForExecution</span><span class="token punctuation">(</span>sparkPlan<span class="token punctuation">)</span>
</code></pre></div><p>prepareForExecution其实是一个RuleExecutor[SparkPlan]，当然这里的Rule就是SparkPlan了。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">protected</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> val prepareForExecution <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuleExecutor</span><span class="token punctuation">[</span><span class="token class-name">SparkPlan</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    val batches <span class="token operator">=</span>
      <span class="token class-name">Batch</span><span class="token punctuation">(</span><span class="token string">&quot;Add exchange&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Once</span><span class="token punctuation">,</span> <span class="token class-name">AddExchange</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>prepareForExecution里面只有一条规则：AddExchange。主要工作是检查是否有不匹配的partition类型，如果不兼容就增加一个Exchange节点，用来重新分区。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> <span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">AddExchange</span><span class="token punctuation">(</span>sqlContext<span class="token operator">:</span> <span class="token class-name">SQLContext</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> <span class="token class-name">Rule</span><span class="token punctuation">[</span><span class="token class-name">SparkPlan</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  def <span class="token function">apply</span><span class="token punctuation">(</span>plan<span class="token operator">:</span> <span class="token class-name">SparkPlan</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">SparkPlan</span> <span class="token operator">=</span> plan<span class="token punctuation">.</span>transformUp <span class="token punctuation">{</span>
    <span class="token keyword">case</span> operator<span class="token operator">:</span> <span class="token class-name">SparkPlan</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
      <span class="token comment">// Check if every child's outputPartitioning satisfies the corresponding</span>
      <span class="token comment">// required data distribution.</span>
      def meetsRequirements <span class="token operator">=</span>
        <span class="token operator">!</span>operator<span class="token punctuation">.</span>requiredChildDistribution<span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span>operator<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">.</span>map <span class="token punctuation">{</span>
          <span class="token keyword">case</span> <span class="token punctuation">(</span>required<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
            val valid <span class="token operator">=</span> child<span class="token punctuation">.</span>outputPartitioning<span class="token punctuation">.</span><span class="token function">satisfies</span><span class="token punctuation">(</span>required<span class="token punctuation">)</span>
            <span class="token function">logDebug</span><span class="token punctuation">(</span>
              s<span class="token string">&quot;${if (valid) &quot;</span><span class="token class-name">Valid</span><span class="token string">&quot; else &quot;</span><span class="token class-name">Invalid</span><span class="token string">&quot;} distribution,&quot;</span> <span class="token operator">+</span>
                s<span class="token string">&quot;required: $required current: ${child.outputPartitioning}&quot;</span><span class="token punctuation">)</span>
            valid
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token operator">!</span>_<span class="token punctuation">)</span>

      <span class="token comment">// Check if outputPartitionings of children are compatible with each other.</span>
      <span class="token comment">// It is possible that every child satisfies its required data distribution</span>
      <span class="token comment">// but two children have incompatible outputPartitionings. For example,</span>
      <span class="token comment">// A dataset is range partitioned by &quot;a.asc&quot; (RangePartitioning) and another</span>
      <span class="token comment">// dataset is hash partitioned by &quot;a&quot; (HashPartitioning). Tuples in these two</span>
      <span class="token comment">// datasets are both clustered by &quot;a&quot;, but these two outputPartitionings are not</span>
      <span class="token comment">// compatible.</span>
      <span class="token comment">// TODO: ASSUMES TRANSITIVITY?</span>
      def compatible <span class="token operator">=</span>
        <span class="token operator">!</span>operator<span class="token punctuation">.</span>children
          <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>outputPartitioning<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">sliding</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span>map <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token class-name">Seq</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
            <span class="token keyword">case</span> <span class="token class-name">Seq</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> a compatibleWith b
          <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token operator">!</span>_<span class="token punctuation">)</span>

      <span class="token comment">// Check if the partitioning we want to ensure is the same as the child's output</span>
      <span class="token comment">// partitioning. If so, we do not need to add the Exchange operator.</span>
      def <span class="token function">addExchangeIfNecessary</span><span class="token punctuation">(</span>partitioning<span class="token operator">:</span> <span class="token class-name">Partitioning</span><span class="token punctuation">,</span> child<span class="token operator">:</span> <span class="token class-name">SparkPlan</span><span class="token punctuation">)</span> <span class="token operator">=</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>outputPartitioning <span class="token operator">!=</span> partitioning<span class="token punctuation">)</span> <span class="token class-name">Exchange</span><span class="token punctuation">(</span>partitioning<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token keyword">else</span> child

      <span class="token keyword">if</span> <span class="token punctuation">(</span>meetsRequirements <span class="token operator">&amp;&amp;</span> compatible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        operator
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// At least one child does not satisfies its required data distribution or</span>
        <span class="token comment">// at least one child's outputPartitioning is not compatible with another child's</span>
        <span class="token comment">// outputPartitioning. In this case, we need to add Exchange operators.</span>
        val repartitionedChildren <span class="token operator">=</span> operator<span class="token punctuation">.</span>requiredChildDistribution<span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span>operator<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">.</span>map <span class="token punctuation">{</span>
          <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token class-name">AllTuples</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
            <span class="token function">addExchangeIfNecessary</span><span class="token punctuation">(</span><span class="token class-name">SinglePartition</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span>
          <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token class-name">ClusteredDistribution</span><span class="token punctuation">(</span>clustering<span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
            <span class="token function">addExchangeIfNecessary</span><span class="token punctuation">(</span><span class="token class-name">HashPartitioning</span><span class="token punctuation">(</span>clustering<span class="token punctuation">,</span> numPartitions<span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span>
          <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token class-name">OrderedDistribution</span><span class="token punctuation">(</span>ordering<span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
            <span class="token function">addExchangeIfNecessary</span><span class="token punctuation">(</span><span class="token class-name">RangePartitioning</span><span class="token punctuation">(</span>ordering<span class="token punctuation">,</span> numPartitions<span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span>
          <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token class-name">UnspecifiedDistribution</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> child
          <span class="token keyword">case</span> <span class="token punctuation">(</span>dist<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> sys<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>s<span class="token string">&quot;Don't know how to ensure $dist&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        operator<span class="token punctuation">.</span><span class="token function">withNewChildren</span><span class="token punctuation">(</span>repartitionedChildren<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="spark-plan"><a href="#spark-plan" class="header-anchor">#</a> Spark Plan</h3> <p>Spark Plan是SparkSQL中的Physical Plan。它继承自Query Plan[Spark Plan]，里面定义了partition，requiredChildDistribution以及spark sql启动执行的execute方法。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SparkPlan</span> <span class="token keyword">extends</span> <span class="token class-name">QueryPlan</span><span class="token punctuation">[</span><span class="token class-name">SparkPlan</span><span class="token punctuation">]</span> <span class="token keyword">with</span> <span class="token class-name">Logging</span> <span class="token keyword">with</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
  self<span class="token operator">:</span> <span class="token class-name">Product</span> <span class="token operator">=</span><span class="token operator">&gt;</span>

  <span class="token comment">/** Specifies how data is partitioned across different nodes in the cluster. */</span>
  def outputPartitioning<span class="token operator">:</span> <span class="token class-name">Partitioning</span> <span class="token operator">=</span> <span class="token class-name">UnknownPartitioning</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// TODO: WRONG WIDTH!</span>

  <span class="token comment">/** Specifies any partition requirements on the input data for this operator. */</span>
  def requiredChildDistribution<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Distribution</span><span class="token punctuation">]</span> <span class="token operator">=</span>
    <span class="token class-name">Seq</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>children<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">UnspecifiedDistribution</span><span class="token punctuation">)</span>

  <span class="token comment">/**
   * Runs this query returning the result as an RDD.
   */</span>
  def <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>目前SparkSQL中实现了一下十几种不同的Spark Plan，下面介绍几个比较重要的Spark Plan。</p> <p><img src="http://marsishandsome.github.io/SparkSQL-Internal/images/spark-plan.png" alt="img"></p> <h5 id="physicalrdd"><a href="#physicalrdd" class="header-anchor">#</a> PhysicalRDD</h5> <p>当向SqlContext注册一个SchemaRDD时，就会生成一个PhysicalRDD，表示已经存在的RDD，不需要额外再去计算。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">PhysicalRDD</span><span class="token punctuation">(</span>output<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Attribute</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rdd<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> <span class="token class-name">LeafNode</span> <span class="token punctuation">{</span>
  override def <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> rdd
<span class="token punctuation">}</span>
</code></pre></div><h5 id="inmemorycolumnartablescan"><a href="#inmemorycolumnartablescan" class="header-anchor">#</a> InMemoryColumnarTableScan</h5> <p>当使用cache时，就用生成InMemoryColumnarTableScan，内存列存储就是在这个类里面实现的。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> <span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">InMemoryColumnarTableScan</span><span class="token punctuation">(</span>
    attributes<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Attribute</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    predicates<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    relation<span class="token operator">:</span> <span class="token class-name">InMemoryRelation</span><span class="token punctuation">)</span>
  <span class="token keyword">extends</span> <span class="token class-name">LeafNode</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="parquettablescan"><a href="#parquettablescan" class="header-anchor">#</a> ParquetTableScan</h5> <p>读取Parquet类型数据的实现。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">ParquetTableScan</span><span class="token punctuation">(</span>
    attributes<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Attribute</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    relation<span class="token operator">:</span> <span class="token class-name">ParquetRelation</span><span class="token punctuation">,</span>
    columnPruningPred<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">extends</span> <span class="token class-name">LeafNode</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="cachetablecommand"><a href="#cachetablecommand" class="header-anchor">#</a> CacheTableCommand</h5> <p>Cache的物理执行实现。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">CacheTableCommand</span><span class="token punctuation">(</span>
    tableName<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    plan<span class="token operator">:</span> <span class="token class-name">Option</span><span class="token punctuation">[</span><span class="token class-name">LogicalPlan</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    isLazy<span class="token operator">:</span> <span class="token class-name">Boolean</span><span class="token punctuation">)</span>
  <span class="token keyword">extends</span> <span class="token class-name">LeafNode</span> <span class="token keyword">with</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>

  override <span class="token keyword">protected</span> lazy val sideEffectResult <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">import</span> <span class="token namespace">sqlContext<span class="token punctuation">.</span></span>_

    plan<span class="token punctuation">.</span><span class="token function">foreach</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">registerTempTable</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">cacheTable</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Performs eager caching</span>
      <span class="token function">table</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Seq</span><span class="token punctuation">.</span>empty<span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  override def output<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Attribute</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">Seq</span><span class="token punctuation">.</span>empty
<span class="token punctuation">}</span>
</code></pre></div><h5 id="executedcommand"><a href="#executedcommand" class="header-anchor">#</a> ExecutedCommand</h5> <p>执行传递进来的RunnableCommand，返回执行的结果。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">ExecutedCommand</span><span class="token punctuation">(</span>cmd<span class="token operator">:</span> <span class="token class-name">RunnableCommand</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> <span class="token class-name">SparkPlan</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * A concrete command should override this lazy field to wrap up any side effects caused by the
   * command or any other computation that should be evaluated exactly once. The value of this field
   * can be used as the contents of the corresponding RDD generated from the physical plan of this
   * command.
   *
   * The `execute()` method of all the physical command classes should reference `sideEffectResult`
   * so that the command can be executed eagerly right after the command query is created.
   */</span>
  <span class="token keyword">protected</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> lazy val sideEffectResult<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span> <span class="token operator">=</span> cmd<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>sqlContext<span class="token punctuation">)</span>

  override def output <span class="token operator">=</span> cmd<span class="token punctuation">.</span>output

  override def children <span class="token operator">=</span> <span class="token class-name">Nil</span>

  override def <span class="token function">executeCollect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span> <span class="token operator">=</span> sideEffectResult<span class="token punctuation">.</span>toArray

  override def <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span> <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span><span class="token function">parallelize</span><span class="token punctuation">(</span>sideEffectResult<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="hashjoin"><a href="#hashjoin" class="header-anchor">#</a> HashJoin</h5> <p>Join操作主要包含BroadcastHashJoin、LeftSemiJoinHash、ShuffledHashJoin均实现了HashJoin这个trait。</p> <p>HashJoin这个trait的主要成员有：</p> <ul><li>buildSide是左连接还是右连接，有一种基准的意思。</li> <li>leftKeys是左孩子的expressions, rightKeys是右孩子的expressions。</li> <li>left是左孩子物理计划，right是右孩子物理计划。</li> <li>buildSideKeyGenerator是一个Projection是根据传入的Row对象来计算buildSide的Expression的。</li> <li>streamSideKeyGenerator是一个MutableProjection是根据传入的Row对象来计算streamSide的Expression的。</li> <li>这里buildSide如果是left的话，可以理解为buildSide是左表，那么去连接这个左表的右表就是streamSide。</li></ul> <p>HashJoin关键的操作是joinIterators，简单来说就是join两个表，把每个表看着Iterators[Row]. 方式：</p> <ol><li>首先遍历buildSide，计算buildKeys然后利用一个HashMap，形成 (buildKeys, Iterators[Row])的格式。</li> <li>遍历StreamedSide，计算streamedKey，去HashMap里面去匹配key，来进行join</li> <li>最后生成一个joinRow，这个将两个row对接。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code>trait <span class="token class-name">HashJoin</span> <span class="token punctuation">{</span>
  self<span class="token operator">:</span> <span class="token class-name">SparkPlan</span> <span class="token operator">=</span><span class="token operator">&gt;</span>

  val leftKeys<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span>
  val rightKeys<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span>
  val buildSide<span class="token operator">:</span> <span class="token class-name">BuildSide</span>
  val left<span class="token operator">:</span> <span class="token class-name">SparkPlan</span>
  val right<span class="token operator">:</span> <span class="token class-name">SparkPlan</span>

  <span class="token keyword">protected</span> lazy val <span class="token punctuation">(</span>buildPlan<span class="token punctuation">,</span> streamedPlan<span class="token punctuation">)</span> <span class="token operator">=</span> buildSide match <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token class-name">BuildLeft</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token class-name">BuildRight</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>right<span class="token punctuation">,</span> left<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">protected</span> lazy val <span class="token punctuation">(</span>buildKeys<span class="token punctuation">,</span> streamedKeys<span class="token punctuation">)</span> <span class="token operator">=</span> buildSide match <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token class-name">BuildLeft</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>leftKeys<span class="token punctuation">,</span> rightKeys<span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token class-name">BuildRight</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>rightKeys<span class="token punctuation">,</span> leftKeys<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  override def output <span class="token operator">=</span> left<span class="token punctuation">.</span>output <span class="token operator">++</span> right<span class="token punctuation">.</span>output

  <span class="token annotation punctuation">@transient</span> <span class="token keyword">protected</span> lazy val buildSideKeyGenerator<span class="token operator">:</span> <span class="token class-name">Projection</span> <span class="token operator">=</span>
    <span class="token function">newProjection</span><span class="token punctuation">(</span>buildKeys<span class="token punctuation">,</span> buildPlan<span class="token punctuation">.</span>output<span class="token punctuation">)</span>

  <span class="token annotation punctuation">@transient</span> <span class="token keyword">protected</span> lazy val streamSideKeyGenerator<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">MutableProjection</span> <span class="token operator">=</span>
    <span class="token function">newMutableProjection</span><span class="token punctuation">(</span>streamedKeys<span class="token punctuation">,</span> streamedPlan<span class="token punctuation">.</span>output<span class="token punctuation">)</span>

  <span class="token keyword">protected</span> def <span class="token function">hashJoin</span><span class="token punctuation">(</span>streamIter<span class="token operator">:</span> <span class="token class-name">Iterator</span><span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span><span class="token punctuation">,</span> hashedRelation<span class="token operator">:</span> <span class="token class-name">HashedRelation</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Iterator</span><span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span> <span class="token operator">=</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Iterator</span><span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
      <span class="token comment">//left数据的当前行</span>
      <span class="token keyword">private</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span> <span class="token keyword">var</span> currentStreamedRow<span class="token operator">:</span> <span class="token class-name">Row</span> <span class="token operator">=</span> _
      <span class="token comment">//right中key等于当前left数据的所有行</span>
      <span class="token keyword">private</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span> <span class="token keyword">var</span> currentHashMatches<span class="token operator">:</span> <span class="token class-name">CompactBuffer</span><span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span> <span class="token operator">=</span> _
      <span class="token comment">//currentHashMatches访问到的当前Index</span>
      <span class="token keyword">private</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span> <span class="token keyword">var</span> currentMatchPosition<span class="token operator">:</span> <span class="token class-name">Int</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>

      <span class="token comment">// Mutable per row objects.</span>
      <span class="token comment">//使用mutable的row对象，减少GC压力</span>
      <span class="token keyword">private</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span> val joinRow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JoinedRow2</span>

      <span class="token keyword">private</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span> val joinKeys <span class="token operator">=</span> <span class="token function">streamSideKeyGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token comment">//先访问currentHashMatches，如果currentHashMatches没有数据了，从stream中取下一个</span>
      override <span class="token keyword">final</span> def hasNext<span class="token operator">:</span> <span class="token class-name">Boolean</span> <span class="token operator">=</span>
        <span class="token punctuation">(</span>currentMatchPosition <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> currentMatchPosition <span class="token operator">&lt;</span> currentHashMatches<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token punctuation">(</span>streamIter<span class="token punctuation">.</span>hasNext <span class="token operator">&amp;&amp;</span> <span class="token function">fetchNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token comment">//从currentHashMatches中取下一个</span>
      override <span class="token keyword">final</span> def <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        val ret <span class="token operator">=</span> buildSide match <span class="token punctuation">{</span>
          <span class="token keyword">case</span> <span class="token class-name">BuildRight</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">joinRow</span><span class="token punctuation">(</span>currentStreamedRow<span class="token punctuation">,</span> <span class="token function">currentHashMatches</span><span class="token punctuation">(</span>currentMatchPosition<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">case</span> <span class="token class-name">BuildLeft</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">joinRow</span><span class="token punctuation">(</span><span class="token function">currentHashMatches</span><span class="token punctuation">(</span>currentMatchPosition<span class="token punctuation">)</span><span class="token punctuation">,</span> currentStreamedRow<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        currentMatchPosition <span class="token operator">+=</span> <span class="token number">1</span>
        ret
      <span class="token punctuation">}</span>

      <span class="token keyword">private</span> <span class="token keyword">final</span> def <span class="token function">fetchNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Boolean</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        currentHashMatches <span class="token operator">=</span> <span class="token keyword">null</span>
        currentMatchPosition <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span>currentHashMatches <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> streamIter<span class="token punctuation">.</span>hasNext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          currentStreamedRow <span class="token operator">=</span> streamIter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//从stream中取下一个</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">joinKeys</span><span class="token punctuation">(</span>currentStreamedRow<span class="token punctuation">)</span><span class="token punctuation">.</span>anyNull<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//从hash map中取出所有key=joinKeys.currentValue的行</span>
            currentHashMatches <span class="token operator">=</span> hashedRelation<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>joinKeys<span class="token punctuation">.</span>currentValue<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentHashMatches <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token boolean">false</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          currentMatchPosition <span class="token operator">=</span> <span class="token number">0</span>
          <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="hashouterjoin"><a href="#hashouterjoin" class="header-anchor">#</a> HashOuterJoin</h5> <p>使用Shuffle+HashMap的方式进行Outer Join。具体步骤如下</p> <ol><li>调用zipPartitions将两个rdd对应的partition数据放到一起</li> <li>在每个partition中，对两个数据分别建立两个HashMap</li> <li>根据Outer Join的类型(left, right, full)，生成对应的iterator</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">HashOuterJoin</span><span class="token punctuation">(</span>
    leftKeys<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    rightKeys<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    joinType<span class="token operator">:</span> <span class="token class-name">JoinType</span><span class="token punctuation">,</span>
    condition<span class="token operator">:</span> <span class="token class-name">Option</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    left<span class="token operator">:</span> <span class="token class-name">SparkPlan</span><span class="token punctuation">,</span>
    right<span class="token operator">:</span> <span class="token class-name">SparkPlan</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> <span class="token class-name">BinaryNode</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    override def <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    left<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">zipPartitions</span><span class="token punctuation">(</span>right<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>leftIter<span class="token punctuation">,</span> rightIter<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
      <span class="token comment">// TODO this probably can be replaced by external sort (sort merged join?)</span>
      <span class="token comment">// Build HashMap for current partition in left relation</span>
      val leftHashTable <span class="token operator">=</span> <span class="token function">buildHashTable</span><span class="token punctuation">(</span>leftIter<span class="token punctuation">,</span> <span class="token function">newProjection</span><span class="token punctuation">(</span>leftKeys<span class="token punctuation">,</span> left<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// Build HashMap for current partition in right relation</span>
      val rightHashTable <span class="token operator">=</span> <span class="token function">buildHashTable</span><span class="token punctuation">(</span>rightIter<span class="token punctuation">,</span> <span class="token function">newProjection</span><span class="token punctuation">(</span>rightKeys<span class="token punctuation">,</span> right<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
      val boundCondition <span class="token operator">=</span>
        condition<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">newPredicate</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> left<span class="token punctuation">.</span>output <span class="token operator">++</span> right<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span><span class="token punctuation">(</span>row<span class="token operator">:</span> <span class="token class-name">Row</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      joinType match <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token class-name">LeftOuter</span> <span class="token operator">=</span><span class="token operator">&gt;</span> leftHashTable<span class="token punctuation">.</span>keysIterator<span class="token punctuation">.</span>flatMap <span class="token punctuation">{</span> key <span class="token operator">=</span><span class="token operator">&gt;</span>
          <span class="token function">leftOuterIterator</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> leftHashTable<span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> EMPTY_LIST<span class="token punctuation">)</span><span class="token punctuation">,</span>
            rightHashTable<span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> EMPTY_LIST<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> <span class="token class-name">RightOuter</span> <span class="token operator">=</span><span class="token operator">&gt;</span> rightHashTable<span class="token punctuation">.</span>keysIterator<span class="token punctuation">.</span>flatMap <span class="token punctuation">{</span> key <span class="token operator">=</span><span class="token operator">&gt;</span>
          <span class="token function">rightOuterIterator</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> leftHashTable<span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> EMPTY_LIST<span class="token punctuation">)</span><span class="token punctuation">,</span>
            rightHashTable<span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> EMPTY_LIST<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> <span class="token class-name">FullOuter</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>leftHashTable<span class="token punctuation">.</span>keySet <span class="token operator">++</span> rightHashTable<span class="token punctuation">.</span>keySet<span class="token punctuation">)</span><span class="token punctuation">.</span>iterator<span class="token punctuation">.</span>flatMap <span class="token punctuation">{</span> key <span class="token operator">=</span><span class="token operator">&gt;</span>
          <span class="token function">fullOuterIterator</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>
            leftHashTable<span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> EMPTY_LIST<span class="token punctuation">)</span><span class="token punctuation">,</span>
            rightHashTable<span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> EMPTY_LIST<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> x <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span>s<span class="token string">&quot;HashOuterJoin should not take $x as the JoinType&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="leftsemijoinhash"><a href="#leftsemijoinhash" class="header-anchor">#</a> LeftSemiJoinHash</h5> <p>将第二个表的join keys放到hash set中，遍历第一个表，从hash set中查找join key。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">LeftSemiJoinHash</span><span class="token punctuation">(</span>
    leftKeys<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    rightKeys<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    left<span class="token operator">:</span> <span class="token class-name">SparkPlan</span><span class="token punctuation">,</span>
    right<span class="token operator">:</span> <span class="token class-name">SparkPlan</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> <span class="token class-name">BinaryNode</span> <span class="token keyword">with</span> <span class="token class-name">HashJoin</span> <span class="token punctuation">{</span>

  override val buildSide <span class="token operator">=</span> <span class="token class-name">BuildRight</span>

  override def requiredChildDistribution <span class="token operator">=</span>
    <span class="token class-name">ClusteredDistribution</span><span class="token punctuation">(</span>leftKeys<span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">ClusteredDistribution</span><span class="token punctuation">(</span>rightKeys<span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>

  override def output <span class="token operator">=</span> left<span class="token punctuation">.</span>output

  override def <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    buildPlan<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">zipPartitions</span><span class="token punctuation">(</span>streamedPlan<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>buildIter<span class="token punctuation">,</span> streamIter<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
      val hashSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>HashSet</span><span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">var</span> currentRow<span class="token operator">:</span> <span class="token class-name">Row</span> <span class="token operator">=</span> <span class="token keyword">null</span>

      <span class="token comment">// Create a Hash set of buildKeys</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>buildIter<span class="token punctuation">.</span>hasNext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        currentRow <span class="token operator">=</span> buildIter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        val rowKey <span class="token operator">=</span> <span class="token function">buildSideKeyGenerator</span><span class="token punctuation">(</span>currentRow<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rowKey<span class="token punctuation">.</span>anyNull<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          val keyExists <span class="token operator">=</span> hashSet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>rowKey<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keyExists<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            hashSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rowKey<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      val joinKeys <span class="token operator">=</span> <span class="token function">streamSideKeyGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      streamIter<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>current <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token operator">!</span><span class="token function">joinKeys</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">.</span>anyNull <span class="token operator">&amp;&amp;</span> hashSet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>joinKeys<span class="token punctuation">.</span>currentValue<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="shuffledhashjoin"><a href="#shuffledhashjoin" class="header-anchor">#</a> ShuffledHashJoin</h5> <p>先Shuffle数据，再通过hash join的方式实现inner join。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">ShuffledHashJoin</span><span class="token punctuation">(</span>
    leftKeys<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    rightKeys<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    buildSide<span class="token operator">:</span> <span class="token class-name">BuildSide</span><span class="token punctuation">,</span>
    left<span class="token operator">:</span> <span class="token class-name">SparkPlan</span><span class="token punctuation">,</span>
    right<span class="token operator">:</span> <span class="token class-name">SparkPlan</span><span class="token punctuation">)</span>
  <span class="token keyword">extends</span> <span class="token class-name">BinaryNode</span> <span class="token keyword">with</span> <span class="token class-name">HashJoin</span> <span class="token punctuation">{</span>

  override def outputPartitioning<span class="token operator">:</span> <span class="token class-name">Partitioning</span> <span class="token operator">=</span> left<span class="token punctuation">.</span>outputPartitioning

  override def requiredChildDistribution <span class="token operator">=</span>
    <span class="token class-name">ClusteredDistribution</span><span class="token punctuation">(</span>leftKeys<span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">ClusteredDistribution</span><span class="token punctuation">(</span>rightKeys<span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>

  override def <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    buildPlan<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">zipPartitions</span><span class="token punctuation">(</span>streamedPlan<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>buildIter<span class="token punctuation">,</span> streamIter<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
      val hashed <span class="token operator">=</span> <span class="token class-name">HashedRelation</span><span class="token punctuation">(</span>buildIter<span class="token punctuation">,</span> buildSideKeyGenerator<span class="token punctuation">)</span>
      <span class="token function">hashJoin</span><span class="token punctuation">(</span>streamIter<span class="token punctuation">,</span> hashed<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="broadcasthashjoin"><a href="#broadcasthashjoin" class="header-anchor">#</a> BroadcastHashJoin</h5> <p>将其中一个数据broadcast出去，然后在另一个数据的每个partition进行hash join。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">BroadcastHashJoin</span><span class="token punctuation">(</span>
    leftKeys<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    rightKeys<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    buildSide<span class="token operator">:</span> <span class="token class-name">BuildSide</span><span class="token punctuation">,</span>
    left<span class="token operator">:</span> <span class="token class-name">SparkPlan</span><span class="token punctuation">,</span>
    right<span class="token operator">:</span> <span class="token class-name">SparkPlan</span><span class="token punctuation">)</span>
  <span class="token keyword">extends</span> <span class="token class-name">BinaryNode</span> <span class="token keyword">with</span> <span class="token class-name">HashJoin</span> <span class="token punctuation">{</span>

  override def outputPartitioning<span class="token operator">:</span> <span class="token class-name">Partitioning</span> <span class="token operator">=</span> streamedPlan<span class="token punctuation">.</span>outputPartitioning

  override def requiredChildDistribution <span class="token operator">=</span>
    <span class="token class-name">UnspecifiedDistribution</span> <span class="token operator">::</span> <span class="token class-name">UnspecifiedDistribution</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>

  <span class="token annotation punctuation">@transient</span>
  <span class="token keyword">private</span> val broadcastFuture <span class="token operator">=</span> future <span class="token punctuation">{</span>
    <span class="token comment">// Note that we use .execute().collect() because we don't want to convert data to Scala types</span>
    val input<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span> <span class="token operator">=</span> buildPlan<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    val hashed <span class="token operator">=</span> <span class="token class-name">HashedRelation</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>iterator<span class="token punctuation">,</span> buildSideKeyGenerator<span class="token punctuation">,</span> input<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
    sparkContext<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>hashed<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  override def <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    val broadcastRelation <span class="token operator">=</span> <span class="token class-name">Await</span><span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span>broadcastFuture<span class="token punctuation">,</span> <span class="token number">5.</span>minute<span class="token punctuation">)</span>

    streamedPlan<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mapPartitions <span class="token punctuation">{</span> streamedIter <span class="token operator">=</span><span class="token operator">&gt;</span>
      <span class="token function">hashJoin</span><span class="token punctuation">(</span>streamedIter<span class="token punctuation">,</span> broadcastRelation<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="直接调用rdd函数"><a href="#直接调用rdd函数" class="header-anchor">#</a> 直接调用rdd函数</h5> <ul><li>Intersect：rdd.intersection</li> <li>Except：rdd.subtract</li> <li>Sample：rdd.sample</li> <li>TakeOrdered：rdd.takeOrdered</li></ul> <h5 id="直接调用sparkcontext的函数"><a href="#直接调用sparkcontext的函数" class="header-anchor">#</a> 直接调用SparkContext的函数</h5> <ul><li>Union：sparkContext.union</li></ul> <h5 id="在rdd-mappartitions中进行简单计算"><a href="#在rdd-mappartitions中进行简单计算" class="header-anchor">#</a> 在rdd.mapPartitions中进行简单计算</h5> <ul><li>Distinct：使用HashSet类</li> <li>Sort: 调用SeqLike的sort函数</li> <li>Filter：调用iterator的filter函数</li> <li>ExternalSorter：使用ExternalSorter类</li> <li>Project：调用iterator的filter函数</li></ul> <h3 id="strategies"><a href="#strategies" class="header-anchor">#</a> Strategies</h3> <p>下面来看一下在生成物理计划中使用到的十几种strategy。</p> <h5 id="commandstrategy"><a href="#commandstrategy" class="header-anchor">#</a> CommandStrategy</h5> <p>CommandStrategy是专门针对Command类型的Logical Plan，即set key = value 、 explain sql、 cache table 这类操作</p> <ol><li>RunnableCommand：执行继承自RunnableCommand的命令，并将Seq[Row]转化为RDD。</li> <li>SetCommand：设置SparkContext的参数</li> <li>ExplainCommand：利用executed Plan打印出tree string</li> <li>CacheTableCommand：将RDD以列式方式缓存到内存中</li> <li>UncacheTableCommand：将缓存的RDD清除</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">CommandStrategy</span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token class-name">SQLContext</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> <span class="token class-name">Strategy</span> <span class="token punctuation">{</span>
    def <span class="token function">apply</span><span class="token punctuation">(</span>plan<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">SparkPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span> plan match <span class="token punctuation">{</span>
      <span class="token keyword">case</span> r<span class="token operator">:</span> <span class="token class-name">RunnableCommand</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">ExecutedCommand</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>SetCommand</span><span class="token punctuation">(</span>kv<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name">Seq</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>SetCommand</span><span class="token punctuation">(</span>kv<span class="token punctuation">,</span> plan<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>ExplainCommand</span><span class="token punctuation">(</span>logicalPlan<span class="token punctuation">,</span> extended<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name">Seq</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>ExplainCommand</span><span class="token punctuation">(</span>logicalPlan<span class="token punctuation">,</span> plan<span class="token punctuation">.</span>output<span class="token punctuation">,</span> extended<span class="token punctuation">)</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>CacheTableCommand</span><span class="token punctuation">(</span>tableName<span class="token punctuation">,</span> optPlan<span class="token punctuation">,</span> isLazy<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name">Seq</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>CacheTableCommand</span><span class="token punctuation">(</span>tableName<span class="token punctuation">,</span> optPlan<span class="token punctuation">,</span> isLazy<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>UncacheTableCommand</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name">Seq</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>UncacheTableCommand</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">case</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Nil</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h5 id="datasourcestrategy"><a href="#datasourcestrategy" class="header-anchor">#</a> DataSourceStrategy</h5> <p>根据不同的BaseRelation生产不同的PhysicalRDD。支持4种BaseRelation:</p> <ol><li>TableScan：默认的Scan策略</li> <li>PrunedScan：列裁剪，不需要的列不会从外部数据源加载</li> <li>PrunedFilterScan：在列裁剪的基础上加入Filter，在加载数据也的时候就进行过滤，而不是在客户端请求返回时做Filter</li> <li>CatalystScan：Catalyst的支持传入expressions来进行Scan，支持列裁剪和Filter。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> object <span class="token class-name">DataSourceStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">Strategy</span> <span class="token punctuation">{</span>
  def <span class="token function">apply</span><span class="token punctuation">(</span>plan<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">SparkPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span> plan match <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token class-name">PhysicalOperation</span><span class="token punctuation">(</span>projectList<span class="token punctuation">,</span> filters<span class="token punctuation">,</span> l @ <span class="token class-name">LogicalRelation</span><span class="token punctuation">(</span>t<span class="token operator">:</span> <span class="token class-name">CatalystScan</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
      <span class="token function">pruneFilterProjectRaw</span><span class="token punctuation">(</span>
        l<span class="token punctuation">,</span>
        projectList<span class="token punctuation">,</span>
        filters<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>a<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> t<span class="token punctuation">.</span><span class="token function">buildScan</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>

    <span class="token keyword">case</span> <span class="token class-name">PhysicalOperation</span><span class="token punctuation">(</span>projectList<span class="token punctuation">,</span> filters<span class="token punctuation">,</span> l @ <span class="token class-name">LogicalRelation</span><span class="token punctuation">(</span>t<span class="token operator">:</span> <span class="token class-name">PrunedFilteredScan</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
      <span class="token function">pruneFilterProject</span><span class="token punctuation">(</span>
        l<span class="token punctuation">,</span>
        projectList<span class="token punctuation">,</span>
        filters<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>a<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> t<span class="token punctuation">.</span><span class="token function">buildScan</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>

    <span class="token keyword">case</span> <span class="token class-name">PhysicalOperation</span><span class="token punctuation">(</span>projectList<span class="token punctuation">,</span> filters<span class="token punctuation">,</span> l @ <span class="token class-name">LogicalRelation</span><span class="token punctuation">(</span>t<span class="token operator">:</span> <span class="token class-name">PrunedScan</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
      <span class="token function">pruneFilterProject</span><span class="token punctuation">(</span>
        l<span class="token punctuation">,</span>
        projectList<span class="token punctuation">,</span>
        filters<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>a<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> t<span class="token punctuation">.</span><span class="token function">buildScan</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>

    <span class="token keyword">case</span> l @ <span class="token class-name">LogicalRelation</span><span class="token punctuation">(</span>t<span class="token operator">:</span> <span class="token class-name">TableScan</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
      <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>PhysicalRDD</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>output<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">buildScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>

    <span class="token keyword">case</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Nil</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="takeordered"><a href="#takeordered" class="header-anchor">#</a> TakeOrdered</h5> <p>如果有Limit和Sort操作将会使用TakeOrdered策略，返回一个TakeOrdered的Spark Plan。</p> <div class="language-java extra-class"><pre class="language-java"><code> object <span class="token class-name">TakeOrdered</span> <span class="token keyword">extends</span> <span class="token class-name">Strategy</span> <span class="token punctuation">{</span>
    def <span class="token function">apply</span><span class="token punctuation">(</span>plan<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">SparkPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span> plan match <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>Limit</span><span class="token punctuation">(</span><span class="token class-name">IntegerLiteral</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>Sort</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>TakeOrdered</span><span class="token punctuation">(</span>limit<span class="token punctuation">,</span> order<span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Nil</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h5 id="hashaggregation"><a href="#hashaggregation" class="header-anchor">#</a> HashAggregation</h5> <p>聚合操作可以映射为RDD的shuffle操作。</p> <div class="language-java extra-class"><pre class="language-java"><code>object <span class="token class-name">HashAggregation</span> <span class="token keyword">extends</span> <span class="token class-name">Strategy</span> <span class="token punctuation">{</span>
    def <span class="token function">apply</span><span class="token punctuation">(</span>plan<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">SparkPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span> plan match <span class="token punctuation">{</span>
      <span class="token comment">// Aggregations that can be performed in two phases, before and after the shuffle.</span>

      <span class="token comment">// Cases where all aggregates can be codegened.</span>
      <span class="token keyword">case</span> <span class="token class-name">PartialAggregation</span><span class="token punctuation">(</span>
             namedGroupingAttributes<span class="token punctuation">,</span>
             rewrittenAggregateExpressions<span class="token punctuation">,</span>
             groupingExpressions<span class="token punctuation">,</span>
             partialComputation<span class="token punctuation">,</span>
             child<span class="token punctuation">)</span>
             <span class="token keyword">if</span> <span class="token function">canBeCodeGened</span><span class="token punctuation">(</span>
                  <span class="token function">allAggregates</span><span class="token punctuation">(</span>partialComputation<span class="token punctuation">)</span> <span class="token operator">++</span>
                  <span class="token function">allAggregates</span><span class="token punctuation">(</span>rewrittenAggregateExpressions<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
               codegenEnabled <span class="token operator">=</span><span class="token operator">&gt;</span>
          <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>GeneratedAggregate</span><span class="token punctuation">(</span>
            partial <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            namedGroupingAttributes<span class="token punctuation">,</span>
            rewrittenAggregateExpressions<span class="token punctuation">,</span>
            <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>GeneratedAggregate</span><span class="token punctuation">(</span>
              partial <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              groupingExpressions<span class="token punctuation">,</span>
              partialComputation<span class="token punctuation">,</span>
              <span class="token function">planLater</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>

      <span class="token comment">// Cases where some aggregate can not be codegened</span>
      <span class="token keyword">case</span> <span class="token class-name">PartialAggregation</span><span class="token punctuation">(</span>
             namedGroupingAttributes<span class="token punctuation">,</span>
             rewrittenAggregateExpressions<span class="token punctuation">,</span>
             groupingExpressions<span class="token punctuation">,</span>
             partialComputation<span class="token punctuation">,</span>
             child<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>Aggregate</span><span class="token punctuation">(</span>
          partial <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          namedGroupingAttributes<span class="token punctuation">,</span>
          rewrittenAggregateExpressions<span class="token punctuation">,</span>
          <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>Aggregate</span><span class="token punctuation">(</span>
            partial <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            groupingExpressions<span class="token punctuation">,</span>
            partialComputation<span class="token punctuation">,</span>
            <span class="token function">planLater</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>

      <span class="token keyword">case</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Nil</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
</code></pre></div><h5 id="leftsemijoin"><a href="#leftsemijoin" class="header-anchor">#</a> LeftSemiJoin</h5> <p>如果Logical Plan里的Join是joinType为LeftSemi的话，就会执行这种策略，这里ExtractEquiJoinKeys是一个pattern定义在patterns.scala里，主要是做模式匹配用的。这里匹配只要是等值的join操作，都会封装为ExtractEquiJoinKeys对象，它会解析当前join，最后返回(joinType, rightKeys, leftKeys, condition, leftChild, rightChild)的格式。最后返回一个execution.LeftSemiJoinHash这个Spark Plan。</p> <div class="language-java extra-class"><pre class="language-java"><code>object <span class="token class-name">LeftSemiJoin</span> <span class="token keyword">extends</span> <span class="token class-name">Strategy</span> <span class="token keyword">with</span> <span class="token class-name">PredicateHelper</span> <span class="token punctuation">{</span>
    def <span class="token function">apply</span><span class="token punctuation">(</span>plan<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">SparkPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span> plan match <span class="token punctuation">{</span>
      <span class="token comment">// Find left semi joins where at least some predicates can be evaluated by matching join keys</span>
      <span class="token keyword">case</span> <span class="token class-name">ExtractEquiJoinKeys</span><span class="token punctuation">(</span><span class="token class-name">LeftSemi</span><span class="token punctuation">,</span> leftKeys<span class="token punctuation">,</span> rightKeys<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        val semiJoin <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">joins<span class="token punctuation">.</span></span>LeftSemiJoinHash</span><span class="token punctuation">(</span>
          leftKeys<span class="token punctuation">,</span> rightKeys<span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span>
        condition<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Filter</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> semiJoin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span>semiJoin<span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token comment">// no predicate can be evaluated by matching hash keys</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>Join</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> <span class="token class-name">LeftSemi</span><span class="token punctuation">,</span> condition<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">joins<span class="token punctuation">.</span></span>LeftSemiJoinBNL</span><span class="token punctuation">(</span><span class="token function">planLater</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">,</span> condition<span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Nil</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h5 id="hashjoin-2"><a href="#hashjoin-2" class="header-anchor">#</a> HashJoin</h5> <p>HashJoin是我们最见的操作，innerJoin类型，里面提供了2种Spark Plan：BroadcastHashJoin 和 ShuffledHashJoin。 BroadcastHashJoin的实现是一种广播变量的实现方法，如果设置了spark.sql.join.broadcastTables这个参数的表就会用spark的Broadcast Variables方式先将一张表给查询出来，然后广播到各个机器中。ShuffledHashJoin是一种最传统的默认的join方式，会根据shuffle key进行shuffle的hash join。</p> <div class="language-java extra-class"><pre class="language-java"><code>object <span class="token class-name">HashJoin</span> <span class="token keyword">extends</span> <span class="token class-name">Strategy</span> <span class="token keyword">with</span> <span class="token class-name">PredicateHelper</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span> def <span class="token function">makeBroadcastHashJoin</span><span class="token punctuation">(</span>
        leftKeys<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        rightKeys<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        left<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">,</span>
        right<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">,</span>
        condition<span class="token operator">:</span> <span class="token class-name">Option</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        side<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">joins<span class="token punctuation">.</span></span>BuildSide</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      val broadcastHashJoin <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span>joins<span class="token punctuation">.</span></span>BroadcastHashJoin</span><span class="token punctuation">(</span>
        leftKeys<span class="token punctuation">,</span> rightKeys<span class="token punctuation">,</span> side<span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span>
      condition<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Filter</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> broadcastHashJoin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span>broadcastHashJoin<span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
    <span class="token punctuation">}</span>

    def <span class="token function">apply</span><span class="token punctuation">(</span>plan<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">SparkPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span> plan match <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token class-name">ExtractEquiJoinKeys</span><span class="token punctuation">(</span><span class="token class-name">Inner</span><span class="token punctuation">,</span> leftKeys<span class="token punctuation">,</span> rightKeys<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span>
        <span class="token keyword">if</span> sqlContext<span class="token punctuation">.</span>autoBroadcastJoinThreshold <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
           right<span class="token punctuation">.</span>statistics<span class="token punctuation">.</span>sizeInBytes <span class="token operator">&lt;=</span> sqlContext<span class="token punctuation">.</span>autoBroadcastJoinThreshold <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token function">makeBroadcastHashJoin</span><span class="token punctuation">(</span>leftKeys<span class="token punctuation">,</span> rightKeys<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">joins<span class="token punctuation">.</span></span>BuildRight</span><span class="token punctuation">)</span>

      <span class="token keyword">case</span> <span class="token class-name">ExtractEquiJoinKeys</span><span class="token punctuation">(</span><span class="token class-name">Inner</span><span class="token punctuation">,</span> leftKeys<span class="token punctuation">,</span> rightKeys<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span>
        <span class="token keyword">if</span> sqlContext<span class="token punctuation">.</span>autoBroadcastJoinThreshold <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
           left<span class="token punctuation">.</span>statistics<span class="token punctuation">.</span>sizeInBytes <span class="token operator">&lt;=</span> sqlContext<span class="token punctuation">.</span>autoBroadcastJoinThreshold <span class="token operator">=</span><span class="token operator">&gt;</span>
          <span class="token function">makeBroadcastHashJoin</span><span class="token punctuation">(</span>leftKeys<span class="token punctuation">,</span> rightKeys<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">joins<span class="token punctuation">.</span></span>BuildLeft</span><span class="token punctuation">)</span>

      <span class="token keyword">case</span> <span class="token class-name">ExtractEquiJoinKeys</span><span class="token punctuation">(</span><span class="token class-name">Inner</span><span class="token punctuation">,</span> leftKeys<span class="token punctuation">,</span> rightKeys<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        val buildSide <span class="token operator">=</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>right<span class="token punctuation">.</span>statistics<span class="token punctuation">.</span>sizeInBytes <span class="token operator">&lt;=</span> left<span class="token punctuation">.</span>statistics<span class="token punctuation">.</span>sizeInBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token namespace">joins<span class="token punctuation">.</span></span>BuildRight</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token namespace">joins<span class="token punctuation">.</span></span>BuildLeft</span>
          <span class="token punctuation">}</span>
        val hashJoin <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">joins<span class="token punctuation">.</span></span>ShuffledHashJoin</span><span class="token punctuation">(</span>
          leftKeys<span class="token punctuation">,</span> rightKeys<span class="token punctuation">,</span> buildSide<span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span>
        condition<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Filter</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> hashJoin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span>hashJoin<span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>

      <span class="token keyword">case</span> <span class="token class-name">ExtractEquiJoinKeys</span><span class="token punctuation">(</span>joinType<span class="token punctuation">,</span> leftKeys<span class="token punctuation">,</span> rightKeys<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">joins<span class="token punctuation">.</span></span>HashOuterJoin</span><span class="token punctuation">(</span>
          leftKeys<span class="token punctuation">,</span> rightKeys<span class="token punctuation">,</span> joinType<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>

      <span class="token keyword">case</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Nil</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h5 id="inmemoryscans"><a href="#inmemoryscans" class="header-anchor">#</a> InMemoryScans</h5> <p>InMemoryScans主要是对InMemoryRelation这个Logical Plan操作。调用的其实是Spark Planner里的pruneFilterProject这个方法。</p> <div class="language-java extra-class"><pre class="language-java"><code>object <span class="token class-name">InMemoryScans</span> <span class="token keyword">extends</span> <span class="token class-name">Strategy</span> <span class="token punctuation">{</span>
    def <span class="token function">apply</span><span class="token punctuation">(</span>plan<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">SparkPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span> plan match <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token class-name">PhysicalOperation</span><span class="token punctuation">(</span>projectList<span class="token punctuation">,</span> filters<span class="token punctuation">,</span> mem<span class="token operator">:</span> <span class="token class-name">InMemoryRelation</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token function">pruneFilterProject</span><span class="token punctuation">(</span>
          projectList<span class="token punctuation">,</span>
          filters<span class="token punctuation">,</span>
          identity<span class="token punctuation">[</span><span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// All filters still need to be evaluated.</span>
          <span class="token class-name">InMemoryColumnarTableScan</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span>  filters<span class="token punctuation">,</span> mem<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Nil</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h5 id="parquetoperations"><a href="#parquetoperations" class="header-anchor">#</a> ParquetOperations</h5> <p>支持ParquetOperations的读写，插入Table等。</p> <div class="language-java extra-class"><pre class="language-java"><code>object <span class="token class-name">ParquetOperations</span> <span class="token keyword">extends</span> <span class="token class-name">Strategy</span> <span class="token punctuation">{</span>
    def <span class="token function">apply</span><span class="token punctuation">(</span>plan<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">SparkPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span> plan match <span class="token punctuation">{</span>
      <span class="token comment">// TODO: need to support writing to other types of files.  Unify the below code paths.</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>WriteToFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        val relation <span class="token operator">=</span>
          <span class="token class-name">ParquetRelation</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> child<span class="token punctuation">,</span> sparkContext<span class="token punctuation">.</span>hadoopConfiguration<span class="token punctuation">,</span> sqlContext<span class="token punctuation">)</span>
        <span class="token comment">// Note: overwrite=false because otherwise the metadata we just created will be deleted</span>
        <span class="token class-name">InsertIntoParquetTable</span><span class="token punctuation">(</span>relation<span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">,</span> overwrite <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>InsertIntoTable</span><span class="token punctuation">(</span>table<span class="token operator">:</span> <span class="token class-name">ParquetRelation</span><span class="token punctuation">,</span> partition<span class="token punctuation">,</span> child<span class="token punctuation">,</span> overwrite<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name">InsertIntoParquetTable</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">,</span> overwrite<span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name">PhysicalOperation</span><span class="token punctuation">(</span>projectList<span class="token punctuation">,</span> filters<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">,</span> relation<span class="token operator">:</span> <span class="token class-name">ParquetRelation</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        val prunePushedDownFilters <span class="token operator">=</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlContext<span class="token punctuation">.</span>parquetFilterPushDown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span>predicates<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
              <span class="token comment">// Note: filters cannot be pushed down to Parquet if they contain more complex</span>
              <span class="token comment">// expressions than simple &quot;Attribute cmp Literal&quot; comparisons. Here we remove all</span>
              <span class="token comment">// filters that have been pushed down. Note that a predicate such as &quot;(A AND B) OR C&quot;</span>
              <span class="token comment">// can result in &quot;A OR C&quot; being pushed down. Here we are conservative in the sense</span>
              <span class="token comment">// that even if &quot;A&quot; was pushed and we check for &quot;A AND B&quot; we still want to keep</span>
              <span class="token comment">// &quot;A AND B&quot; in the higher-level filter, not just &quot;B&quot;.</span>
              predicates<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>p <span class="token operator">=</span><span class="token operator">&gt;</span> p <span class="token operator">-&gt;</span> <span class="token class-name">ParquetFilters</span><span class="token punctuation">.</span><span class="token function">createFilter</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>collect <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token punctuation">(</span>predicate<span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> predicate
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            identity<span class="token punctuation">[</span><span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">]</span> _
          <span class="token punctuation">}</span>
        <span class="token function">pruneFilterProject</span><span class="token punctuation">(</span>
          projectList<span class="token punctuation">,</span>
          filters<span class="token punctuation">,</span>
          prunePushedDownFilters<span class="token punctuation">,</span>
          <span class="token class-name">ParquetTableScan</span><span class="token punctuation">(</span>
            _<span class="token punctuation">,</span>
            relation<span class="token punctuation">,</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlContext<span class="token punctuation">.</span>parquetFilterPushDown<span class="token punctuation">)</span> filters <span class="token keyword">else</span> <span class="token class-name">Nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>

      <span class="token keyword">case</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Nil</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h5 id="basicoperators"><a href="#basicoperators" class="header-anchor">#</a> BasicOperators</h5> <p>所有定义在org.apache.spark.sql.execution里的基本的Spark Plan，它们都在org.apache.spark.sql.execution包下basicOperators.scala内。有Project、Filter、Sample、Union、Limit、TakeOrdered、Sort、ExistingRdd。这些是基本元素，实现都相对简单，基本上都是RDD里的方法来实现的。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Can we automate these 'pass through' operations?</span>
  object <span class="token class-name">BasicOperators</span> <span class="token keyword">extends</span> <span class="token class-name">Strategy</span> <span class="token punctuation">{</span>
    def numPartitions <span class="token operator">=</span> self<span class="token punctuation">.</span>numPartitions

    def <span class="token function">apply</span><span class="token punctuation">(</span>plan<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">SparkPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span> plan match <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>Distinct</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>Distinct</span><span class="token punctuation">(</span>partial <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>Distinct</span><span class="token punctuation">(</span>partial <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>

      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>Sort</span><span class="token punctuation">(</span>sortExprs<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token keyword">if</span> sqlContext<span class="token punctuation">.</span>externalSortEnabled <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>ExternalSort</span><span class="token punctuation">(</span>sortExprs<span class="token punctuation">,</span> global <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>Sort</span><span class="token punctuation">(</span>sortExprs<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>Sort</span><span class="token punctuation">(</span>sortExprs<span class="token punctuation">,</span> global <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">::</span> <span class="token class-name">Nil</span>

      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>SortPartitions</span><span class="token punctuation">(</span>sortExprs<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token comment">// This sort only sorts tuples within a partition. Its requiredDistribution will be</span>
        <span class="token comment">// an UnspecifiedDistribution.</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>Sort</span><span class="token punctuation">(</span>sortExprs<span class="token punctuation">,</span> global <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>Project</span><span class="token punctuation">(</span>projectList<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>Project</span><span class="token punctuation">(</span>projectList<span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>Filter</span><span class="token punctuation">(</span>condition<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>Filter</span><span class="token punctuation">(</span>condition<span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>Aggregate</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> agg<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>Aggregate</span><span class="token punctuation">(</span>partial <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> group<span class="token punctuation">,</span> agg<span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>Sample</span><span class="token punctuation">(</span>fraction<span class="token punctuation">,</span> withReplacement<span class="token punctuation">,</span> seed<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>Sample</span><span class="token punctuation">(</span>fraction<span class="token punctuation">,</span> withReplacement<span class="token punctuation">,</span> seed<span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name">SparkLogicalPlan</span><span class="token punctuation">(</span>alreadyPlanned<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> alreadyPlanned <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>LocalRelation</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        val nPartitions <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token number">1</span> <span class="token keyword">else</span> numPartitions
        <span class="token class-name">PhysicalRDD</span><span class="token punctuation">(</span>
          output<span class="token punctuation">,</span>
          <span class="token class-name">RDDConversions</span><span class="token punctuation">.</span><span class="token function">productToRowRdd</span><span class="token punctuation">(</span>sparkContext<span class="token punctuation">.</span><span class="token function">parallelize</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> nPartitions<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">StructType</span><span class="token punctuation">.</span><span class="token function">fromAttributes</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>Limit</span><span class="token punctuation">(</span><span class="token class-name">IntegerLiteral</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>Limit</span><span class="token punctuation">(</span>limit<span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name">Unions</span><span class="token punctuation">(</span>unionChildren<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>Union</span><span class="token punctuation">(</span>unionChildren<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>planLater<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>Except</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>Except</span><span class="token punctuation">(</span><span class="token function">planLater</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>Intersect</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>Intersect</span><span class="token punctuation">(</span><span class="token function">planLater</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>Generate</span><span class="token punctuation">(</span>generator<span class="token punctuation">,</span> join<span class="token punctuation">,</span> outer<span class="token punctuation">,</span> _<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>Generate</span><span class="token punctuation">(</span>generator<span class="token punctuation">,</span> join <span class="token operator">=</span> join<span class="token punctuation">,</span> outer <span class="token operator">=</span> outer<span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>NoRelation</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>PhysicalRDD</span><span class="token punctuation">(</span><span class="token class-name">Nil</span><span class="token punctuation">,</span> singleRowRdd<span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>Repartition</span><span class="token punctuation">(</span>expressions<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>Exchange</span><span class="token punctuation">(</span><span class="token class-name">HashPartitioning</span><span class="token punctuation">(</span>expressions<span class="token punctuation">,</span> numPartitions<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> e @ <span class="token class-name">EvaluatePython</span><span class="token punctuation">(</span>udf<span class="token punctuation">,</span> child<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name">BatchPythonEvaluation</span><span class="token punctuation">(</span>udf<span class="token punctuation">,</span> e<span class="token punctuation">.</span>output<span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name">LogicalRDD</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> rdd<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">PhysicalRDD</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> rdd<span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Nil</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h5 id="cartesianproduct"><a href="#cartesianproduct" class="header-anchor">#</a> CartesianProduct</h5> <p>笛卡尔积的Join，有待过滤条件的Join。主要是利用RDD的cartesian实现的。</p> <div class="language-java extra-class"><pre class="language-java"><code>object <span class="token class-name">CartesianProduct</span> <span class="token keyword">extends</span> <span class="token class-name">Strategy</span> <span class="token punctuation">{</span>
    def <span class="token function">apply</span><span class="token punctuation">(</span>plan<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">SparkPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span> plan match <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>Join</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> _<span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span>joins<span class="token punctuation">.</span></span>CartesianProduct</span><span class="token punctuation">(</span><span class="token function">planLater</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>Join</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> <span class="token class-name">Inner</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>condition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>Filter</span><span class="token punctuation">(</span>condition<span class="token punctuation">,</span>
          <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span>joins<span class="token punctuation">.</span></span>CartesianProduct</span><span class="token punctuation">(</span><span class="token function">planLater</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Nil</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h5 id="broadcastnestedloopjoin"><a href="#broadcastnestedloopjoin" class="header-anchor">#</a> BroadcastNestedLoopJoin</h5> <p>BroadcastNestedLoopJoin可用于Left Outer， Right Outer， Full Outer这三种类型的join，Hash Join仅仅用于InnerJoin。</p> <div class="language-java extra-class"><pre class="language-java"><code>object <span class="token class-name">BroadcastNestedLoopJoin</span> <span class="token keyword">extends</span> <span class="token class-name">Strategy</span> <span class="token punctuation">{</span>
    def <span class="token function">apply</span><span class="token punctuation">(</span>plan<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">SparkPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span> plan match <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>Join</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> joinType<span class="token punctuation">,</span> condition<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        val buildSide <span class="token operator">=</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>right<span class="token punctuation">.</span>statistics<span class="token punctuation">.</span>sizeInBytes <span class="token operator">&lt;=</span> left<span class="token punctuation">.</span>statistics<span class="token punctuation">.</span>sizeInBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token namespace">joins<span class="token punctuation">.</span></span>BuildRight</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token namespace">joins<span class="token punctuation">.</span></span>BuildLeft</span>
          <span class="token punctuation">}</span>
        <span class="token class-name"><span class="token namespace">joins<span class="token punctuation">.</span></span>BroadcastNestedLoopJoin</span><span class="token punctuation">(</span>
          <span class="token function">planLater</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">planLater</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">,</span> buildSide<span class="token punctuation">,</span> joinType<span class="token punctuation">,</span> condition<span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>
      <span class="token keyword">case</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Nil</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="_3-udf"><a href="#_3-udf" class="header-anchor">#</a> 3. UDF</h2> <p>在sql语句中，除了可以使用+ - * /等表达式外，还可以使用用户定义的函数UDF。下面是SqlParser中对UDF的语法定义：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> lazy val function<span class="token operator">:</span> <span class="token class-name">Parser</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span> <span class="token operator">=</span>
    <span class="token punctuation">(</span> SUM   <span class="token operator">~</span><span class="token operator">&gt;</span> <span class="token string">&quot;(&quot;</span> <span class="token operator">~</span><span class="token operator">&gt;</span> expression             <span class="token operator">&lt;</span><span class="token operator">~</span> <span class="token string">&quot;)&quot;</span> <span class="token operator">^</span><span class="token operator">^</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> exp <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Sum</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">|</span> ident <span class="token operator">~</span> <span class="token punctuation">(</span><span class="token string">&quot;(&quot;</span> <span class="token operator">~</span><span class="token operator">&gt;</span> <span class="token function">repsep</span><span class="token punctuation">(</span>expression<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">~</span> <span class="token string">&quot;)&quot;</span> <span class="token operator">^</span><span class="token operator">^</span>
      <span class="token punctuation">{</span> <span class="token keyword">case</span> udfName <span class="token operator">~</span> exprs <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">UnresolvedFunction</span><span class="token punctuation">(</span>udfName<span class="token punctuation">,</span> exprs<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
</code></pre></div><p>将SqlParser传入的udfName和exprs封装成一个叫 UnresolvedFunction的类，该类继承自Expression。只是这个Expression的dataType等一系列属性和eval计算方法均无法访问，强制访问会抛出异常，因为它没有被Resolved，只是一个载体。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">UnresolvedFunction</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> children<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> <span class="token class-name">Expression</span> <span class="token punctuation">{</span>
  override def dataType <span class="token operator">=</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnresolvedException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot;dataType&quot;</span><span class="token punctuation">)</span>
  override def foldable <span class="token operator">=</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnresolvedException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot;foldable&quot;</span><span class="token punctuation">)</span>
  override def nullable <span class="token operator">=</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnresolvedException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot;nullable&quot;</span><span class="token punctuation">)</span>
  override lazy val resolved <span class="token operator">=</span> <span class="token boolean">false</span>

  <span class="token comment">// Unresolved functions are transient at compile time and don't get evaluated during execution.</span>
  override def <span class="token function">eval</span><span class="token punctuation">(</span>input<span class="token operator">:</span> <span class="token class-name">Row</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">EvaluatedType</span> <span class="token operator">=</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TreeNodeException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> s<span class="token string">&quot;No function to evaluate expression. type: ${this.nodeName}&quot;</span><span class="token punctuation">)</span>

  override def toString <span class="token operator">=</span> s<span class="token string">&quot;'$name(${children.mkString(&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;)})&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在SqlContext中有一个functionRegistry对象，使用的是SimpleFunctionRegistry，用来存储用户定义的函数。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> lazy val functionRegistry<span class="token operator">:</span> <span class="token class-name">FunctionRegistry</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleFunctionRegistry</span>
</code></pre></div><h3 id="udf注册"><a href="#udf注册" class="header-anchor">#</a> UDF注册</h3> <h5 id="udfregistration"><a href="#udfregistration" class="header-anchor">#</a> UDFRegistration</h5> <p>registerFunction是UDFRegistration下的方法，SQLContext现在实现了UDFRegistration这个trait，只要导入SQLContext，即可以使用udf功能。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">SQLContext</span><span class="token punctuation">(</span><span class="token annotation punctuation">@transient</span> val sparkContext<span class="token operator">:</span> <span class="token class-name">SparkContext</span><span class="token punctuation">)</span>
  <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>Logging</span>
  <span class="token keyword">with</span> <span class="token class-name">SQLConf</span>
  <span class="token keyword">with</span> <span class="token class-name">CacheManager</span>
  <span class="token keyword">with</span> <span class="token class-name">ExpressionConversions</span>
  <span class="token keyword">with</span> <span class="token class-name">UDFRegistration</span>
  <span class="token keyword">with</span> <span class="token class-name">Serializable</span>
</code></pre></div><p>registerFunction接受一个name和 一个func，可以是Function1到Function22，即这个udf的参数只支持1-22个。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> trait <span class="token class-name">UDFRegistration</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
def registerFunction<span class="token punctuation">[</span><span class="token class-name">T</span><span class="token operator">:</span> <span class="token class-name">TypeTag</span><span class="token punctuation">]</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> func<span class="token operator">:</span> <span class="token class-name">Function1</span><span class="token punctuation">[</span>_<span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    def <span class="token function">builder</span><span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">ScalaUdf</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token class-name">ScalaReflection</span><span class="token punctuation">.</span>schemaFor<span class="token punctuation">[</span><span class="token class-name">T</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dataType<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
    functionRegistry<span class="token punctuation">.</span><span class="token function">registerFunction</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> builder<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  def registerFunction<span class="token punctuation">[</span><span class="token class-name">T</span><span class="token operator">:</span> <span class="token class-name">TypeTag</span><span class="token punctuation">]</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> func<span class="token operator">:</span> <span class="token class-name">Function22</span><span class="token punctuation">[</span>_<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    def <span class="token function">builder</span><span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">ScalaUdf</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token class-name">ScalaReflection</span><span class="token punctuation">.</span>schemaFor<span class="token punctuation">[</span><span class="token class-name">T</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dataType<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
    functionRegistry<span class="token punctuation">.</span><span class="token function">registerFunction</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> builder<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>内部builder通过ScalaUdf来构造一个Expression，这里ScalaUdf继承自Expression，传入scala的function作为UDF的实现。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">ScalaUdf</span><span class="token punctuation">(</span>function<span class="token operator">:</span> <span class="token class-name">AnyRef</span><span class="token punctuation">,</span> dataType<span class="token operator">:</span> <span class="token class-name">DataType</span><span class="token punctuation">,</span> children<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">extends</span> <span class="token class-name">Expression</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="simplefunctionregistry"><a href="#simplefunctionregistry" class="header-anchor">#</a> SimpleFunctionRegistry</h5> <p>SimpleFunctionRegistry中使用HashMap存储用户定义的函数。</p> <div class="language-java extra-class"><pre class="language-java"><code>type <span class="token class-name">FunctionBuilder</span> <span class="token operator">=</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Expression</span>
<span class="token keyword">class</span> <span class="token class-name">SimpleFunctionRegistry</span> <span class="token keyword">extends</span> <span class="token class-name">FunctionRegistry</span> <span class="token punctuation">{</span>
  val functionBuilders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">mutable<span class="token punctuation">.</span></span>HashMap</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">FunctionBuilder</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  def <span class="token function">registerFunction</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> builder<span class="token operator">:</span> <span class="token class-name">FunctionBuilder</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    functionBuilders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> builder<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  override def <span class="token function">lookupFunction</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> children<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Expression</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">functionBuilders</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="udf计算"><a href="#udf计算" class="header-anchor">#</a> UDF计算</h3> <p>UDF既然已经被封装为catalyst树里的一个Expression节点，那么计算的时候也就是计算ScalaUdf的eval方法。先通过Row和表达式计算function所需要的参数，最后通过反射调用function，来达到计算udf的目的。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">ScalaUdf</span><span class="token punctuation">(</span>function<span class="token operator">:</span> <span class="token class-name">AnyRef</span><span class="token punctuation">,</span> dataType<span class="token operator">:</span> <span class="token class-name">DataType</span><span class="token punctuation">,</span> children<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">extends</span> <span class="token class-name">Expression</span> <span class="token punctuation">{</span>

  override def <span class="token function">eval</span><span class="token punctuation">(</span>input<span class="token operator">:</span> <span class="token class-name">Row</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Any</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    val result <span class="token operator">=</span> children<span class="token punctuation">.</span>size match <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token number">0</span> <span class="token operator">=</span><span class="token operator">&gt;</span> function<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Any</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">case</span> <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        function<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Any</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Any</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
          <span class="token class-name">ScalaReflection</span><span class="token punctuation">.</span><span class="token function">convertToScala</span><span class="token punctuation">(</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">children</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dataType<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_4-in-memory-columnar-storage"><a href="#_4-in-memory-columnar-storage" class="header-anchor">#</a> 4. In-Memory Columnar Storage</h2> <p>Spark SQL可以将数据缓存到内存中，我们可以见到的通过调用cache table tableName即可将一张表缓存到内存中，来极大的提高查询效率。这就涉及到内存中的数据的存储形式，我们知道基于关系型的数据可以存储为基于行存储结构或者基于列存储结构，或者基于行和列的混合存储，即Row Based Storage、Column Based Storage、 PAX Storage。</p> <p>Spark SQL 将数据加载到内存是以列的存储结构。称为In-Memory Columnar Storage。若直接存储Java Object会产生很大的内存开销，并且这样是基于Row的存储结构。查询某些列速度略慢，虽然数据以及载入内存，查询效率还是低于面向列的存储结构。</p> <p>Spark SQL的In-Memory Columnar Storage是位于spark列下面org.apache.spark.sql.columnar包内。核心的类有 ColumnBuilder, InMemoryColumnarTableScan, ColumnAccessor, ColumnType。如果列有压缩的情况：compression包下面有具体的build列和access列的类。</p> <p>当我们调用<code>sql(&quot;cache table src&quot;)</code>时，会产生一个catalyst.plans.logical.CacheTableCommand，是一个LogicalPlan。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">CacheTableCommand</span><span class="token punctuation">(</span>tableName<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> plan<span class="token operator">:</span> <span class="token class-name">Option</span><span class="token punctuation">[</span><span class="token class-name">LogicalPlan</span><span class="token punctuation">]</span><span class="token punctuation">,</span> isLazy<span class="token operator">:</span> <span class="token class-name">Boolean</span><span class="token punctuation">)</span>
  <span class="token keyword">extends</span> <span class="token class-name">Command</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Command</span> <span class="token keyword">extends</span> <span class="token class-name">LeafNode</span> <span class="token punctuation">{</span>
  self<span class="token operator">:</span> <span class="token class-name">Product</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
  def output<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Attribute</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">Seq</span><span class="token punctuation">.</span>empty
<span class="token punctuation">}</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">LeafNode</span> <span class="token keyword">extends</span> <span class="token class-name">LogicalPlan</span> <span class="token keyword">with</span> <span class="token namespace">trees<span class="token punctuation">.</span></span><span class="token class-name">LeafNode</span><span class="token punctuation">[</span><span class="token class-name">LogicalPlan</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  self<span class="token operator">:</span> <span class="token class-name">Product</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在生成物理计划的时候，会转换成execution.CacheTableComman的Physical Plan。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">logical<span class="token punctuation">.</span></span>CacheTableCommand</span><span class="token punctuation">(</span>tableName<span class="token punctuation">,</span> optPlan<span class="token punctuation">,</span> isLazy<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name">Seq</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>CacheTableCommand</span><span class="token punctuation">(</span>tableName<span class="token punctuation">,</span> optPlan<span class="token punctuation">,</span> isLazy<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">CacheTableCommand</span><span class="token punctuation">(</span>
    tableName<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    plan<span class="token operator">:</span> <span class="token class-name">Option</span><span class="token punctuation">[</span><span class="token class-name">LogicalPlan</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    isLazy<span class="token operator">:</span> <span class="token class-name">Boolean</span><span class="token punctuation">)</span>
  <span class="token keyword">extends</span> <span class="token class-name">LeafNode</span> <span class="token keyword">with</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>

  override <span class="token keyword">protected</span> lazy val sideEffectResult <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">import</span> <span class="token namespace">sqlContext<span class="token punctuation">.</span></span>_

    plan<span class="token punctuation">.</span><span class="token function">foreach</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">registerTempTable</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">cacheTable</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Performs eager caching</span>
      <span class="token function">table</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Seq</span><span class="token punctuation">.</span>empty<span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  override def output<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Attribute</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">Seq</span><span class="token punctuation">.</span>empty
<span class="token punctuation">}</span>
</code></pre></div><p>接着调用CacheManager的cacheTable函数，然后调cacheQuery函数。在cacheQuery里面生成了InMemoryRelation对象，就是列式存储的数据结构。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> trait <span class="token class-name">CacheManager</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    def <span class="token function">cacheTable</span><span class="token punctuation">(</span>tableName<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token function">cacheQuery</span><span class="token punctuation">(</span><span class="token function">table</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token keyword">private</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> def <span class="token function">cacheQuery</span><span class="token punctuation">(</span>
      query<span class="token operator">:</span> <span class="token class-name">SchemaRDD</span><span class="token punctuation">,</span>
      tableName<span class="token operator">:</span> <span class="token class-name">Option</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
      storageLevel<span class="token operator">:</span> <span class="token class-name">StorageLevel</span> <span class="token operator">=</span> MEMORY_AND_DISK<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> writeLock <span class="token punctuation">{</span>
    val planToCache <span class="token operator">=</span> query<span class="token punctuation">.</span>queryExecution<span class="token punctuation">.</span>analyzed
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">lookupCachedData</span><span class="token punctuation">(</span>planToCache<span class="token punctuation">)</span><span class="token punctuation">.</span>nonEmpty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">logWarning</span><span class="token punctuation">(</span><span class="token string">&quot;Asked to cache already cached data.&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      cachedData <span class="token operator">+=</span>
        <span class="token class-name">CachedData</span><span class="token punctuation">(</span>
          planToCache<span class="token punctuation">,</span>
          <span class="token class-name">InMemoryRelation</span><span class="token punctuation">(</span>
            useCompression<span class="token punctuation">,</span>
            columnBatchSize<span class="token punctuation">,</span>
            storageLevel<span class="token punctuation">,</span>
            query<span class="token punctuation">.</span>queryExecution<span class="token punctuation">.</span>executedPlan<span class="token punctuation">,</span>
            tableName<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="用法"><a href="#用法" class="header-anchor">#</a> 用法</h3> <p>SparkSQL中有三种方法触发cache：</p> <ol><li>sqlContext.sql(&quot;cache table tableName&quot;)</li> <li>sqlContext.cacheTable(&quot;tableName&quot;)</li> <li>schemaRDD.cache()</li></ol> <p>以上三种用法都会使用到列存储的方式对rdd进行缓存。如果调用了普通rdd的cache方法，是不会触发列式存储的cache。</p> <p>在Spark1.2.0中，cache table的执行时eager模式的，如果想触发lazy模式，可以主动添加lazy关键字，例如<code>cache lazy table tabelName</code>。</p> <p>而在Spark1.2.0之前，cache table的默认语义是lazy的，所以需要主动触发action才会真正执行cache操作。</p> <h3 id="inmemoryrelation"><a href="#inmemoryrelation" class="header-anchor">#</a> InMemoryRelation</h3> <p>InMemoryRelation继承自LogicalPlan。_cachedColumnBuffers这个类型为RDD[CachedBatch]的私有字段。CachedBatch是Array[Array[Byte]]的封装。</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">CachedBatch</span><span class="token punctuation">(</span>buffers<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">Byte</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stats<span class="token operator">:</span> <span class="token class-name">Row</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="http://marsishandsome.github.io/SparkSQL-Internal/images/column-store3.png" alt="img"></p> <p>构造一个InMemoryRelation需要该Relation</p> <ol><li>output Attribute</li> <li>是否需要useCoompression来压缩，默认为false</li> <li>一次处理的多少行数据batchSize</li> <li>storageLevel 缓存到什么地方</li> <li>child 即SparkPlan</li> <li>table名</li> <li>_cachedColumnBuffers最终将table放入内存的存储句柄，是一个RDD[CachedBatch]</li> <li>_statistics是统计信息</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> <span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">InMemoryRelation</span><span class="token punctuation">(</span>
    output<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Attribute</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    useCompression<span class="token operator">:</span> <span class="token class-name">Boolean</span><span class="token punctuation">,</span>
    batchSize<span class="token operator">:</span> <span class="token class-name">Int</span><span class="token punctuation">,</span>
    storageLevel<span class="token operator">:</span> <span class="token class-name">StorageLevel</span><span class="token punctuation">,</span>
    child<span class="token operator">:</span> <span class="token class-name">SparkPlan</span><span class="token punctuation">,</span>
    tableName<span class="token operator">:</span> <span class="token class-name">Option</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> _cachedColumnBuffers<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token class-name">CachedBatch</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> _statistics<span class="token operator">:</span> <span class="token class-name">Statistics</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token keyword">extends</span> <span class="token class-name">LogicalPlan</span> <span class="token keyword">with</span> <span class="token class-name">MultiInstanceRelation</span>
</code></pre></div><p>可以通过设置： spark.sql.inMemoryColumnarStorage.compressed为true来设置内存中的列存储是否需要压缩。 spark.sql.inMemoryColumnarStorage.batchSize来设置一次处理多少row spark.sql.defaultSizeInBytes来设置初始化的column的bufferbytes的默认大小，这里只是其中一个参数。</p> <p>缓存主流程：</p> <ol><li>判断_cachedColumnBuffers是否为null，如果不是null，则已经Cache了当前table，重复cache不会触发cache操作，如果是null，则调用buildBuffers。</li> <li>child是物理执行计划SparkPlan</li> <li>执行mapPartitions操作，对当前RDD的每个分区的数据进行操作。</li> <li>对于每一个分区，迭代里面的数据生成新的Iterator。每个Iterator里面是CachedBatch</li> <li>对于child.output的每一列，都会生成一个ColumnBuilder，最后组合为一个columnBuilders是一个数组。</li> <li>数组内每个CommandBuilder持有一个ByteBuffer</li> <li>遍历原始分区的记录，将对于的行转为列，并将数据存到ByteBuffer内。</li> <li>最后将此RDD调用persist方法，将RDD缓存。</li> <li>将cached赋给_cachedColumnBuffers。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>_cachedColumnBuffers <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">buildBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

<span class="token keyword">private</span> def <span class="token function">buildBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    val output <span class="token operator">=</span> child<span class="token punctuation">.</span>output
    val cached <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mapPartitions <span class="token punctuation">{</span> rowIterator <span class="token operator">=</span><span class="token operator">&gt;</span>
      <span class="token keyword">new</span> <span class="token class-name">Iterator</span><span class="token punctuation">[</span><span class="token class-name">CachedBatch</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
        def <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          val columnBuilders <span class="token operator">=</span> output<span class="token punctuation">.</span>map <span class="token punctuation">{</span> attribute <span class="token operator">=</span><span class="token operator">&gt;</span>
            val columnType <span class="token operator">=</span> <span class="token class-name">ColumnType</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span>dataType<span class="token punctuation">)</span>
            val initialBufferSize <span class="token operator">=</span> columnType<span class="token punctuation">.</span>defaultSize <span class="token operator">*</span> batchSize
            <span class="token class-name">ColumnBuilder</span><span class="token punctuation">(</span>columnType<span class="token punctuation">.</span>typeId<span class="token punctuation">,</span> initialBufferSize<span class="token punctuation">,</span> attribute<span class="token punctuation">.</span>name<span class="token punctuation">,</span> useCompression<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">.</span>toArray

          <span class="token keyword">var</span> rowCount <span class="token operator">=</span> <span class="token number">0</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span>rowIterator<span class="token punctuation">.</span>hasNext <span class="token operator">&amp;&amp;</span> rowCount <span class="token operator">&lt;</span> batchSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            val row <span class="token operator">=</span> rowIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> row<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">columnBuilders</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendFrom</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
              i <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token punctuation">}</span>
            rowCount <span class="token operator">+=</span> <span class="token number">1</span>
          <span class="token punctuation">}</span>

          val stats <span class="token operator">=</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">fromSeq</span><span class="token punctuation">(</span>
            columnBuilders<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>columnStats<span class="token punctuation">.</span>collectedStatistics<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">foldLeft</span><span class="token punctuation">(</span><span class="token class-name">Seq</span><span class="token punctuation">.</span>empty<span class="token punctuation">[</span><span class="token class-name">Any</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_ <span class="token operator">++</span> _<span class="token punctuation">)</span><span class="token punctuation">)</span>

          batchStats <span class="token operator">+=</span> stats
          <span class="token class-name">CachedBatch</span><span class="token punctuation">(</span>columnBuilders<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stats<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        def hasNext <span class="token operator">=</span> rowIterator<span class="token punctuation">.</span>hasNext
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span>storageLevel<span class="token punctuation">)</span>

    cached<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>tableName<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>n <span class="token operator">=</span><span class="token operator">&gt;</span> s<span class="token string">&quot;In-memory table $n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>toString<span class="token punctuation">)</span><span class="token punctuation">)</span>
    _cachedColumnBuffers <span class="token operator">=</span> cached
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="columnbuilder"><a href="#columnbuilder" class="header-anchor">#</a> ColumnBuilder</h3> <p>columnBuilders是一个存储ColumnBuilder的数组。</p> <div class="language-java extra-class"><pre class="language-java"><code> val columnBuilders <span class="token operator">=</span> output<span class="token punctuation">.</span>map <span class="token punctuation">{</span> attribute <span class="token operator">=</span><span class="token operator">&gt;</span>
            val columnType <span class="token operator">=</span> <span class="token class-name">ColumnType</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span>dataType<span class="token punctuation">)</span>
            val initialBufferSize <span class="token operator">=</span> columnType<span class="token punctuation">.</span>defaultSize <span class="token operator">*</span> batchSize
            <span class="token class-name">ColumnBuilder</span><span class="token punctuation">(</span>columnType<span class="token punctuation">.</span>typeId<span class="token punctuation">,</span> initialBufferSize<span class="token punctuation">,</span> attribute<span class="token punctuation">.</span>name<span class="token punctuation">,</span> useCompression<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">.</span>toArray
</code></pre></div><p>初始化ColumnBuilder的时候会传入的参数：</p> <ol><li>columnType.typeId 表示列的数据类型</li> <li>initialBufferSize ByteBuffer的初始化大小，列类型默认长度 * batchSize ，默认batchSize是1000。拿Int类型举例，initialBufferSize of IntegerType = 4 * 1000</li> <li>attribute.name 即字段名age,name，etc</li> <li>useCompression 是否开启压缩</li></ol> <p>ColumnType封装了该类型的typeId和该类型的defaultSize。并且提供了extract、append、getField方法，来向buffer里追加和获取数据。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> <span class="token keyword">sealed</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ColumnType</span><span class="token punctuation">[</span><span class="token class-name">T</span> <span class="token operator">&lt;</span><span class="token operator">:</span> <span class="token class-name">DataType</span><span class="token punctuation">,</span> <span class="token class-name">JvmType</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
    val typeId<span class="token operator">:</span> <span class="token class-name">Int</span><span class="token punctuation">,</span>
    val defaultSize<span class="token operator">:</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  def <span class="token function">extract</span><span class="token punctuation">(</span>buffer<span class="token operator">:</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">JvmType</span>

  def <span class="token function">append</span><span class="token punctuation">(</span>v<span class="token operator">:</span> <span class="token class-name">JvmType</span><span class="token punctuation">,</span> buffer<span class="token operator">:</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span>

  def <span class="token function">actualSize</span><span class="token punctuation">(</span>row<span class="token operator">:</span> <span class="token class-name">Row</span><span class="token punctuation">,</span> ordinal<span class="token operator">:</span> <span class="token class-name">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Int</span> <span class="token operator">=</span> defaultSize
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ColumnBuilder的主要职责是：管理ByteBuffer，包括初始化buffer，添加数据到buffer内，检查剩余空间，和申请新的空间这几项主要职责。</p> <p>initialize负责初始化buffer。</p> <div class="language-java extra-class"><pre class="language-java"><code>override def <span class="token function">initialize</span><span class="token punctuation">(</span>
      initialSize<span class="token operator">:</span> <span class="token class-name">Int</span><span class="token punctuation">,</span>
      columnName<span class="token operator">:</span> <span class="token class-name">String</span> <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
      useCompression<span class="token operator">:</span> <span class="token class-name">Boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    val size <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>initialSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> DEFAULT_INITIAL_BUFFER_SIZE <span class="token keyword">else</span> initialSize
    <span class="token keyword">this</span><span class="token punctuation">.</span>columnName <span class="token operator">=</span> columnName

    <span class="token comment">// Reserves 4 bytes for column type ID</span>
    buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">+</span> size <span class="token operator">*</span> columnType<span class="token punctuation">.</span>defaultSize<span class="token punctuation">)</span>
    buffer<span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">ByteOrder</span><span class="token punctuation">.</span><span class="token function">nativeOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>columnType<span class="token punctuation">.</span>typeId<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>appendFrom是负责添加数据。</p> <div class="language-java extra-class"><pre class="language-java"><code>override def <span class="token function">appendFrom</span><span class="token punctuation">(</span>row<span class="token operator">:</span> <span class="token class-name">Row</span><span class="token punctuation">,</span> ordinal<span class="token operator">:</span> <span class="token class-name">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    buffer <span class="token operator">=</span> <span class="token function">ensureFreeSpace</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> columnType<span class="token punctuation">.</span><span class="token function">actualSize</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> ordinal<span class="token punctuation">)</span><span class="token punctuation">)</span>
    columnType<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> ordinal<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>ensureFreeSpace主要是操作buffer，如果要追加的数据大于剩余空间，就扩大buffer。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span><span class="token punctuation">[</span>columnar<span class="token punctuation">]</span> def <span class="token function">ensureFreeSpace</span><span class="token punctuation">(</span>orig<span class="token operator">:</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">,</span> size<span class="token operator">:</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>orig<span class="token punctuation">.</span>remaining <span class="token operator">&gt;=</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      orig
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// grow in steps of initial size</span>
      val capacity <span class="token operator">=</span> orig<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      val newSize <span class="token operator">=</span> capacity <span class="token operator">+</span> size<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>capacity <span class="token operator">/</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
      val pos <span class="token operator">=</span> orig<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token class-name">ByteBuffer</span>
        <span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>newSize<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">ByteOrder</span><span class="token punctuation">.</span><span class="token function">nativeOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>orig<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pos<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-external-data-source"><a href="#_5-external-data-source" class="header-anchor">#</a> 5. External Data Source</h2> <h3 id="外部数据源的注册流程"><a href="#外部数据源的注册流程" class="header-anchor">#</a> 外部数据源的注册流程</h3> <h5 id="ddlparser"><a href="#ddlparser" class="header-anchor">#</a> DDLParser</h5> <p><code>Create Temmporary Table Using</code>语法的解析由DDLParser负责，最后生成一个CreateTableUsing的类。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> lazy val createTable<span class="token operator">:</span> <span class="token class-name">Parser</span><span class="token punctuation">[</span><span class="token class-name">LogicalPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span>
    CREATE <span class="token operator">~</span> TEMPORARY <span class="token operator">~</span> TABLE <span class="token operator">~</span><span class="token operator">&gt;</span> ident <span class="token operator">~</span> <span class="token punctuation">(</span>USING <span class="token operator">~</span><span class="token operator">&gt;</span> className<span class="token punctuation">)</span> <span class="token operator">~</span> <span class="token punctuation">(</span>OPTIONS <span class="token operator">~</span><span class="token operator">&gt;</span> options<span class="token punctuation">)</span> <span class="token operator">^</span><span class="token operator">^</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> tableName <span class="token operator">~</span> provider <span class="token operator">~</span> opts <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token class-name">CreateTableUsing</span><span class="token punctuation">(</span>tableName<span class="token punctuation">,</span> provider<span class="token punctuation">,</span> opts<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre></div><h5 id="createtableusing-logical-plan"><a href="#createtableusing-logical-plan" class="header-anchor">#</a> CreateTableUsing (Logical Plan)</h5> <p>CreateTableUsing继承自RunnableCommand，是一个Logical Plan。</p> <p>CreateTableUsing类接受三个参数：</p> <ol><li>tableName：表名</li> <li>provider：解析具体文件数据的类或包</li> <li>options：解析时需要的其他参数</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> <span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">CreateTableUsing</span><span class="token punctuation">(</span>
    tableName<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    provider<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> <span class="token class-name">Map</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> <span class="token class-name">RunnableCommand</span> <span class="token punctuation">{</span>

  def <span class="token function">run</span><span class="token punctuation">(</span>sqlContext<span class="token operator">:</span> <span class="token class-name">SQLContext</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    val loader <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span>getContextOrSparkClassLoader
    val clazz<span class="token operator">:</span> <span class="token class-name">Class</span><span class="token punctuation">[</span>_<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">try</span> loader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> cnf<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassNotFoundException</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token keyword">try</span> loader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>provider <span class="token operator">+</span> <span class="token string">&quot;.DefaultSource&quot;</span><span class="token punctuation">)</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
          <span class="token keyword">case</span> cnf<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassNotFoundException</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
            sys<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>s<span class="token string">&quot;Failed to load class for data source: $provider&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    val dataSource <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>sources<span class="token punctuation">.</span></span>RelationProvider</span><span class="token punctuation">]</span>
    val relation <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">createRelation</span><span class="token punctuation">(</span>sqlContext<span class="token punctuation">,</span> options<span class="token punctuation">)</span>

    sqlContext<span class="token punctuation">.</span><span class="token function">baseRelationToSchemaRDD</span><span class="token punctuation">(</span>relation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerTempTable</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span>
    <span class="token class-name">Seq</span><span class="token punctuation">.</span>empty
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>CreateTableUsing的run方法定义了这个Logical Plan需要做的事情：</p> <ol><li>加载provider类</li> <li>如果1失败，加载provider包中的DefaultSource类</li> <li>新建加载进来的类的对象，类型转换为org.apache.spark.sql.sources.RelationProvider</li> <li>通过RelationProvider的createRelation方法创建BaseRelation对象</li> <li>通过SqlContext的baseRelationToSchemaRDD方法创建并注册SchemaRDD</li></ol> <p>baseRelationToSchemaRDD方法</p> <ol><li>首先把baseRelation包装成LogicalRelation(baseRelation)</li> <li>然后调用logicalPlanToSparkQuery</li> <li>最后被包装成 SchemaRDD(SqlContext, LogicalPlan(baseRelation))</li></ol> <div class="language-java extra-class"><pre class="language-java"><code>implicit def <span class="token function">baseRelationToSchemaRDD</span><span class="token punctuation">(</span>baseRelation<span class="token operator">:</span> <span class="token class-name">BaseRelation</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">SchemaRDD</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">logicalPlanToSparkQuery</span><span class="token punctuation">(</span><span class="token class-name">LogicalRelation</span><span class="token punctuation">(</span>baseRelation<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

implicit def <span class="token function">logicalPlanToSparkQuery</span><span class="token punctuation">(</span>plan<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">SchemaRDD</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SchemaRDD</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> plan<span class="token punctuation">)</span>
</code></pre></div><h5 id="executedcommand-physical-plan"><a href="#executedcommand-physical-plan" class="header-anchor">#</a> ExecutedCommand (Physical Plan)</h5> <p>CreateTableUsing这个Logical Plan最后会被转换为ExecutedCommand的Physcial Plan。执行ExecutedCommand的时候，会调用CreateTableUsing的run函数，从而触发resolver类的加载以及SchemaRDD的注册。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">ExecutedCommand</span><span class="token punctuation">(</span>cmd<span class="token operator">:</span> <span class="token class-name">RunnableCommand</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> <span class="token class-name">SparkPlan</span> <span class="token punctuation">{</span>
 <span class="token keyword">protected</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> lazy val sideEffectResult<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span> <span class="token operator">=</span> cmd<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>sqlContext<span class="token punctuation">)</span>

  override def output <span class="token operator">=</span> cmd<span class="token punctuation">.</span>output

  override def children <span class="token operator">=</span> <span class="token class-name">Nil</span>

  override def <span class="token function">executeCollect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span> <span class="token operator">=</span> sideEffectResult<span class="token punctuation">.</span>toArray

  override def <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span> <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span><span class="token function">parallelize</span><span class="token punctuation">(</span>sideEffectResult<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="外部数据源的核心类"><a href="#外部数据源的核心类" class="header-anchor">#</a> 外部数据源的核心类</h3> <p>下面介绍一下外部数据源的两个核心类RelationProvider和BaseRelation。</p> <h5 id="relationprovider"><a href="#relationprovider" class="header-anchor">#</a> RelationProvider</h5> <p>RelationProvider是外部数据源的入口，如果想让SparkSQL读取某种格式的外部数据，必须继承该类。RelationProvider只有一个方法createRelation，接收SqlContext和一堆参数，返回BaseRelation。</p> <div class="language-java extra-class"><pre class="language-java"><code>trait <span class="token class-name">RelationProvider</span> <span class="token punctuation">{</span>
  <span class="token comment">/** Returns a new base relation with the given parameters. */</span>
  def <span class="token function">createRelation</span><span class="token punctuation">(</span>sqlContext<span class="token operator">:</span> <span class="token class-name">SQLContext</span><span class="token punctuation">,</span> parameters<span class="token operator">:</span> <span class="token class-name">Map</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">BaseRelation</span>
<span class="token punctuation">}</span>
</code></pre></div><p>来看一下SparkSQL自带的读取JSON格式数据的DefaultSource：</p> <ol><li>该类继承自RelationProvider</li> <li>createRelation方法首先读取参数path（数据路径）和samplingRate（取样比例）</li> <li>然后创建JSONRelation</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> <span class="token keyword">class</span> <span class="token class-name">DefaultSource</span> <span class="token keyword">extends</span> <span class="token class-name">RelationProvider</span> <span class="token punctuation">{</span>
  <span class="token comment">/** Returns a new base relation with the given parameters. */</span>
  override def <span class="token function">createRelation</span><span class="token punctuation">(</span>
      sqlContext<span class="token operator">:</span> <span class="token class-name">SQLContext</span><span class="token punctuation">,</span>
      parameters<span class="token operator">:</span> <span class="token class-name">Map</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">BaseRelation</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    val fileName <span class="token operator">=</span> parameters<span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">,</span> sys<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Option 'path' not specified&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    val samplingRatio <span class="token operator">=</span> parameters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;samplingRatio&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>toDouble<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span>

    <span class="token class-name">JSONRelation</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> samplingRatio<span class="token punctuation">)</span><span class="token punctuation">(</span>sqlContext<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="baserelation"><a href="#baserelation" class="header-anchor">#</a> BaseRelation</h5> <p>SparkSQL用BaseRelation类来把一个数据文件抽象成一张表格，在BaseRelation中定义了Schema。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseRelation</span> <span class="token punctuation">{</span>
  def sqlContext<span class="token operator">:</span> <span class="token class-name">SQLContext</span>
  def schema<span class="token operator">:</span> <span class="token class-name">StructType</span>
  def sizeInBytes <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span>defaultSizeInBytes
<span class="token punctuation">}</span>
</code></pre></div><p>BaseRelation有四个子类，如果想让SparkSQL读取某种格式的外部数据，必须继承下面四个类中的其中一个。 四个子类都提供了一个buildScan的方法，返回值都一样是RDD[Row]，而参数各不一样。</p> <ul><li>TableScan是最基本的BaseRelation，不接收任何参数</li> <li>PrunedScan只读取某些特定列，接收Stirng数组作为参数</li> <li>PrunedFilteredScan在PrunedScan的基础上还增加行过滤，额外接收Filter数组</li> <li>CatalystScan类似于PrunedFilteredScan，不同点是filters的类型为Expression</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">TableScan</span> <span class="token keyword">extends</span> <span class="token class-name">BaseRelation</span> <span class="token punctuation">{</span>
  def <span class="token function">buildScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">PrunedScan</span> <span class="token keyword">extends</span> <span class="token class-name">BaseRelation</span> <span class="token punctuation">{</span>
  def <span class="token function">buildScan</span><span class="token punctuation">(</span>requiredColumns<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">PrunedFilteredScan</span> <span class="token keyword">extends</span> <span class="token class-name">BaseRelation</span> <span class="token punctuation">{</span>
  def <span class="token function">buildScan</span><span class="token punctuation">(</span>requiredColumns<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">,</span> filters<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">Filter</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">CatalystScan</span> <span class="token keyword">extends</span> <span class="token class-name">BaseRelation</span> <span class="token punctuation">{</span>
  def <span class="token function">buildScan</span><span class="token punctuation">(</span>requiredColumns<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Attribute</span><span class="token punctuation">]</span><span class="token punctuation">,</span> filters<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看一下SparkSQL为读取json格式的数据实现的JSONRelation:</p> <ol><li>JSONRelation继承自TableScan，说明不做任何过滤</li> <li>首先通过SparkContext的textFile生成baseRDD</li> <li>然后调用JsonRDD的inferSchema，从原始数据中分析出Schema信息</li> <li>最后调用JsonRDD的jsonStringToRow，把Json格式的数据转成SchemaRDD格式</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> <span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">JSONRelation</span><span class="token punctuation">(</span>fileName<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> samplingRatio<span class="token operator">:</span> <span class="token class-name">Double</span><span class="token punctuation">)</span><span class="token punctuation">(</span>
    <span class="token annotation punctuation">@transient</span> val sqlContext<span class="token operator">:</span> <span class="token class-name">SQLContext</span><span class="token punctuation">)</span>
  <span class="token keyword">extends</span> <span class="token class-name">TableScan</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> def baseRDD <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span><span class="token function">textFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span>

  override val schema <span class="token operator">=</span>
    <span class="token class-name">JsonRDD</span><span class="token punctuation">.</span><span class="token function">inferSchema</span><span class="token punctuation">(</span>
      baseRDD<span class="token punctuation">,</span>
      samplingRatio<span class="token punctuation">,</span>
      sqlContext<span class="token punctuation">.</span>columnNameOfCorruptRecord<span class="token punctuation">)</span>

  override def <span class="token function">buildScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token class-name">JsonRDD</span><span class="token punctuation">.</span><span class="token function">jsonStringToRow</span><span class="token punctuation">(</span>baseRDD<span class="token punctuation">,</span> schema<span class="token punctuation">,</span> sqlContext<span class="token punctuation">.</span>columnNameOfCorruptRecord<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="外部数据源table查询的计划解析流程"><a href="#外部数据源table查询的计划解析流程" class="header-anchor">#</a> 外部数据源Table查询的计划解析流程</h3> <h5 id="datasourcesstrategy-logical-plan-physical-plan"><a href="#datasourcesstrategy-logical-plan-physical-plan" class="header-anchor">#</a> DataSourcesStrategy (Logical Plan -&gt; Physical Plan)</h5> <p>DataSourcesStrategy是Logical Plan转换成Physical Plan中</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span><span class="token punctuation">[</span>sql<span class="token punctuation">]</span> object <span class="token class-name">DataSourceStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">Strategy</span> <span class="token punctuation">{</span>
  def <span class="token function">apply</span><span class="token punctuation">(</span>plan<span class="token operator">:</span> <span class="token class-name">LogicalPlan</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">SparkPlan</span><span class="token punctuation">]</span> <span class="token operator">=</span> plan match <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token class-name">PhysicalOperation</span><span class="token punctuation">(</span>projectList<span class="token punctuation">,</span> filters<span class="token punctuation">,</span> l @ <span class="token class-name">LogicalRelation</span><span class="token punctuation">(</span>t<span class="token operator">:</span> <span class="token class-name">CatalystScan</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
      <span class="token function">pruneFilterProjectRaw</span><span class="token punctuation">(</span>
        l<span class="token punctuation">,</span>
        projectList<span class="token punctuation">,</span>
        filters<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>a<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> t<span class="token punctuation">.</span><span class="token function">buildScan</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>

    <span class="token keyword">case</span> <span class="token class-name">PhysicalOperation</span><span class="token punctuation">(</span>projectList<span class="token punctuation">,</span> filters<span class="token punctuation">,</span> l @ <span class="token class-name">LogicalRelation</span><span class="token punctuation">(</span>t<span class="token operator">:</span> <span class="token class-name">PrunedFilteredScan</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
      <span class="token function">pruneFilterProject</span><span class="token punctuation">(</span>
        l<span class="token punctuation">,</span>
        projectList<span class="token punctuation">,</span>
        filters<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>a<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> t<span class="token punctuation">.</span><span class="token function">buildScan</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>

    <span class="token keyword">case</span> <span class="token class-name">PhysicalOperation</span><span class="token punctuation">(</span>projectList<span class="token punctuation">,</span> filters<span class="token punctuation">,</span> l @ <span class="token class-name">LogicalRelation</span><span class="token punctuation">(</span>t<span class="token operator">:</span> <span class="token class-name">PrunedScan</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
      <span class="token function">pruneFilterProject</span><span class="token punctuation">(</span>
        l<span class="token punctuation">,</span>
        projectList<span class="token punctuation">,</span>
        filters<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>a<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> t<span class="token punctuation">.</span><span class="token function">buildScan</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>

    <span class="token keyword">case</span> l @ <span class="token class-name">LogicalRelation</span><span class="token punctuation">(</span>t<span class="token operator">:</span> <span class="token class-name">TableScan</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
      <span class="token class-name"><span class="token namespace">execution<span class="token punctuation">.</span></span>PhysicalRDD</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>output<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">buildScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token class-name">Nil</span>

    <span class="token keyword">case</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Nil</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="如何自定义一个外部数据源"><a href="#如何自定义一个外部数据源" class="header-anchor">#</a> 如何自定义一个外部数据源</h3> <h3 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h3> <p><a href="http://blog.csdn.net/oopsoom/article/details/42061077" target="_blank" rel="noopener noreferrer">Spark SQL之External DataSource外部数据源（一）示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://blog.csdn.net/oopsoom/article/details/42064075" target="_blank" rel="noopener noreferrer">Spark SQL之External DataSource外部数据源（二）源码分析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="_6-code-generation"><a href="#_6-code-generation" class="header-anchor">#</a> 6. Code Generation</h2> <p>SparkSQL利用Scala提供的Reflection和Quasiquotes机制来实现Code Generation。</p> <h3 id="scala-reflection"><a href="#scala-reflection" class="header-anchor">#</a> Scala Reflection</h3> <p>Java本身就已经提供了Reflection功能，在Scala2.10之前，Scala并不提供额外的Reflection机制，Scala2.10在Java Reflection基础上又实现了一套更加powerful的Reflection机制。Scala中的Reflection分为两大类：Runtime Reflection和Compile-time Reflection。</p> <h5 id="runtime-reflection"><a href="#runtime-reflection" class="header-anchor">#</a> Runtime Reflection</h5> <p>Runtime Reflection主要包括</p> <ol><li>动态获取对象的类型</li> <li>动态新建对象</li> <li>动态调用对象的方法</li></ol> <p>这部分和Java提供的Reflection比较类似。</p> <h5 id="compile-time-reflection"><a href="#compile-time-reflection" class="header-anchor">#</a> Compile-time Reflection</h5> <p>Scala的Compile-time Reflection允许程序在编译期间修改自己的代码，从而实现meta-programming。Complie-time Reflection是通过macros实现的，macros允许程序可以在编译期间修改自己的语法树。</p> <h5 id="abstract-syntax-tree"><a href="#abstract-syntax-tree" class="header-anchor">#</a> Abstract Syntax Tree</h5> <p>Scala使用Abstract Syntax Tree来表示Scala程序，Scala的Reflection提供了多种方法来操作AST:</p> <ol><li>reify方法可以把一个表达式变成一个AST</li> <li>在Compile-time，通过macros可以操作AST</li> <li>在Runtime，通过toolboxes也可以操作AST</li></ol> <p>下面的例子演示了如果在Runtime利用toolboxes操作AST</p> <ol><li>在Runtime利用ToolBox的parse函数，将一段代码变了AST</li> <li>然后通过ToolBox的eval函数，将生成的AST进行求值，返回该段代码的返回值f，f是一个实现+1操作的函数</li> <li>最后调用返回的函数f</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">ToolBox</span>

object <span class="token class-name">HelloToolBox</span> <span class="token punctuation">{</span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    val toolBox <span class="token operator">=</span> scala<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>universe<span class="token punctuation">.</span>
      <span class="token function">runtimeMirror</span><span class="token punctuation">(</span>getClass<span class="token punctuation">.</span>getClassLoader<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mkToolBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    val code <span class="token operator">=</span>
      <span class="token triple-quoted-string string">&quot;&quot;&quot;
        val f = {x: Int =&gt; x + 1}
        f
      &quot;&quot;&quot;</span>

    val tree <span class="token operator">=</span> toolBox<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span>

    val func <span class="token operator">=</span> toolBox<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span>
    val result <span class="token operator">=</span> func<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span><span class="token class-name">Int</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>程序的输出为：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token punctuation">{</span>
  val f <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> x<span class="token punctuation">.</span>$<span class="token function">plus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  f
<span class="token punctuation">}</span>
<span class="token number">2</span>
</code></pre></div><h3 id="scala-quasiquotes"><a href="#scala-quasiquotes" class="header-anchor">#</a> Scala Quasiquotes</h3> <p>Quasiquotes是Scala提供的方便操作AST的库，当把代码放到<code>q&quot;...&quot;</code>里面时，将会返回一个AST。</p> <div class="language-java extra-class"><pre class="language-java"><code>scala<span class="token operator">&gt;</span> val tree <span class="token operator">=</span> q<span class="token string">&quot;i am { a quasiquote }&quot;</span>
tree<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">universe<span class="token punctuation">.</span></span>Tree</span> <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">am</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>quasiquote<span class="token punctuation">)</span>
</code></pre></div><p>下面的例子演示了如何利用Quasiquotes来实现Code Generation:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>currentMirror</span>
<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">ToolBox</span>

object <span class="token class-name">HelloQuasiquotes</span> <span class="token punctuation">{</span>

  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    val universe<span class="token operator">:</span> scala<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>universe<span class="token punctuation">.</span>type <span class="token operator">=</span> scala<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>universe
    <span class="token keyword">import</span> <span class="token namespace">universe<span class="token punctuation">.</span></span>_

    val toolbox <span class="token operator">=</span> currentMirror<span class="token punctuation">.</span><span class="token function">mkToolBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    val tree <span class="token operator">=</span> q<span class="token triple-quoted-string string">&quot;&quot;&quot;
              val f = {x: Int =&gt; x + 1}
              f
             &quot;&quot;&quot;</span>

    <span class="token function">println</span><span class="token punctuation">(</span><span class="token function">showCode</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">)</span>

    val func <span class="token operator">=</span> toolbox<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span>
    val result <span class="token operator">=</span> func<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span><span class="token class-name">Int</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>程序输出为：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token punctuation">{</span>
  val f <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> x<span class="token punctuation">.</span>+<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  f
<span class="token punctuation">}</span>
<span class="token number">2</span>
</code></pre></div><h3 id="sparksql-code-generation"><a href="#sparksql-code-generation" class="header-anchor">#</a> SparkSQL Code Generation</h3> <p>SparkSQL使用Quasiquotes来实现Code Genration。Quasiquotes是Scala 2.11的新功能，当使用Scala 2.10来编译Spark时，只能通过<a href="http://docs.scala-lang.org/overviews/macros/paradise.html" target="_blank" rel="noopener noreferrer">macro paradise compiler plugin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的方式使用quasiquotes。</p> <h5 id="codegenerator"><a href="#codegenerator" class="header-anchor">#</a> CodeGenerator</h5> <p>CodeGenerator是代码生成的基类，里面定义了</p> <ol><li>expressionEvaluator：把一个Expression变成EvaluatedExpression，即AST</li> <li>toolBox: 可以在返回的AST上求值，返回动态生成的代码的调用入口</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">CodeGenerator</span><span class="token punctuation">[</span><span class="token class-name">InType</span> <span class="token operator">&lt;</span><span class="token operator">:</span> <span class="token class-name">AnyRef</span><span class="token punctuation">,</span> <span class="token class-name">OutType</span> <span class="token operator">&lt;</span><span class="token operator">:</span> <span class="token class-name">AnyRef</span><span class="token punctuation">]</span> <span class="token keyword">extends</span> <span class="token class-name">Logging</span> <span class="token punctuation">{</span>
  <span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token punctuation">{</span>universe <span class="token operator">=</span><span class="token operator">&gt;</span> ru<span class="token punctuation">}</span>
  <span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>universe<span class="token punctuation">.</span></span>_
  <span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">ToolBox</span>

  <span class="token keyword">protected</span> val toolBox <span class="token operator">=</span> <span class="token function">runtimeMirror</span><span class="token punctuation">(</span>getClass<span class="token punctuation">.</span>getClassLoader<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mkToolBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  def <span class="token function">expressionEvaluator</span><span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token class-name">Expression</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">EvaluatedExpression</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>EvaluatedExpression可以理解为已经生成好的代码，这段代码可以在Row上求值，EvaluatedEpression包括</p> <ol><li>code：AST的List，用来求值的代码</li> <li>nullTerm：代码中的变量名，表示最后的值是否是null</li> <li>primitiveTerm：代码中的变量名，表示最后的值的原始类型，无效如果nullTerm=true</li> <li>objectTerm：代码中的变量名，表示最后的值的包装类型</li></ol> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">protected</span> <span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">EvaluatedExpression</span><span class="token punctuation">(</span>
      code<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Tree</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      nullTerm<span class="token operator">:</span> <span class="token class-name">TermName</span><span class="token punctuation">,</span>
      primitiveTerm<span class="token operator">:</span> <span class="token class-name">TermName</span><span class="token punctuation">,</span>
      objectTerm<span class="token operator">:</span> <span class="token class-name">TermName</span><span class="token punctuation">)</span>
</code></pre></div><p>下面来看一下Code Generation的关键函数expressionEvaluator。</p> <ol><li>调用freshName为primitiveTerm、nullTerm、objectTerm生成变量名</li> <li>调用primitiveEvaluation，把Expression变成Seq[Tree]，可能会失败</li> <li>如果primitiveEvaluation失败，则生成表达式树求值的代码</li> <li>返回EvaluatedExpression</li></ol> <div class="language-java extra-class"><pre class="language-java"><code>def <span class="token function">expressionEvaluator</span><span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token class-name">Expression</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">EvaluatedExpression</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    val primitiveTerm <span class="token operator">=</span> <span class="token function">freshName</span><span class="token punctuation">(</span><span class="token string">&quot;primitiveTerm&quot;</span><span class="token punctuation">)</span>
    val nullTerm <span class="token operator">=</span> <span class="token function">freshName</span><span class="token punctuation">(</span><span class="token string">&quot;nullTerm&quot;</span><span class="token punctuation">)</span>
    val objectTerm <span class="token operator">=</span> <span class="token function">freshName</span><span class="token punctuation">(</span><span class="token string">&quot;objectTerm&quot;</span><span class="token punctuation">)</span>
    val primitiveEvaluation<span class="token operator">:</span> <span class="token class-name">PartialFunction</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">,</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Tree</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
    val code<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Tree</span><span class="token punctuation">]</span> <span class="token operator">=</span>
      primitiveEvaluation<span class="token punctuation">.</span>lift<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span>getOrElse <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>s<span class="token string">&quot;No rules to generate $e&quot;</span><span class="token punctuation">)</span>
        val tree <span class="token operator">=</span> reify <span class="token punctuation">{</span> e <span class="token punctuation">}</span>
        q<span class="token triple-quoted-string string">&quot;&quot;&quot;
          val $objectTerm = $tree.eval(i)
          val $nullTerm = $objectTerm == null
          val $primitiveTerm = $objectTerm.asInstanceOf[${termForType(e.dataType)}]
         &quot;&quot;&quot;</span><span class="token punctuation">.</span>children
      <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token class-name">EvaluatedExpression</span><span class="token punctuation">(</span>code <span class="token operator">++</span> debugCode<span class="token punctuation">,</span> nullTerm<span class="token punctuation">,</span> primitiveTerm<span class="token punctuation">,</span> objectTerm<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>primitiveEvaluation是一个PartialFunction，把Expression变成Seq[Tree]。</p> <p>下面分析一下And是如何生成代码的：</p> <ol><li>分别生成e1和e2的AST</li> <li>分几种情况判断And的结果是否为null以及是否为primitive</li> <li>返回e1、e2和add的代码</li></ol> <div class="language-java extra-class"><pre class="language-java"><code>val primitiveEvaluation<span class="token operator">:</span> <span class="token class-name">PartialFunction</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">,</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Tree</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">case</span> <span class="token class-name">And</span><span class="token punctuation">(</span>e1<span class="token punctuation">,</span> e2<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        val eval1 <span class="token operator">=</span> <span class="token function">expressionEvaluator</span><span class="token punctuation">(</span>e1<span class="token punctuation">)</span>
        val eval2 <span class="token operator">=</span> <span class="token function">expressionEvaluator</span><span class="token punctuation">(</span>e2<span class="token punctuation">)</span>

        eval1<span class="token punctuation">.</span>code <span class="token operator">++</span> eval2<span class="token punctuation">.</span>code <span class="token operator">++</span>
        q<span class="token triple-quoted-string string">&quot;&quot;&quot;
          var $nullTerm = false
          var $primitiveTerm: ${termForType(BooleanType)} = false

          if ((!${eval1.nullTerm} &amp;&amp; !${eval1.primitiveTerm}) ||
              (!${eval2.nullTerm} &amp;&amp; !${eval2.primitiveTerm})) {
            $nullTerm = false
            $primitiveTerm = false
          } else if (${eval1.nullTerm} || ${eval2.nullTerm} ) {
            $nullTerm = true
          } else {
            $nullTerm = false
            $primitiveTerm = true
          }
         &quot;&quot;&quot;</span><span class="token punctuation">.</span>children
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Add的代码看上去更加简洁，只有一句话，其实是因为把(e1, e2)隐式转换成了class Evaluate2，并调用其evaluate方法。</p> <div class="language- extra-class"><pre class="language-text"><code>case Add(e1, e2) =&gt;      (e1, e2) evaluate { case (eval1, eval2) =&gt; q&quot;$eval1 + $eval2&quot; }
</code></pre></div><p>evaluate方法接受一个function，返回一个Seq[Tree]。function接收两个scala reflaction中的TermName，返回一个AST。</p> <ol><li>evaluate方首先调用expressionEvaluator，分别计算两个表达式的AST</li> <li>然后生成传递进来的function的AST，参数为1中得到的primitiveTerm</li> <li>生成function代码的nullTerm</li> <li>生成function代码的primitiveTerm，如果是null的话返回该类型的默认值</li></ol> <div class="language-java extra-class"><pre class="language-java"><code>implicit <span class="token keyword">class</span> <span class="token class-name">Evaluate2</span><span class="token punctuation">(</span>expressions<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">Expression</span><span class="token punctuation">,</span> <span class="token class-name">Expression</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    def <span class="token function">evaluate</span><span class="token punctuation">(</span>f<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">TermName</span><span class="token punctuation">,</span> <span class="token class-name">TermName</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Tree</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Tree</span><span class="token punctuation">]</span> <span class="token operator">=</span>
        <span class="token function">evaluateAs</span><span class="token punctuation">(</span>expressions<span class="token punctuation">.</span>_1<span class="token punctuation">.</span>dataType<span class="token punctuation">)</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>

      def <span class="token function">evaluateAs</span><span class="token punctuation">(</span>resultType<span class="token operator">:</span> <span class="token class-name">DataType</span><span class="token punctuation">)</span><span class="token punctuation">(</span>f<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">TermName</span><span class="token punctuation">,</span> <span class="token class-name">TermName</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Tree</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Tree</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO: Right now some timestamp tests fail if we enforce this...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expressions<span class="token punctuation">.</span>_1<span class="token punctuation">.</span>dataType <span class="token operator">!=</span> expressions<span class="token punctuation">.</span>_2<span class="token punctuation">.</span>dataType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>s<span class="token string">&quot;${expressions._1.dataType} != ${expressions._2.dataType}&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        val eval1 <span class="token operator">=</span> <span class="token function">expressionEvaluator</span><span class="token punctuation">(</span>expressions<span class="token punctuation">.</span>_1<span class="token punctuation">)</span>
        val eval2 <span class="token operator">=</span> <span class="token function">expressionEvaluator</span><span class="token punctuation">(</span>expressions<span class="token punctuation">.</span>_2<span class="token punctuation">)</span>
        val resultCode <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>eval1<span class="token punctuation">.</span>primitiveTerm<span class="token punctuation">,</span> eval2<span class="token punctuation">.</span>primitiveTerm<span class="token punctuation">)</span>

        eval1<span class="token punctuation">.</span>code <span class="token operator">++</span> eval2<span class="token punctuation">.</span>code <span class="token operator">++</span>
        q<span class="token triple-quoted-string string">&quot;&quot;&quot;
          val $nullTerm = ${eval1.nullTerm} || ${eval2.nullTerm}
          val $primitiveTerm: ${termForType(resultType)} =
            if($nullTerm) {
              ${defaultPrimitive(resultType)}
            } else {
              $resultCode.asInstanceOf[${termForType(resultType)}]
            }
        &quot;&quot;&quot;</span><span class="token punctuation">.</span>children <span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Tree</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>来看一下Code Generation生成出来的Add的示例代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token keyword">class</span> $anon <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>catalyst<span class="token punctuation">.</span>expressions<span class="token punctuation">.</span></span>MutableProjection</span> <span class="token punctuation">{</span>
    def <span class="token generics"><span class="token punctuation">&lt;</span>init<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span>init<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span> <span class="token keyword">var</span> mutableRow<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>catalyst<span class="token punctuation">.</span>expressions<span class="token punctuation">.</span></span>MutableRow</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>catalyst<span class="token punctuation">.</span>expressions<span class="token punctuation">.</span></span>GenericMutableRow</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    def <span class="token function">target</span><span class="token punctuation">(</span>row<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>catalyst<span class="token punctuation">.</span>expressions<span class="token punctuation">.</span></span>MutableRow</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>catalyst<span class="token punctuation">.</span>expressions<span class="token punctuation">.</span></span>MutableProjection</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      mutableRow <span class="token operator">=</span> row<span class="token punctuation">;</span>
      <span class="token keyword">this</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    def currentValue<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>catalyst<span class="token punctuation">.</span>expressions<span class="token punctuation">.</span></span>Row</span> <span class="token operator">=</span> mutableRow<span class="token punctuation">;</span>
    def <span class="token function">apply</span><span class="token punctuation">(</span>i<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>catalyst<span class="token punctuation">.</span>expressions<span class="token punctuation">.</span></span>Row</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>catalyst<span class="token punctuation">.</span>expressions<span class="token punctuation">.</span></span>Row</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      val nullTerm$<span class="token number">4</span><span class="token operator">:</span> <span class="token class-name">Boolean</span> <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">isNullAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      val primitiveTerm$<span class="token number">3</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>catalyst<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>IntegerType<span class="token punctuation">.</span>JvmType</span> <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nullTerm$<span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token operator">-</span><span class="token number">1</span>
      <span class="token keyword">else</span>
        i<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      val nullTerm$<span class="token number">7</span><span class="token operator">:</span> <span class="token class-name">Boolean</span> <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">isNullAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      val primitiveTerm$<span class="token number">6</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>catalyst<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>IntegerType<span class="token punctuation">.</span>JvmType</span> <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nullTerm$<span class="token number">7</span><span class="token punctuation">)</span>
        <span class="token operator">-</span><span class="token number">1</span>
      <span class="token keyword">else</span>
        i<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      val nullTerm$<span class="token number">1</span> <span class="token operator">=</span> nullTerm$<span class="token number">4.</span>$bar$<span class="token function">bar</span><span class="token punctuation">(</span>nullTerm$<span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      val primitiveTerm$<span class="token number">0</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>catalyst<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>IntegerType<span class="token punctuation">.</span>JvmType</span> <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nullTerm$<span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token operator">-</span><span class="token number">1</span>
      <span class="token keyword">else</span>
        primitiveTerm$<span class="token number">3.</span>$<span class="token function">plus</span><span class="token punctuation">(</span>primitiveTerm$<span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>catalyst<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>IntegerType<span class="token punctuation">.</span>JvmType</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nullTerm$<span class="token number">1</span><span class="token punctuation">)</span>
        mutableRow<span class="token punctuation">.</span><span class="token function">setNullAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">else</span>
        mutableRow<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> primitiveTerm$<span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      mutableRow
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">new</span> $<span class="token function">anon</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>有四个类继承了CodeGenrator</p> <ol><li>GenerateProjection</li> <li>GenerateMutableProjection</li> <li>GenerateOrdering</li> <li>GeneratePredicate</li></ol> <h5 id="generatepredicate"><a href="#generatepredicate" class="header-anchor">#</a> GeneratePredicate</h5> <p>下面来分析一下GeneratePredicate这个类。create函数根据一个表达式生成了一段函数代码，该函数的输入是Row（即一行数据），输出是Boolean（即该行是否被过滤）。</p> <ol><li>首先调用expressionEvaluator方法，计算出Expression的AST</li> <li>然后生成返回的函数的代码，函数首先调用1中所得到的AST，如果1中AST的nullTerm=true，则返回false，否则返回1中AST的实际返回值primitiveTerm</li> <li>最后调用toolBox的eval函数，获得AST中function的实例入口地址</li></ol> <div class="language-java extra-class"><pre class="language-java"><code>object <span class="token class-name">GeneratePredicate</span> <span class="token keyword">extends</span> <span class="token class-name">CodeGenerator</span><span class="token punctuation">[</span><span class="token class-name">Expression</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Row</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Boolean</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token punctuation">{</span>universe <span class="token operator">=</span><span class="token operator">&gt;</span> ru<span class="token punctuation">}</span>
  <span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>universe<span class="token punctuation">.</span></span>_

  <span class="token keyword">protected</span> def <span class="token function">canonicalize</span><span class="token punctuation">(</span>in<span class="token operator">:</span> <span class="token class-name">Expression</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Expression</span> <span class="token operator">=</span> <span class="token class-name">ExpressionCanonicalizer</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span>

  <span class="token keyword">protected</span> def <span class="token function">bind</span><span class="token punctuation">(</span>in<span class="token operator">:</span> <span class="token class-name">Expression</span><span class="token punctuation">,</span> inputSchema<span class="token operator">:</span> <span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">Attribute</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Expression</span> <span class="token operator">=</span>
    <span class="token class-name">BindReferences</span><span class="token punctuation">.</span><span class="token function">bindReference</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> inputSchema<span class="token punctuation">)</span>

  <span class="token keyword">protected</span> def <span class="token function">create</span><span class="token punctuation">(</span>predicate<span class="token operator">:</span> <span class="token class-name">Expression</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Row</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Boolean</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    val cEval <span class="token operator">=</span> <span class="token function">expressionEvaluator</span><span class="token punctuation">(</span>predicate<span class="token punctuation">)</span>

    val code <span class="token operator">=</span>
      q<span class="token triple-quoted-string string">&quot;&quot;&quot;
        (i: $rowType) =&gt; {
          ..${cEval.code}
          if (${cEval.nullTerm}) false else ${cEval.primitiveTerm}
        }
      &quot;&quot;&quot;</span>
    toolBox<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span><span class="token class-name">Row</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Boolean</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="参考-2"><a href="#参考-2" class="header-anchor">#</a> 参考</h3> <p>http://docs.scala-lang.org/overviews/reflection/symbols-trees-types.html</p> <p>http://docs.scala-lang.org/overviews/quasiquotes/intro.html</p> <p>http://docs.scala-lang.org/overviews/quasiquotes/setup.html</p> <p>http://docs.scala-lang.org/overviews/macros/paradise.html</p> <p>http://www.infoq.com/cn/news/2013/01/scala-macros</p> <p>https://databricks.com/blog/2014/06/02/exciting-performance-improvements-on-the-horizon-for-spark-sql.html</p> <p>https://gist.github.com/marmbrus/9efb31d2b5154aea6652</p> <h2 id="_99-推荐资料"><a href="#_99-推荐资料" class="header-anchor">#</a> 99. 推荐资料</h2> <h3 id="官方资料"><a href="#官方资料" class="header-anchor">#</a> 官方资料</h3> <p><a href="http://marsishandsome.github.io/SparkSQL-Internal/07-overall/www.databricks.com" target="_blank" rel="noopener noreferrer">Databricks官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://marsishandsome.github.io/SparkSQL-Internal/07-overall/spark.apache.org" target="_blank" rel="noopener noreferrer">Spark官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://marsishandsome.github.io/SparkSQL-Internal/07-overall/github.com/apache/spark" target="_blank" rel="noopener noreferrer">Spark Github<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://issues.apache.org/jira/browse/SPARK/?selectedTab=com.atlassian.jira.jira-projects-plugin:summary-panel" target="_blank" rel="noopener noreferrer">Spark GIRA<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://spark-summit.org/2014" target="_blank" rel="noopener noreferrer">Spark Submit<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="spark博客"><a href="#spark博客" class="header-anchor">#</a> Spark博客</h3> <p><a href="http://blog.csdn.net/oopsoom" target="_blank" rel="noopener noreferrer">OopsOutOfMemory<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://blog.csdn.net/book_mmicky" target="_blank" rel="noopener noreferrer">mmicky的hadoop、Spark世界<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://www.cnblogs.com/hseagle/" target="_blank" rel="noopener noreferrer">徽沪一郎<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://baishuo491.iteye.com/blog" target="_blank" rel="noopener noreferrer">baishuo491<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://jerryshao.me/" target="_blank" rel="noopener noreferrer">赛赛的网络日志 Jerry Shao<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://www.cnblogs.com/jerrylead/default.html?page=1" target="_blank" rel="noopener noreferrer">JerryLead博客园<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://blog.csdn.net/pelick" target="_blank" rel="noopener noreferrer">张包峰的博客<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="spark深入研究"><a href="#spark深入研究" class="header-anchor">#</a> Spark深入研究</h3> <p><a href="https://github.com/JerryLead/SparkInternals/blob/master/markdown/0-Introduction.md" target="_blank" rel="noopener noreferrer">Spark Internals by JerryLead<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="spark论文"><a href="#spark论文" class="header-anchor">#</a> Spark论文</h3> <p><a href="http://people.csail.mit.edu/matei/papers/2010/hotcloud_spark.pdf" target="_blank" rel="noopener noreferrer">Spark: Cluster Computing with Working Sets<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> Matei Zaharia</p> <p><a href="http://www.cs.berkeley.edu/~matei/papers/2012/nsdi_spark.pdf" target="_blank" rel="noopener noreferrer">Resilient Distributed Datasets: A Fault-Tolerant Abstraction for In-Memory Cluster Computing<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> Matei Zaharia</p> <p><a href="http://www.cs.berkeley.edu/~matei/papers/2012/hotcloud_spark_streaming.pdf" target="_blank" rel="noopener noreferrer">Discretized Streams: An Efficient and Fault-Tolerant Model for Stream Processing on Large Clusters<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> Matei Zaharia</p> <p><a href="http://www.eecs.berkeley.edu/Pubs/TechRpts/2012/EECS-2012-214.pdf" target="_blank" rel="noopener noreferrer">Shark: SQL and Rich Analytics at Scale<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> Reynold Shi Xin, Matei Zaharia</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/./bigdata/spark/Spark SQL Catalyst优化器.html" class="prev">
        Spark SQL Catalyst优化器
      </a></span> <span class="next"><a href="/./bigdata/spark/SparkSQL调优.html">
        SparkSQL调优
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="./assets/js/app.dc5b0715.js" defer></script><script src="./assets/js/2.47c06342.js" defer></script><script src="./assets/js/44.e75043b3.js" defer></script>
  </body>
</html>
